<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota Y√∂netimi - Geli≈ümi≈ü Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --route-primary: #2563eb;
            --route-secondary: #64748b;
            --route-success: #059669;
            --route-danger: #dc2626;
            --route-warning: #d97706;
            --route-info: #0891b2;
            --route-light: #f8fafc;
            --route-dark: #0f172a;
            --route-border: #e2e8f0;
            --route-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --route-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
            --route-radius: 12px;
            --route-radius-lg: 16px;
            --route-transition: all 0.3s ease;
        }

        body {
            background: var(--route-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Main Layout */
        .route-management-container {
            display: grid;
            grid-template-areas: 
                "header header header"
                "sidebar workspace map";
            grid-template-columns: 380px 1fr 520px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 1rem;
            padding: 1rem;
        }

        /* Header */
        .route-header {
            grid-area: header;
            background: white;
            border-radius: var(--route-radius-lg);
            box-shadow: var(--route-shadow);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-header h1 {
            margin: 0;
            color: var(--route-dark);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-navigation {
            display: flex;
            gap: 1rem;
        }

        .main-navigation a {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            text-decoration: none;
            color: var(--route-secondary);
            font-weight: 500;
            transition: var(--route-transition);
            border: 2px solid transparent;
        }

        .main-navigation a.active {
            background: var(--route-primary);
            color: white;
            box-shadow: var(--route-shadow);
        }

        .main-navigation a:hover:not(.active) {
            background: var(--route-light);
            border-color: var(--route-border);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .btn-primary {
            background: var(--route-primary);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.25rem;
            font-weight: 600;
            transition: var(--route-transition);
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: var(--route-shadow-hover);
        }

        /* Sidebar */
        .route-sidebar {
            grid-area: sidebar;
            background: white;
            border-radius: var(--route-radius-lg);
            box-shadow: var(--route-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--route-primary) 0%, #1e40af 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .sidebar-controls {
            padding: 1rem;
            border-bottom: 1px solid var(--route-border);
            background: var(--route-light);
        }

        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--route-border);
            border-radius: 25px;
            font-size: 0.9rem;
            transition: var(--route-transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--route-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--route-secondary);
        }

        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--route-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-select {
            padding: 0.5rem;
            border: 2px solid var(--route-border);
            border-radius: var(--route-radius);
            font-size: 0.85rem;
            transition: var(--route-transition);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--route-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .bulk-actions {
            padding: 1rem;
            border-bottom: 1px solid var(--route-border);
            background: #fef3c7;
            display: none;
        }

        .bulk-actions.show {
            display: block;
        }

        .bulk-actions-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .bulk-count {
            font-weight: 600;
            color: var(--route-warning);
        }

        .bulk-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-bulk {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
            transition: var(--route-transition);
        }

        .btn-bulk-export {
            background: var(--route-info);
            color: white;
        }

        .btn-bulk-delete {
            background: var(--route-danger);
            color: white;
        }

        .btn-bulk-edit {
            background: var(--route-warning);
            color: white;
        }

        /* Route List */
        .route-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .route-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .route-list-container::-webkit-scrollbar-track {
            background: var(--route-light);
            border-radius: 3px;
        }

        .route-list-container::-webkit-scrollbar-thumb {
            background: var(--route-border);
            border-radius: 3px;
        }

        .route-list-container::-webkit-scrollbar-thumb:hover {
            background: var(--route-secondary);
        }

        .route-item {
            background: white;
            border: 2px solid var(--route-border);
            border-radius: var(--route-radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: var(--route-transition);
            position: relative;
        }

        .route-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--route-primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
            border-radius: 2px 0 0 2px;
        }

        .route-item:hover {
            border-color: var(--route-primary);
            transform: translateY(-2px);
            box-shadow: var(--route-shadow-hover);
        }

        .route-item:hover::before {
            transform: scaleY(1);
        }

        .route-item.selected {
            border-color: var(--route-primary);
            background: rgba(37, 99, 235, 0.05);
            box-shadow: var(--route-shadow-hover);
        }

        .route-item.selected::before {
            transform: scaleY(1);
        }

        .route-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .route-checkbox {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .route-item-title {
            font-weight: 700;
            color: var(--route-dark);
            margin: 0;
            font-size: 1rem;
            line-height: 1.3;
            padding-right: 2rem;
        }

        .route-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .route-type-walking { background: #dcfce7; color: #166534; }
        .route-type-hiking { background: #fef3c7; color: #92400e; }
        .route-type-cycling { background: #dbeafe; color: #1e40af; }
        .route-type-driving { background: #fce7f3; color: #be185d; }

        .route-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .route-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--route-secondary);
        }

        .route-stat-icon {
            width: 16px;
            text-align: center;
            color: var(--route-primary);
        }

        .difficulty-stars {
            color: #fbbf24;
            font-size: 0.9rem;
        }

        .route-description {
            font-size: 0.85rem;
            color: var(--route-secondary);
            line-height: 1.4;
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Workspace */
        .route-workspace {
            grid-area: workspace;
            background: white;
            border-radius: var(--route-radius-lg);
            box-shadow: var(--route-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .workspace-header {
            background: linear-gradient(135deg, var(--route-secondary) 0%, #475569 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workspace-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .workspace-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-workspace {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--route-transition);
        }

        .btn-workspace:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .workspace-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .empty-workspace {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--route-secondary);
            text-align: center;
        }

        .empty-workspace i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Map View */
        .route-map-view {
            grid-area: map;
            background: white;
            border-radius: var(--route-radius-lg);
            box-shadow: var(--route-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .map-header {
            background: linear-gradient(135deg, var(--route-success) 0%, #047857 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .map-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn-map {
            padding: 0.25rem 0.5rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: white;
            border-radius: 15px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--route-transition);
        }

        .btn-map:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #routeMap {
            flex: 1;
            min-height: 400px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .route-management-container {
                grid-template-areas: 
                    "header header"
                    "sidebar workspace"
                    "map map";
                grid-template-columns: 350px 1fr;
                grid-template-rows: auto 1fr 400px;
            }
        }

        @media (max-width: 768px) {
            .route-management-container {
                grid-template-areas: 
                    "header"
                    "sidebar"
                    "workspace"
                    "map";
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr 300px;
                padding: 0.5rem;
                gap: 0.5rem;
            }

            .route-header {
                padding: 1rem;
            }

            .route-header h1 {
                font-size: 1.2rem;
            }

            .main-navigation {
                flex-direction: column;
                gap: 0.5rem;
            }

            .header-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Loading States */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--route-border);
            border-top: 4px solid var(--route-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            padding: 1rem;
            border-radius: var(--route-radius);
            box-shadow: var(--route-shadow-hover);
            animation: slideIn 0.3s ease;
        }

        .notification-success {
            background: var(--route-success);
            color: white;
        }

        .notification-error {
            background: var(--route-danger);
            color: white;
        }

        .notification-info {
            background: var(--route-info);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="route-management-container">
        <!-- Header -->
        <header class="route-header">
            <h1>
                <i class="fas fa-route"></i>
                Rota Y√∂netimi
            </h1>
            <nav class="main-navigation">
                <a href="poi_manager_enhanced.html">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    POI Y√∂netimi
                </a>
                <a href="route_manager_enhanced.html" class="active">
                    <i class="fas fa-route me-1"></i>
                    Rota Y√∂netimi
                </a>
                <a href="file_import_manager.html">
                    <i class="fas fa-file-import me-1"></i>
                    Dosya Import
                </a>
            </nav>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="showCreateRouteModal()">
                    <i class="fas fa-plus me-1"></i>
                    Yeni Rota
                </button>
                <button class="btn btn-outline-secondary" onclick="refreshRoutes()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Yenile
                </button>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="route-sidebar">
            <div class="sidebar-header">
                <h3>
                    <i class="fas fa-list me-2"></i>
                    Rota Listesi
                </h3>
            </div>

            <!-- Search and Filters -->
            <div class="sidebar-controls">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="routeSearch" 
                           placeholder="Rota ara..." oninput="handleSearch()">
                </div>

                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-filter"></i>
                            Rota T√ºr√º
                        </label>
                        <select class="filter-select" id="typeFilter" onchange="applyFilters()">
                            <option value="">T√ºm T√ºrler</option>
                            <option value="walking">üö∂ Y√ºr√ºy√º≈ü</option>
                            <option value="hiking">ü•æ Doƒüa Y√ºr√ºy√º≈ü√º</option>
                            <option value="cycling">üö¥ Bisiklet</option>
                            <option value="driving">üöó Araba</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-star"></i>
                            Zorluk Seviyesi
                        </label>
                        <select class="filter-select" id="difficultyFilter" onchange="applyFilters()">
                            <option value="">T√ºm Seviyeler</option>
                            <option value="1">‚≠ê √áok Kolay</option>
                            <option value="2">‚≠ê‚≠ê Kolay</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê Orta</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Zor</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê √áok Zor</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-clock"></i>
                            Maksimum S√ºre
                        </label>
                        <select class="filter-select" id="durationFilter" onchange="applyFilters()">
                            <option value="">S√ºre Sƒ±nƒ±rƒ± Yok</option>
                            <option value="30">30 dakika</option>
                            <option value="60">1 saat</option>
                            <option value="120">2 saat</option>
                            <option value="240">4 saat</option>
                            <option value="480">8 saat</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-sort"></i>
                            Sƒ±ralama
                        </label>
                        <select class="filter-select" id="sortFilter" onchange="applyFilters()">
                            <option value="name_asc">ƒ∞sim (A-Z)</option>
                            <option value="name_desc">ƒ∞sim (Z-A)</option>
                            <option value="created_desc">En Yeni</option>
                            <option value="created_asc">En Eski</option>
                            <option value="difficulty_asc">Kolay ‚Üí Zor</option>
                            <option value="difficulty_desc">Zor ‚Üí Kolay</option>
                            <option value="duration_asc">Kƒ±sa ‚Üí Uzun</option>
                            <option value="duration_desc">Uzun ‚Üí Kƒ±sa</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="bulk-actions" id="bulkActions">
                <div class="bulk-actions-header">
                    <span class="bulk-count" id="bulkCount">0 rota se√ßildi</span>
                    <button class="btn-bulk btn-bulk-clear" onclick="clearSelection()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="bulk-buttons">
                    <button class="btn-bulk btn-bulk-export" onclick="exportSelected()">
                        <i class="fas fa-download me-1"></i>
                        Dƒ±≈üa Aktar
                    </button>
                    <button class="btn-bulk btn-bulk-edit" onclick="bulkEdit()">
                        <i class="fas fa-edit me-1"></i>
                        Toplu D√ºzenle
                    </button>
                    <button class="btn-bulk btn-bulk-delete" onclick="deleteSelected()">
                        <i class="fas fa-trash me-1"></i>
                        Sil
                    </button>
                </div>
            </div>

            <!-- Route List -->
            <div class="route-list-container" id="routeListContainer">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </aside>

        <!-- Workspace -->
        <main class="route-workspace">
            <div class="workspace-header">
                <h3 class="workspace-title" id="workspaceTitle">Rota Detaylarƒ±</h3>
                <div class="workspace-actions" id="workspaceActions" style="display: none;">
                    <button class="btn-workspace" onclick="editCurrentRoute()">
                        <i class="fas fa-edit me-1"></i>
                        D√ºzenle
                    </button>
                    <button class="btn-workspace" onclick="duplicateCurrentRoute()">
                        <i class="fas fa-copy me-1"></i>
                        Kopyala
                    </button>
                    <button class="btn-workspace" onclick="exportCurrentRoute()">
                        <i class="fas fa-download me-1"></i>
                        Dƒ±≈üa Aktar
                    </button>
                </div>
            </div>
            <div class="workspace-content" id="workspaceContent">
                <div class="empty-workspace">
                    <i class="fas fa-route"></i>
                    <h4>Rota Se√ßin</h4>
                    <p>Detaylarƒ± g√∂r√ºnt√ºlemek i√ßin sol taraftan bir rota se√ßin</p>
                </div>
            </div>
        </main>

        <!-- Map View -->
        <section class="route-map-view">
            <div class="map-header">
                <h3 class="map-title">
                    <i class="fas fa-map me-2"></i>
                    Harita G√∂r√ºn√ºm√º
                </h3>
                <div class="map-controls">
                    <button class="btn-map" onclick="toggleMapLayer('satellite')">
                        <i class="fas fa-satellite"></i>
                    </button>
                    <button class="btn-map" onclick="toggleMapLayer('terrain')">
                        <i class="fas fa-mountain"></i>
                    </button>
                    <button class="btn-map" onclick="fitMapToRoutes()">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                </div>
            </div>
            <div id="routeMap"></div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>  
    <script src="static/js/api-client.js"></script>
    <script src="static/js/navigation-manager.js"></script>
  <script>
        // Global variables
        const apiBase = '/api';
        let allRoutes = [];
        let filteredRoutes = [];
        let selectedRoutes = new Set();
        let currentRoute = null;
        let map = null;
        let routeLayers = {};
        let poiMarkersLayer = null;
        let searchTimeout = null;
        let associatedPoiIdSet = new Set();
        let associatedPoiOrderedIds = [];
        let csrfToken = null;

        // --- Helpers: ID and parsing ---
        function getRouteId(route) {
            return route?.id ?? route?._id ?? route?.route_id ?? null;
        }

        function getPoiId(poi) {
            return poi?.id ?? poi?._id ?? poi?.poi_id ?? null;
        }

        // Route type configurations
        const ROUTE_TYPES = {
            'walking': { name: 'Y√ºr√ºy√º≈ü', icon: 'üö∂', color: '#059669' },
            'hiking': { name: 'Doƒüa Y√ºr√ºy√º≈ü√º', icon: 'ü•æ', color: '#d97706' },
            'cycling': { name: 'Bisiklet', icon: 'üö¥', color: '#2563eb' },
            'driving': { name: 'Araba', icon: 'üöó', color: '#dc2626' }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadRoutes();
            setupEventListeners();
            // Fetch CSRF token for admin POSTs
            fetch('/auth/csrf-token', { credentials: 'include' })
                .then(r => r.ok ? r.json() : null)
                .then(d => { if (d?.csrf_token) csrfToken = d.csrf_token; })
                .catch(() => {});
        });

        // Fetch and attach geometry for routes if missing
        async function attachGeometriesToRoutes(routes) {
            try {
                const tasks = routes.map(async (r) => {
                    try {
                        const rid = getRouteId(r);
                        if (!rid || r.geometry) return;
                        const res = await fetch(`${apiBase}/routes/${rid}/geometry`, { credentials: 'include' });
                        if (!res.ok) return;
                        const g = await res.json();
                        if (g && g.geometry) {
                            let geo = g.geometry;
                            if (typeof geo === 'string') {
                                try { geo = JSON.parse(geo); } catch(e) { /* ignore */ }
                            }
                            r.geometry = geo || r.geometry;
                            if (g.total_distance != null) r.total_distance = g.total_distance;
                            if (g.estimated_duration != null) r.estimated_duration = g.estimated_duration;
                        }
                    } catch(e) { /* ignore per route */ }
                });
                await Promise.all(tasks);
            } catch (e) {
                console.warn('attachGeometriesToRoutes failed:', e);
            }
        }

        // Initialize Leaflet map
        function initializeMap() {
            console.log('Initializing map...');
            const mapContainer = document.getElementById('routeMap');
            console.log('Map container:', mapContainer, 'Visible:', mapContainer ? mapContainer.offsetHeight : 'N/A');
            
            map = L.map('routeMap').setView([38.7312, 34.4547], 10);
            console.log('Map object created:', map);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            // Layer for POI markers of the selected route
            poiMarkersLayer = L.layerGroup().addTo(map);
            
            // Force map size invalidation after a short delay
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    console.log('Map size invalidated');
                }
            }, 100);

            // Add map click handler
            map.on('click', function(e) {
                // Handle map interactions
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input with debouncing
            document.getElementById('routeSearch').addEventListener('input', handleSearch);
            
            // Filter change handlers
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('difficultyFilter').addEventListener('change', applyFilters);
            document.getElementById('durationFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
        }

        // Load routes from API
        async function loadRoutes() {
            try {
                showLoading();
                const response = await fetch(`${apiBase}/admin/routes`, { credentials: 'include' });
                const data = await response.json();
                
                if (response.ok) {
                    if (Array.isArray(data)) {
                        allRoutes = data;
                    } else if (Array.isArray(data.routes)) {
                        allRoutes = data.routes;
                    } else if (Array.isArray(data.results)) {
                        allRoutes = data.results;
                    } else {
                        // Fallback: try to consolidate values if grouped
                        allRoutes = [];
                        Object.values(data || {}).forEach(val => {
                            if (Array.isArray(val)) allRoutes = allRoutes.concat(val);
                        });
                    }
                    filteredRoutes = [...allRoutes];
                    displayRoutes();
                    await attachGeometriesToRoutes(filteredRoutes);
                    updateMapRoutes();
                } else {
                    throw new Error(data.error || 'Rotalar y√ºklenemedi');
                }
            } catch (error) {
                console.error('Routes load error:', error);
                showError('Rotalar y√ºklenirken hata olu≈ütu: ' + error.message);
            }
        }

        // Display routes in sidebar
        function displayRoutes() {
            const container = document.getElementById('routeListContainer');
            
            if (filteredRoutes.length === 0) {
                container.innerHTML = `
                    <div class="empty-workspace">
                        <i class="fas fa-route"></i>
                        <h5>Rota bulunamadƒ±</h5>
                        <p>Arama kriterlerinizi deƒüi≈ütirin veya yeni rota olu≈üturun</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredRoutes.map(route => {
                const rid = getRouteId(route);
                return `
                <div class="route-item ${selectedRoutes.has(rid) ? 'selected' : ''}" 
                     data-route-id="${rid}" role="button" tabindex="0" onclick="selectRoute(${rid}); return false;">
                    <input type="checkbox" class="route-checkbox" 
                           ${selectedRoutes.has(rid) ? 'checked' : ''}
                           onclick="toggleRouteSelection(event, ${rid}); return false;">
                    
                    <div class="route-item-header">
                        <h4 class="route-item-title">${escapeHtml(route.name)}</h4>
                    </div>
                    
                    <div class="route-type-badge route-type-${route.route_type}">
                        ${ROUTE_TYPES[route.route_type]?.icon || 'üó∫Ô∏è'} 
                        ${ROUTE_TYPES[route.route_type]?.name || route.route_type}
                    </div>
                    
                    <div class="route-description">
                        ${escapeHtml(route.description || 'A√ßƒ±klama bulunmuyor')}
                    </div>
                    
                    <div class="route-stats">
                        <div class="route-stat">
                            <i class="fas fa-clock route-stat-icon"></i>
                            <span>${route.estimated_duration || 0} dk</span>
                        </div>
                        <div class="route-stat">
                            <i class="fas fa-route route-stat-icon"></i>
                            <span>${route.total_distance || 0} km</span>
                        </div>
                        <div class="route-stat">
                            <i class="fas fa-mountain route-stat-icon"></i>
                            <span>${route.elevation_gain || 0} m</span>
                        </div>
                        <div class="route-stat">
                            <i class="fas fa-star route-stat-icon"></i>
                            <span class="difficulty-stars">${getDifficultyStars(route.difficulty_level)}</span>
                        </div>
                    </div>
                    
                    ${route.is_circular ? '<div class="badge bg-info">Dairesel</div>' : ''}
                    ${route.tags ? `<div class="route-tags">${route.tags}</div>` : ''}
                </div>`;
            }).join('');

            updateBulkActions();
        }

        // Handle search with debouncing
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 300);
        }

        // Apply all filters
        async function applyFilters() {
            const searchTerm = document.getElementById('routeSearch').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const difficultyFilter = document.getElementById('difficultyFilter').value;
            const durationFilter = document.getElementById('durationFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            // Filter routes
            filteredRoutes = allRoutes.filter(route => {
                // Search filter
                if (searchTerm && !route.name.toLowerCase().includes(searchTerm) && 
                    !route.description?.toLowerCase().includes(searchTerm) &&
                    !route.tags?.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Type filter
                if (typeFilter && route.route_type !== typeFilter) {
                    return false;
                }

                // Difficulty filter
                if (difficultyFilter && route.difficulty_level != difficultyFilter) {
                    return false;
                }

                // Duration filter
                if (durationFilter && route.estimated_duration > parseInt(durationFilter)) {
                    return false;
                }

                return true;
            });

        // --- Helpers: ID and parsing ---
        function getRouteId(route) {
            return route?.id ?? route?._id ?? route?.route_id ?? null;
        }

        function getPoiId(poi) {
            return poi?.id ?? poi?._id ?? poi?.poi_id ?? null;
        }

            // Sort routes
            filteredRoutes.sort((a, b) => {
                switch (sortFilter) {
                    case 'name_asc':
                        return a.name.localeCompare(b.name);
                    case 'name_desc':
                        return b.name.localeCompare(a.name);
                    case 'created_desc':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'created_asc':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'difficulty_asc':
                        return a.difficulty_level - b.difficulty_level;
                    case 'difficulty_desc':
                        return b.difficulty_level - a.difficulty_level;
                    case 'duration_asc':
                        return (a.estimated_duration || 0) - (b.estimated_duration || 0);
                    case 'duration_desc':
                        return (b.estimated_duration || 0) - (a.estimated_duration || 0);
                    default:
                        return 0;
                }
            });

            displayRoutes();
            await attachGeometriesToRoutes(filteredRoutes);
            updateMapRoutes();
        }

        // Select a route
        function selectRoute(routeId) {
            currentRoute = allRoutes.find(r => getRouteId(r) === routeId);
            if (currentRoute) {
                // Update UI selection
                document.querySelectorAll('.route-item').forEach(item => {
                    item.classList.remove('selected');
                });
                document.querySelector(`[data-route-id="${routeId}"]`).classList.add('selected');

                // Display route details in workspace
                displayRouteDetails(currentRoute);

                // Just highlight the selected route on map; do not alter checkbox selections or redraw all
                try { highlightRouteOnMap(currentRoute); } catch (e) {}
            }
        }

        // Toggle route selection for bulk operations
        function toggleRouteSelection(event, routeId) {
            event.stopPropagation();
            
            if (selectedRoutes.has(routeId)) {
                selectedRoutes.delete(routeId);
            } else {
                selectedRoutes.add(routeId);
            }
            
            updateBulkActions();
            displayRoutes();
            // When checkboxes change, redraw map for selected set
            updateMapRoutes();
        }

        // Update bulk actions visibility and count
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const bulkCount = document.getElementById('bulkCount');
            
            if (selectedRoutes.size > 0) {
                bulkActions.classList.add('show');
                bulkCount.textContent = `${selectedRoutes.size} rota se√ßildi`;
            } else {
                bulkActions.classList.remove('show');
            }
        }

        // Clear selection
        function clearSelection() {
            selectedRoutes.clear();
            updateBulkActions();
            displayRoutes();
        }

        // Display route details in workspace
        function displayRouteDetails(route) {
            const workspaceTitle = document.getElementById('workspaceTitle');
            const workspaceActions = document.getElementById('workspaceActions');
            const workspaceContent = document.getElementById('workspaceContent');

            workspaceTitle.textContent = route.name;
            workspaceActions.style.display = 'flex';

            workspaceContent.innerHTML = `
                <div class="route-detail-view">
                    <div class="route-detail-header">
                        <div class="route-type-badge route-type-${route.route_type}">
                            ${ROUTE_TYPES[route.route_type]?.icon || 'üó∫Ô∏è'} 
                            ${ROUTE_TYPES[route.route_type]?.name || route.route_type}
                        </div>
                        <div class="difficulty-display">
                            <span class="difficulty-stars">${getDifficultyStars(route.difficulty_level)}</span>
                            <span class="difficulty-text">Zorluk: ${route.difficulty_level}/5</span>
                        </div>
                    </div>

                    <div class="route-description-full">
                        <h5><i class="fas fa-info-circle me-2"></i>A√ßƒ±klama</h5>
                        <p>${escapeHtml(route.description || 'A√ßƒ±klama bulunmuyor')}</p>
                    </div>

                    <div class="route-statistics">
                        <h5><i class="fas fa-chart-bar me-2"></i>ƒ∞statistikler</h5>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${route.estimated_duration || 0}</div>
                                    <div class="stat-label">Dakika</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${route.total_distance || 0}</div>
                                    <div class="stat-label">Kilometre</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-mountain"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${route.elevation_gain || 0}</div>
                                    <div class="stat-label">Y√ºkselti (m)</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${route.poi_count || 0}</div>
                                    <div class="stat-label">POI Sayƒ±sƒ±</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${route.tags ? `
                        <div class="route-tags-section">
                            <h5><i class="fas fa-tags me-2"></i>Etiketler</h5>
                            <div class="tags-container">
                                ${route.tags.split(',').map(tag => 
                                    `<span class="tag-chip">${escapeHtml(tag.trim())}</span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="route-metadata">
                        <h5><i class="fas fa-info me-2"></i>Metadata</h5>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <strong>Olu≈üturulma:</strong>
                                <span>${formatDate(route.created_at)}</span>
                            </div>
                            <div class="metadata-item">
                                <strong>G√ºncellenme:</strong>
                                <span>${formatDate(route.updated_at)}</span>
                            </div>
                            <div class="metadata-item">
                                <strong>Dairesel Rota:</strong>
                                <span>${route.is_circular ? 'Evet' : 'Hayƒ±r'}</span>
                            </div>
                            ${route.import_source ? `
                                <div class="metadata-item">
                                    <strong>Import Kaynaƒüƒ±:</strong>
                                    <span>${escapeHtml(route.import_source)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Add CSS for route detail view
            addRouteDetailStyles();
        }

        // Add styles for route detail view
        function addRouteDetailStyles() {
            if (document.getElementById('routeDetailStyles')) return;

            const style = document.createElement('style');
            style.id = 'routeDetailStyles';
            style.textContent = `
                .route-detail-view {
                    padding: 0;
                }

                .route-detail-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 1.5rem;
                    padding-bottom: 1rem;
                    border-bottom: 2px solid var(--route-border);
                }

                .difficulty-display {
                    text-align: right;
                }

                .difficulty-text {
                    display: block;
                    font-size: 0.85rem;
                    color: var(--route-secondary);
                    margin-top: 0.25rem;
                }

                .route-description-full {
                    margin-bottom: 1.5rem;
                }

                .route-description-full h5 {
                    color: var(--route-dark);
                    margin-bottom: 0.75rem;
                }

                .route-description-full p {
                    color: var(--route-secondary);
                    line-height: 1.6;
                }

                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 1rem;
                    margin-bottom: 1.5rem;
                }

                .stat-card {
                    background: var(--route-light);
                    border-radius: var(--route-radius);
                    padding: 1rem;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    border: 2px solid var(--route-border);
                    transition: var(--route-transition);
                }

                .stat-card:hover {
                    border-color: var(--route-primary);
                    transform: translateY(-2px);
                }

                .stat-icon {
                    width: 40px;
                    height: 40px;
                    background: var(--route-primary);
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.1rem;
                }

                .stat-value {
                    font-size: 1.25rem;
                    font-weight: 700;
                    color: var(--route-dark);
                }

                .stat-label {
                    font-size: 0.8rem;
                    color: var(--route-secondary);
                }

                .route-tags-section {
                    margin-bottom: 1.5rem;
                }

                .route-tags-section h5 {
                    color: var(--route-dark);
                    margin-bottom: 0.75rem;
                }

                .tags-container {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.5rem;
                }

                .tag-chip {
                    background: var(--route-primary);
                    color: white;
                    padding: 0.25rem 0.75rem;
                    border-radius: 15px;
                    font-size: 0.8rem;
                    font-weight: 500;
                }

                .route-metadata h5 {
                    color: var(--route-dark);
                    margin-bottom: 0.75rem;
                }

                .metadata-grid {
                    display: grid;
                    gap: 0.5rem;
                }

                .metadata-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 0.5rem;
                    background: var(--route-light);
                    border-radius: var(--route-radius);
                    border: 1px solid var(--route-border);
                }

                .metadata-item strong {
                    color: var(--route-dark);
                }

                .metadata-item span {
                    color: var(--route-secondary);
                }
            `;
            document.head.appendChild(style);
        }

        // Update map with filtered routes
        async function updateMapRoutes() {
            console.log('=== updateMapRoutes called ===');
            console.log('filteredRoutes count:', filteredRoutes.length);
            console.log('map object:', map);
            console.log('routeLayers before clear:', Object.keys(routeLayers));
            
            // Clear existing route layers
            Object.values(routeLayers).forEach(layer => {
                map.removeLayer(layer);
            });
            routeLayers = {};
            console.log('Route layers cleared');

            // Determine which routes to draw (reverted to drawing all filtered routes)
            const drawingRoutes = filteredRoutes;
            console.log('Drawing filteredRoutes:', drawingRoutes.map(r => getRouteId(r)));

            // Add chosen routes to map
            for (const route of drawingRoutes) {
                console.log('Processing route:', route.name, 'ID:', getRouteId(route));
                const color = ROUTE_TYPES[route.route_type]?.color || '#2563eb';
                let layer = null;
                try {
                    if (route.geometry) {
                        let geo = route.geometry;
                        console.log('Original geometry for route', route.name, ':', geo);
                        if (typeof geo === 'string') {
                            try { geo = JSON.parse(geo); } catch (e) { console.warn('geometry not JSON string:', e); }
                        }
                        console.log('Parsed geometry:', geo);
                        if (geo && typeof geo === 'object' && !Array.isArray(geo) && geo.type && geo.coordinates) {
                            // Valid GeoJSON object
                            console.log('Attempting L.geoJSON with valid GeoJSON:', geo);
                            layer = L.geoJSON(geo, { style: { color, weight: 3, opacity: 0.7 } });
                        } else if (Array.isArray(geo)) {
                            // Assume array of [lng, lat] or [lat, lng]
                            const latlngs = geo.map(p => {
                                if (Array.isArray(p)) {
                                    const a = Number(p[0]);
                                    const b = Number(p[1]);
                                    if (!isNaN(a) && !isNaN(b)) {
                                        if (a >= -180 && a <= 180 && b >= -90 && b <= 90) {
                                            return [b, a];
                                        }
                                        return [a, b];
                                    }
                                }
                                return [p.lat || p.latitude, p.lng || p.longitude];
                            });
                            layer = L.polyline(latlngs, { color, weight: 3, opacity: 0.7 });
                        }
                    } else {
                        console.log('No geometry found for route:', route.name, 'trying POI fallback directly...');
                        // Try POI fallback immediately for routes without geometry
                        const rid = getRouteId(route);
                        if (rid) {
                            try {
                                const rd = await fetch(`${apiBase}/admin/routes/${rid}`, { credentials: 'include' });
                                if (rd.ok) {
                                    const rj = await rd.json();
                                    console.log('Direct POI route detail response:', rj);
                                    const pois = Array.isArray(rj?.pois) ? rj.pois : [];
                                    console.log('Direct POI found for route:', pois.length);
                                    if (pois.length >= 2) {
                                        const latlngs = pois
                                            .sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0))
                                            .map(p => [Number(p.lat || p.latitude), Number(p.lon || p.longitude)])
                                            .filter(arr => Number.isFinite(arr[0]) && Number.isFinite(arr[1]));
                                        console.log('Direct POI valid coordinates:', latlngs);
                                        if (latlngs.length >= 2) {
                                            // Use smart routing API to get real road network route
                                            try {
                                                const waypoints = pois
                                                    .sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0))
                                                    .map(p => ({
                                                        lat: Number(p.lat || p.latitude),
                                                        lng: Number(p.lon || p.longitude),
                                                        name: p.name
                                                    }))
                                                    .filter(wp => Number.isFinite(wp.lat) && Number.isFinite(wp.lng));
                                                    
                                                console.log('Creating smart route with waypoints:', waypoints);
                                                
                                                const routeResponse = await fetch('/api/route/smart', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    credentials: 'include',
                                                    body: JSON.stringify({ waypoints })
                                                });
                                                
                                                if (routeResponse.ok) {
                                    const routeData = await routeResponse.json();
                                    console.log('Smart route response:', routeData);
                                    console.log('Route data structure:', Object.keys(routeData));
                                    console.log('Route.route structure:', routeData.route ? Object.keys(routeData.route) : 'no route key');
                                    
                                    // Check ALL possible response structures
                                    let allCoords = [];
                                    
                                    // Prefer route.segments[].coordinates [{lat,lng}, ...]
                                    if (routeData.route && Array.isArray(routeData.route.segments) && routeData.route.segments.length > 0) {
                                        routeData.route.segments.forEach(seg => {
                                            if (Array.isArray(seg?.coordinates) && seg.coordinates.length > 0) {
                                                seg.coordinates.forEach(pt => {
                                                    const lat = Number(pt.lat);
                                                    const lng = Number(pt.lng);
                                                    if (Number.isFinite(lat) && Number.isFinite(lng)) allCoords.push([lat, lng]);
                                                });
                                            }
                                        });
                                        console.log('Using route.segments.coordinates:', allCoords.length);
                                    } else if (routeData.route && routeData.route.geometry && Array.isArray(routeData.route.geometry)) {
                                        allCoords = routeData.route.geometry;
                                        console.log('Using route.geometry:', allCoords.length);
                                    } else if (routeData.route && routeData.route.coordinates && Array.isArray(routeData.route.coordinates)) {
                                        allCoords = routeData.route.coordinates;
                                        console.log('Using route.coordinates:', allCoords.length);
                                    } else if (routeData.segments && Array.isArray(routeData.segments)) {
                                        routeData.segments.forEach(segment => {
                                            if (Array.isArray(segment)) allCoords.push(...segment);
                                        });
                                        console.log('Using segments:', allCoords.length);
                                    } else if (routeData.route && routeData.route.segments && Array.isArray(routeData.route.segments)) {
                                        routeData.route.segments.forEach(segment => {
                                            if (Array.isArray(segment)) allCoords.push(...segment);
                                        });
                                        console.log('Using route.segments (array arrays):', allCoords.length);
                                    } else {
                                        console.log('No recognized route format found, trying fallback to waypoints');
                                        // Fallback: use original waypoints
                                        allCoords = waypoints.map(wp => [wp.lat, wp.lng]);
                                    }
                                    
                                    if (allCoords.length >= 2) {
                                        layer = L.polyline(allCoords, { color, weight: 4, opacity: 0.8 });
                                        layer.bindPopup(`
                                            <strong>${escapeHtml(route.name)}</strong><br>
                                            ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                            ${Math.round(routeData.total_distance || 0)} km<br>
                                            ${Math.round(routeData.estimated_time || 0)} dakika<br>
                                            <small>Yol aƒüƒ±ndan hesaplandƒ±</small>
                                        `);
                                        routeLayers[rid] = layer;
                                        layer.addTo(map);
                                        console.log('Smart route added for:', route.name);
                                    }
                                } else {
                                    throw new Error('Smart route API failed');
                                }
                                            } catch (smartRouteError) {
                                                console.warn('Smart route failed, falling back to simple polyline:', smartRouteError);
                                                // Fallback to simple polyline
                                                layer = L.polyline(latlngs, { color, weight: 4, opacity: 0.8 });
                                                layer.bindPopup(`
                                                    <strong>${escapeHtml(route.name)}</strong><br>
                                                    ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                                    ${route.estimated_duration || 0} dakika<br>
                                                    <small>D√ºz √ßizgi (yol aƒüƒ± bulunamadƒ±)</small>
                                                `);
                                                routeLayers[rid] = layer;
                                                layer.addTo(map);
                                                console.log('Fallback polyline added for route:', route.name);
                                            }
                                        }
                                    }
                                }
                            } catch (e) {
                                console.warn('Direct POI fallback failed:', e);
                            }
                        }
                        
                        // Original geometry fetch fallback
                        // Try lazy fetch of geometry and retry once
                        try {
                            const rid = getRouteId(route);
                            if (rid) {
                                console.log('Fetching geometry for route ID:', rid);
                                const res = await fetch(`${apiBase}/routes/${rid}/geometry`, { credentials: 'include' });
                                if (res.ok) {
                                    const g = await res.json();
                                    console.log('Geometry response:', g);
                                    if (g && g.geometry) {
                                        let geo = g.geometry;
                                        if (typeof geo === 'string') {
                                            try { geo = JSON.parse(geo); } catch(e) {}
                                        }
                                        route.geometry = geo;
                                        // Retry build
                                        if (geo && typeof geo === 'object') {
                                            layer = L.geoJSON(geo, { style: { color, weight: 3, opacity: 0.7 } });
                                        }
                                        if (layer) {
                                            layer.bindPopup(`
                                                <strong>${escapeHtml(route.name)}</strong><br>
                                                ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                                ${route.estimated_duration || 0} dakika
                                            `);
                                            const rid2 = getRouteId(route);
                                            routeLayers[rid2] = layer;
                                            layer.addTo(map);
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('Lazy geometry fetch failed:', e);
                        }
                    }
                } catch (error) {
                    console.warn('Route geometry parse error:', error);
                    console.log('ERROR CAUGHT! Now trying POI fallback for route:', route.name);
                    const rid = getRouteId(route);
                    console.log('Route ID for POI fallback:', rid);
                    if (rid) {
                        console.log('Geometry failed, trying POI fallback for route:', route.name);
                        try {
                            const rd = await fetch(`${apiBase}/admin/routes/${rid}`, { credentials: 'include' });
                            if (rd.ok) {
                                const rj = await rd.json();
                                console.log('Route detail response:', rj);
                                const pois = Array.isArray(rj?.pois) ? rj.pois : [];
                                console.log('Found POIs for route:', pois.length);
                                if (pois.length >= 2) {
                                    const latlngs = pois
                                        .sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0))
                                        .map(p => [Number(p.lat || p.latitude), Number(p.lon || p.longitude)])
                                        .filter(arr => Number.isFinite(arr[0]) && Number.isFinite(arr[1]));
                                    console.log('Valid coordinates:', latlngs);
                                    if (latlngs.length >= 2) {
                                        // Smart routing for error fallback
                                        try {
                                            const waypoints = pois
                                                .sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0))
                                                .map(p => ({
                                                    lat: Number(p.lat || p.latitude),
                                                    lng: Number(p.lon || p.longitude),
                                                    name: p.name
                                                }))
                                                .filter(wp => Number.isFinite(wp.lat) && Number.isFinite(wp.lng));
                                                
                                            const routeResponse = await fetch('/api/route/smart', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                credentials: 'include',
                                                body: JSON.stringify({ waypoints })
                                            });
                                            
                                            if (routeResponse.ok) {
                                                const routeData = await routeResponse.json();
                                                if (routeData.route && Array.isArray(routeData.route.segments)) {
                                                    const coords = [];
                                                    routeData.route.segments.forEach(seg => {
                                                        if (Array.isArray(seg?.coordinates)) {
                                                            seg.coordinates.forEach(pt => {
                                                                const lat = Number(pt.lat);
                                                                const lng = Number(pt.lng);
                                                                if (Number.isFinite(lat) && Number.isFinite(lng)) coords.push([lat, lng]);
                                                            });
                                                        }
                                                    });
                                                    if (coords.length >= 2) {
                                                        layer = L.polyline(coords, { color, weight: 4, opacity: 0.8 });
                                                        layer.bindPopup(`
                                                            <strong>${escapeHtml(route.name)}</strong><br>
                                                            ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                                            <small>Yol aƒüƒ±ndan hesaplandƒ±</small>
                                                        `);
                                                        routeLayers[rid] = layer;
                                                        layer.addTo(map);
                                                        console.log('Smart route added from error fallback:', route.name);
                                                    }
                                                }
                                            } else {
                                                throw new Error('Smart route failed');
                                            }
                                        } catch (smartError) {
                                            console.warn('Smart routing failed in error fallback, using simple polyline:', smartError);
                                            layer = L.polyline(latlngs, { color, weight: 4, opacity: 0.8 });
                                            layer.bindPopup(`
                                                <strong>${escapeHtml(route.name)}</strong><br>
                                                ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                                ${route.estimated_duration || 0} dakika<br>
                                                <small>D√ºz √ßizgi (yol aƒüƒ± bulunamadƒ±)</small>
                                            `);
                                            routeLayers[rid] = layer;
                                            layer.addTo(map);
                                            console.log('Final fallback polyline for route:', route.name);
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('POI fallback failed:', e);
                        }
                    }
                }
            }

            // Fit map to show all drawn routes
            console.log('Total route layers added:', Object.keys(routeLayers).length);
            if (Object.keys(routeLayers).length > 0) {
                const group = new L.featureGroup(Object.values(routeLayers));
                map.fitBounds(group.getBounds(), { padding: [20, 20] });
                console.log('Map fitted to route bounds');
            } else {
                console.log('No route layers to display, invalidating map size');
                setTimeout(() => { try { map.invalidateSize(); } catch(e) {} }, 100);
            }
        }

        // Highlight specific route on map
        function highlightRouteOnMap(route) {
            // Reset all route styles
            Object.entries(routeLayers).forEach(([id, layer]) => {
                const routeData = allRoutes.find(r => String(getRouteId(r)) == String(id));
                layer.setStyle({
                    color: ROUTE_TYPES[routeData?.route_type]?.color || '#2563eb',
                    weight: 3,
                    opacity: 0.7
                });
            });

            // Highlight selected route
            const rid = getRouteId(route);
            if (!routeLayers[rid]) {
                // Create layer on demand if missing
                const prevFiltered = filteredRoutes;
                filteredRoutes = [route];
                updateMapRoutes();
                filteredRoutes = prevFiltered;
            }
            if (routeLayers[rid]) {
                // Hide other routes from map for focused view
                Object.entries(routeLayers).forEach(([otherId, layer]) => {
                    if (String(otherId) !== String(rid)) {
                        try { map.removeLayer(layer); } catch (e) {}
                    }
                });

                // Emphasize selected route
                try { routeLayers[rid].setStyle({ color: '#dc2626', weight: 5, opacity: 1 }); } catch (e) {}
                // Ensure layer is on map
                if (!map.hasLayer(routeLayers[rid])) {
                    try { routeLayers[rid].addTo(map); } catch (e) {}
                }

                // Render associated POIs as markers
                renderRoutePoisOnMap(rid).then(() => {
                    try {
                        const group = new L.featureGroup([routeLayers[rid], poiMarkersLayer]);
                        map.fitBounds(group.getBounds(), { padding: [50, 50] });
                    } catch (e) {
                        map.fitBounds(routeLayers[rid].getBounds(), { padding: [50, 50] });
                    }
                });
            }
        }

        // Render POI markers for a route on the map
        async function renderRoutePoisOnMap(routeId) {
            if (!poiMarkersLayer) return;
            try { poiMarkersLayer.clearLayers(); } catch (e) {}

            try {
                const resp = await fetch(`${apiBase}/admin/routes/${routeId}/pois`, { credentials: 'include' });
                if (!resp.ok) return;
                const data = await resp.json();
                const pois = Array.isArray(data?.pois) ? data.pois : (Array.isArray(data) ? data : []);
                // Sort by order_in_route if available
                pois.sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0));
                pois.forEach((p, idx) => {
                    const lat = Number(p.lat || p.latitude);
                    const lng = Number(p.lon || p.longitude);
                    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
                    const marker = L.marker([lat, lng], {
                        title: p.name || `POI ${idx + 1}`
                    });
                    marker.bindPopup(`
                        <strong>${escapeHtml(p.name || 'POI')}</strong><br/>
                        ${p.category ? escapeHtml(p.category) : ''}<br/>
                        <small>Sƒ±ra: ${p.order_in_route || idx + 1}</small>
                    `);
                    poiMarkersLayer.addLayer(marker);
                });
            } catch (e) {
                console.warn('renderRoutePoisOnMap failed:', e);
            }
        }

        // Utility functions
        function getDifficultyStars(level) {
            return '‚≠ê'.repeat(level || 0) + '‚òÜ'.repeat(5 - (level || 0));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Bilinmiyor';
            return new Date(dateString).toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading() {
            document.getElementById('routeListContainer').innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            `;
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>${message}</span>
                    <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Action handlers
        function refreshRoutes() {
            loadRoutes();
        }

        function showCreateRouteModal() {
            // TODO: Implement create route modal
            showNotification('Rota olu≈üturma √∂zelliƒüi yakƒ±nda eklenecek', 'info');
        }

        function editCurrentRoute() {
            if (currentRoute) {
                displayRouteEditForm(currentRoute);
            }
        }

        // Display route editing form in workspace
        function displayRouteEditForm(route) {
            const workspaceTitle = document.getElementById('workspaceTitle');
            const workspaceActions = document.getElementById('workspaceActions');
            const workspaceContent = document.getElementById('workspaceContent');

            workspaceTitle.textContent = `${route.name} - D√ºzenleme`;
            workspaceActions.innerHTML = `
                <button class="btn-workspace" onclick="saveRouteChanges()">
                    <i class="fas fa-save me-1"></i>
                    Kaydet
                </button>
                <button class="btn-workspace" onclick="cancelRouteEdit()">
                    <i class="fas fa-times me-1"></i>
                    ƒ∞ptal
                </button>
            `;

            workspaceContent.innerHTML = `
                <div class="route-edit-form">
                    <form id="routeEditForm">
                        <div class="form-section">
                            <h5><i class="fas fa-info-circle me-2"></i>Temel Bilgiler</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editRouteName">Rota Adƒ± *</label>
                                    <input type="text" id="editRouteName" class="form-control" 
                                           value="${escapeHtml(route.name)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editRouteType">Rota T√ºr√º *</label>
                                    <select id="editRouteType" class="form-control" required>
                                        <option value="walking" ${route.route_type === 'walking' ? 'selected' : ''}>üö∂ Y√ºr√ºy√º≈ü</option>
                                        <option value="hiking" ${route.route_type === 'hiking' ? 'selected' : ''}>ü•æ Doƒüa Y√ºr√ºy√º≈ü√º</option>
                                        <option value="cycling" ${route.route_type === 'cycling' ? 'selected' : ''}>üö¥ Bisiklet</option>
                                        <option value="driving" ${route.route_type === 'driving' ? 'selected' : ''}>üöó Araba</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="editRouteDescription">A√ßƒ±klama</label>
                                <textarea id="editRouteDescription" class="form-control" rows="3">${escapeHtml(route.description || '')}</textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h5><i class="fas fa-chart-bar me-2"></i>Rota √ñzellikleri</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editDifficulty">Zorluk Seviyesi</label>
                                    <select id="editDifficulty" class="form-control">
                                        <option value="1" ${route.difficulty_level === 1 ? 'selected' : ''}>‚≠ê √áok Kolay</option>
                                        <option value="2" ${route.difficulty_level === 2 ? 'selected' : ''}>‚≠ê‚≠ê Kolay</option>
                                        <option value="3" ${route.difficulty_level === 3 ? 'selected' : ''}>‚≠ê‚≠ê‚≠ê Orta</option>
                                        <option value="4" ${route.difficulty_level === 4 ? 'selected' : ''}>‚≠ê‚≠ê‚≠ê‚≠ê Zor</option>
                                        <option value="5" ${route.difficulty_level === 5 ? 'selected' : ''}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê √áok Zor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editDuration">Tahmini S√ºre (dakika)</label>
                                    <input type="number" id="editDuration" class="form-control" 
                                           value="${route.estimated_duration || ''}" min="1">
                                </div>
                                <div class="form-group">
                                    <label for="editDistance">Mesafe (km)</label>
                                    <input type="number" id="editDistance" class="form-control" 
                                           value="${route.total_distance || ''}" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="editElevation">Y√ºkselti Kazancƒ± (m)</label>
                                    <input type="number" id="editElevation" class="form-control" 
                                           value="${route.elevation_gain || ''}" min="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="editTags">Etiketler (virg√ºlle ayƒ±rƒ±n)</label>
                                <input type="text" id="editTags" class="form-control" 
                                       value="${escapeHtml(route.tags || '')}" 
                                       placeholder="tarihi, doƒüa, macera">
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="editIsCircular" class="form-check-input" 
                                           ${route.is_circular ? 'checked' : ''}>
                                    <label for="editIsCircular" class="form-check-label">
                                        Dairesel Rota (Ba≈ülangƒ±√ß = Biti≈ü)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h5><i class="fas fa-map-marker-alt me-2"></i>POI ƒ∞li≈ükilendirme</h5>
                            <div class="poi-association-container">
                <div class="poi-search-section" onsubmit="return false;">
                                    <div class="search-container">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="poiSearchInput" 
                                               placeholder="POI ara..." oninput="searchPOIs()">
                                    </div>
                                    <button type="button" class="btn btn-outline-primary" onclick="suggestNearbyPOIs()">
                                        <i class="fas fa-magic me-1"></i>
                                        Yakƒ±n POI'leri √ñner
                                    </button>
                                </div>
                                
                                <div class="poi-lists-container">
                                    <div class="available-pois">
                                        <h6>Mevcut POI'ler</h6>
                                        <div id="availablePOIsList" class="poi-list">
                                            <div class="loading-spinner">
                                                <div class="spinner"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="associated-pois">
                                        <h6>ƒ∞li≈ükilendirilmi≈ü POI'ler</h6>
                                        <div id="associatedPOIsList" class="poi-list">
                                            <!-- Associated POIs will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h5><i class="fas fa-download me-2"></i>Dƒ±≈üa Aktarma Se√ßenekleri</h5>
                            <div class="export-options">
                                <button type="button" class="btn btn-outline-info" onclick="exportRouteAsGPX(${route.id})">
                                    <i class="fas fa-file-code me-1"></i>
                                    GPX Olarak ƒ∞ndir
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="exportRouteAsKML(${route.id})">
                                    <i class="fas fa-globe me-1"></i>
                                    KML Olarak ƒ∞ndir
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="exportRouteAsJSON(${route.id})">
                                    <i class="fas fa-code me-1"></i>
                                    JSON Olarak ƒ∞ndir
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="printRouteDetails(${route.id})">
                                    <i class="fas fa-print me-1"></i>
                                    Yazdƒ±r
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            `;

            // Add CSS for edit form
            addRouteEditFormStyles();
            
            // Load POIs for association
            loadPOIsForAssociation(route.id);
        }

        // Add styles for route edit form
        function addRouteEditFormStyles() {
            if (document.getElementById('routeEditFormStyles')) return;

            const style = document.createElement('style');
            style.id = 'routeEditFormStyles';
            style.textContent = `
                .route-edit-form {
                    padding: 0;
                }

                .form-section {
                    margin-bottom: 2rem;
                    padding-bottom: 1.5rem;
                    border-bottom: 2px solid var(--route-border);
                }

                .form-section:last-child {
                    border-bottom: none;
                }

                .form-section h5 {
                    color: var(--route-dark);
                    margin-bottom: 1rem;
                    font-weight: 600;
                }

                .form-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 1rem;
                    margin-bottom: 1rem;
                }

                .form-group {
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .form-group label {
                    font-weight: 600;
                    color: var(--route-dark);
                    font-size: 0.9rem;
                }

                .form-control {
                    padding: 0.75rem;
                    border: 2px solid var(--route-border);
                    border-radius: var(--route-radius);
                    font-size: 0.9rem;
                    transition: var(--route-transition);
                }

                .form-control:focus {
                    outline: none;
                    border-color: var(--route-primary);
                    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
                }

                .form-check {
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    margin-top: 0.5rem;
                }

                .form-check-input {
                    width: 18px;
                    height: 18px;
                }

                .poi-association-container {
                    background: var(--route-light);
                    border-radius: var(--route-radius);
                    padding: 1rem;
                    border: 2px solid var(--route-border);
                }

                .poi-search-section {
                    display: flex;
                    gap: 1rem;
                    align-items: center;
                    margin-bottom: 1rem;
                }

                .poi-search-section .search-container {
                    flex: 1;
                }

                .poi-lists-container {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 1rem;
                }

                .available-pois, .associated-pois {
                    background: white;
                    border-radius: var(--route-radius);
                    padding: 1rem;
                    border: 2px solid var(--route-border);
                }

                .available-pois h6, .associated-pois h6 {
                    margin-bottom: 0.75rem;
                    color: var(--route-dark);
                    font-weight: 600;
                }

                .poi-list {
                    max-height: 200px;
                    overflow-y: auto;
                }

                .poi-item-small {
                    background: var(--route-light);
                    border: 1px solid var(--route-border);
                    border-radius: var(--route-radius);
                    padding: 0.75rem;
                    margin-bottom: 0.5rem;
                    cursor: pointer;
                    transition: var(--route-transition);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .poi-item-small:hover {
                    border-color: var(--route-primary);
                    background: white;
                }

                .poi-item-info {
                    flex: 1;
                }

                .poi-item-name {
                    font-weight: 600;
                    color: var(--route-dark);
                    font-size: 0.9rem;
                }

                .poi-item-category {
                    font-size: 0.8rem;
                    color: var(--route-secondary);
                }

                .poi-item-actions {
                    display: flex;
                    gap: 0.25rem;
                }

                .btn-poi-action {
                    padding: 0.25rem 0.5rem;
                    border: none;
                    border-radius: 15px;
                    font-size: 0.75rem;
                    cursor: pointer;
                    transition: var(--route-transition);
                }

                .btn-add-poi {
                    background: var(--route-success);
                    color: white;
                }

                .btn-remove-poi {
                    background: var(--route-danger);
                    color: white;
                }

                .export-options {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.75rem;
                }

                .export-options .btn {
                    padding: 0.5rem 1rem;
                    border-radius: 20px;
                    font-size: 0.85rem;
                    font-weight: 500;
                }

                @media (max-width: 768px) {
                    .form-grid {
                        grid-template-columns: 1fr;
                    }

                    .poi-lists-container {
                        grid-template-columns: 1fr;
                    }

                    .poi-search-section {
                        flex-direction: column;
                        align-items: stretch;
                    }

                    .export-options {
                        flex-direction: column;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // Load POIs for association
        async function loadPOIsForAssociation(routeId) {
            try {
                // Load all POIs
                const poisResponse = await fetch(`${apiBase}/pois`, { credentials: 'include' });
                let poisData = { pois: [] };
                if (poisResponse.ok) {
                    const raw = await poisResponse.json();
                    if (Array.isArray(raw)) {
                        poisData = { pois: raw };
                    } else if (Array.isArray(raw.pois)) {
                        poisData = { pois: raw.pois };
                    } else if (Array.isArray(raw.results)) {
                        poisData = { pois: raw.results };
                    } else {
                        let arr = [];
                        Object.values(raw || {}).forEach(v => { if (Array.isArray(v)) arr = arr.concat(v); });
                        poisData = { pois: arr };
                    }
                }
                
                // Load route detail with associated POIs (more reliable)
                const routeDetailResp = await fetch(`${apiBase}/admin/routes/${routeId}`, { credentials: 'include' });
                let associationsData = { pois: [] };
                if (routeDetailResp.ok) {
                    const routeDetail = await routeDetailResp.json();
                    if (Array.isArray(routeDetail?.pois)) {
                        associationsData = { pois: routeDetail.pois };
                    }
                }
                
                if (poisResponse.ok && routeDetailResp.ok) {
                    const allPOIs = poisData.pois || [];
                    // Normalize associated POIs ‚Üí ordered id list and membership set
                    const assocList = (associationsData.pois || []).slice();
                    assocList.sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0));
                    associatedPoiOrderedIds = assocList
                        .map(p => getPoiId(p) || (p.poi ? getPoiId(p.poi) : null))
                        .filter(id => id != null);
                    associatedPoiIdSet = new Set(associatedPoiOrderedIds);
                    const associatedPOIIds = new Set(associatedPoiOrderedIds);
                    
                    displayAvailablePOIs(allPOIs.filter(poi => !associatedPOIIds.has(getPoiId(poi))));
                    displayAssociatedPOIs(allPOIs.filter(poi => associatedPOIIds.has(getPoiId(poi))));
                }
            } catch (error) {
                console.error('Error loading POIs:', error);
                showError("POI'ler y√ºklenirken hata olu≈ütu");
            }
        }

        // Display available POIs
        function displayAvailablePOIs(pois) {
            const container = document.getElementById('availablePOIsList');
            
            if (pois.length === 0) {
                container.innerHTML = '<p class="text-muted">ƒ∞li≈ükilendirilecek POI bulunamadƒ±</p>';
                return;
            }

            container.innerHTML = pois.map(poi => `
                <div class="poi-item-small">
                    <div class="poi-item-info">
                        <div class="poi-item-name">${escapeHtml(poi.name)}</div>
                        <div class="poi-item-category">${escapeHtml(poi.category || 'Kategori yok')}</div>
                    </div>
                    <div class="poi-item-actions">
                        <button type="button" class="btn-poi-action btn-add-poi" onclick="associatePOI(${getPoiId(poi)})">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Display associated POIs
        function displayAssociatedPOIs(pois) {
            const container = document.getElementById('associatedPOIsList');
            
            if (pois.length === 0) {
                container.innerHTML = '<p class="text-muted">ƒ∞li≈ükilendirilmi≈ü POI bulunmuyor</p>';
                return;
            }

            container.innerHTML = pois.map((poi, idx) => `
                <div class="poi-item-small">
                    <div class="poi-item-info">
                        <div class="poi-item-name">${escapeHtml(poi.name)}</div>
                        <div class="poi-item-category">${escapeHtml(poi.category || 'Kategori yok')}</div>
                    </div>
                    <div class="poi-item-actions">
                        <button type="button" class="btn-poi-action btn-remove-poi" onclick="disassociatePOI(${getPoiId(poi)})">
                            <i class="fas fa-times"></i>
                        </button>
                        ${idx > 0 ? `<button type="button" class="btn-poi-action" title="Yukarƒ±" onclick="reorderAssociatedPOI(${getPoiId(poi)}, -1)"><i class="fas fa-arrow-up"></i></button>` : ''}
                        ${idx < pois.length - 1 ? `<button type="button" class="btn-poi-action" title="A≈üaƒüƒ±" onclick="reorderAssociatedPOI(${getPoiId(poi)}, 1)"><i class="fas fa-arrow-down"></i></button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Search POIs
        function searchPOIs() {
            const searchTerm = document.getElementById('poiSearchInput').value.toLowerCase();
            const availableItems = document.querySelectorAll('#availablePOIsList .poi-item-small');
            const associatedItems = document.querySelectorAll('#associatedPOIsList .poi-item-small');
            
            [...availableItems, ...associatedItems].forEach(item => {
                const name = item.querySelector('.poi-item-name').textContent.toLowerCase();
                const category = item.querySelector('.poi-item-category').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || category.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Associate POI with route
        async function associatePOI(poiId) {
            if (!currentRoute) return;
            
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;
                // Add to current set and send full set to backend to avoid clearing issue
                const idInt = parseInt(poiId);
                if (!Number.isFinite(idInt)) return;
                // Preserve order reliably using associatedPoiOrderedIds (list)
                if (!associatedPoiIdSet.has(idInt)) {
                    associatedPoiOrderedIds.push(idInt);
                    associatedPoiIdSet.add(idInt);
                }
                const payloadPois = associatedPoiOrderedIds.map((id, idx) => ({ poi_id: id, order_in_route: idx + 1 }));
                const response = await fetch(`${apiBase}/admin/routes/${currentRoute.id}/pois`, {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify({ csrf_token: csrfToken || '', pois: payloadPois })
                });
                
                if (response.ok) {
                    showNotification('POI ba≈üarƒ±yla ili≈ükilendirildi', 'success');
                    loadPOIsForAssociation(currentRoute.id);
                    // Auto-update route visualization
                    await updateRouteVisualization(currentRoute.id);
                } else {
                    throw new Error('POI ili≈ükilendirilemedi');
                }
            } catch (error) {
                console.error('POI association error:', error);
                showError('POI ili≈ükilendirilirken hata olu≈ütu');
            }
        }

        // Disassociate POI from route
        async function disassociatePOI(poiId) {
            if (!currentRoute) return;
            
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;
                const idInt = parseInt(poiId);
                if (!Number.isFinite(idInt)) return;
                // Remove from both ordered list and set
                associatedPoiOrderedIds = associatedPoiOrderedIds.filter(id => id !== idInt);
                associatedPoiIdSet.delete(idInt);
                const payloadPois = associatedPoiOrderedIds.map((id, idx) => ({ poi_id: id, order_in_route: idx + 1 }));
                const response = await fetch(`${apiBase}/admin/routes/${currentRoute.id}/pois`, {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify({ csrf_token: csrfToken || '', pois: payloadPois })
                });
                
                if (response.ok) {
                    showNotification('POI ba≈üarƒ±yla kaldƒ±rƒ±ldƒ±', 'success');
                    loadPOIsForAssociation(currentRoute.id);
                    // Auto-update route visualization
                    await updateRouteVisualization(currentRoute.id);
                } else {
                    throw new Error('POI kaldƒ±rƒ±lamadƒ±');
                }
            } catch (error) {
                console.error('POI disassociation error:', error);
                showError('POI kaldƒ±rƒ±lƒ±rken hata olu≈ütu');
            }
        }

        // Auto-update route visualization when POIs change
        async function updateRouteVisualization(routeId) {
            if (!map || !routeId) return;
            
            console.log('Updating route visualization for route ID:', routeId);
            
            try {
                // Fetch current route with its POIs
                const response = await fetch(`${apiBase}/admin/routes/${routeId}`, { credentials: 'include' });
                if (!response.ok) return;
                
                const routeData = await response.json();
                const pois = Array.isArray(routeData?.pois) ? routeData.pois : [];
                
                console.log('Route POIs for visualization:', pois.length);
                
                if (pois.length >= 2) {
                    // Remove existing route layer
                    const existingLayer = routeLayers[routeId];
                    if (existingLayer) {
                        map.removeLayer(existingLayer);
                        delete routeLayers[routeId];
                    }
                    
                    // Create waypoints for smart routing
                    const waypoints = pois
                        .sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0))
                        .map(p => ({
                            lat: Number(p.lat || p.latitude),
                            lng: Number(p.lon || p.longitude),
                            name: p.name
                        }))
                        .filter(wp => Number.isFinite(wp.lat) && Number.isFinite(wp.lng));
                    
                    console.log('Waypoints for smart routing:', waypoints);
                    
                    if (waypoints.length >= 2) {
                        try {
                            // Call smart routing API
                            const routeResponse = await fetch('/api/route/smart', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ waypoints })
                            });
                            
                            if (routeResponse.ok) {
                                const routeApiData = await routeResponse.json();
                                console.log('Smart route API response:', routeApiData);
                                console.log('Live route API structure:', Object.keys(routeApiData));
                                
                                // Try ALL possible formats for live route
                                let allCoords = [];
                                
                                // Prefer route.segments[].coordinates [{lat,lng}, ...]
                                if (routeApiData.route && Array.isArray(routeApiData.route.segments) && routeApiData.route.segments.length > 0) {
                                    routeApiData.route.segments.forEach(seg => {
                                        if (Array.isArray(seg?.coordinates) && seg.coordinates.length > 0) {
                                            seg.coordinates.forEach(pt => {
                                                const lat = Number(pt.lat);
                                                const lng = Number(pt.lng);
                                                if (Number.isFinite(lat) && Number.isFinite(lng)) allCoords.push([lat, lng]);
                                            });
                                        }
                                    });
                                    console.log('Live route using route.segments.coordinates:', allCoords.length);
                                } else if (routeApiData.route && routeApiData.route.geometry && Array.isArray(routeApiData.route.geometry)) {
                                    allCoords = routeApiData.route.geometry;
                                    console.log('Live route using route.geometry:', allCoords.length);
                                } else if (routeApiData.route && routeApiData.route.coordinates && Array.isArray(routeApiData.route.coordinates)) {
                                    allCoords = routeApiData.route.coordinates;
                                    console.log('Live route using route.coordinates:', allCoords.length);
                                } else if (routeApiData.segments && Array.isArray(routeApiData.segments)) {
                                    routeApiData.segments.forEach(segment => {
                                        if (Array.isArray(segment)) allCoords.push(...segment);
                                    });
                                    console.log('Live route using segments:', allCoords.length);
                                } else {
                                    console.log('Live route fallback to waypoints');
                                    allCoords = waypoints.map(wp => [wp.lat, wp.lng]);
                                }
                                
                                if (allCoords.length >= 2) {
                                    const color = ROUTE_TYPES[routeData.route_type]?.color || '#2563eb';
                                    const layer = L.polyline(allCoords, { color, weight: 4, opacity: 0.8 });
                                    layer.bindPopup(`
                                        <strong>${escapeHtml(routeData.name)}</strong><br>
                                        ${ROUTE_TYPES[routeData.route_type]?.name || routeData.route_type}<br>
                                        ${Math.round(routeApiData.total_distance || 0)} km<br>
                                        ${Math.round(routeApiData.estimated_time || 0)} dakika<br>
                                        <small>Canlƒ± rota - ${pois.length} POI</small>
                                    `);
                                    routeLayers[routeId] = layer;
                                    layer.addTo(map);
                                    console.log('Live route visualization updated!');
                                    
                                    // Fit map to new route
                                    const group = new L.featureGroup([layer]);
                                    map.fitBounds(group.getBounds(), { padding: [20, 20] });
                                }
                            } else {
                                throw new Error('Smart routing failed');
                            }
                        } catch (smartError) {
                            console.warn('Smart routing failed, using simple polyline:', smartError);
                            // Fallback to simple polyline
                            const simpleCoords = waypoints.map(wp => [wp.lat, wp.lng]);
                            const color = ROUTE_TYPES[routeData.route_type]?.color || '#2563eb';
                            const layer = L.polyline(simpleCoords, { color, weight: 4, opacity: 0.8 });
                            layer.bindPopup(`
                                <strong>${escapeHtml(routeData.name)}</strong><br>
                                ${ROUTE_TYPES[routeData.route_type]?.name || routeData.route_type}<br>
                                <small>Basit rota - ${pois.length} POI</small>
                            `);
                            routeLayers[routeId] = layer;
                            layer.addTo(map);
                            console.log('Fallback route visualization updated');
                        }
                    }
                } else {
                    // Remove route if less than 2 POIs
                    const existingLayer = routeLayers[routeId];
                    if (existingLayer) {
                        map.removeLayer(existingLayer);
                        delete routeLayers[routeId];
                        console.log('Route removed (less than 2 POIs)');
                    }
                }
            } catch (error) {
                console.error('Route visualization update failed:', error);
            }
        }

        // Reorder associated POI
        async function reorderAssociatedPOI(poiId, delta) {
            if (!currentRoute) return;
            const ids = associatedPoiOrderedIds.slice();
            const idx = ids.indexOf(poiId);
            if (idx < 0) return;
            const swapIdx = idx + delta;
            if (swapIdx < 0 || swapIdx >= ids.length) return;
            // swap
            [ids[idx], ids[swapIdx]] = [ids[swapIdx], ids[idx]];
            associatedPoiOrderedIds = ids;
            associatedPoiIdSet = new Set(ids);
            // Persist new order
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken) headers['X-CSRFToken'] = csrfToken;
            const payloadPois = ids.map((id, i) => ({ poi_id: id, order_in_route: i + 1 }));
            try {
                const resp = await fetch(`${apiBase}/admin/routes/${currentRoute.id}/pois`, {
                    method: 'POST', headers, credentials: 'include',
                    body: JSON.stringify({ csrf_token: csrfToken || '', pois: payloadPois })
                });
                if (resp.ok) {
                    loadPOIsForAssociation(currentRoute.id);
                    // Auto-update route visualization after reordering
                    await updateRouteVisualization(currentRoute.id);
                } else {
                    showNotification('Sƒ±ralama kaydedilemedi', 'error');
                }
            } catch (e) {
                showNotification('Sƒ±ralama hatasƒ±', 'error');
            }
        }

        // Build and save route from associated POIs (geometry + stats)
        async function buildAndSaveRouteFromAssociatedPOIs() {
            if (!currentRoute) return;
            const ids = Array.from(associatedPoiIdSet);
            if (ids.length < 2) { showNotification('Rota i√ßin en az 2 POI se√ßin', 'warning'); return; }
            try {
                // Build polyline from associated POIs in current order
                const ordered = ids.map(id => (allPoisForAssociation || []).find(p => getPoiId(p) === id)).filter(Boolean);
                const coords = ordered.map(p => ({ lat: p.latitude || p.lat, lng: p.longitude || p.lng }));
                // Distance (Haversine)
                const R = 6371000; // meters
                const toRad = d => d * Math.PI / 180;
                let totalMeters = 0;
                for (let i = 1; i < coords.length; i++) {
                    const a = coords[i-1], b = coords[i];
                    const dLat = toRad(b.lat - a.lat);
                    const dLon = toRad(b.lng - a.lng);
                    const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
                    const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
                    totalMeters += 2 * R * Math.asin(Math.sqrt(h));
                }
                const estimatedSeconds = Math.round((totalMeters / 1.2)); // y√ºr√ºy√º≈ü ~1.2 m/s varsayƒ±m
                const segments = [{ coordinates: coords }];
                const waypoints = ordered.map((p, i) => ({ name: p.name, latitude: p.latitude || p.lat, longitude: p.longitude || p.lng, order: i+1 }));

                // Save geometry to backend
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;
                const resp = await fetch(`${apiBase}/admin/routes/${currentRoute.id}/geometry`, {
                    method: 'POST', headers, credentials: 'include',
                    body: JSON.stringify({ geometry: segments, total_distance: totalMeters, estimated_time: estimatedSeconds, waypoints })
                });
                if (!resp.ok) throw new Error('Geometri kaydedilemedi');
                showNotification('Rota geometri kaydedildi', 'success');
                await loadRoutes();
                // √ñnizleme i√ßin vurgula
                highlightRouteOnMap(allRoutes.find(r => getRouteId(r) === getRouteId(currentRoute)) || currentRoute);
            } catch (e) {
                console.error('Build route error:', e);
                showNotification('Rota olu≈üturma/kaydetme hatasƒ±', 'error');
            }
        }

        // Preview on map without saving
        function previewRouteFromAssociatedPOIs() {
            const ids = Array.from(associatedPoiIdSet);
            if (ids.length < 2) { showNotification('√ñnizleme i√ßin en az 2 POI se√ßin', 'warning'); return; }
            const ordered = ids.map(id => (allPoisForAssociation || []).find(p => getPoiId(p) === id)).filter(Boolean);
            const latlngs = ordered.map(p => [p.latitude || p.lat, p.longitude || p.lng]);
            if (!map) return;
            // Remove old preview if exists
            if (routeLayers['__preview__']) {
                try { map.removeLayer(routeLayers['__preview__']); } catch(e) {}
            }
            const layer = L.polyline(latlngs, { color: '#10b981', weight: 4, opacity: 0.9, dashArray: '6,4' }).addTo(map);
            routeLayers['__preview__'] = layer;
            map.fitBounds(layer.getBounds(), { padding: [30, 30] });
        }

        // Suggest nearby POIs
        async function suggestNearbyPOIs() {
            if (!currentRoute) return;
            
            try {
                const response = await fetch(`${apiBase}/routes/${currentRoute.id}/suggest-pois`);
                const data = await response.json();
                
                if (response.ok) {
                    const suggestions = data.suggestions || [];
                    if (suggestions.length > 0) {
                        showNotification(`${suggestions.length} yakƒ±n POI √∂nerisi bulundu`, 'success');
                        // TODO: Display suggestions in a modal or special section
                    } else {
                        showNotification('Yakƒ±n POI bulunamadƒ±', 'info');
                    }
                } else {
                    throw new Error('POI √∂nerileri alƒ±namadƒ±');
                }
            } catch (error) {
                console.error('POI suggestion error:', error);
                showError('POI √∂nerileri alƒ±nƒ±rken hata olu≈ütu');
            }
        }

        // Save route changes (with CSRF)
        async function saveRouteChanges() {
            if (!currentRoute) return;
            
            try {
                const formData = {
                    name: document.getElementById('editRouteName').value,
                    description: document.getElementById('editRouteDescription').value,
                    route_type: document.getElementById('editRouteType').value,
                    difficulty_level: parseInt(document.getElementById('editDifficulty').value),
                    estimated_duration: parseInt(document.getElementById('editDuration').value) || null,
                    total_distance: parseFloat(document.getElementById('editDistance').value) || null,
                    elevation_gain: parseInt(document.getElementById('editElevation').value) || null,
                    tags: document.getElementById('editTags').value,
                    is_circular: document.getElementById('editIsCircular').checked
                };
                
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;
                const response = await fetch(`${apiBase}/admin/routes/${currentRoute.id}`, {
                    method: 'PUT',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showNotification('Rota ba≈üarƒ±yla g√ºncellendi', 'success');
                    
                    // Update current route data
                    Object.assign(currentRoute, formData);
                    
                    // Refresh routes list
                    await loadRoutes();
                    
                    // Return to detail view
                    displayRouteDetails(currentRoute);
                } else {
                    let message = 'Rota g√ºncellenemedi';
                    try { const errorData = await response.json(); if (errorData?.error) message = errorData.error; } catch(e) {}
                    throw new Error(message);
                }
            } catch (error) {
                console.error('Route update error:', error);
                showError('Rota g√ºncellenirken hata olu≈ütu: ' + error.message);
            }
        }

        // Cancel route edit
        function cancelRouteEdit() {
            if (currentRoute) {
                displayRouteDetails(currentRoute);
            }
        }

        // Export functions
        async function exportRouteAsGPX(routeId) {
            try {
                const response = await fetch(`${apiBase}/routes/${routeId}/export/gpx`);
                if (response.ok) {
                    const blob = await response.blob();
                    downloadFile(blob, `route_${routeId}.gpx`, 'application/gpx+xml');
                } else {
                    throw new Error('GPX export failed');
                }
            } catch (error) {
                console.error('GPX export error:', error);
                showError('GPX dƒ±≈üa aktarƒ±mƒ±nda hata olu≈ütu');
            }
        }

        async function exportRouteAsKML(routeId) {
            try {
                const response = await fetch(`${apiBase}/routes/${routeId}/export/kml`);
                if (response.ok) {
                    const blob = await response.blob();
                    downloadFile(blob, `route_${routeId}.kml`, 'application/vnd.google-earth.kml+xml');
                } else {
                    throw new Error('KML export failed');
                }
            } catch (error) {
                console.error('KML export error:', error);
                showError('KML dƒ±≈üa aktarƒ±mƒ±nda hata olu≈ütu');
            }
        }

        async function exportRouteAsJSON(routeId) {
            try {
                const response = await fetch(`${apiBase}/routes/${routeId}/export/json`);
                if (response.ok) {
                    const blob = await response.blob();
                    downloadFile(blob, `route_${routeId}.json`, 'application/json');
                } else {
                    throw new Error('JSON export failed');
                }
            } catch (error) {
                console.error('JSON export error:', error);
                showError('JSON dƒ±≈üa aktarƒ±mƒ±nda hata olu≈ütu');
            }
        }

        function printRouteDetails(routeId) {
            const route = allRoutes.find(r => r.id === routeId);
            if (!route) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>${escapeHtml(route.name)} - Rota Detaylarƒ±</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2563eb; }
                        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
                        .stat { padding: 10px; background: #f8fafc; border-radius: 8px; }
                        .stat-label { font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>${escapeHtml(route.name)}</h1>
                    <p><strong>T√ºr:</strong> ${ROUTE_TYPES[route.route_type]?.name || route.route_type}</p>
                    <p><strong>A√ßƒ±klama:</strong> ${escapeHtml(route.description || 'A√ßƒ±klama bulunmuyor')}</p>
                    
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-label">S√ºre</div>
                            <div>${route.estimated_duration || 0} dakika</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Mesafe</div>
                            <div>${route.total_distance || 0} km</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Y√ºkselti</div>
                            <div>${route.elevation_gain || 0} m</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Zorluk</div>
                            <div>${getDifficultyStars(route.difficulty_level)} (${route.difficulty_level}/5)</div>
                        </div>
                    </div>
                    
                    ${route.tags ? `<p><strong>Etiketler:</strong> ${escapeHtml(route.tags)}</p>` : ''}
                    <p><strong>Dairesel Rota:</strong> ${route.is_circular ? 'Evet' : 'Hayƒ±r'}</p>
                    <p><strong>Olu≈üturulma:</strong> ${formatDate(route.created_at)}</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Utility function to download files
        function downloadFile(blob, filename, mimeType) {
            const url = window.URL.createObjectURL(new Blob([blob], { type: mimeType }));
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        function duplicateCurrentRoute() {
            if (currentRoute) {
                // TODO: Implement route duplication
                showNotification(`${currentRoute.name} rotasƒ± kopyalama √∂zelliƒüi yakƒ±nda eklenecek`, 'info');
            }
        }

        function exportCurrentRoute() {
            if (currentRoute) {
                // TODO: Implement route export
                showNotification(`${currentRoute.name} rotasƒ± dƒ±≈üa aktarma √∂zelliƒüi yakƒ±nda eklenecek`, 'info');
            }
        }

        function exportSelected() {
            if (selectedRoutes.size > 0) {
                // TODO: Implement bulk export
                showNotification(`${selectedRoutes.size} rota dƒ±≈üa aktarma √∂zelliƒüi yakƒ±nda eklenecek`, 'info');
            }
        }

        function bulkEdit() {
            if (selectedRoutes.size > 0) {
                // TODO: Implement bulk edit
                showNotification(`${selectedRoutes.size} rota toplu d√ºzenleme √∂zelliƒüi yakƒ±nda eklenecek`, 'info');
            }
        }

        function deleteSelected() {
            if (selectedRoutes.size > 0) {
                if (confirm(`${selectedRoutes.size} rotayƒ± silmek istediƒüinizden emin misiniz?`)) {
                    // TODO: Implement bulk delete
                    showNotification(`${selectedRoutes.size} rota silme √∂zelliƒüi yakƒ±nda eklenecek`, 'info');
                }
            }
        }

        function toggleMapLayer(layerType) {
            // TODO: Implement map layer switching
            showNotification(`${layerType} katmanƒ± √∂zelliƒüi yakƒ±nda eklenecek`, 'info');
        }

        function fitMapToRoutes() {
            if (Object.keys(routeLayers).length > 0) {
                const group = new L.featureGroup(Object.values(routeLayers));
                map.fitBounds(group.getBounds(), { padding: [20, 20] });
            }
        }
    </script>
</body>
</html>