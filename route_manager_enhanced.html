<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota Yönetimi - Gelişmiş Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --route-primary: #2563eb;
            --route-secondary: #64748b;
            --route-success: #059669;
            --route-danger: #dc2626;
            --route-warning: #d97706;
            --route-info: #0891b2;
            --route-light: #f8fafc;
            --route-dark: #0f172a;
            --route-border: #e2e8f0;
            --route-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --route-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
            --route-radius: 12px;
            --route-radius-lg: 16px;
            --route-transition: all 0.3s ease;
        }

        body {
            background: var(--route-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Main Layout */
        .route-management-container {
            display: grid;
            grid-template-areas: 
                "header header header"
                "sidebar workspace map";
            grid-template-columns: 380px 1fr 600px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 1rem;
            padding: 1rem;
            position: relative;
        }

        /* Resizable Splitter */
        .resize-handle {
            position: absolute;
            top: 80px; /* Header yüksekliği + padding */
            right: 620px; /* Map genişliği + gap */
            width: 8px;
            height: calc(100vh - 100px);
            background: linear-gradient(90deg, transparent 2px, var(--route-border) 2px, var(--route-border) 6px, transparent 6px);
            cursor: col-resize;
            z-index: 1000;
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        .resize-handle:hover {
            background: linear-gradient(90deg, transparent 1px, var(--route-primary) 1px, var(--route-primary) 7px, transparent 7px);
            box-shadow: 0 0 8px rgba(37, 99, 235, 0.3);
        }

        .resize-handle.dragging {
            background: linear-gradient(90deg, transparent 1px, var(--route-primary) 1px, var(--route-primary) 7px, transparent 7px);
            box-shadow: 0 0 12px rgba(37, 99, 235, 0.5);
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 30px;
            background: repeating-linear-gradient(
                to bottom,
                var(--route-secondary) 0px,
                var(--route-secondary) 3px,
                transparent 3px,
                transparent 6px
            );
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }

        .resize-handle:hover::before,
        .resize-handle.dragging::before {
            opacity: 1;
        }

        /* Header */
        .route-header {
            grid-area: header;
            background: white;
            border-radius: var(--route-radius-lg);
            box-shadow: var(--route-shadow);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-header h1 {
            margin: 0;
            color: var(--route-dark);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-navigation {
            display: flex;
            gap: 1rem;
        }

        .main-navigation a {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            text-decoration: none;
            color: var(--route-secondary);
            font-weight: 500;
            transition: var(--route-transition);
            border: 2px solid transparent;
        }

        .main-navigation a.active {
            background: var(--route-primary);
            color: white;
            box-shadow: var(--route-shadow);
        }

        .main-navigation a:hover:not(.active) {
            background: var(--route-light);
            border-color: var(--route-border);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .btn-primary {
            background: var(--route-primary);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.25rem;
            font-weight: 600;
            transition: var(--route-transition);
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: var(--route-shadow-hover);
        }

        /* Sidebar */
        .route-sidebar {
            grid-area: sidebar;
            background: white;
            border-radius: var(--route-radius-lg);
            box-shadow: var(--route-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--route-primary) 0%, #1e40af 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .sidebar-controls {
            padding: 1rem;
            border-bottom: 1px solid var(--route-border);
            background: var(--route-light);
        }

        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--route-border);
            border-radius: 25px;
            font-size: 0.9rem;
            transition: var(--route-transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--route-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--route-secondary);
        }

        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--route-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-select {
            padding: 0.5rem;
            border: 2px solid var(--route-border);
            border-radius: var(--route-radius);
            font-size: 0.85rem;
            transition: var(--route-transition);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--route-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .bulk-actions {
            padding: 1rem;
            border-bottom: 1px solid var(--route-border);
            background: #fef3c7;
            display: none;
        }

        .bulk-actions.show {
            display: block;
        }

        .bulk-actions-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .bulk-count {
            font-weight: 600;
            color: var(--route-warning);
        }

        .bulk-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-bulk {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
            transition: var(--route-transition);
        }

        .btn-bulk-export {
            background: var(--route-info);
            color: white;
        }

        .btn-bulk-delete {
            background: var(--route-danger);
            color: white;
        }

        .btn-bulk-edit {
            background: var(--route-warning);
            color: white;
        }

        /* Route List */
        .route-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .route-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .route-list-container::-webkit-scrollbar-track {
            background: var(--route-light);
            border-radius: 3px;
        }

        .route-list-container::-webkit-scrollbar-thumb {
            background: var(--route-border);
            border-radius: 3px;
        }

        .route-list-container::-webkit-scrollbar-thumb:hover {
            background: var(--route-secondary);
        }

        .route-item {
            background: white;
            border: 2px solid var(--route-border);
            border-radius: var(--route-radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: var(--route-transition);
            position: relative;
        }

        .route-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--route-primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
            border-radius: 2px 0 0 2px;
        }

        .route-item:hover {
            border-color: var(--route-primary);
            transform: translateY(-2px);
            box-shadow: var(--route-shadow-hover);
        }

        .route-item:hover::before {
            transform: scaleY(1);
        }

        .route-item.selected {
            border-color: var(--route-primary);
            background: rgba(37, 99, 235, 0.05);
            box-shadow: var(--route-shadow-hover);
        }

        .route-item.selected::before {
            transform: scaleY(1);
        }

        .route-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .route-item-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-route-info {
            background: none;
            border: none;
            color: var(--route-primary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: var(--route-transition);
            opacity: 0.7;
        }

        .btn-route-info:hover {
            background: rgba(37, 99, 235, 0.1);
            opacity: 1;
            transform: scale(1.1);
        }

        .route-checkbox {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .route-item-title {
            font-weight: 700;
            color: var(--route-dark);
            margin: 0;
            font-size: 1rem;
            line-height: 1.3;
            padding-right: 2rem;
        }

        .route-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .route-type-walking { background: #dcfce7; color: #166534; }
        .route-type-hiking { background: #fef3c7; color: #92400e; }
        .route-type-cycling { background: #dbeafe; color: #1e40af; }
        .route-type-driving { background: #fce7f3; color: #be185d; }

        .route-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .route-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--route-secondary);
        }

        .route-stat-icon {
            width: 16px;
            text-align: center;
            color: var(--route-primary);
        }

        .difficulty-stars {
            color: #fbbf24;
            font-size: 0.9rem;
        }

        .route-description {
            font-size: 0.85rem;
            color: var(--route-secondary);
            line-height: 1.4;
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Workspace */
        .route-workspace {
            grid-area: workspace;
            background: white;
            border-radius: var(--route-radius-lg);
            box-shadow: var(--route-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .workspace-header {
            background: linear-gradient(135deg, var(--route-secondary) 0%, #475569 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workspace-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .workspace-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-workspace {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--route-transition);
        }

        .btn-workspace:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-workspace.btn-danger {
            border-color: rgba(220, 38, 38, 0.5);
            color: #dc2626;
        }

        .btn-workspace.btn-danger:hover {
            background: rgba(220, 38, 38, 0.1);
            border-color: #dc2626;
        }

        .workspace-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .empty-workspace {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--route-secondary);
            text-align: center;
        }

        .empty-workspace i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Map View */
        .route-map-view {
            grid-area: map;
            background: white;
            border-radius: var(--route-radius-lg);
            box-shadow: var(--route-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .map-header {
            background: linear-gradient(135deg, var(--route-success) 0%, #047857 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .map-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn-map {
            padding: 0.25rem 0.5rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: white;
            border-radius: 15px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--route-transition);
        }

        .btn-map:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #routeMap {
            flex: 1;
            min-height: 400px;
        }

        /* Elevation Chart Container */
        .route-elevation-container {
            background: white;
            border-top: 1px solid var(--route-border);
            padding: 1rem;
        }

        /* Map Fullscreen */
        .route-map-view.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border-radius: 0;
        }

        body.map-fullscreen {
            overflow: hidden;
        }

        .route-map-view.fullscreen #routeMap {
            min-height: calc(100vh - 60px); /* Header yüksekliği çıkarılmış */
        }

        /* Custom POI Map Markers */
        .custom-poi-marker {
            background: transparent !important;
            border: none !important;
        }

        .poi-marker-container {
            width: 35px;
            height: 35px;
            border-radius: 50% 50% 50% 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            border: 3px solid white;
            transition: transform 0.2s ease;
            position: relative;
            transform: rotate(-45deg);
        }

        .poi-marker-container i {
            transform: rotate(45deg);
            z-index: 2;
        }

        .poi-order-number {
            position: absolute;
            bottom: -8px;
            right: -8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            transform: rotate(45deg);
            border: 2px solid white;
        }

        .poi-marker-container:hover {
            transform: rotate(-45deg) scale(1.1);
            z-index: 1000;
        }

        /* POI Popup Styles */
        .poi-popup {
            min-width: 200px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .poi-popup-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .poi-popup-category {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        .poi-popup-description {
            color: #444;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .poi-popup-order {
            color: #666;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Route Details Popup Styles */
        .route-detail-popup {
            padding: 0;
        }

        .route-detail-popup .route-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--route-border);
        }

        .route-detail-popup .route-description-full {
            margin-bottom: 1.5rem;
        }

        .route-detail-popup .route-description-full h6 {
            color: var(--route-primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .route-detail-popup .route-statistics h6 {
            color: var(--route-primary);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .stats-grid-popup {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card-popup {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--route-light);
            border-radius: var(--route-radius);
            border: 1px solid var(--route-border);
        }

        .stat-card-popup .stat-icon {
            margin-right: 0.75rem;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--route-primary);
            color: white;
            border-radius: 50%;
            font-size: 1rem;
        }

        .stat-card-popup .stat-info {
            flex: 1;
        }

        .stat-card-popup .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--route-primary);
            line-height: 1;
        }

        .stat-card-popup .stat-label {
            font-size: 0.8rem;
            color: var(--route-secondary);
            margin-top: 0.25rem;
        }

        .route-detail-popup .route-tags-section h6 {
            color: var(--route-primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .route-detail-popup .route-metadata h6 {
            color: var(--route-primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .metadata-grid-popup {
            display: grid;
            gap: 0.5rem;
        }

        .metadata-grid-popup .metadata-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--route-border);
        }

        .metadata-grid-popup .metadata-item:last-child {
            border-bottom: none;
        }

        /* POI Order Badge */
        .poi-order-badge {
            display: inline-block;
            background: var(--route-primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .route-management-container {
                grid-template-areas: 
                    "header header"
                    "sidebar workspace"
                    "map map";
                grid-template-columns: 350px 1fr;
                grid-template-rows: auto 1fr 450px;
            }
            
            .resize-handle {
                display: none; /* Hide splitter on smaller screens */
            }
        }

        @media (max-width: 768px) {
            .route-management-container {
                grid-template-areas: 
                    "header"
                    "sidebar"
                    "workspace"
                    "map";
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr 300px;
                padding: 0.5rem;
                gap: 0.5rem;
            }

            .route-header {
                padding: 1rem;
            }

            .route-header h1 {
                font-size: 1.2rem;
            }

            .main-navigation {
                flex-direction: column;
                gap: 0.5rem;
            }

            .header-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Loading States */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--route-border);
            border-top: 4px solid var(--route-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            padding: 1rem;
            border-radius: var(--route-radius);
            box-shadow: var(--route-shadow-hover);
            animation: slideIn 0.3s ease;
        }

        .notification-success {
            background: var(--route-success);
            color: white;
        }

        .notification-error {
            background: var(--route-danger);
            color: white;
        }

        .notification-info {
            background: var(--route-info);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="route-management-container" id="routeContainer">
        <!-- Resizable Splitter -->
        <div class="resize-handle" id="resizeHandle"></div>
        
        <!-- Header -->
        <header class="route-header">
            <h1>
                <i class="fas fa-route"></i>
                Rota Yönetimi
            </h1>
            <nav class="main-navigation">
                <a href="poi_manager_enhanced.html">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    POI Yönetimi
                </a>
                <a href="route_manager_enhanced.html" class="active">
                    <i class="fas fa-route me-1"></i>
                    Rota Yönetimi
                </a>
                <a href="file_import_manager.html">
                    <i class="fas fa-file-import me-1"></i>
                    Dosya Import
                </a>
            </nav>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="showCreateRouteModal()">
                    <i class="fas fa-plus me-1"></i>
                    Yeni Rota
                </button>
                <button class="btn btn-outline-secondary" onclick="refreshRoutes()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Yenile
                </button>
                <button class="btn btn-outline-warning" onclick="clearMapRoutes()" title="Haritadaki tüm rotaları temizle">
                    <i class="fas fa-eraser me-1"></i>
                    Haritayı Temizle
                </button>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="route-sidebar">
            <div class="sidebar-header">
                <h3>
                    <i class="fas fa-list me-2"></i>
                    Rota Listesi
                </h3>
            </div>

            <!-- Search and Filters -->
            <div class="sidebar-controls">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="routeSearch" 
                           placeholder="Rota ara..." oninput="handleSearch()">
                </div>

                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-filter"></i>
                            Rota Türü
                        </label>
                        <select class="filter-select" id="typeFilter" onchange="applyFilters()">
                            <option value="">Tüm Türler</option>
                            <option value="walking">🚶 Yürüyüş</option>
                            <option value="hiking">🥾 Doğa Yürüyüşü</option>
                            <option value="cycling">🚴 Bisiklet</option>
                            <option value="driving">🚗 Araba</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-star"></i>
                            Zorluk Seviyesi
                        </label>
                        <select class="filter-select" id="difficultyFilter" onchange="applyFilters()">
                            <option value="">Tüm Seviyeler</option>
                            <option value="1">⭐ Çok Kolay</option>
                            <option value="2">⭐⭐ Kolay</option>
                            <option value="3">⭐⭐⭐ Orta</option>
                            <option value="4">⭐⭐⭐⭐ Zor</option>
                            <option value="5">⭐⭐⭐⭐⭐ Çok Zor</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-clock"></i>
                            Maksimum Süre
                        </label>
                        <select class="filter-select" id="durationFilter" onchange="applyFilters()">
                            <option value="">Süre Sınırı Yok</option>
                            <option value="30">30 dakika</option>
                            <option value="60">1 saat</option>
                            <option value="120">2 saat</option>
                            <option value="240">4 saat</option>
                            <option value="480">8 saat</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-sort"></i>
                            Sıralama
                        </label>
                        <select class="filter-select" id="sortFilter" onchange="applyFilters()">
                            <option value="name_asc">İsim (A-Z)</option>
                            <option value="name_desc">İsim (Z-A)</option>
                            <option value="created_desc">En Yeni</option>
                            <option value="created_asc">En Eski</option>
                            <option value="difficulty_asc">Kolay → Zor</option>
                            <option value="difficulty_desc">Zor → Kolay</option>
                            <option value="duration_asc">Kısa → Uzun</option>
                            <option value="duration_desc">Uzun → Kısa</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="bulk-actions" id="bulkActions">
                <div class="bulk-actions-header">
                    <span class="bulk-count" id="bulkCount">0 rota seçildi</span>
                    <button class="btn-bulk btn-bulk-clear" onclick="clearSelection()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="bulk-buttons">
                    <button class="btn-bulk btn-bulk-export" onclick="exportSelected()">
                        <i class="fas fa-download me-1"></i>
                        Dışa Aktar
                    </button>
                    <button class="btn-bulk btn-bulk-edit" onclick="bulkEdit()">
                        <i class="fas fa-edit me-1"></i>
                        Toplu Düzenle
                    </button>
                    <button class="btn-bulk btn-bulk-delete" onclick="deleteSelected()">
                        <i class="fas fa-trash me-1"></i>
                        Sil
                    </button>
                </div>
            </div>

            <!-- Route List -->
            <div class="route-list-container" id="routeListContainer">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </aside>

        <!-- Workspace -->
        <main class="route-workspace">
            <div class="workspace-header">
                <h3 class="workspace-title" id="workspaceTitle">Rota Detayları</h3>
                <div class="workspace-actions" id="workspaceActions" style="display: none;">
                    <button class="btn-workspace" onclick="editCurrentRoute()">
                        <i class="fas fa-edit me-1"></i>
                        Düzenle
                    </button>
                    <button class="btn-workspace" onclick="duplicateCurrentRoute()">
                        <i class="fas fa-copy me-1"></i>
                        Kopyala
                    </button>
                    <button class="btn-workspace" onclick="exportCurrentRoute()">
                        <i class="fas fa-download me-1"></i>
                        Dışa Aktar
                    </button>
                    <button class="btn-workspace btn-danger" onclick="deleteCurrentRoute()">
                        <i class="fas fa-trash me-1"></i>
                        Sil
                    </button>
                    <button class="btn-workspace" onclick="clearRouteSelection()" title="Rota seçimini temizle">
                        <i class="fas fa-times me-1"></i>
                        Seçimi Temizle
                    </button>
                </div>
            </div>
            <div class="workspace-content" id="workspaceContent">
                <div class="empty-workspace">
                    <i class="fas fa-route"></i>
                    <h4>Rota Seçin</h4>
                    <p>Detayları görüntülemek için sol taraftan bir rota seçin</p>
                </div>
            </div>
        </main>

        <!-- Map View -->
        <section class="route-map-view">
            <div class="map-header">
                <h3 class="map-title" id="mapTitle">
                    <i class="fas fa-map me-2"></i>
                    Harita Görünümü
                </h3>
                <div class="map-controls">
                    <button class="btn-map" onclick="toggleMapLayer('satellite')" title="Uydu Görünümü">
                        <i class="fas fa-satellite"></i>
                    </button>
                    <button class="btn-map" onclick="toggleMapLayer('terrain')" title="Arazi Görünümü">
                        <i class="fas fa-mountain"></i>
                    </button>
                    <button class="btn-map" onclick="fitMapToRoutes()" title="Rotalara Odaklan">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                    <button class="btn-map" onclick="toggleMapFullscreen()" title="Tam Ekran" id="fullscreenBtn">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div id="routeMap"></div>
            <!-- Elevation Chart Container -->
            <div class="route-elevation-container">
                <div id="routeElevationChartContainer" class="elevation-chart-hidden"></div>
            </div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>  
    <script src="static/js/rate-limiter.js"></script>
    <script src="static/js/elevation-chart.js"></script>
    <script src="static/js/api-client.js"></script>
    <script src="static/js/navigation-manager.js"></script>
  <script>
        // Rate limiting bilgilendirme mesajı
        if (window.rateLimiter) {
            console.log('✅ Rate limiting aktif - API çağrıları sınırlandırılacak');
        }

        // Tüm rotaları haritadan kaldır
        function clearAllRoutesFromMap() {
            Object.values(routeLayers).forEach(layer => {
                try {
                    map.removeLayer(layer);
                } catch (e) {
                    console.warn('Layer removal error:', e);
                }
            });
            routeLayers = {};
            console.log('Tüm rotalar haritadan kaldırıldı');
        }

        // POI'lerden dinamik rota oluştur
        async function createRouteFromPOIs(route, color) {
            const rid = getRouteId(route);
            console.log('POI\'lerden rota oluşturuluyor:', route.name);
            
            try {
                // Rotanın POI'lerini al
                const response = await rateLimitedFetch(`${apiBase}/admin/routes/${rid}/pois`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const pois = data.pois || data.results || [];
                    
                    if (pois.length > 0) {
                        // POI koordinatlarını al
                        const latlngs = pois
                            .filter(poi => poi.latitude && poi.longitude)
                            .map(poi => [parseFloat(poi.latitude), parseFloat(poi.longitude)]);
                        
                        if (latlngs.length > 1) {
                            // POI'ler arasında rota çiz
                            const layer = L.polyline(latlngs, {
                                color: color,
                                weight: 4,
                                opacity: 0.8,
                                dashArray: '8,4' // POI-based rotayı ayırt etmek için
                            }).addTo(map);
                            
                            routeLayers[rid] = layer;
                            
                            // POI marker'larını da ekle
                            pois.forEach((poi, index) => {
                                if (poi.latitude && poi.longitude) {
                                    const marker = L.marker([parseFloat(poi.latitude), parseFloat(poi.longitude)])
                                        .bindPopup(`
                                            <strong>${poi.name || 'POI'}</strong><br>
                                            <small>Sıra: ${index + 1}</small>
                                        `);
                                    poiMarkersLayer.addLayer(marker);
                                }
                            });
                            
                            // Haritayı rotaya odakla
                            map.fitBounds(layer.getBounds(), { padding: [50, 50] });
                            
                            console.log('✅ POI-based rota oluşturuldu:', pois.length, 'POI');
                            showNotification(`${pois.length} POI ile dinamik rota oluşturuldu`, 'success');
                        } else {
                            console.warn('Yeterli POI koordinatı yok');
                            showNotification('Bu rotada yeterli POI koordinatı bulunamadı', 'warning');
                        }
                    } else {
                        console.warn('Rota POI\'si bulunamadı');
                        showNotification('Bu rotaya ait POI bulunamadı', 'warning');
                    }
                } else {
                    console.warn('POI\'ler alınamadı:', response.status);
                }
            } catch (error) {
                console.error('POI-based rota oluşturma hatası:', error);
                showNotification('Dinamik rota oluşturulamadı', 'error');
            }
        }

        // Tek bir rotayı haritaya ekle
        async function showSingleRouteOnMap(route) {
            const rid = getRouteId(route);
            if (!rid) {
                console.warn('Route ID bulunamadı:', route);
                return;
            }

            try {
                // Önce mevcut geometriyi kontrol et
                let geometry = route.geometry;
                
                // Geometri yoksa veya string ise API'den al
                if (!geometry || typeof geometry === 'string') {
                    console.log(`Rota ${rid} için geometri API'den alınıyor...`);
                    
                    try {
                        const response = await rateLimitedFetch(`${apiBase}/routes/${rid}/geometry`, { 
                            credentials: 'include' 
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.geometry) {
                                geometry = data.geometry;
                                console.log(`Geometri başarıyla alındı:`, geometry);
                            } else {
                                console.warn('API geometri döndürmedi:', data);
                            }
                        } else {
                            console.warn(`Geometri API hatası: ${response.status} ${response.statusText}`);
                        }
                    } catch (apiError) {
                        console.warn('Geometri API çağrısı başarısız:', apiError);
                    }
                }

                // Hibrit geometri işleme - hem statik hem dinamik rota desteği
                if (geometry) {
                    console.log('Ham geometri verisi:', geometry);
                    
                    // String ise parse et
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Geometry JSON parse hatası:', e);
                            return;
                        }
                    }

                    // Rota rengini belirle
                    const color = ROUTE_TYPES[route.route_type]?.color || '#2563eb';
                    let layer = null;
                    
                    // YAKLAŞIM 1: Statik LineString geometrisi (klasik)
                    if (geometry.type === 'LineString' && geometry.coordinates && geometry.coordinates.length > 0) {
                        console.log('📍 Statik LineString geometrisi kullanılıyor');
                        const latlngs = geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        layer = L.polyline(latlngs, {
                            color: color,
                            weight: 4,
                            opacity: 0.8
                        });
                    }
                    // YAKLAŞIM 2: API response formatı (nested geometry)
                    else if (geometry.geometry && geometry.geometry.type === 'LineString') {
                        console.log('📍 Nested LineString geometrisi kullanılıyor');
                        const coords = geometry.geometry.coordinates;
                        if (coords && coords.length > 0) {
                            const latlngs = coords.map(coord => [coord[1], coord[0]]);
                            layer = L.polyline(latlngs, {
                                color: color,
                                weight: 4,
                                opacity: 0.8
                            });
                        }
                    }
                    // YAKLAŞIM 3: POI-based dinamik rota (waypoints)
                    else if (geometry.waypoints && Array.isArray(geometry.waypoints) && geometry.waypoints.length > 0) {
                        console.log('📍 POI-based waypoints kullanılıyor');
                        const latlngs = geometry.waypoints.map(wp => [wp.lat || wp.latitude, wp.lng || wp.longitude]);
                        if (latlngs.length > 1) {
                            // Waypoints arasında düz çizgi çek (basit yaklaşım)
                            layer = L.polyline(latlngs, {
                                color: color,
                                weight: 4,
                                opacity: 0.8,
                                dashArray: '5,5' // Dinamik rotayı ayırt etmek için kesikli çizgi
                            });
                        }
                    }
                    // YAKLAŞIM 4: Rota POI'lerinden dinamik rota oluştur
                    else {
                        console.log('📍 Rota POI\'lerinden dinamik rota oluşturuluyor');
                        await createRouteFromPOIs(route, color);
                        return; // createRouteFromPOIs kendi layer'ını oluşturacak
                    }

                    // Layer oluşturulduysa haritaya ekle
                    if (layer) {
                        layer.addTo(map);
                        routeLayers[rid] = layer;
                        
                        // Haritayı rotaya odakla
                        map.fitBounds(layer.getBounds(), { padding: [50, 50] });
                        
                        console.log('✅ Rota haritaya eklendi:', route.name);
                    } else {
                        console.warn('Hiçbir geometri formatı işlenemedi:', geometry);
                        showNotification('Rota geometrisi işlenemedi', 'warning');
                    }
                } else {
                    console.warn('Rota geometrisi bulunamadı:', route.name);
                    showNotification('Bu rotanın geometrisi bulunamadı', 'warning');
                }
            } catch (error) {
                console.error('Rota yükleme hatası:', error);
                showNotification('Rota yüklenirken hata oluştu: ' + error.message, 'error');
            }
        }

        // Global variables
        const apiBase = '/api';
        let allRoutes = [];
        let filteredRoutes = [];
        let selectedRoutes = new Set();
        let currentRoute = null;
        let map = null;
        let routeLayers = {};
        let poiMarkersLayer = null;
        let searchTimeout = null;
        let associatedPoiIdSet = new Set();
        let associatedPoiOrderedIds = [];
        let csrfToken = null;
        
        // Rate limiting için
        let lastLoadTime = 0;
        const minLoadInterval = 2000; // 2 saniye minimum aralık
        let loadingInProgress = false;

        // --- Helpers: ID and parsing ---
        function getRouteId(route) {
            return route?.id ?? route?._id ?? route?.route_id ?? null;
        }

        function getPoiId(poi) {
            // Try different ID field names in order of preference
            return poi?.id ?? poi?._id ?? poi?.poi_id ?? null;
        }

        // Route type configurations
        const ROUTE_TYPES = {
            'walking': { name: 'Yürüyüş', icon: '🚶', color: '#059669' },
            'hiking': { name: 'Doğa Yürüyüşü', icon: '🥾', color: '#d97706' },
            'cycling': { name: 'Bisiklet', icon: '🚴', color: '#2563eb' },
            'driving': { name: 'Araba', icon: '🚗', color: '#dc2626' }
        };

        // POI Category configurations
        const POI_CATEGORIES = {
            'kulturel_miras': { name: '🏛️ Kültürel Miras', icon: 'landmark', color: '#8B4513' },
            'dogal_miras': { name: '🌿 Doğal Miras', icon: 'mountain', color: '#228B22' },
            'yasayan_kultur': { name: '🎨 Yaşayan Kültür', icon: 'palette', color: '#9932CC' },
            'gastronomi': { name: '🍽️ Gastronomi', icon: 'utensils', color: '#DC143C' },
            'konaklama_hizmet': { name: '🏨 Konaklama & Hizmetler', icon: 'bed', color: '#4169E1' },
            'macera_spor': { name: '🏃 Macera & Spor', icon: 'hiking', color: '#FF6347' },
            'seyir_noktalari': { name: '📷 Seyir Noktaları', icon: 'camera', color: '#ff9500' }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadRoutes();
            setupEventListeners();
            setupResizableMap();
            // Fetch CSRF token for admin POSTs
            fetch('/auth/csrf-token', { credentials: 'include' })
                .then(r => r.ok ? r.json() : null)
                .then(d => { if (d?.csrf_token) csrfToken = d.csrf_token; })
                .catch(() => {});
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (window.routeElevationChart) {
                window.routeElevationChart.destroy();
                window.routeElevationChart = null;
            }
        });

        // Fetch and attach geometry for routes if missing
        async function attachGeometriesToRoutes(routes) {
            try {
                const tasks = routes.map(async (r) => {
                    try {
                        const rid = getRouteId(r);
                        if (!rid || r.geometry) return;
                        const res = await fetch(`${apiBase}/routes/${rid}/geometry`, { credentials: 'include' });
                        if (!res.ok) {
                            if (res.status === 404) {
                                // Silently ignore 404s for routes without geometry
                                return;
                            }
                            console.warn(`Failed to fetch geometry for route ${rid}: ${res.status}`);
                            return;
                        }
                        const g = await res.json();
                        if (g && g.geometry) {
                            let geo = g.geometry;
                            if (typeof geo === 'string') {
                                try { geo = JSON.parse(geo); } catch(e) { /* ignore */ }
                            }
                            r.geometry = geo || r.geometry;
                            if (g.total_distance != null) r.total_distance = g.total_distance;
                            if (g.estimated_duration != null) r.estimated_duration = g.estimated_duration;
                        }
                    } catch(e) { /* ignore per route */ }
                });
                await Promise.all(tasks);
            } catch (e) {
                console.warn('attachGeometriesToRoutes failed:', e);
            }
        }

        // Initialize Leaflet map
        function initializeMap() {
            console.log('Initializing map...');
            const mapContainer = document.getElementById('routeMap');
            console.log('Map container:', mapContainer, 'Visible:', mapContainer ? mapContainer.offsetHeight : 'N/A');
            
            map = L.map('routeMap').setView([38.7312, 34.4547], 10);
            console.log('Map object created:', map);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            // Layer for POI markers of the selected route
            poiMarkersLayer = L.layerGroup().addTo(map);
            
            // Force map size invalidation after a short delay
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    console.log('Map size invalidated');
                }
            }, 100);

            // Add map click handler
            map.on('click', function(e) {
                // Handle map interactions
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input with debouncing
            document.getElementById('routeSearch').addEventListener('input', handleSearch);
            
            // Filter change handlers
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('difficultyFilter').addEventListener('change', applyFilters);
            document.getElementById('durationFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
        }

        // Load routes from API
        async function loadRoutes() {
            // Rate limiting kontrolü - Geliştirme için devre dışı
            // const now = Date.now();
            // if (loadingInProgress || (now - lastLoadTime) < minLoadInterval) {
            //     console.log('Rota yükleme rate limit nedeniyle atlandı');
            //     return;
            // }
            
            // loadingInProgress = true;  // Geliştirme için devre dışı
            // lastLoadTime = now;
            
            try {
                showLoading();
                const response = await rateLimitedFetch(`${apiBase}/admin/routes`, { credentials: 'include' });
                const data = await response.json();
                
                if (response.ok) {
                    if (Array.isArray(data)) {
                        allRoutes = data;
                    } else if (Array.isArray(data.routes)) {
                        allRoutes = data.routes;
                    } else if (Array.isArray(data.results)) {
                        allRoutes = data.results;
                    } else {
                        // Fallback: try to consolidate values if grouped
                        allRoutes = [];
                        Object.values(data || {}).forEach(val => {
                            if (Array.isArray(val)) allRoutes = allRoutes.concat(val);
                        });
                    }
                    console.log('Loaded routes:', allRoutes.map(r => ({id: getRouteId(r), name: r.name})));
                    filteredRoutes = [...allRoutes];
                    console.log('Filtered routes:', filteredRoutes.map(r => ({id: getRouteId(r), name: r.name})));
                    displayRoutes();
                    // Rotaları otomatik olarak haritaya yükleme - devre dışı bırakıldı
                    // await attachGeometriesToRoutes(filteredRoutes);
                    // updateMapRoutes();
                    
                    // Auto-focus sadece seçili rota varsa
                    // setTimeout(() => {
                    //     if (Object.keys(routeLayers).length > 0) {
                    //         fitMapToRoutes();
                    //     }
                    // }, 1000);
                } else {
                    throw new Error(data.error || 'Rotalar yüklenemedi');
                }
            } catch (error) {
                console.error('Routes load error:', error);
                showError('Rotalar yüklenirken hata oluştu: ' + error.message);
            } finally {
                loadingInProgress = false;
            }
        }

        // Display routes in sidebar
        function displayRoutes() {
            const container = document.getElementById('routeListContainer');
            
            if (filteredRoutes.length === 0) {
                container.innerHTML = `
                    <div class="empty-workspace">
                        <i class="fas fa-route"></i>
                        <h5>Rota bulunamadı</h5>
                        <p>Arama kriterlerinizi değiştirin veya yeni rota oluşturun</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredRoutes.map(route => {
                const rid = getRouteId(route);
                return `
                <div class="route-item ${selectedRoutes.has(rid) ? 'selected' : ''}" 
                     data-route-id="${rid}" role="button" tabindex="0" onclick="selectRoute(${rid}); return false;"
                     ondblclick="showRouteDetailsPopup(${rid}); return false;">
                    <input type="checkbox" class="route-checkbox" 
                           ${selectedRoutes.has(rid) ? 'checked' : ''}
                           onclick="toggleRouteSelection(event, ${rid}); return false;">
                    
                    <div class="route-item-header">
                        <h4 class="route-item-title">${escapeHtml(route.name)}</h4>
                        <div class="route-item-actions">
                            ${(!route.geometry || (route.geometry && !route.geometry.geometry && !route.geometry.type)) ? '<span class="badge bg-warning" title="Harita geometrisi yok">Geometri Yok</span>' : ''}
                            <button class="btn-route-info" onclick="showRouteDetailsPopup(${rid}); event.stopPropagation(); return false;" title="Rota Detayları">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="route-type-badge route-type-${route.route_type}">
                        ${ROUTE_TYPES[route.route_type]?.icon || '🗺️'} 
                        ${ROUTE_TYPES[route.route_type]?.name || route.route_type}
                    </div>
                    
                    <div class="route-description">
                        ${escapeHtml(route.description || 'Açıklama bulunmuyor')}
                    </div>
                    
                    <div class="route-stats">
                        <div class="route-stat">
                            <i class="fas fa-clock route-stat-icon"></i>
                            <span>${route.estimated_duration || 0} dk</span>
                        </div>
                        <div class="route-stat">
                            <i class="fas fa-route route-stat-icon"></i>
                            <span>${(route.total_distance || 0).toFixed(2)} km</span>
                        </div>
                        <div class="route-stat">
                            <i class="fas fa-mountain route-stat-icon"></i>
                            <span>${route.elevation_gain || 0} m</span>
                        </div>
                        <div class="route-stat">
                            <i class="fas fa-star route-stat-icon"></i>
                            <span class="difficulty-stars">${getDifficultyStars(route.difficulty_level)}</span>
                        </div>
                    </div>
                    
                    ${route.is_circular ? '<div class="badge bg-info">Dairesel</div>' : ''}
                    ${route.tags ? `<div class="route-tags">${route.tags}</div>` : ''}
                </div>`;
            }).join('');

            updateBulkActions();
        }

        // Handle search with debouncing
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 800); // Arama için daha uzun bekleme süresi
        }

        // Apply all filters
        async function applyFilters() {
            const searchTerm = document.getElementById('routeSearch').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const difficultyFilter = document.getElementById('difficultyFilter').value;
            const durationFilter = document.getElementById('durationFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            // Filter routes
            filteredRoutes = allRoutes.filter(route => {
                // Search filter
                if (searchTerm && !route.name.toLowerCase().includes(searchTerm) && 
                    !route.description?.toLowerCase().includes(searchTerm) &&
                    !route.tags?.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Type filter
                if (typeFilter && route.route_type !== typeFilter) {
                    return false;
                }

                // Difficulty filter
                if (difficultyFilter && route.difficulty_level != difficultyFilter) {
                    return false;
                }

                // Duration filter
                if (durationFilter && route.estimated_duration > parseInt(durationFilter)) {
                    return false;
                }

                return true;
            });

        // --- Helpers: ID and parsing ---
        function getRouteId(route) {
            return route?.id ?? route?._id ?? route?.route_id ?? null;
        }

        function getPoiId(poi) {
            // Try different ID field names in order of preference
            return poi?.id ?? poi?._id ?? poi?.poi_id ?? null;
        }

            // Sort routes
            filteredRoutes.sort((a, b) => {
                switch (sortFilter) {
                    case 'name_asc':
                        return a.name.localeCompare(b.name);
                    case 'name_desc':
                        return b.name.localeCompare(a.name);
                    case 'created_desc':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'created_asc':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'difficulty_asc':
                        return a.difficulty_level - b.difficulty_level;
                    case 'difficulty_desc':
                        return b.difficulty_level - a.difficulty_level;
                    case 'duration_asc':
                        return (a.estimated_duration || 0) - (b.estimated_duration || 0);
                    case 'duration_desc':
                        return (b.estimated_duration || 0) - (a.estimated_duration || 0);
                    default:
                        return 0;
                }
            });

            displayRoutes();
            // Filtreleme sırasında da otomatik harita güncelleme devre dışı
            // await attachGeometriesToRoutes(filteredRoutes);
            
            // Sadece seçili rota varsa haritayı güncelle
            // if (!currentRoute) {
            //     updateMapRoutes();
            // }
        }

        // Select a route
        function selectRoute(routeId) {
            currentRoute = allRoutes.find(r => getRouteId(r) === routeId);
            if (currentRoute) {
                // Update UI selection
                document.querySelectorAll('.route-item').forEach(item => {
                    item.classList.remove('selected');
                });
                const selectedElement = document.querySelector(`[data-route-id="${routeId}"]`);
                if (selectedElement) {
                    selectedElement.classList.add('selected');
                }

                // Display route details in workspace
                displayRouteDetails(currentRoute);

                // Highlight and focus on the selected route
                highlightAndFocusRoute(currentRoute);
            }
        }

        // Toggle route selection for bulk operations
        function toggleRouteSelection(event, routeId) {
            event.stopPropagation();
            
            if (selectedRoutes.has(routeId)) {
                selectedRoutes.delete(routeId);
            } else {
                selectedRoutes.add(routeId);
            }
            
            updateBulkActions();
            displayRoutes();
            // When checkboxes change, redraw map for selected set
            updateMapRoutes();
        }

        // Update bulk actions visibility and count
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const bulkCount = document.getElementById('bulkCount');
            
            if (selectedRoutes.size > 0) {
                bulkActions.classList.add('show');
                bulkCount.textContent = `${selectedRoutes.size} rota seçildi`;
            } else {
                bulkActions.classList.remove('show');
            }
        }

        // Clear selection
        function clearSelection() {
            selectedRoutes.clear();
            updateBulkActions();
            displayRoutes();
        }

        // Clear route selection and show all routes
        function clearRouteSelection() {
            currentRoute = null;
            
            // Update map title
            updateMapTitle();
            
            // Remove UI selection
            document.querySelectorAll('.route-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Reset all route styles to normal
            Object.entries(routeLayers).forEach(([id, layer]) => {
                const routeData = allRoutes.find(r => String(getRouteId(r)) === String(id));
                if (routeData) {
                    const color = ROUTE_TYPES[routeData.route_type]?.color || '#2563eb';
                    layer.setStyle({
                        color: color,
                        weight: 3,
                        opacity: 0.7
                    });
                }
            });
            
            // Clear POI markers
            if (poiMarkersLayer) {
                poiMarkersLayer.clearLayers();
            }
            
            // Show empty workspace
            document.getElementById('workspaceContent').innerHTML = `
                <div class="empty-workspace">
                    <i class="fas fa-route"></i>
                    <h4>Rota Seçin</h4>
                    <p>Detayları görüntülemek için sol taraftan bir rota seçin</p>
                </div>
            `;
            
            // Hide workspace actions
            document.getElementById('workspaceActions').style.display = 'none';
            
            // Fit map to all routes
            fitMapToRoutes();
        }

        // Display route details in workspace
        function displayRouteDetails(route) {
            const workspaceTitle = document.getElementById('workspaceTitle');
            const workspaceActions = document.getElementById('workspaceActions');
            const workspaceContent = document.getElementById('workspaceContent');

            workspaceTitle.textContent = route.name;
            workspaceActions.style.display = 'flex';

            workspaceContent.innerHTML = `
                <div class="route-detail-view">
                    <div class="route-detail-header">
                        <div class="route-type-badge route-type-${route.route_type}">
                            ${ROUTE_TYPES[route.route_type]?.icon || '🗺️'} 
                            ${ROUTE_TYPES[route.route_type]?.name || route.route_type}
                        </div>
                        <div class="difficulty-display">
                            <span class="difficulty-stars">${getDifficultyStars(route.difficulty_level)}</span>
                            <span class="difficulty-text">Zorluk: ${route.difficulty_level}/5</span>
                        </div>
                    </div>

                    <div class="route-description-full">
                        <h5><i class="fas fa-info-circle me-2"></i>Açıklama</h5>
                        <p>${escapeHtml(route.description || 'Açıklama bulunmuyor')}</p>
                    </div>

                    <div class="route-statistics">
                        <h5><i class="fas fa-chart-bar me-2"></i>İstatistikler</h5>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${route.estimated_duration || 0}</div>
                                    <div class="stat-label">Dakika</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${(route.total_distance || 0).toFixed(2)}</div>
                                    <div class="stat-label">Kilometre</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-mountain"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${route.elevation_gain || 0}</div>
                                    <div class="stat-label">Yükselti (m)</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${route.poi_count || 0}</div>
                                    <div class="stat-label">POI Sayısı</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${route.tags ? `
                        <div class="route-tags-section">
                            <h5><i class="fas fa-tags me-2"></i>Etiketler</h5>
                            <div class="tags-container">
                                ${route.tags.split(',').map(tag => 
                                    `<span class="tag-chip">${escapeHtml(tag.trim())}</span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="route-metadata">
                        <h5><i class="fas fa-info me-2"></i>Metadata</h5>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <strong>Oluşturulma:</strong>
                                <span>${formatDate(route.created_at)}</span>
                            </div>
                            <div class="metadata-item">
                                <strong>Güncellenme:</strong>
                                <span>${formatDate(route.updated_at)}</span>
                            </div>
                            <div class="metadata-item">
                                <strong>Dairesel Rota:</strong>
                                <span>${route.is_circular ? 'Evet' : 'Hayır'}</span>
                            </div>
                            ${route.import_source ? `
                                <div class="metadata-item">
                                    <strong>Import Kaynağı:</strong>
                                    <span>${escapeHtml(route.import_source)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Add CSS for route detail view
            addRouteDetailStyles();
            
            // Create elevation chart for route manager
            if (window.ElevationChart && route) {
                setTimeout(async () => {
                    if (window.routeElevationChart) {
                        window.routeElevationChart.destroy();
                    }
                    window.routeElevationChart = new ElevationChart('routeElevationChartContainer', routeMap);
                    
                    // Load route data for elevation
                    if (route.geometry) {
                        await window.routeElevationChart.loadRouteElevation({
                            geometry: route.geometry
                        });
                    } else if (route.pois && route.pois.length > 0) {
                        await window.routeElevationChart.loadRouteElevation({
                            pois: route.pois.map(poi => ({
                                name: poi.name,
                                latitude: poi.latitude || poi.lat,
                                longitude: poi.longitude || poi.lng || poi.lon
                            }))
                        });
                    }
                }, 500);
            }
        }

        // Show route details in a popup modal
        function showRouteDetailsPopup(routeId) {
            const route = allRoutes.find(r => getRouteId(r) === routeId);
            if (!route) {
                console.error('Route not found:', routeId);
                return;
            }

            const modalHtml = `
                <div class="modal fade" id="routeDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-route me-2"></i>
                                    Rota Detayları - ${escapeHtml(route.name)}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="route-detail-popup">
                                    <div class="route-detail-header">
                                        <div class="route-type-badge route-type-${route.route_type}">
                                            ${ROUTE_TYPES[route.route_type]?.icon || '🗺️'} 
                                            ${ROUTE_TYPES[route.route_type]?.name || route.route_type}
                                        </div>
                                        <div class="difficulty-display">
                                            <span class="difficulty-stars">${getDifficultyStars(route.difficulty_level)}</span>
                                            <span class="difficulty-text">Zorluk: ${route.difficulty_level}/5</span>
                                        </div>
                                    </div>

                                    <div class="route-description-full">
                                        <h6><i class="fas fa-info-circle me-2"></i>Açıklama</h6>
                                        <p>${escapeHtml(route.description || 'Açıklama bulunmuyor')}</p>
                                    </div>

                                    <div class="route-statistics">
                                        <h6><i class="fas fa-chart-bar me-2"></i>İstatistikler</h6>
                                        <div class="stats-grid-popup">
                                            <div class="stat-card-popup">
                                                <div class="stat-icon">
                                                    <i class="fas fa-clock"></i>
                                                </div>
                                                <div class="stat-info">
                                                    <div class="stat-value">${route.estimated_duration || 0}</div>
                                                    <div class="stat-label">Dakika</div>
                                                </div>
                                            </div>
                                            <div class="stat-card-popup">
                                                <div class="stat-icon">
                                                    <i class="fas fa-route"></i>
                                                </div>
                                                <div class="stat-info">
                                                    <div class="stat-value">${(route.total_distance || 0).toFixed(2)}</div>
                                                    <div class="stat-label">Kilometre</div>
                                                </div>
                                            </div>
                                            <div class="stat-card-popup">
                                                <div class="stat-icon">
                                                    <i class="fas fa-mountain"></i>
                                                </div>
                                                <div class="stat-info">
                                                    <div class="stat-value">${route.elevation_gain || 0}</div>
                                                    <div class="stat-label">Yükselti (m)</div>
                                                </div>
                                            </div>
                                            <div class="stat-card-popup">
                                                <div class="stat-icon">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                </div>
                                                <div class="stat-info">
                                                    <div class="stat-value">${route.poi_count || 0}</div>
                                                    <div class="stat-label">POI Sayısı</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    ${route.tags ? `
                                        <div class="route-tags-section">
                                            <h6><i class="fas fa-tags me-2"></i>Etiketler</h6>
                                            <div class="tags-container">
                                                ${route.tags.split(',').map(tag => 
                                                    `<span class="tag-chip">${escapeHtml(tag.trim())}</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    <div class="route-metadata">
                                        <h6><i class="fas fa-info me-2"></i>Metadata</h6>
                                        <div class="metadata-grid-popup">
                                            <div class="metadata-item">
                                                <strong>Oluşturulma:</strong>
                                                <span>${formatDate(route.created_at)}</span>
                                            </div>
                                            <div class="metadata-item">
                                                <strong>Güncellenme:</strong>
                                                <span>${formatDate(route.updated_at)}</span>
                                            </div>
                                            <div class="metadata-item">
                                                <strong>Dairesel Rota:</strong>
                                                <span>${route.is_circular ? 'Evet' : 'Hayır'}</span>
                                            </div>
                                            ${route.import_source ? `
                                                <div class="metadata-item">
                                                    <strong>Import Kaynağı:</strong>
                                                    <span>${escapeHtml(route.import_source)}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="selectRouteFromPopup(${routeId})">
                                    <i class="fas fa-eye me-1"></i>Rotayı Seç ve Görüntüle
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('routeDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('routeDetailsModal'));
            modal.show();
        }

        // Select route from popup and close modal
        function selectRouteFromPopup(routeId) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('routeDetailsModal'));
            if (modal) modal.hide();
            
            // Select the route
            selectRoute(routeId);
        }

        // Add styles for route detail view
        function addRouteDetailStyles() {
            if (document.getElementById('routeDetailStyles')) return;

            const style = document.createElement('style');
            style.id = 'routeDetailStyles';
            style.textContent = `
                .route-detail-view {
                    padding: 0;
                }

                .route-detail-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 1.5rem;
                    padding-bottom: 1rem;
                    border-bottom: 2px solid var(--route-border);
                }

                .difficulty-display {
                    text-align: right;
                }

                .difficulty-text {
                    display: block;
                    font-size: 0.85rem;
                    color: var(--route-secondary);
                    margin-top: 0.25rem;
                }

                .route-description-full {
                    margin-bottom: 1.5rem;
                }

                .route-description-full h5 {
                    color: var(--route-dark);
                    margin-bottom: 0.75rem;
                }

                .route-description-full p {
                    color: var(--route-secondary);
                    line-height: 1.6;
                }

                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 1rem;
                    margin-bottom: 1.5rem;
                }

                .stat-card {
                    background: var(--route-light);
                    border-radius: var(--route-radius);
                    padding: 1rem;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    border: 2px solid var(--route-border);
                    transition: var(--route-transition);
                }

                .stat-card:hover {
                    border-color: var(--route-primary);
                    transform: translateY(-2px);
                }

                .stat-icon {
                    width: 40px;
                    height: 40px;
                    background: var(--route-primary);
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.1rem;
                }

                .stat-value {
                    font-size: 1.25rem;
                    font-weight: 700;
                    color: var(--route-dark);
                }

                .stat-label {
                    font-size: 0.8rem;
                    color: var(--route-secondary);
                }

                .route-tags-section {
                    margin-bottom: 1.5rem;
                }

                .route-tags-section h5 {
                    color: var(--route-dark);
                    margin-bottom: 0.75rem;
                }

                .tags-container {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.5rem;
                }

                .tag-chip {
                    background: var(--route-primary);
                    color: white;
                    padding: 0.25rem 0.75rem;
                    border-radius: 15px;
                    font-size: 0.8rem;
                    font-weight: 500;
                }

                .route-metadata h5 {
                    color: var(--route-dark);
                    margin-bottom: 0.75rem;
                }

                .metadata-grid {
                    display: grid;
                    gap: 0.5rem;
                }

                .metadata-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 0.5rem;
                    background: var(--route-light);
                    border-radius: var(--route-radius);
                    border: 1px solid var(--route-border);
                }

                .metadata-item strong {
                    color: var(--route-dark);
                }

                .metadata-item span {
                    color: var(--route-secondary);
                }
            `;
            document.head.appendChild(style);
        }

        // Update map with filtered routes
        async function updateMapRoutes() {
            console.log('=== updateMapRoutes called ===');
            console.log('filteredRoutes count:', filteredRoutes.length);
            console.log('map object:', map);
            console.log('routeLayers before clear:', Object.keys(routeLayers));
            
            // Clear existing route layers
            Object.values(routeLayers).forEach(layer => {
                map.removeLayer(layer);
            });
            routeLayers = {};
            console.log('Route layers cleared');

            // Determine which routes to draw (reverted to drawing all filtered routes)
            const drawingRoutes = filteredRoutes;
            console.log('Drawing filteredRoutes:', drawingRoutes.map(r => getRouteId(r)));

            // Add chosen routes to map
            for (const route of drawingRoutes) {
                console.log('Processing route:', route.name, 'ID:', getRouteId(route));
                const color = ROUTE_TYPES[route.route_type]?.color || '#2563eb';
                let layer = null;
                try {
                    if (route.geometry) {
                        let geo = route.geometry;
                        console.log('Original geometry for route', route.name, ':', geo);
                        if (typeof geo === 'string') {
                            try { geo = JSON.parse(geo); } catch (e) { console.warn('geometry not JSON string:', e); }
                        }
                        
                        // Handle nested geometry structure from API
                        if (geo && geo.geometry && geo.geometry.type && geo.geometry.coordinates) {
                            geo = geo.geometry; // Extract the actual GeoJSON
                        }
                        
                        console.log('Parsed geometry:', geo);
                        if (geo && typeof geo === 'object' && !Array.isArray(geo) && geo.type && geo.coordinates) {
                            // Valid GeoJSON object
                            console.log('Attempting L.geoJSON with valid GeoJSON:', geo);
                            layer = L.geoJSON(geo, { style: { color, weight: 3, opacity: 0.7 } });
                            console.log('L.geoJSON layer created:', layer ? 'SUCCESS' : 'FAILED');
                            
                            if (layer) {
                                layer.bindPopup(`
                                    <strong>${escapeHtml(route.name)}</strong><br>
                                    ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                    ${route.estimated_duration || 0} dakika
                                `);
                                
                                const rid = getRouteId(route);
                                routeLayers[rid] = layer;
                                layer.addTo(map);
                                console.log('Static geometry layer added for route:', route.name, 'ID:', rid);
                            }
                        } else if (Array.isArray(geo)) {
                            // Assume array of [lng, lat] or [lat, lng]
                            const latlngs = geo.map(p => {
                                if (Array.isArray(p)) {
                                    const a = Number(p[0]);
                                    const b = Number(p[1]);
                                    if (!isNaN(a) && !isNaN(b)) {
                                        if (a >= -180 && a <= 180 && b >= -90 && b <= 90) {
                                            return [b, a];
                                        }
                                        return [a, b];
                                    }
                                }
                                return [p.lat || p.latitude, p.lng || p.longitude];
                            });
                            layer = L.polyline(latlngs, { color, weight: 3, opacity: 0.7 });
                        }
                    } else {
                        console.log('No geometry found for route:', route.name, 'trying POI fallback directly...');
                        // Try POI fallback immediately for routes without geometry
                        const rid = getRouteId(route);
                        if (rid) {
                            try {
                                const rd = await fetch(`${apiBase}/admin/routes/${rid}`, { credentials: 'include' });
                                if (rd.ok) {
                                    const rj = await rd.json();
                                    console.log('Direct POI route detail response:', rj);
                                    const pois = Array.isArray(rj?.pois) ? rj.pois : [];
                                    console.log('Direct POI found for route:', pois.length);
                                    if (pois.length >= 2) {
                                        const latlngs = pois
                                            .sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0))
                                            .map(p => [Number(p.lat || p.latitude), Number(p.lon || p.longitude)])
                                            .filter(arr => Number.isFinite(arr[0]) && Number.isFinite(arr[1]));
                                        console.log('Direct POI valid coordinates:', latlngs);
                                        if (latlngs.length >= 2) {
                                            // Use smart routing API to get real road network route
                                            try {
                                                const waypoints = pois
                                                    .sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0))
                                                    .map(p => ({
                                                        lat: Number(p.lat || p.latitude),
                                                        lng: Number(p.lon || p.longitude),
                                                        name: p.name
                                                    }))
                                                    .filter(wp => Number.isFinite(wp.lat) && Number.isFinite(wp.lng));
                                                    
                                                console.log('Creating smart route with waypoints:', waypoints);
                                                
                                                const routeResponse = await fetch('/api/route/smart', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    credentials: 'include',
                                                    body: JSON.stringify({ waypoints })
                                                });
                                                
                                                if (routeResponse.ok) {
                                    const routeData = await routeResponse.json();
                                    console.log('Smart route response:', routeData);
                                    console.log('Route data structure:', Object.keys(routeData));
                                    console.log('Route.route structure:', routeData.route ? Object.keys(routeData.route) : 'no route key');
                                    
                                    // Check ALL possible response structures
                                    let allCoords = [];
                                    
                                    // Prefer route.segments[].coordinates [{lat,lng}, ...]
                                    if (routeData.route && Array.isArray(routeData.route.segments) && routeData.route.segments.length > 0) {
                                        routeData.route.segments.forEach(seg => {
                                            if (Array.isArray(seg?.coordinates) && seg.coordinates.length > 0) {
                                                seg.coordinates.forEach(pt => {
                                                    const lat = Number(pt.lat);
                                                    const lng = Number(pt.lng);
                                                    if (Number.isFinite(lat) && Number.isFinite(lng)) allCoords.push([lat, lng]);
                                                });
                                            }
                                        });
                                        console.log('Using route.segments.coordinates:', allCoords.length);
                                    } else if (routeData.route && routeData.route.geometry && Array.isArray(routeData.route.geometry)) {
                                        allCoords = routeData.route.geometry;
                                        console.log('Using route.geometry:', allCoords.length);
                                    } else if (routeData.route && routeData.route.coordinates && Array.isArray(routeData.route.coordinates)) {
                                        allCoords = routeData.route.coordinates;
                                        console.log('Using route.coordinates:', allCoords.length);
                                    } else if (routeData.segments && Array.isArray(routeData.segments)) {
                                        routeData.segments.forEach(segment => {
                                            if (Array.isArray(segment)) allCoords.push(...segment);
                                        });
                                        console.log('Using segments:', allCoords.length);
                                    } else if (routeData.route && routeData.route.segments && Array.isArray(routeData.route.segments)) {
                                        routeData.route.segments.forEach(segment => {
                                            if (Array.isArray(segment)) allCoords.push(...segment);
                                        });
                                        console.log('Using route.segments (array arrays):', allCoords.length);
                                    } else {
                                        console.log('No recognized route format found, trying fallback to waypoints');
                                        // Fallback: use original waypoints
                                        allCoords = waypoints.map(wp => [wp.lat, wp.lng]);
                                    }
                                    
                                    if (allCoords.length >= 2) {
                                        layer = L.polyline(allCoords, { color, weight: 4, opacity: 0.8 });
                                        layer.bindPopup(`
                                            <strong>${escapeHtml(route.name)}</strong><br>
                                            ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                            ${Math.round(routeData.total_distance || 0)} km<br>
                                            ${Math.round(routeData.estimated_time || 0)} dakika<br>
                                            <small>Yol ağından hesaplandı</small>
                                        `);
                                        routeLayers[rid] = layer;
                                        layer.addTo(map);
                                        console.log('Smart route added for:', route.name);
                                    }
                                } else {
                                    throw new Error('Smart route API failed');
                                }
                                            } catch (smartRouteError) {
                                                console.warn('Smart route failed, falling back to simple polyline:', smartRouteError);
                                                // Fallback to simple polyline
                                                layer = L.polyline(latlngs, { color, weight: 4, opacity: 0.8 });
                                                layer.bindPopup(`
                                                    <strong>${escapeHtml(route.name)}</strong><br>
                                                    ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                                    ${route.estimated_duration || 0} dakika<br>
                                                    <small>Düz çizgi (yol ağı bulunamadı)</small>
                                                `);
                                                routeLayers[rid] = layer;
                                                layer.addTo(map);
                                                console.log('Fallback polyline added for route:', route.name);
                                            }
                                        }
                                    }
                                }
                            } catch (e) {
                                console.warn('Direct POI fallback failed:', e);
                            }
                        }
                        
                        // Original geometry fetch fallback
                        // Try lazy fetch of geometry and retry once
                        try {
                            const rid = getRouteId(route);
                            if (rid) {
                                console.log('Fetching geometry for route ID:', rid);
                                const res = await fetch(`${apiBase}/routes/${rid}/geometry`, { credentials: 'include' });
                                if (res.ok) {
                                    const g = await res.json();
                                    console.log('Geometry response:', g);
                                    if (g && g.geometry) {
                                        let geo = g.geometry;
                                        if (typeof geo === 'string') {
                                            try { geo = JSON.parse(geo); } catch(e) {}
                                        }
                                        route.geometry = geo;
                                        // Retry build
                                        if (geo && typeof geo === 'object') {
                                            layer = L.geoJSON(geo, { style: { color, weight: 3, opacity: 0.7 } });
                                        }
                                        if (layer) {
                                            layer.bindPopup(`
                                                <strong>${escapeHtml(route.name)}</strong><br>
                                                ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                                ${route.estimated_duration || 0} dakika
                                            `);
                                } else if (res.status === 404) {
                                    console.warn(`Route ${rid} geometry not found (404) - skipping map display`);
                                    // Route has no geometry, skip adding to map but don't show error
                                    continue;
                                } else {
                                    console.error(`Failed to fetch geometry for route ${rid}: ${res.status}`);
                                    continue;
                                            const rid2 = getRouteId(route);
                                            routeLayers[rid2] = layer;
                                            layer.addTo(map);
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('Lazy geometry fetch failed:', e);
                        }
                    }
                } catch (error) {
                    console.warn('Route geometry parse error:', error);
                    console.log('ERROR CAUGHT! Now trying POI fallback for route:', route.name);
                    const rid = getRouteId(route);
                    console.log('Route ID for POI fallback:', rid);
                    if (rid) {
                        console.log('Geometry failed, trying POI fallback for route:', route.name);
                        try {
                            const rd = await fetch(`${apiBase}/admin/routes/${rid}`, { credentials: 'include' });
                            if (rd.ok) {
                                const rj = await rd.json();
                                console.log('Route detail response:', rj);
                                const pois = Array.isArray(rj?.pois) ? rj.pois : [];
                                console.log('Found POIs for route:', pois.length);
                                if (pois.length >= 2) {
                                    const latlngs = pois
                                        .sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0))
                                        .map(p => [Number(p.lat || p.latitude), Number(p.lon || p.longitude)])
                                        .filter(arr => Number.isFinite(arr[0]) && Number.isFinite(arr[1]));
                                    console.log('Valid coordinates:', latlngs);
                                    if (latlngs.length >= 2) {
                                        // Smart routing for error fallback
                                        try {
                                            const waypoints = pois
                                                .sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0))
                                                .map(p => ({
                                                    lat: Number(p.lat || p.latitude),
                                                    lng: Number(p.lon || p.longitude),
                                                    name: p.name
                                                }))
                                                .filter(wp => Number.isFinite(wp.lat) && Number.isFinite(wp.lng));
                                                
                                            const routeResponse = await fetch('/api/route/smart', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                credentials: 'include',
                                                body: JSON.stringify({ waypoints })
                                            });
                                            
                                            if (routeResponse.ok) {
                                                const routeData = await routeResponse.json();
                                                if (routeData.route && Array.isArray(routeData.route.segments)) {
                                                    const coords = [];
                                                    routeData.route.segments.forEach(seg => {
                                                        if (Array.isArray(seg?.coordinates)) {
                                                            seg.coordinates.forEach(pt => {
                                                                const lat = Number(pt.lat);
                                                                const lng = Number(pt.lng);
                                                                if (Number.isFinite(lat) && Number.isFinite(lng)) coords.push([lat, lng]);
                                                            });
                                                        }
                                                    });
                                                    if (coords.length >= 2) {
                                                        layer = L.polyline(coords, { color, weight: 4, opacity: 0.8 });
                                                        layer.bindPopup(`
                                                            <strong>${escapeHtml(route.name)}</strong><br>
                                                            ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                                            <small>Yol ağından hesaplandı</small>
                                                        `);
                                                        routeLayers[rid] = layer;
                                                        layer.addTo(map);
                                                        console.log('Smart route added from error fallback:', route.name);
                                                    }
                                                }
                                            } else {
                                                throw new Error('Smart route failed');
                                            }
                                        } catch (smartError) {
                                            console.warn('Smart routing failed in error fallback, using simple polyline:', smartError);
                                            layer = L.polyline(latlngs, { color, weight: 4, opacity: 0.8 });
                                            layer.bindPopup(`
                                                <strong>${escapeHtml(route.name)}</strong><br>
                                                ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                                                ${route.estimated_duration || 0} dakika<br>
                                                <small>Düz çizgi (yol ağı bulunamadı)</small>
                                            `);
                                            routeLayers[rid] = layer;
                                            layer.addTo(map);
                                            console.log('Final fallback polyline for route:', route.name);
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('POI fallback failed:', e);
                        }
                    }
                }
            }

            // Fit map to show all drawn routes
            console.log('Total route layers added:', Object.keys(routeLayers).length);
            if (Object.keys(routeLayers).length > 0) {
                const group = new L.featureGroup(Object.values(routeLayers));
                map.fitBounds(group.getBounds(), { padding: [20, 20] });
                console.log('Map fitted to route bounds');
            } else {
                console.log('No route layers to display, invalidating map size');
                setTimeout(() => { try { map.invalidateSize(); } catch(e) {} }, 100);
            }
        }

        // Update map title based on selected route
        function updateMapTitle(route = null) {
            const mapTitle = document.getElementById('mapTitle');
            if (route) {
                mapTitle.innerHTML = `
                    <i class="fas fa-map me-2"></i>
                    <span style="color: ${ROUTE_TYPES[route.route_type]?.color || '#2563eb'}">
                        ${escapeHtml(route.name)}
                    </span>
                `;
            } else {
                mapTitle.innerHTML = `
                    <i class="fas fa-map me-2"></i>
                    Harita Görünümü
                `;
            }
        }

        // Highlight and focus on selected route - sadece seçili rotayı göster
        async function highlightAndFocusRoute(route) {
            console.log('Highlighting and focusing on route:', route.name);
            
            const rid = getRouteId(route);
            if (!rid) {
                console.warn('No route ID found');
                return;
            }

            // Update map title
            updateMapTitle(route);

            // Önce tüm rotaları haritadan kaldır
            clearAllRoutesFromMap();
            
            // Sadece seçili rotayı haritaya ekle
            await showSingleRouteOnMap(route);
            
            // Seçili rotanın POI'lerini yükle ve göster
            setTimeout(async () => {
                await loadAndDisplayRoutePOIs(rid);
            }, 100);
        }

        // Load and display POI markers for a specific route
        async function loadAndDisplayRoutePOIs(routeId) {
            if (!poiMarkersLayer) return;
            
            // Clear existing POI markers
            poiMarkersLayer.clearLayers();
            
            try {
                const routeDetailResp = await fetch(`${apiBase}/admin/routes/${routeId}`, { credentials: 'include' });
                
                if (routeDetailResp.ok) {
                    const routeDetail = await routeDetailResp.json();
                    const pois = Array.isArray(routeDetail?.pois) ? routeDetail.pois : [];
                    
                    if (pois.length > 0) {
                        console.log('Adding POI markers for route:', pois.length);
                        
                        // Sort POIs by order
                        const sortedPois = pois.sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0));
                        
                        // Add POI markers with category icons
                        sortedPois.forEach((poi, index) => {
                            const lat = Number(poi.lat || poi.latitude);
                            const lng = Number(poi.lon || poi.longitude);
                            
                            if (Number.isFinite(lat) && Number.isFinite(lng)) {
                                // Get category info for custom icon
                                const category = POI_CATEGORIES[poi.category] || { 
                                    icon: 'map-marker-alt', 
                                    color: '#2563eb',
                                    name: poi.category || 'Kategori yok'
                                };

                                // Create custom POI icon
                                const customIcon = L.divIcon({
                                    className: 'custom-poi-marker',
                                    html: `
                                        <div class="poi-marker-container" style="background-color: ${category.color}">
                                            <i class="fas fa-${category.icon}"></i>
                                            <div class="poi-order-number">${poi.order_in_route || index + 1}</div>
                                        </div>
                                    `,
                                    iconSize: [35, 35],
                                    iconAnchor: [17, 35],
                                    popupAnchor: [0, -35]
                                });

                                const marker = L.marker([lat, lng], {
                                    icon: customIcon,
                                    title: poi.name || `POI ${index + 1}`
                                });
                                
                                marker.bindPopup(`
                                    <div class="poi-popup">
                                        <div class="poi-popup-header">
                                            <i class="fas fa-${category.icon}" style="color: ${category.color}"></i>
                                            <strong>${escapeHtml(poi.name || 'POI')}</strong>
                                        </div>
                                        <div class="poi-popup-category">${category.name}</div>
                                        ${poi.description ? `<div class="poi-popup-description">${escapeHtml(poi.description.substring(0, 100))}${poi.description.length > 100 ? '...' : ''}</div>` : ''}
                                        <div class="poi-popup-order">Sıra: ${poi.order_in_route || index + 1}</div>
                                    </div>
                                `);
                                
                                poiMarkersLayer.addLayer(marker);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading route POIs:', error);
            }
        }

        // Show selected route on map with focus
        async function showSelectedRouteOnMap(route) {
            console.log('=== showSelectedRouteOnMap called ===');
            console.log('Selected route:', route.name, 'ID:', getRouteId(route));
            
            const rid = getRouteId(route);
            if (!rid) {
                console.warn('No route ID found');
                return;
            }

            // Clear existing route layers to show only selected route
            Object.values(routeLayers).forEach(layer => {
                try { map.removeLayer(layer); } catch (e) {}
            });
            routeLayers = {};

            // Clear POI markers
            if (poiMarkersLayer) {
                poiMarkersLayer.clearLayers();
            }

            let routeLayer = null;
            const color = ROUTE_TYPES[route.route_type]?.color || '#2563eb';

            try {
                // First try to use existing geometry
                if (route.geometry) {
                    let geo = route.geometry;
                    if (typeof geo === 'string') {
                        try { geo = JSON.parse(geo); } catch(e) { console.warn('geometry not JSON:', e); }
                    }
                    
                    if (geo && typeof geo === 'object' && geo.type && geo.coordinates) {
                        routeLayer = L.geoJSON(geo, { 
                            style: { color, weight: 4, opacity: 0.9 } 
                        });
                        console.log('Route created from existing geometry');
                    }
                }

                // If no geometry, try to build from POIs
                if (!routeLayer) {
                    console.log('No geometry found, trying POI-based route');
                    const routeDetailResp = await fetch(`${apiBase}/admin/routes/${rid}`, { credentials: 'include' });
                    
                    if (routeDetailResp.ok) {
                        const routeDetail = await routeDetailResp.json();
                        const pois = Array.isArray(routeDetail?.pois) ? routeDetail.pois : [];
                        console.log('Found POIs for route:', pois.length);

                        if (pois.length >= 2) {
                            // Sort POIs by order
                            const sortedPois = pois.sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0));
                            
                            // Create waypoints for smart routing
                            const waypoints = sortedPois
                                .map(p => ({
                                    lat: Number(p.lat || p.latitude),
                                    lng: Number(p.lon || p.longitude),
                                    name: p.name
                                }))
                                .filter(wp => Number.isFinite(wp.lat) && Number.isFinite(wp.lng));

                            console.log('Waypoints for smart routing:', waypoints.length);

                            if (waypoints.length >= 2) {
                                try {
                                    // Try smart routing first
                                    const routeResponse = await fetch('/api/route/smart', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        credentials: 'include',
                                        body: JSON.stringify({ waypoints })
                                    });

                                    if (routeResponse.ok) {
                                        const routeData = await routeResponse.json();
                                        console.log('Smart route response:', routeData);

                                        let allCoords = [];
                                        
                                        // Extract coordinates from smart route response
                                        if (routeData.route && Array.isArray(routeData.route.segments)) {
                                            routeData.route.segments.forEach(seg => {
                                                if (Array.isArray(seg?.coordinates)) {
                                                    seg.coordinates.forEach(pt => {
                                                        const lat = Number(pt.lat);
                                                        const lng = Number(pt.lng);
                                                        if (Number.isFinite(lat) && Number.isFinite(lng)) {
                                                            allCoords.push([lat, lng]);
                                                        }
                                                    });
                                                }
                                            });
                                        }

                                        if (allCoords.length >= 2) {
                                            routeLayer = L.polyline(allCoords, { 
                                                color, weight: 4, opacity: 0.9 
                                            });
                                            console.log('Smart route layer created');
                                        }
                                    }
                                } catch (smartError) {
                                    console.warn('Smart routing failed:', smartError);
                                }

                                // Fallback to simple polyline if smart routing failed
                                if (!routeLayer) {
                                    const simpleCoords = waypoints.map(wp => [wp.lat, wp.lng]);
                                    routeLayer = L.polyline(simpleCoords, { 
                                        color, weight: 4, opacity: 0.9 
                                    });
                                    console.log('Fallback polyline created');
                                }
                            }

                            // Add POI markers with category icons
                            sortedPois.forEach((poi, index) => {
                                const lat = Number(poi.lat || poi.latitude);
                                const lng = Number(poi.lon || poi.longitude);
                                
                                if (Number.isFinite(lat) && Number.isFinite(lng)) {
                                    // Get category info for custom icon
                                    const category = POI_CATEGORIES[poi.category] || { 
                                        icon: 'map-marker-alt', 
                                        color: '#2563eb',
                                        name: poi.category || 'Kategori yok'
                                    };

                                    // Create custom POI icon
                                    const customIcon = L.divIcon({
                                        className: 'custom-poi-marker',
                                        html: `
                                            <div class="poi-marker-container" style="background-color: ${category.color}">
                                                <i class="fas fa-${category.icon}"></i>
                                                <div class="poi-order-number">${poi.order_in_route || index + 1}</div>
                                            </div>
                                        `,
                                        iconSize: [35, 35],
                                        iconAnchor: [17, 35],
                                        popupAnchor: [0, -35]
                                    });

                                    const marker = L.marker([lat, lng], {
                                        icon: customIcon,
                                        title: poi.name || `POI ${index + 1}`
                                    });
                                    
                                    marker.bindPopup(`
                                        <div class="poi-popup">
                                            <div class="poi-popup-header">
                                                <i class="fas fa-${category.icon}" style="color: ${category.color}"></i>
                                                <strong>${escapeHtml(poi.name || 'POI')}</strong>
                                            </div>
                                            <div class="poi-popup-category">${category.name}</div>
                                            ${poi.description ? `<div class="poi-popup-description">${escapeHtml(poi.description.substring(0, 100))}${poi.description.length > 100 ? '...' : ''}</div>` : ''}
                                            <div class="poi-popup-order">Sıra: ${poi.order_in_route || index + 1}</div>
                                        </div>
                                    `);
                                    
                                    poiMarkersLayer.addLayer(marker);
                                }
                            });
                        }
                    }
                }

                // Add route layer to map if created
                if (routeLayer) {
                    routeLayer.bindPopup(`
                        <strong>${escapeHtml(route.name)}</strong><br>
                        ${ROUTE_TYPES[route.route_type]?.name || route.route_type}<br>
                        ${route.estimated_duration || 0} dakika
                    `);
                    
                    routeLayers[rid] = routeLayer;
                    routeLayer.addTo(map);
                    console.log('Route layer added to map');

                    // Fit map to route and POIs
                    try {
                        const layers = [routeLayer];
                        if (poiMarkersLayer.getLayers().length > 0) {
                            layers.push(poiMarkersLayer);
                        }
                        const group = new L.featureGroup(layers);
                        map.fitBounds(group.getBounds(), { padding: [50, 50] });
                        console.log('Map fitted to route bounds');
                    } catch (e) {
                        console.warn('Failed to fit bounds:', e);
                    }
                } else {
                    console.warn('Could not create route layer');
                    showNotification('Rota haritada görüntülenemedi', 'warning');
                }

            } catch (error) {
                console.error('Error showing route on map:', error);
                showNotification('Rota görüntülenirken hata oluştu', 'error');
            }
        }

        // Render POI markers for a route on the map
        async function renderRoutePoisOnMap(routeId) {
            if (!poiMarkersLayer) return;
            try { poiMarkersLayer.clearLayers(); } catch (e) {}

            try {
                const resp = await fetch(`${apiBase}/admin/routes/${routeId}/pois`, { credentials: 'include' });
                if (!resp.ok) return;
                const data = await resp.json();
                const pois = Array.isArray(data?.pois) ? data.pois : (Array.isArray(data) ? data : []);
                // Sort by order_in_route if available
                pois.sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0));
                pois.forEach((p, idx) => {
                    const lat = Number(p.lat || p.latitude);
                    const lng = Number(p.lon || p.longitude);
                    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
                    const marker = L.marker([lat, lng], {
                        title: p.name || `POI ${idx + 1}`
                    });
                    marker.bindPopup(`
                        <strong>${escapeHtml(p.name || 'POI')}</strong><br/>
                        ${p.category ? escapeHtml(p.category) : ''}<br/>
                        <small>Sıra: ${p.order_in_route || idx + 1}</small>
                    `);
                    poiMarkersLayer.addLayer(marker);
                });
            } catch (e) {
                console.warn('renderRoutePoisOnMap failed:', e);
            }
        }

        // Utility functions
        function getDifficultyStars(level) {
            return '⭐'.repeat(level || 0) + '☆'.repeat(5 - (level || 0));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Bilinmiyor';
            return new Date(dateString).toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading() {
            document.getElementById('routeListContainer').innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            `;
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>${message}</span>
                    <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Resizable Map Functionality
        function setupResizableMap() {
            const resizeHandle = document.getElementById('resizeHandle');
            const container = document.getElementById('routeContainer');
            let isResizing = false;
            let startX = 0;
            let startMapWidth = 600;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startMapWidth = getCurrentMapWidth();
                resizeHandle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const deltaX = startX - e.clientX; // Reversed because we're moving from right
                const newMapWidth = Math.max(400, Math.min(800, startMapWidth + deltaX));
                
                // Update grid template columns
                container.style.gridTemplateColumns = `380px 1fr ${newMapWidth}px`;
                
                // Update resize handle position
                resizeHandle.style.right = `${newMapWidth + 20}px`;
                
                // Invalidate map size
                if (map) {
                    setTimeout(() => map.invalidateSize(), 10);
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizeHandle.classList.remove('dragging');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    
                    // Final map size invalidation
                    if (map) {
                        setTimeout(() => map.invalidateSize(), 100);
                    }
                }
            });

            // Get current map width from computed styles
            function getCurrentMapWidth() {
                const computedStyle = window.getComputedStyle(container);
                const columns = computedStyle.gridTemplateColumns.split(' ');
                const mapColumn = columns[2];
                return parseInt(mapColumn) || 600;
            }
        }

        // Action handlers
        function refreshRoutes() {
            // Rate limiting kontrolü - Geliştirme için devre dışı
            // const now = Date.now();
            // if ((now - lastLoadTime) < minLoadInterval) {
            //     showNotification('Çok sık yenileme yapıyorsunuz, lütfen bekleyin', 'warning');
            //     return;
            // }
            loadRoutes();
        }

        function clearMapRoutes() {
            clearAllRoutesFromMap();
            // POI marker'larını da temizle
            if (poiMarkersLayer) {
                poiMarkersLayer.clearLayers();
            }
            // Seçili rotayı sıfırla
            currentRoute = null;
            // UI'dan seçimi kaldır
            document.querySelectorAll('.route-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Workspace'i gizle
            hideWorkspace();
            showNotification('Harita temizlendi', 'success');
        }

        function showCreateRouteModal() {
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="createRouteModal" tabindex="-1" aria-labelledby="createRouteModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="createRouteModalLabel">
                                    <i class="fas fa-plus-circle me-2"></i>Yeni Rota Oluştur
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createRouteForm">
                                    <div class="mb-3">
                                        <label for="routeName" class="form-label">Rota Adı *</label>
                                        <input type="text" class="form-control" id="routeName" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="routeDescription" class="form-label">Açıklama</label>
                                        <textarea class="form-control" id="routeDescription" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="routeType" class="form-label">Rota Tipi *</label>
                                                <select class="form-select" id="routeType" required>
                                                    <option value="">Seçiniz</option>
                                                    <option value="walking">Yürüyüş</option>
                                                    <option value="hiking">Doğa Yürüyüşü</option>
                                                    <option value="cycling">Bisiklet</option>
                                                    <option value="driving">Araç</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="difficultyLevel" class="form-label">Zorluk Seviyesi *</label>
                                                <select class="form-select" id="difficultyLevel" required>
                                                    <option value="">Seçiniz</option>
                                                    <option value="1">1 - Çok Kolay</option>
                                                    <option value="2">2 - Kolay</option>
                                                    <option value="3">3 - Orta</option>
                                                    <option value="4">4 - Zor</option>
                                                    <option value="5">5 - Çok Zor</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="estimatedDuration" class="form-label">Tahmini Süre (dakika)</label>
                                                <input type="number" class="form-control" id="estimatedDuration" min="1">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="totalDistance" class="form-label">Toplam Mesafe (km)</label>
                                                <input type="number" class="form-control" id="totalDistance" min="0" step="0.1">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="isCircular" class="form-label">
                                            <input type="checkbox" id="isCircular" class="form-check-input me-2">
                                            Dairesel Rota (başlangıç ve bitiş aynı nokta)
                                        </label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="tags" class="form-label">Etiketler</label>
                                        <input type="text" class="form-control" id="tags" placeholder="Örn: doğa, tarih, fotoğraf (virgülle ayırın)">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                <button type="button" class="btn btn-primary" onclick="createNewRoute()">
                                    <i class="fas fa-save me-2"></i>Rotayı Oluştur
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('createRouteModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createRouteModal'));
            modal.show();
        }

        // Create new route function
        async function createNewRoute() {
            // Get form data
            const form = document.getElementById('createRouteForm');
            const formData = new FormData(form);
            
            const routeData = {
                name: document.getElementById('routeName').value.trim(),
                description: document.getElementById('routeDescription').value.trim(),
                route_type: document.getElementById('routeType').value,
                difficulty_level: parseInt(document.getElementById('difficultyLevel').value),
                estimated_duration: parseInt(document.getElementById('estimatedDuration').value) || 0,
                total_distance: parseFloat(document.getElementById('totalDistance').value) || 0,
                is_circular: document.getElementById('isCircular').checked,
                tags: document.getElementById('tags').value.trim(),
                is_active: true
            };
            
            // Validation
            if (!routeData.name) {
                showNotification('Rota adı zorunludur!', 'error');
                return;
            }
            
            if (!routeData.route_type) {
                showNotification('Rota tipi seçiniz!', 'error');
                return;
            }
            
            if (!routeData.difficulty_level) {
                showNotification('Zorluk seviyesi seçiniz!', 'error');
                return;
            }
            
            try {
                // Send to API
                const response = await fetch('/api/admin/routes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': window.csrfToken || ''
                    },
                    body: JSON.stringify(routeData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createRouteModal'));
                    modal.hide();
                    
                    // Refresh routes list
                    loadRoutes();
                    
                    showNotification('✅ Yeni rota başarıyla oluşturuldu!', 'success');
                    
                    // Optionally select the new route
                    if (result.route && result.route.id) {
                        setTimeout(() => {
                            selectRoute(result.route.id);
                        }, 1000);
                    }
                } else {
                    const error = await response.json();
                    showNotification(`❌ Rota oluşturulamadı: ${error.message || 'Bilinmeyen hata'}`, 'error');
                }
            } catch (error) {
                console.error('Error creating route:', error);
                showNotification('❌ Rota oluşturulurken hata oluştu', 'error');
            }
        }

        // Map fullscreen functionality
        function toggleMapFullscreen() {
            const mapView = document.querySelector('.route-map-view');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const icon = fullscreenBtn.querySelector('i');
            
            if (mapView.classList.contains('fullscreen')) {
                // Exit fullscreen
                mapView.classList.remove('fullscreen');
                document.body.classList.remove('map-fullscreen');
                icon.className = 'fas fa-expand';
                fullscreenBtn.title = 'Tam Ekran';
            } else {
                // Enter fullscreen
                mapView.classList.add('fullscreen');
                document.body.classList.add('map-fullscreen');
                icon.className = 'fas fa-compress';
                fullscreenBtn.title = 'Tam Ekrandan Çık';
            }
            
            // Invalidate map size after transition
            setTimeout(() => {
                if (map) map.invalidateSize();
            }, 300);
        }

        // Map layer toggle functions
        function toggleMapLayer(layerType) {
            showNotification(`${layerType} katmanı özelliği yakında eklenecek`, 'info');
        }

        function fitMapToRoutes() {
            if (map && Object.keys(routeLayers).length > 0) {
                // If there's a selected route, focus on it; otherwise show all routes
                if (currentRoute && routeLayers[getRouteId(currentRoute)]) {
                    const selectedLayer = routeLayers[getRouteId(currentRoute)];
                    const layers = [selectedLayer];
                    
                    // Include POI markers if they exist
                    if (poiMarkersLayer && poiMarkersLayer.getLayers().length > 0) {
                        layers.push(poiMarkersLayer);
                    }
                    
                    const group = new L.featureGroup(layers);
                    map.fitBounds(group.getBounds(), { 
                        padding: [30, 30],
                        maxZoom: 14,
                        animate: true,
                        duration: 0.8
                    });
                    showNotification(`${currentRoute.name} rotasına odaklanıldı`, 'info');
                } else {
                    // Show all routes
                    const group = new L.featureGroup(Object.values(routeLayers));
                    map.fitBounds(group.getBounds(), { 
                        padding: [20, 20],
                        animate: true,
                        duration: 0.8
                    });
                    showNotification('Tüm rotalara odaklanıldı', 'info');
                }
            } else {
                showNotification('Görüntülenecek rota bulunamadı', 'warning');
            }
        }

        function editCurrentRoute() {
            if (currentRoute) {
                displayRouteEditForm(currentRoute);
            }
        }

        // Display route editing form in workspace
        function displayRouteEditForm(route) {
            const workspaceTitle = document.getElementById('workspaceTitle');
            const workspaceActions = document.getElementById('workspaceActions');
            const workspaceContent = document.getElementById('workspaceContent');

            workspaceTitle.textContent = `${route.name} - Düzenleme`;
            workspaceActions.innerHTML = `
                <button class="btn-workspace" onclick="saveRouteChanges()">
                    <i class="fas fa-save me-1"></i>
                    Kaydet
                </button>
                <button class="btn-workspace" onclick="cancelRouteEdit()">
                    <i class="fas fa-times me-1"></i>
                    İptal
                </button>
            `;

            workspaceContent.innerHTML = `
                <div class="route-edit-form">
                    <form id="routeEditForm">
                        <div class="form-section">
                            <h5><i class="fas fa-info-circle me-2"></i>Temel Bilgiler</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editRouteName">Rota Adı *</label>
                                    <input type="text" id="editRouteName" class="form-control" 
                                           value="${escapeHtml(route.name)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editRouteType">Rota Türü *</label>
                                    <select id="editRouteType" class="form-control" required>
                                        <option value="walking" ${route.route_type === 'walking' ? 'selected' : ''}>🚶 Yürüyüş</option>
                                        <option value="hiking" ${route.route_type === 'hiking' ? 'selected' : ''}>🥾 Doğa Yürüyüşü</option>
                                        <option value="cycling" ${route.route_type === 'cycling' ? 'selected' : ''}>🚴 Bisiklet</option>
                                        <option value="driving" ${route.route_type === 'driving' ? 'selected' : ''}>🚗 Araba</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="editRouteDescription">Açıklama</label>
                                <textarea id="editRouteDescription" class="form-control" rows="3">${escapeHtml(route.description || '')}</textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h5><i class="fas fa-chart-bar me-2"></i>Rota Özellikleri</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editDifficulty">Zorluk Seviyesi</label>
                                    <select id="editDifficulty" class="form-control">
                                        <option value="1" ${route.difficulty_level === 1 ? 'selected' : ''}>⭐ Çok Kolay</option>
                                        <option value="2" ${route.difficulty_level === 2 ? 'selected' : ''}>⭐⭐ Kolay</option>
                                        <option value="3" ${route.difficulty_level === 3 ? 'selected' : ''}>⭐⭐⭐ Orta</option>
                                        <option value="4" ${route.difficulty_level === 4 ? 'selected' : ''}>⭐⭐⭐⭐ Zor</option>
                                        <option value="5" ${route.difficulty_level === 5 ? 'selected' : ''}>⭐⭐⭐⭐⭐ Çok Zor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editDuration">Tahmini Süre (dakika)</label>
                                    <input type="number" id="editDuration" class="form-control" 
                                           value="${route.estimated_duration || ''}" min="1">
                                </div>
                                <div class="form-group">
                                    <label for="editDistance">Mesafe (km)</label>
                                    <input type="number" id="editDistance" class="form-control" 
                                           value="${route.total_distance || ''}" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="editElevation">Yükselti Kazancı (m)</label>
                                    <input type="number" id="editElevation" class="form-control" 
                                           value="${route.elevation_gain || ''}" min="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="editTags">Etiketler (virgülle ayırın)</label>
                                <input type="text" id="editTags" class="form-control" 
                                       value="${escapeHtml(route.tags || '')}" 
                                       placeholder="tarihi, doğa, macera">
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="editIsCircular" class="form-check-input" 
                                           ${route.is_circular ? 'checked' : ''}>
                                    <label for="editIsCircular" class="form-check-label">
                                        Dairesel Rota (Başlangıç = Bitiş)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h5><i class="fas fa-map-marker-alt me-2"></i>POI İlişkilendirme</h5>
                            <div class="poi-association-container">
                <div class="poi-search-section" onsubmit="return false;">
                                    <div class="search-container">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="poiSearchInput" 
                                               placeholder="POI ara..." oninput="searchPOIs()">
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary" onclick="findNearbyPOIs()">
                                            <i class="fas fa-search-location me-1"></i>
                                            Yakın POI'leri Bul
                                        </button>
                                        <button type="button" class="btn btn-outline-success" onclick="autoAssociateNearbyPOIs()">
                                            <i class="fas fa-magic me-1"></i>
                                            Otomatik Ekle
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="testNearbyFeature()">
                                            <i class="fas fa-bug me-1"></i>
                                            Test
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="poi-lists-container">
                                    <div class="available-pois">
                                        <h6>Mevcut POI'ler</h6>
                                        <div id="availablePOIsList" class="poi-list">
                                            <div class="loading-spinner">
                                                <div class="spinner"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="associated-pois">
                                        <h6>İlişkilendirilmiş POI'ler</h6>
                                        <div id="associatedPOIsList" class="poi-list">
                                            <!-- Associated POIs will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h5><i class="fas fa-download me-2"></i>Dışa Aktarma Seçenekleri</h5>
                            <div class="export-options">
                                <button type="button" class="btn btn-outline-info" onclick="exportRouteAsGPX(${getRouteId(route)})">
                                    <i class="fas fa-file-code me-1"></i>
                                    GPX Olarak İndir
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="exportRouteAsKML(${getRouteId(route)})">
                                    <i class="fas fa-globe me-1"></i>
                                    KML Olarak İndir
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="exportRouteAsJSON(${getRouteId(route)})">
                                    <i class="fas fa-code me-1"></i>
                                    JSON Olarak İndir
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="printRouteDetails(${getRouteId(route)})">
                                    <i class="fas fa-print me-1"></i>
                                    Yazdır
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            `;

            // Add CSS for edit form
            addRouteEditFormStyles();
            
            // Load POIs for association
            loadPOIsForAssociation(getRouteId(route));
        }

        // Add styles for route edit form
        function addRouteEditFormStyles() {
            if (document.getElementById('routeEditFormStyles')) return;

            const style = document.createElement('style');
            style.id = 'routeEditFormStyles';
            style.textContent = `
                .route-edit-form {
                    padding: 0;
                }

                .form-section {
                    margin-bottom: 2rem;
                    padding-bottom: 1.5rem;
                    border-bottom: 2px solid var(--route-border);
                }

                .form-section:last-child {
                    border-bottom: none;
                }

                .form-section h5 {
                    color: var(--route-dark);
                    margin-bottom: 1rem;
                    font-weight: 600;
                }

                .form-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 1rem;
                    margin-bottom: 1rem;
                }

                .form-group {
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .form-group label {
                    font-weight: 600;
                    color: var(--route-dark);
                    font-size: 0.9rem;
                }

                .form-control {
                    padding: 0.75rem;
                    border: 2px solid var(--route-border);
                    border-radius: var(--route-radius);
                    font-size: 0.9rem;
                    transition: var(--route-transition);
                }

                .form-control:focus {
                    outline: none;
                    border-color: var(--route-primary);
                    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
                }

                .form-check {
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    margin-top: 0.5rem;
                }

                .form-check-input {
                    width: 18px;
                    height: 18px;
                }

                .poi-association-container {
                    background: var(--route-light);
                    border-radius: var(--route-radius);
                    padding: 1rem;
                    border: 2px solid var(--route-border);
                }

                .poi-search-section {
                    display: flex;
                    gap: 1rem;
                    align-items: center;
                    margin-bottom: 1rem;
                }

                .poi-search-section .search-container {
                    flex: 1;
                }

                .poi-lists-container {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 1rem;
                }

                .available-pois, .associated-pois {
                    background: white;
                    border-radius: var(--route-radius);
                    padding: 1rem;
                    border: 2px solid var(--route-border);
                }

                .available-pois h6, .associated-pois h6 {
                    margin-bottom: 0.75rem;
                    color: var(--route-dark);
                    font-weight: 600;
                }

                .poi-list {
                    max-height: 200px;
                    overflow-y: auto;
                }

                .poi-item-small {
                    background: var(--route-light);
                    border: 1px solid var(--route-border);
                    border-radius: var(--route-radius);
                    padding: 0.75rem;
                    margin-bottom: 0.5rem;
                    cursor: pointer;
                    transition: var(--route-transition);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .poi-item-small:hover {
                    border-color: var(--route-primary);
                    background: white;
                }

                .poi-item-info {
                    flex: 1;
                }

                .poi-item-name {
                    font-weight: 600;
                    color: var(--route-dark);
                    font-size: 0.9rem;
                }

                .poi-item-category {
                    font-size: 0.8rem;
                    color: var(--route-secondary);
                }

                .poi-item-actions {
                    display: flex;
                    gap: 0.25rem;
                }

                .btn-poi-action {
                    padding: 0.25rem 0.5rem;
                    border: none;
                    border-radius: 15px;
                    font-size: 0.75rem;
                    cursor: pointer;
                    transition: var(--route-transition);
                }

                .btn-add-poi {
                    background: var(--route-success);
                    color: white;
                }

                .btn-remove-poi {
                    background: var(--route-danger);
                    color: white;
                }

                .poi-order-badge {
                    display: inline-block;
                    background: var(--route-primary);
                    color: white;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    text-align: center;
                    line-height: 20px;
                    font-size: 0.7rem;
                    font-weight: bold;
                    margin-right: 0.5rem;
                }

                .export-options {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.75rem;
                }

                .export-options .btn {
                    padding: 0.5rem 1rem;
                    border-radius: 20px;
                    font-size: 0.85rem;
                    font-weight: 500;
                }

                @media (max-width: 768px) {
                    .form-grid {
                        grid-template-columns: 1fr;
                    }

                    .poi-lists-container {
                        grid-template-columns: 1fr;
                    }

                    .poi-search-section {
                        flex-direction: column;
                        align-items: stretch;
                    }

                    .export-options {
                        flex-direction: column;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // Load POIs for association
        async function loadPOIsForAssociation(routeId) {
            console.log('Loading POIs for association with route:', routeId);
            
            try {
                // Show loading state
                const availableContainer = document.getElementById('availablePOIsList');
                const associatedContainer = document.getElementById('associatedPOIsList');
                
                if (availableContainer) {
                    availableContainer.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
                }
                if (associatedContainer) {
                    associatedContainer.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
                }

                // Load all POIs
                const poisResponse = await fetch(`${apiBase}/pois`, { credentials: 'include' });
                let allPOIs = [];
                
                if (poisResponse.ok) {
                    const raw = await poisResponse.json();
                    console.log('All POIs response:', raw);
                    
                    if (Array.isArray(raw)) {
                        allPOIs = raw;
                    } else if (Array.isArray(raw.pois)) {
                        allPOIs = raw.pois;
                    } else if (Array.isArray(raw.results)) {
                        allPOIs = raw.results;
                    } else {
                        // Handle categorized POIs
                        Object.values(raw || {}).forEach(v => { 
                            if (Array.isArray(v)) allPOIs = allPOIs.concat(v); 
                        });
                    }
                    console.log('Processed all POIs:', allPOIs.length);
                } else {
                    console.error('Failed to load POIs:', poisResponse.status);
                    throw new Error('POI\'ler yüklenemedi');
                }
                
                // Load route detail with associated POIs
                const routeDetailResp = await fetch(`${apiBase}/admin/routes/${routeId}`, { credentials: 'include' });
                let associatedPOIs = [];
                
                if (routeDetailResp.ok) {
                    const routeDetail = await routeDetailResp.json();
                    console.log('Route detail response:', routeDetail);
                    
                    if (Array.isArray(routeDetail?.pois)) {
                        associatedPOIs = routeDetail.pois;
                    }
                    console.log('Associated POIs from route:', associatedPOIs.length);
                } else {
                    console.error('Failed to load route detail:', routeDetailResp.status);
                }
                
                // Process associated POIs and update global state
                const assocList = associatedPOIs.slice();
                assocList.sort((a, b) => (a.order_in_route || 0) - (b.order_in_route || 0));
                
                associatedPoiOrderedIds = assocList
                    .map(p => {
                        // Handle different POI ID formats
                        const id = getPoiId(p) || (p.poi ? getPoiId(p.poi) : null);
                        return id ? parseInt(id) : null;
                    })
                    .filter(id => id != null && Number.isFinite(id));
                
                associatedPoiIdSet = new Set(associatedPoiOrderedIds);
                
                console.log('Associated POI IDs (ordered):', associatedPoiOrderedIds);
                console.log('Associated POI ID set:', Array.from(associatedPoiIdSet));
                
                // Separate available and associated POIs
                const associatedPOIIds = new Set(associatedPoiOrderedIds);
                const availablePOIs = allPOIs.filter(poi => {
                    const poiId = parseInt(getPoiId(poi));
                    return Number.isFinite(poiId) && !associatedPOIIds.has(poiId);
                });
                
                // Get associated POI objects in correct order
                const orderedAssociatedPOIs = associatedPoiOrderedIds
                    .map(id => allPOIs.find(poi => parseInt(getPoiId(poi)) === id))
                    .filter(poi => poi != null);
                
                console.log('Available POIs:', availablePOIs.length);
                console.log('Ordered associated POIs:', orderedAssociatedPOIs.length);
                
                // Display POI lists
                displayAvailablePOIs(availablePOIs);
                displayAssociatedPOIs(orderedAssociatedPOIs);
                
            } catch (error) {
                console.error('Error loading POIs for association:', error);
                showNotification("POI'ler yüklenirken hata oluştu: " + error.message, 'error');
                
                // Show error state
                const availableContainer = document.getElementById('availablePOIsList');
                const associatedContainer = document.getElementById('associatedPOIsList');
                
                if (availableContainer) {
                    availableContainer.innerHTML = '<p class="text-danger">POI\'ler yüklenemedi</p>';
                }
                if (associatedContainer) {
                    associatedContainer.innerHTML = '<p class="text-danger">İlişkili POI\'ler yüklenemedi</p>';
                }
            }
        }

        // Display available POIs
        function displayAvailablePOIs(pois) {
            const container = document.getElementById('availablePOIsList');
            
            console.log('Displaying', pois.length, 'available POIs');
            
            if (!container) {
                console.warn('Available POIs container not found');
                return;
            }
            
            if (pois.length === 0) {
                console.log('No available POIs to display, showing empty message');
                container.innerHTML = '<p class="text-muted">İlişkilendirilecek POI bulunamadı</p>';
                return;
            }

            console.log('Displaying available POIs:', pois.length);

            container.innerHTML = pois.map(poi => {
                const poiId = getPoiId(poi);
                if (!poiId) {
                    console.warn('POI without ID:', poi);
                    return '';
                }
                
                // Get category info for icon
                const category = POI_CATEGORIES[poi.category] || { 
                    icon: 'map-marker-alt', 
                    color: '#2563eb',
                    name: poi.category || 'Kategori yok'
                };

                return `
                    <div class="poi-item-small" data-poi-id="${poiId}">
                        <div class="poi-item-info">
                            <div class="poi-item-name">
                                <i class="fas fa-${category.icon}" style="color: ${category.color}; margin-right: 0.5rem;"></i>
                                ${escapeHtml(poi.name || 'İsimsiz POI')}
                            </div>
                            <div class="poi-item-category">${category.name}</div>
                        </div>
                        <div class="poi-item-actions">
                            <button type="button" class="btn-poi-action btn-add-poi" onclick="associatePOI(${poiId})" title="POI'yi rotaya ekle">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).filter(html => html).join('');
            
            console.log('Available POIs displayed successfully');
        }

        // Display associated POIs
        function displayAssociatedPOIs(pois) {
            const container = document.getElementById('associatedPOIsList');
            
            console.log('Displaying', pois.length, 'associated POIs');
            
            if (!container) {
                console.warn('Associated POIs container not found');
                return;
            }
            
            if (pois.length === 0) {
                console.log('No POIs to display, showing empty message');
                container.innerHTML = '<p class="text-muted">İlişkilendirilmiş POI bulunmuyor</p>';
                return;
            }

            console.log('Displaying associated POIs:', pois.length);

            container.innerHTML = pois.map((poi, idx) => {
                const poiId = getPoiId(poi);
                if (!poiId) {
                    console.warn('Associated POI without ID:', poi);
                    return '';
                }
                
                // Get category info for icon
                const category = POI_CATEGORIES[poi.category] || { 
                    icon: 'map-marker-alt', 
                    color: '#2563eb',
                    name: poi.category || 'Kategori yok'
                };

                return `
                    <div class="poi-item-small" data-poi-id="${poiId}">
                        <div class="poi-item-info">
                            <div class="poi-item-name">
                                <span class="poi-order-badge">${idx + 1}</span>
                                <i class="fas fa-${category.icon}" style="color: ${category.color}; margin-right: 0.5rem;"></i>
                                ${escapeHtml(poi.name || 'İsimsiz POI')}
                            </div>
                            <div class="poi-item-category">${category.name}</div>
                        </div>
                        <div class="poi-item-actions">
                            <button type="button" class="btn-poi-action btn-remove-poi" onclick="disassociatePOI(${poiId})" title="POI'yi rotadan çıkar">
                                <i class="fas fa-times"></i>
                            </button>
                            ${idx > 0 ? `<button type="button" class="btn-poi-action" title="Yukarı taşı" onclick="reorderAssociatedPOI(${poiId}, -1)"><i class="fas fa-arrow-up"></i></button>` : ''}
                            ${idx < pois.length - 1 ? `<button type="button" class="btn-poi-action" title="Aşağı taşı" onclick="reorderAssociatedPOI(${poiId}, 1)"><i class="fas fa-arrow-down"></i></button>` : ''}
                        </div>
                    </div>
                `;
            }).filter(html => html).join('');
            
            console.log('Associated POIs displayed successfully');
        }

        // Search POIs
        function searchPOIs() {
            const searchTerm = document.getElementById('poiSearchInput').value.toLowerCase();
            const availableItems = document.querySelectorAll('#availablePOIsList .poi-item-small');
            const associatedItems = document.querySelectorAll('#associatedPOIsList .poi-item-small');
            
            [...availableItems, ...associatedItems].forEach(item => {
                const name = item.querySelector('.poi-item-name').textContent.toLowerCase();
                const category = item.querySelector('.poi-item-category').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || category.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Associate POI with route
        async function associatePOI(poiId) {
            if (!currentRoute) {
                showNotification('Önce bir rota seçin', 'warning');
                return;
            }
            
            try {
                console.log('Associating POI:', poiId, 'with route:', getRouteId(currentRoute));
                
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;
                
                const idInt = parseInt(poiId);
                if (!Number.isFinite(idInt)) {
                    console.error('Invalid POI ID:', poiId);
                    showNotification('Geçersiz POI ID', 'error');
                    return;
                }
                
                // Add to current set and preserve order
                if (!associatedPoiIdSet.has(idInt)) {
                    associatedPoiOrderedIds.push(idInt);
                    associatedPoiIdSet.add(idInt);
                    console.log('Added POI to local set. New order:', associatedPoiOrderedIds);
                } else {
                    console.log('POI already in set, skipping local add');
                }
                
                // Send updated POI list to backend
                const payloadPois = associatedPoiOrderedIds.map((id, idx) => ({ 
                    poi_id: id, 
                    order_in_route: idx + 1 
                }));
                
                console.log('Sending POI payload:', payloadPois);
                
                const url = `${apiBase}/admin/routes/${getRouteId(currentRoute)}/pois`;
                console.log('API URL:', url);
                
                const requestBody = { 
                    csrf_token: csrfToken || '', 
                    pois: payloadPois 
                };
                console.log('Request body:', requestBody);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('POI association response:', result);
                    showNotification('POI başarıyla ilişkilendirildi', 'success');
                    
                    // Reload POI lists to reflect changes
                    console.log('Reloading POI lists...');
                    await loadPOIsForAssociation(getRouteId(currentRoute));
                    
                    // Update route visualization on map
                    console.log('Updating route visualization...');
                    await showSelectedRouteOnMap(currentRoute);
                } else {
                    const responseText = await response.text();
                    console.error('POI association failed:', response.status, responseText);
                    
                    let errorData = {};
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        errorData = { error: responseText };
                    }
                    
                    throw new Error(errorData.error || 'POI ilişkilendirilemedi');
                }
            } catch (error) {
                console.error('POI association error:', error);
                showNotification('POI ilişkilendirilirken hata oluştu: ' + error.message, 'error');
                
                // Revert local changes on error
                const idInt = parseInt(poiId);
                if (associatedPoiIdSet.has(idInt)) {
                    associatedPoiOrderedIds = associatedPoiOrderedIds.filter(id => id !== idInt);
                    associatedPoiIdSet.delete(idInt);
                    console.log('Reverted local changes. New order:', associatedPoiOrderedIds);
                }
            }
        }

        // Disassociate POI from route
        async function disassociatePOI(poiId) {
            if (!currentRoute) {
                showNotification('Önce bir rota seçin', 'warning');
                return;
            }
            
            try {
                console.log('Disassociating POI:', poiId, 'from route:', getRouteId(currentRoute));
                
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;
                
                const idInt = parseInt(poiId);
                if (!Number.isFinite(idInt)) {
                    showNotification('Geçersiz POI ID', 'error');
                    return;
                }
                
                // Store original state for rollback
                const originalOrderedIds = [...associatedPoiOrderedIds];
                const originalIdSet = new Set(associatedPoiIdSet);
                
                // Remove from both ordered list and set
                associatedPoiOrderedIds = associatedPoiOrderedIds.filter(id => id !== idInt);
                associatedPoiIdSet.delete(idInt);
                
                console.log('Removed POI from local set. New order:', associatedPoiOrderedIds);
                
                // Send updated POI list to backend
                const payloadPois = associatedPoiOrderedIds.map((id, idx) => ({ 
                    poi_id: id, 
                    order_in_route: idx + 1 
                }));
                
                console.log('Sending updated POI payload:', payloadPois);
                
                const response = await fetch(`${apiBase}/admin/routes/${getRouteId(currentRoute)}/pois`, {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify({ 
                        csrf_token: csrfToken || '', 
                        pois: payloadPois 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('POI disassociation response:', result);
                    showNotification('POI başarıyla kaldırıldı', 'success');
                    
                    // Reload POI lists to reflect changes
                    await loadPOIsForAssociation(getRouteId(currentRoute));
                    
                    // Update route visualization on map
                    await showSelectedRouteOnMap(currentRoute);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('POI disassociation failed:', response.status, errorData);
                    throw new Error(errorData.error || 'POI kaldırılamadı');
                }
            } catch (error) {
                console.error('POI disassociation error:', error);
                showNotification('POI kaldırılırken hata oluştu: ' + error.message, 'error');
                
                // Revert local changes on error
                const idInt = parseInt(poiId);
                if (!associatedPoiIdSet.has(idInt)) {
                    associatedPoiOrderedIds.push(idInt);
                    associatedPoiIdSet.add(idInt);
                }
            }
        }



        // Reorder associated POI
        async function reorderAssociatedPOI(poiId, delta) {
            if (!currentRoute) {
                showNotification('Önce bir rota seçin', 'warning');
                return;
            }
            
            console.log('Reordering POI:', poiId, 'delta:', delta);
            
            const idInt = parseInt(poiId);
            const ids = associatedPoiOrderedIds.slice();
            const idx = ids.indexOf(idInt);
            
            if (idx < 0) {
                console.warn('POI not found in ordered list:', poiId);
                return;
            }
            
            const swapIdx = idx + delta;
            if (swapIdx < 0 || swapIdx >= ids.length) {
                console.warn('Invalid swap index:', swapIdx);
                return;
            }
            
            // Swap positions
            [ids[idx], ids[swapIdx]] = [ids[swapIdx], ids[idx]];
            
            // Update global state
            associatedPoiOrderedIds = ids;
            associatedPoiIdSet = new Set(ids);
            
            console.log('New POI order:', associatedPoiOrderedIds);
            
            try {
                // Persist new order to backend
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;
                
                const payloadPois = ids.map((id, i) => ({ 
                    poi_id: id, 
                    order_in_route: i + 1 
                }));
                
                const response = await fetch(`${apiBase}/admin/routes/${getRouteId(currentRoute)}/pois`, {
                    method: 'POST', 
                    headers, 
                    credentials: 'include',
                    body: JSON.stringify({ 
                        csrf_token: csrfToken || '', 
                        pois: payloadPois 
                    })
                });
                
                if (response.ok) {
                    showNotification('POI sıralaması güncellendi', 'success');
                    
                    // Reload POI lists to show new order
                    await loadPOIsForAssociation(getRouteId(currentRoute));
                    
                    // Update route visualization on map
                    await showSelectedRouteOnMap(currentRoute);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Reorder failed:', response.status, errorData);
                    throw new Error(errorData.error || 'Sıralama kaydedilemedi');
                }
            } catch (error) {
                console.error('POI reorder error:', error);
                showNotification('Sıralama hatası: ' + error.message, 'error');
                
                // Revert local changes on error
                const originalIdx = ids.indexOf(idInt);
                if (originalIdx >= 0) {
                    [ids[originalIdx], ids[swapIdx]] = [ids[swapIdx], ids[originalIdx]];
                    associatedPoiOrderedIds = ids;
                    associatedPoiIdSet = new Set(ids);
                }
            }
        }

        // Build and save route from associated POIs (geometry + stats)
        async function buildAndSaveRouteFromAssociatedPOIs() {
            if (!currentRoute) return;
            const ids = Array.from(associatedPoiIdSet);
            if (ids.length < 2) { showNotification('Rota için en az 2 POI seçin', 'warning'); return; }
            try {
                // Build polyline from associated POIs in current order
                const ordered = ids.map(id => (allPoisForAssociation || []).find(p => getPoiId(p) === id)).filter(Boolean);
                const coords = ordered.map(p => ({ lat: p.latitude || p.lat, lng: p.longitude || p.lng }));
                // Distance (Haversine)
                const R = 6371000; // meters
                const toRad = d => d * Math.PI / 180;
                let totalMeters = 0;
                for (let i = 1; i < coords.length; i++) {
                    const a = coords[i-1], b = coords[i];
                    const dLat = toRad(b.lat - a.lat);
                    const dLon = toRad(b.lng - a.lng);
                    const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
                    const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
                    totalMeters += 2 * R * Math.asin(Math.sqrt(h));
                }
                const estimatedSeconds = Math.round((totalMeters / 1.2)); // yürüyüş ~1.2 m/s varsayım
                const segments = [{ coordinates: coords }];
                const waypoints = ordered.map((p, i) => ({ name: p.name, latitude: p.latitude || p.lat, longitude: p.longitude || p.lng, order: i+1 }));

                // Save geometry to backend
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;
                const resp = await fetch(`${apiBase}/admin/routes/${currentRoute.id}/geometry`, {
                    method: 'POST', headers, credentials: 'include',
                    body: JSON.stringify({ geometry: segments, total_distance: totalMeters, estimated_time: estimatedSeconds, waypoints })
                });
                if (!resp.ok) throw new Error('Geometri kaydedilemedi');
                showNotification('Rota geometri kaydedildi', 'success');
                await loadRoutes();
                // Önizleme için vurgula
                highlightRouteOnMap(allRoutes.find(r => getRouteId(r) === getRouteId(currentRoute)) || currentRoute);
            } catch (e) {
                console.error('Build route error:', e);
                showNotification('Rota oluşturma/kaydetme hatası', 'error');
            }
        }

        // Preview on map without saving
        function previewRouteFromAssociatedPOIs() {
            const ids = Array.from(associatedPoiIdSet);
            if (ids.length < 2) { showNotification('Önizleme için en az 2 POI seçin', 'warning'); return; }
            const ordered = ids.map(id => (allPoisForAssociation || []).find(p => getPoiId(p) === id)).filter(Boolean);
            const latlngs = ordered.map(p => [p.latitude || p.lat, p.longitude || p.lng]);
            if (!map) return;
            // Remove old preview if exists
            if (routeLayers['__preview__']) {
                try { map.removeLayer(routeLayers['__preview__']); } catch(e) {}
            }
            const layer = L.polyline(latlngs, { color: '#10b981', weight: 4, opacity: 0.9, dashArray: '6,4' }).addTo(map);
            routeLayers['__preview__'] = layer;
            map.fitBounds(layer.getBounds(), { padding: [30, 30] });
        }

        // Find nearby POIs for route
        async function findNearbyPOIs() {
            console.log('🔍 findNearbyPOIs çağrıldı');
            console.log('currentRoute:', currentRoute);
            
            if (!currentRoute) {
                console.warn('❌ currentRoute null');
                showNotification('Önce bir rota seçin', 'warning');
                return;
            }
            
            console.log('✅ currentRoute mevcut, ID:', currentRoute.id);
            
            // Rate limiting kontrolü - Geliştirme için devre dışı
            // const now = Date.now();
            // if ((now - lastLoadTime) < minLoadInterval) {
            //     console.log('POI arama rate limit nedeniyle atlandı');
            //     showNotification('Çok sık istek gönderiyorsunuz, lütfen bekleyin', 'warning');
            //     return;
            // }
            
            try {
                showNotification('Yakın POI\'ler aranıyor...', 'info');
                
                const response = await fetch(`${apiBase}/routes/${currentRoute.id}/nearby-pois`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const nearbyPois = data.nearby_pois || [];
                    const effectiveMax = (data.parameters && data.parameters.max_distance_meters) ? data.parameters.max_distance_meters : undefined;
                    if (nearbyPois.length > 0) {
                        showNotification(`${nearbyPois.length} yakın POI bulundu ${effectiveMax ? `(${effectiveMax}m)` : ''}`, 'success');
                        displayNearbyPOIsModal(nearbyPois, effectiveMax || '');
                    } else {
                        showNotification('Rota yakınında POI bulunamadı', 'info');
                    }
                } else {
                    throw new Error(data.error || 'Yakın POI\'ler bulunamadı');
                }
            } catch (error) {
                console.error('Nearby POI search error:', error);
                showError('Yakın POI\'ler aranırken hata oluştu: ' + error.message);
            }
        }

        // Auto-associate nearby POIs
        async function autoAssociateNearbyPOIs() {
            console.log('🚀 autoAssociateNearbyPOIs çağrıldı');
            console.log('currentRoute:', currentRoute);
            
            if (!currentRoute) {
                console.warn('❌ currentRoute null');
                showNotification('Önce bir rota seçin', 'warning');
                return;
            }
            
            console.log('✅ currentRoute mevcut, ID:', currentRoute.id);
            
            // Rate limiting kontrolü - Geliştirme için devre dışı
            // const now = Date.now();
            // if ((now - lastLoadTime) < minLoadInterval) {
            //     console.log('Otomatik POI ekleme rate limit nedeniyle atlandı');
            //     showNotification('Çok sık istek gönderiyorsunuz, lütfen bekleyin', 'warning');
            //     return;
            // }
            
            try {
                showNotification('Yakın POI\'ler otomatik ekleniyor...', 'info');
                
                const requestData = {
                    auto_confirm: true
                };
                
                const response = await fetch(`${apiBase}/routes/${currentRoute.id}/auto-associate-pois`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const associatedCount = data.associated_count || 0;
                    if (associatedCount > 0) {
                        showNotification(`${associatedCount} POI otomatik olarak rotaya eklendi`, 'success');
                        // Refresh POI lists
                        await loadPOIsForAssociation(currentRoute.id);
                        // Refresh route display
                        await loadAndDisplayRoutePOIs(currentRoute.id);
                    } else {
                        showNotification('Eklenecek yakın POI bulunamadı', 'info');
                    }
                } else {
                    throw new Error(data.error || 'Otomatik POI ekleme başarısız');
                }
            } catch (error) {
                console.error('Auto-associate POI error:', error);
                showError('Otomatik POI ekleme hatası: ' + error.message);
            }
        }

        // Display nearby POIs in a modal
        function displayNearbyPOIsModal(nearbyPois, maxDistance) {
            const modalHtml = `
                <div class="modal fade" id="nearbyPoisModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Yakın POI'ler (${maxDistance}m içinde)
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    ${nearbyPois.map(poi => `
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="card-title">
                                                        <i class="fas fa-map-pin me-1"></i>
                                                        ${poi.name}
                                                    </h6>
                                                    <p class="card-text small text-muted mb-2">
                                                        ${poi.description || 'Açıklama yok'}
                                                    </p>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="badge bg-primary">${poi.category}</span>
                                                        <span class="text-muted small">
                                                            ${Math.round(poi.distance_meters)}m
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="card-footer">
                                                    <button class="btn btn-success btn-sm w-100" 
                                                            onclick="associatePOI(${poi.id}); bootstrap.Modal.getInstance(document.getElementById('nearbyPoisModal')).hide();">
                                                        <i class="fas fa-plus me-1"></i>
                                                        Rotaya Ekle
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                                <button type="button" class="btn btn-success" onclick="addAllNearbyPOIs([${nearbyPois.map(p => p.id).join(',')}])">
                                    <i class="fas fa-plus-circle me-1"></i>
                                    Tümünü Ekle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('nearbyPoisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('nearbyPoisModal'));
            modal.show();
        }

        // Add all nearby POIs to route
        async function addAllNearbyPOIs(poiIds) {
            if (!currentRoute || !poiIds.length) return;
            
            try {
                showNotification(`${poiIds.length} POI rotaya ekleniyor...`, 'info');
                
                let addedCount = 0;
                for (const poiId of poiIds) {
                    try {
                        await associatePOI(poiId);
                        addedCount++;
                    } catch (error) {
                        console.warn(`POI ${poiId} eklenemedi:`, error);
                    }
                }
                
                if (addedCount > 0) {
                    showNotification(`${addedCount} POI başarıyla eklendi`, 'success');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('nearbyPoisModal'));
                    if (modal) modal.hide();
                } else {
                    showNotification('Hiçbir POI eklenemedi', 'warning');
                }
                
            } catch (error) {
                console.error('Bulk POI add error:', error);
                showError('POI\'ler eklenirken hata oluştu');
            }
        }

        // Test function for debugging
        function testNearbyFeature() {
            console.log('🧪 TEST: Yakın POI özelliği test ediliyor');
            console.log('currentRoute:', currentRoute);
            console.log('apiBase:', apiBase);
            
            if (!currentRoute) {
                alert('❌ currentRoute null! Önce bir rota seçin.');
                return;
            }
            
            alert(`✅ Test başarılı!\nSeçili rota: ${currentRoute.name}\nID: ${currentRoute.id}\nAPI Base: ${apiBase}`);
            
            // Test API call
            fetch(`${apiBase}/routes/${currentRoute.id}/nearby-pois`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                console.log('🔍 API Test Sonucu:', data);
                if (data.success) {
                    const eff = data.parameters && data.parameters.max_distance_meters ? ` (radar: ${data.parameters.max_distance_meters}m)` : '';
                    alert(`🎉 API Test Başarılı!\n${data.total_found} POI bulundu${eff}.`);
                } else {
                    alert(`❌ API Test Başarısız!\nHata: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('API Test Hatası:', error);
                alert(`❌ API Test Hatası!\n${error.message}`);
            });
        }

        // Save route changes (with CSRF)
        async function saveRouteChanges() {
            if (!currentRoute) return;
            
            try {
                const formData = {
                    name: document.getElementById('editRouteName').value,
                    description: document.getElementById('editRouteDescription').value,
                    route_type: document.getElementById('editRouteType').value,
                    difficulty_level: parseInt(document.getElementById('editDifficulty').value),
                    estimated_duration: parseInt(document.getElementById('editDuration').value) || null,
                    total_distance: parseFloat(document.getElementById('editDistance').value) || null,
                    elevation_gain: parseInt(document.getElementById('editElevation').value) || null,
                    tags: document.getElementById('editTags').value,
                    is_circular: document.getElementById('editIsCircular').checked
                };
                
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;
                const response = await fetch(`${apiBase}/admin/routes/${currentRoute.id}`, {
                    method: 'PUT',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showNotification('Rota başarıyla güncellendi', 'success');
                    
                    // Update current route data
                    Object.assign(currentRoute, formData);
                    
                    // Refresh routes list
                    await loadRoutes();
                    
                    // Return to detail view
                    displayRouteDetails(currentRoute);
                } else {
                    let message = 'Rota güncellenemedi';
                    try { const errorData = await response.json(); if (errorData?.error) message = errorData.error; } catch(e) {}
                    throw new Error(message);
                }
            } catch (error) {
                console.error('Route update error:', error);
                showError('Rota güncellenirken hata oluştu: ' + error.message);
            }
        }

        // Cancel route edit
        function cancelRouteEdit() {
            if (currentRoute) {
                displayRouteDetails(currentRoute);
            }
        }

        // Export functions
        async function exportRouteAsGPX(routeId) {
            try {
                const response = await fetch(`${apiBase}/routes/${routeId}/export/gpx`);
                if (response.ok) {
                    const blob = await response.blob();
                    downloadFile(blob, `route_${routeId}.gpx`, 'application/gpx+xml');
                } else {
                    throw new Error('GPX export failed');
                }
            } catch (error) {
                console.error('GPX export error:', error);
                showError('GPX dışa aktarımında hata oluştu');
            }
        }

        async function exportRouteAsKML(routeId) {
            try {
                const response = await fetch(`${apiBase}/routes/${routeId}/export/kml`);
                if (response.ok) {
                    const blob = await response.blob();
                    downloadFile(blob, `route_${routeId}.kml`, 'application/vnd.google-earth.kml+xml');
                } else {
                    throw new Error('KML export failed');
                }
            } catch (error) {
                console.error('KML export error:', error);
                showError('KML dışa aktarımında hata oluştu');
            }
        }

        async function exportRouteAsJSON(routeId) {
            try {
                const response = await fetch(`${apiBase}/routes/${routeId}/export/json`);
                if (response.ok) {
                    const blob = await response.blob();
                    downloadFile(blob, `route_${routeId}.json`, 'application/json');
                } else {
                    throw new Error('JSON export failed');
                }
            } catch (error) {
                console.error('JSON export error:', error);
                showError('JSON dışa aktarımında hata oluştu');
            }
        }

        function printRouteDetails(routeId) {
            const route = allRoutes.find(r => r.id === routeId);
            if (!route) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>${escapeHtml(route.name)} - Rota Detayları</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2563eb; }
                        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
                        .stat { padding: 10px; background: #f8fafc; border-radius: 8px; }
                        .stat-label { font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>${escapeHtml(route.name)}</h1>
                    <p><strong>Tür:</strong> ${ROUTE_TYPES[route.route_type]?.name || route.route_type}</p>
                    <p><strong>Açıklama:</strong> ${escapeHtml(route.description || 'Açıklama bulunmuyor')}</p>
                    
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-label">Süre</div>
                            <div>${route.estimated_duration || 0} dakika</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Mesafe</div>
                            <div>${(route.total_distance || 0).toFixed(2)} km</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Yükselti</div>
                            <div>${route.elevation_gain || 0} m</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Zorluk</div>
                            <div>${getDifficultyStars(route.difficulty_level)} (${route.difficulty_level}/5)</div>
                        </div>
                    </div>
                    
                    ${route.tags ? `<p><strong>Etiketler:</strong> ${escapeHtml(route.tags)}</p>` : ''}
                    <p><strong>Dairesel Rota:</strong> ${route.is_circular ? 'Evet' : 'Hayır'}</p>
                    <p><strong>Oluşturulma:</strong> ${formatDate(route.created_at)}</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Utility function to download files
        function downloadFile(blob, filename, mimeType) {
            const url = window.URL.createObjectURL(new Blob([blob], { type: mimeType }));
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        function duplicateCurrentRoute() {
            if (currentRoute) {
                // TODO: Implement route duplication
                showNotification(`${currentRoute.name} rotası kopyalama özelliği yakında eklenecek`, 'info');
            }
        }

        function exportCurrentRoute() {
            if (currentRoute) {
                // TODO: Implement route export
                showNotification(`${currentRoute.name} rotası dışa aktarma özelliği yakında eklenecek`, 'info');
            }
        }

        async function deleteCurrentRoute() {
            if (!currentRoute) return;
            
            const routeId = getRouteId(currentRoute);
            const routeName = currentRoute.name;
            
            if (confirm(`"${routeName}" rotasını silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
                try {
                    showNotification('Rota siliniyor...', 'info');
                    
                    const response = await fetch(`${apiBase}/admin/routes/${routeId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            csrf_token: csrfToken
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            showNotification(`"${routeName}" rotası başarıyla silindi`, 'success');
                            
                            // Remove from UI
                            allRoutes = allRoutes.filter(r => getRouteId(r) !== routeId);
                            filteredRoutes = filteredRoutes.filter(r => getRouteId(r) !== routeId);
                            
                            // Remove from map
                            if (routeLayers[routeId]) {
                                map.removeLayer(routeLayers[routeId]);
                                delete routeLayers[routeId];
                            }
                            
                            // Clear selection
                            clearSelection();
                            
                            // Update UI
                            displayRoutes();
                            updateBulkActions();
                            
                        } else {
                            showNotification(`Rota silinemedi: ${data.error}`, 'error');
                        }
                    } else if (response.status === 404) {
                        // Route already deleted
                        showNotification(`"${routeName}" rotası zaten silinmiş`, 'warning');
                        
                        // Remove from UI anyway
                        allRoutes = allRoutes.filter(r => getRouteId(r) !== routeId);
                        filteredRoutes = filteredRoutes.filter(r => getRouteId(r) !== routeId);
                        
                        // Remove from map
                        if (routeLayers[routeId]) {
                            map.removeLayer(routeLayers[routeId]);
                            delete routeLayers[routeId];
                        }
                        
                        // Clear selection
                        clearSelection();
                        
                        // Update UI
                        displayRoutes();
                        updateBulkActions();
                    } else {
                        showNotification(`HTTP hatası: ${response.status}`, 'error');
                    }
                } catch (error) {
                    console.error('Error deleting route:', error);
                    showNotification('Rota silinirken hata oluştu', 'error');
                }
            }
        }

        function exportSelected() {
            if (selectedRoutes.size > 0) {
                // TODO: Implement bulk export
                showNotification(`${selectedRoutes.size} rota dışa aktarma özelliği yakında eklenecek`, 'info');
            }
        }

        function bulkEdit() {
            if (selectedRoutes.size > 0) {
                // TODO: Implement bulk edit
                showNotification(`${selectedRoutes.size} rota toplu düzenleme özelliği yakında eklenecek`, 'info');
            }
        }

        function deleteSelected() {
            if (selectedRoutes.size > 0) {
                if (confirm(`${selectedRoutes.size} rotayı silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
                    deleteSelectedRoutes();
                }
            }
        }

        async function deleteSelectedRoutes() {
            const routeIds = Array.from(selectedRoutes);
            let successCount = 0;
            let errorCount = 0;
            
            showNotification(`${routeIds.length} rota siliniyor...`, 'info');
            
            for (const routeId of routeIds) {
                try {
                    const response = await fetch(`${apiBase}/admin/routes/${routeId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            csrf_token: csrfToken
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.message && !data.error) {
                            // Success response has 'message' field
                            successCount++;
                            
                            // Remove from UI
                            allRoutes = allRoutes.filter(r => getRouteId(r) !== routeId);
                            filteredRoutes = filteredRoutes.filter(r => getRouteId(r) !== routeId);
                            
                            // Remove from map
                            if (routeLayers[routeId]) {
                                map.removeLayer(routeLayers[routeId]);
                                delete routeLayers[routeId];
                            }
                            
                            // Clear selection if this route was selected
                            if (currentRoute && getRouteId(currentRoute) === routeId) {
                                clearSelection();
                            }
                        } else {
                            errorCount++;
                            console.error(`Failed to delete route ${routeId}:`, data.error || 'Unknown error');
                        }
                    } else if (response.status === 404) {
                        // Route already deleted, treat as success
                        successCount++;
                        console.warn(`Route ${routeId} already deleted (404)`);
                        
                        // Remove from UI anyway
                        allRoutes = allRoutes.filter(r => getRouteId(r) !== routeId);
                        filteredRoutes = filteredRoutes.filter(r => getRouteId(r) !== routeId);
                        
                        // Remove from map
                        if (routeLayers[routeId]) {
                            map.removeLayer(routeLayers[routeId]);
                            delete routeLayers[routeId];
                        }
                        
                        // Clear selection if this route was selected
                        if (currentRoute && getRouteId(currentRoute) === routeId) {
                            clearSelection();
                        }
                    } else {
                        errorCount++;
                        console.error(`HTTP error deleting route ${routeId}:`, response.status);
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`Error deleting route ${routeId}:`, error);
                }
            }
            
            // Clear selection
            selectedRoutes.clear();
            
            // Update UI
            displayRoutes();
            updateBulkActions();
            
            // Show result notification
            if (successCount > 0 && errorCount === 0) {
                showNotification(`${successCount} rota başarıyla silindi`, 'success');
            } else if (successCount > 0 && errorCount > 0) {
                showNotification(`${successCount} rota silindi, ${errorCount} rota silinemedi`, 'warning');
            } else {
                showNotification(`Rotalar silinemedi`, 'error');
            }
        }

        function toggleMapLayer(layerType) {
            // TODO: Implement map layer switching
            showNotification(`${layerType} katmanı özelliği yakında eklenecek`, 'info');
        }

        function fitMapToRoutes() {
            if (Object.keys(routeLayers).length > 0) {
                const group = new L.featureGroup(Object.values(routeLayers));
                map.fitBounds(group.getBounds(), { padding: [20, 20] });
            }
        }
    </script>
</body>
</html>