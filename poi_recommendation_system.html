<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ürgüp POI Önerileri - Size Özel Yerler Keşfedin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #f8f9fa;
            --accent-color: #28a745;
            --text-color: #2c3e50;
            --border-color: #dee2e6;
            --legend-width-mobile: 90vw;
            --legend-width-desktop: 320px;
            --legend-animation-duration: 300ms;
            --legend-z-index: 9999;
            --legend-backdrop-blur: 10px;
            --toggle-button-size: 50px;
            --touch-target-min: 44px;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            --card-shadow-hover: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            backdrop-filter: blur(var(--legend-backdrop-blur));
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.95;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 40px;
        }

        .preferences-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container {
            background: var(--gradient-secondary);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
        }

        .slider-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0.6;
        }

        .slider-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .slider-item {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
            min-height: var(--touch-target-min);
            position: relative;
            overflow: hidden;
        }

        .slider-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .slider-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 0.95);
        }

        .slider-item:hover::before {
            transform: scaleY(1);
        }

        .slider-item.active {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
        }

        .slider-item.active::before {
            transform: scaleY(1);
        }

        .slider-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
        }

        .slider-label i {
            width: 20px;
            text-align: center;
            color: var(--primary-color);
            font-size: 16px;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            outline: none;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gradient-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .slider::-webkit-slider-thumb:active {
            transform: scale(1.05);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gradient-primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .slider-value {
            text-align: center;
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
            background: rgba(102, 126, 234, 0.15);
            padding: 8px 16px;
            border-radius: 25px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            min-width: 50px;
        }

        .slider-value.zero {
            color: #999;
            background: rgba(153, 153, 153, 0.1);
            border-color: rgba(153, 153, 153, 0.2);
        }

        .slider-value.high {
            background: rgba(40, 167, 69, 0.15);
            color: var(--accent-color);
            border-color: rgba(40, 167, 69, 0.3);
            transform: scale(1.05);
        }

        .recommend-btn {
            background: linear-gradient(135deg, var(--accent-color) 0%, #20c997 100%);
            border: none;
            color: white;
            padding: 18px 45px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
            position: relative;
            overflow: hidden;
            min-height: var(--touch-target-min);
            touch-action: manipulation;
        }

        .recommend-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .recommend-btn:hover::before {
            left: 100%;
        }

        .recommend-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.4);
        }

        .recommend-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .recommend-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }

        .recommend-btn:disabled::before {
            display: none;
        }

        .results-section {
            margin-top: 40px;
            display: none;
        }

        .poi-card {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            backdrop-filter: blur(15px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            min-height: var(--touch-target-min);
            touch-action: manipulation;
        }

        .poi-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(20px, -20px);
            transition: all 0.3s ease;
        }

        .poi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .poi-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .poi-card:hover::before {
            transform: scaleX(1);
        }

        .poi-card:hover::after {
            transform: translate(10px, -10px) scale(1.2);
            background: radial-gradient(circle, rgba(102, 126, 234, 0.2) 0%, transparent 70%);
        }

        .poi-card:active {
            transform: translateY(-3px) scale(1.01);
        }

        .poi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 15px;
        }

        .poi-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
            line-height: 1.3;
        }

        .poi-score {
            background: linear-gradient(135deg, var(--accent-color) 0%, #20c997 100%);
            color: white;
            padding: 10px 18px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4);
            white-space: nowrap;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .poi-score::before {
            content: '⭐';
            margin-right: 6px;
            font-size: 0.9rem;
        }

        .poi-score::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .poi-card:hover .poi-score::after {
            left: 100%;
        }

        .poi-category {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--gradient-primary);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 16px;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .poi-category::before {
            content: '📍';
            font-size: 0.8rem;
        }

        .poi-card:hover .poi-category {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
        }

        .poi-ratings {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .rating-badge {
            background: var(--gradient-secondary);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-color);
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rating-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .rating-badge.high {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-color: rgba(21, 87, 36, 0.2);
            box-shadow: 0 2px 8px rgba(21, 87, 36, 0.1);
        }

        .rating-badge i {
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-color);
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .loading i {
            font-size: 2.5rem;
            animation: spin 1s linear infinite;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .loading p {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .map-container {
            height: 450px;
            border-radius: 16px;
            overflow: hidden;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
        }

        .no-results {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .no-results i {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.6;
            color: var(--primary-color);
        }

        .no-results h3 {
            color: var(--text-color);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .no-results p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Touch device optimizations */
        .touch-device .slider-item {
            min-height: var(--touch-target-min);
            padding: 16px;
        }

        .touch-device .recommend-btn {
            min-height: var(--touch-target-min);
            padding: 20px 50px;
        }

        .touch-device .poi-card {
            min-height: var(--touch-target-min);
            padding: 20px;
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {

            .slider-item,
            .poi-card,
            .recommend-btn,
            .rating-badge {
                transition: none;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .main-container {
                background: white;
                border: 2px solid black;
            }

            .poi-card {
                border: 2px solid #666;
                background: white;
            }
        }

        /* Location Permission Dialog Styles */
        .location-permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .location-permission-overlay.show {
            display: flex;
        }

        .location-permission-dialog {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            overflow: hidden;
            animation: dialogSlideIn 0.3s ease-out;
        }

        .location-dialog-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-dialog-title {
            font-size: 16px;
            font-weight: 500;
            color: #202124;
            margin: 0;
        }

        .location-dialog-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #5f6368;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-dialog-close:hover {
            background: #f1f3f4;
        }

        .location-dialog-content {
            padding: 24px;
            text-align: center;
        }

        .location-permission-icon {
            width: 48px;
            height: 48px;
            background: #4285f4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: white;
            font-size: 24px;
        }

        .location-permission-message {
            font-size: 14px;
            color: #202124;
            margin: 0 0 24px 0;
            font-weight: 500;
        }

        .location-permission-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .location-permission-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }

        .location-permission-btn:hover {
            background: #3367d6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .location-permission-btn.secondary {
            background: #f8f9fa;
            color: #3c4043;
            border: 1px solid #dadce0;
        }

        .location-permission-btn.secondary:hover {
            background: #f1f3f4;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .location-permission-btn.deny {
            background: transparent;
            color: #d93025;
            border: 1px solid #dadce0;
        }

        .location-permission-btn.deny:hover {
            background: #fce8e6;
            border-color: #d93025;
        }

        @keyframes dialogSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Route Details Panel Styles */
        .route-details-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 350px;
            max-height: 80vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            z-index: 1000;
            display: none;
            animation: panelSlideIn 0.3s ease-out;
        }

        .route-details-panel.show {
            display: block;
        }

        .route-header {
            background: var(--gradient-primary);
            color: white;
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .route-summary {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .summary-item i {
            color: var(--primary-color);
            width: 16px;
            text-align: center;
        }

        .elevation-section {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
        }

        .elevation-section h4 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .elevation-section canvas {
            width: 100%;
            height: 150px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .elevation-stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.8rem;
            color: #666;
        }

        .elevation-stats span {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .elevation-stats span:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .elevation-section.loading {
            opacity: 0.6;
        }

        .elevation-section.error {
            opacity: 0.8;
        }

        .elevation-section.error .elevation-stats span {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .stops-section {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
        }

        .stops-section h4 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .stops-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .stop-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .stop-item:hover {
            background: #f8f9fa;
        }

        .stop-item:last-child {
            border-bottom: none;
        }

        .stop-item.highlighted {
            background: rgba(66, 133, 244, 0.1);
            border-left: 3px solid #4285f4;
            transform: translateX(2px);
        }

        .stop-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .stop-info {
            flex: 1;
        }

        .stop-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .stop-category {
            font-size: 0.8rem;
            color: #666;
        }

        .export-section {
            padding: 16px 20px;
        }

        .export-btn {
            width: 100%;
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-btn:hover {
            background: #20c997;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        @keyframes panelSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Mobile responsiveness for route details panel */
        @media (max-width: 768px) {
            .route-details-panel {
                right: 10px;
                left: 10px;
                width: auto;
                max-height: 70vh;
            }

            .route-summary {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        /* Fallbacks for older browsers */
        @supports not (backdrop-filter: blur(10px)) {

            .main-container,
            .slider-container,
            .poi-card {
                background: rgba(255, 255, 255, 0.95) !important;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px 0;
            }

            .main-container {
                margin: 0 10px;
                border-radius: 12px;
            }

            .content {
                padding: 20px;
            }

            .header {
                padding: 25px 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .slider-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .slider-container {
                padding: 20px;
            }

            .poi-card {
                padding: 20px;
                margin-bottom: 16px;
            }

            .poi-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .poi-score {
                align-self: flex-end;
            }

            .map-container {
                height: 350px;
                margin-top: 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 1rem;
            }

            .slider-row {
                gap: 12px;
            }

            .slider-item {
                padding: 14px;
            }

            .recommend-btn {
                padding: 16px 35px;
                font-size: 1.1rem;
            }

            .poi-ratings {
                gap: 6px;
            }

            .rating-badge {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
        }

        /* Custom marker styles */
        .custom-poi-marker {
            background: transparent !important;
            border: none !important;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .custom-popup .leaflet-popup-content {
            margin: 10px;
            line-height: 1.4;
        }

        .custom-popup .leaflet-popup-tip {
            background: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Route popup styles */
        .route-detail-popup .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 350px !important;
        }

        .route-detail-popup .leaflet-popup-content {
            margin: 10px;
            line-height: 1.4;
        }

        .segment-hover-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .segment-hover-popup .leaflet-popup-content {
            margin: 8px;
            line-height: 1.3;
        }

        .segment-hover-popup .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Route button hover effects */
        .route-detail-popup button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .route-detail-popup button:active {
            transform: translateY(0);
        }

        /* Media Modal Styles */
        .media-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            animation: modalFadeIn 0.3s ease-out;
        }

        .media-modal.show {
            display: flex;
        }

        .media-modal-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        .media-modal-header {
            background: var(--gradient-primary);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .media-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .media-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .media-modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            max-height: calc(90vh - 80px);
            overflow: auto;
        }

        .media-display {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .media-display img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .media-display video {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .media-display audio {
            width: 100%;
            max-width: 500px;
            margin: 20px 0;
        }

        .media-error {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .media-error i {
            font-size: 3rem;
            color: #e74c3c;
            margin-bottom: 16px;
        }

        .media-error h3 {
            color: #333;
            margin-bottom: 8px;
        }

        .media-error button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 16px;
            transition: background 0.2s ease;
        }

        .media-error button:hover {
            background: #5a6fd8;
        }

        .media-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .media-loading i {
            font-size: 2rem;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        /* Navigation controls */
        .media-navigation {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10001;
        }

        .media-nav-prev {
            left: 20px;
        }

        .media-nav-next {
            right: 20px;
        }

        .media-nav-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .media-nav-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .media-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .media-nav-btn:disabled:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: none;
        }

        .media-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            z-index: 10001;
        }

        .media-thumbnails {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            max-width: 80%;
            overflow-x: auto;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            z-index: 10001;
        }

        .media-thumbnail {
            width: 60px;
            height: 45px;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            object-fit: cover;
        }

        .media-thumbnail.active {
            opacity: 1;
            border-color: white;
            transform: scale(1.1);
        }

        .media-thumbnail:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        /* Image zoom controls */
        .image-zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 10002;
        }

        .zoom-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .zoom-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .zoom-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .media-image-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-image-zoomable {
            transition: transform 0.3s ease;
            cursor: grab;
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }

        .media-image-zoomable:active {
            cursor: grabbing;
        }

        .media-image-zoomed {
            cursor: move;
        }

        /* Video and audio enhanced controls */
        .media-video-container {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-audio-container {
            width: 100%;
            max-width: 600px;
            padding: 30px;
            text-align: center;
        }

        .audio-info {
            margin-bottom: 20px;
        }

        .audio-info h4 {
            color: #333;
            margin: 0 0 8px 0;
            font-size: 1.3rem;
        }

        .audio-info .audio-meta {
            color: #666;
            font-size: 0.9rem;
        }

        .media-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 10001;
        }

        .media-progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.1s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Mobile responsive modal */
        @media (max-width: 768px) {
            .media-modal-content {
                max-width: 95vw;
                max-height: 95vh;
                margin: 10px;
            }

            .media-modal-header {
                padding: 12px 16px;
            }

            .media-modal-title {
                font-size: 1.1rem;
            }

            .media-display {
                padding: 16px;
            }

            .media-display img,
            .media-display video {
                max-height: 60vh;
            }

            .media-nav-prev {
                left: 10px;
            }

            .media-nav-next {
                right: 10px;
            }

            .media-nav-btn {
                width: 44px;
                height: 44px;
                font-size: 1rem;
            }

            .media-counter {
                bottom: 15px;
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            .media-thumbnails {
                bottom: 55px;
                max-width: 90%;
            }

            .media-thumbnail {
                width: 50px;
                height: 38px;
            }
        }

        @media (max-width: 480px) {
            .media-modal-content {
                max-width: 98vw;
                max-height: 98vh;
                margin: 5px;
                border-radius: 12px;
            }

            .media-display {
                padding: 12px;
            }

            .media-display img,
            .media-display video {
                max-height: 50vh;
            }

            .media-nav-prev {
                left: 5px;
            }

            .media-nav-next {
                right: 5px;
            }

            .media-nav-btn {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }

            .media-counter {
                bottom: 10px;
                font-size: 0.75rem;
                padding: 4px 10px;
            }

            .media-thumbnails {
                bottom: 45px;
                max-width: 95%;
                gap: 4px;
            }

            .media-thumbnail {
                width: 45px;
                height: 34px;
            }

            .image-zoom-controls {
                top: 10px;
                right: 10px;
                gap: 4px;
            }

            .zoom-btn {
                width: 36px;
                height: 36px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-map-marked-alt"></i> Ürgüp POI Önerileri</h1>
            <p>Tercihlerinizi belirleyin, size özel yerler keşfedin</p>
        </div>

        <div class="content">
            <div class="preferences-section">
                <h2 class="section-title">
                    <i class="fas fa-sliders-h"></i>
                    Tercihlerinizi Belirleyin
                </h2>
                <p style="color: #666; font-size: 1rem; margin-bottom: 25px; text-align: center; line-height: 1.6;">
                    Aşağıdaki kategorilerde ne kadar ilginiz olduğunu belirtin.
                    <strong>0</strong> hiç ilgim yok, <strong>100</strong> çok ilgiliyim anlamına gelir.
                </p>

                <div class="slider-container">
                    <div class="slider-row">
                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-tree"></i>
                                <span>Doğa</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="doga">
                            <div class="slider-value" id="doga-value">0</div>
                        </div>

                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-utensils"></i>
                                <span>Yemek</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="yemek">
                            <div class="slider-value" id="yemek-value">0</div>
                        </div>

                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-landmark"></i>
                                <span>Tarih</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="tarihi">
                            <div class="slider-value" id="tarihi-value">0</div>
                        </div>

                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-gamepad"></i>
                                <span>Eğlence</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="eglence">
                            <div class="slider-value" id="eglence-value">0</div>
                        </div>

                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-palette"></i>
                                <span>Sanat & Kültür</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="sanat_kultur">
                            <div class="slider-value" id="sanat_kultur-value">0</div>
                        </div>

                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-mountain"></i>
                                <span>Macera</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="macera">
                            <div class="slider-value" id="macera-value">0</div>
                        </div>

                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-spa"></i>
                                <span>Rahatlatıcı</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="rahatlatici">
                            <div class="slider-value" id="rahatlatici-value">0</div>
                        </div>

                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-running"></i>
                                <span>Spor</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="spor">
                            <div class="slider-value" id="spor-value">0</div>
                        </div>

                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-shopping-bag"></i>
                                <span>Alışveriş</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="alisveris">
                            <div class="slider-value" id="alisveris-value">0</div>
                        </div>

                        <div class="slider-item">
                            <div class="slider-label">
                                <i class="fas fa-moon"></i>
                                <span>Gece Hayatı</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="slider" id="gece_hayati">
                            <div class="slider-value" id="gece_hayati-value">0</div>
                        </div>
                    </div>
                </div>

                <button class="recommend-btn" id="recommendBtn">
                    <i class="fas fa-magic"></i> Önerilerimi Getir
                </button>
            </div>

            <div class="results-section" id="resultsSection">
                <h2 class="section-title">
                    <i class="fas fa-star"></i>
                    Size Özel Öneriler
                </h2>

                <div id="loadingIndicator" class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Öneriler hazırlanıyor...</p>
                </div>

                <div id="recommendationResults"></div>

                <div id="routeSection" style="display: none; margin-top: 30px;">
                    <h3 class="section-title">
                        <i class="fas fa-route"></i>
                        Rota Planlayıcı
                    </h3>
                    <div
                        style="background: rgba(255, 255, 255, 0.9); border-radius: 16px; padding: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3);">
                        <div id="routeContainer">
                            <p style="text-align: center; color: #666; font-style: italic;">Rota oluşturmak için
                                POI'leri seçin</p>
                        </div>
                    </div>
                </div>

                <div id="mapContainer" class="map-container" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Media Modal Overlay -->
    <div id="mediaModal" class="media-modal">
        <div class="media-modal-content">
            <div class="media-modal-header">
                <h3 class="media-modal-title" id="mediaModalTitle">Medya Görüntüleyici</h3>
                <button class="media-modal-close" id="mediaModalClose" aria-label="Kapat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="media-modal-body" id="mediaModalBody">
                <div class="media-loading">
                    <i class="fas fa-spinner"></i>
                    <p>Medya yükleniyor...</p>
                </div>
            </div>

            <!-- Navigation Controls -->
            <button class="media-navigation media-nav-prev media-nav-btn" id="mediaPrevBtn" aria-label="Önceki">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="media-navigation media-nav-next media-nav-btn" id="mediaNextBtn" aria-label="Sonraki">
                <i class="fas fa-chevron-right"></i>
            </button>

            <!-- Media Counter -->
            <div class="media-counter" id="mediaCounter" style="display: none;">
                1 / 1
            </div>

            <!-- Thumbnail Strip -->
            <div class="media-thumbnails" id="mediaThumbnails" style="display: none;">
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/marslan390/BeautifyMarker/leaflet-beautify-marker-icon.min.js"></script>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/marslan390/BeautifyMarker/leaflet-beautify-marker-icon.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@3.0.0/Control.FullScreen.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@3.0.0/Control.FullScreen.css" />

    <!-- Route Details Panel -->
    <div id="routeDetailsPanel" class="route-details-panel">
        <div class="route-header">
            <h3>Rota Detayları</h3>
            <button class="close-btn" onclick="RouteDetailsPanel.hide()">×</button>
        </div>
        
        <div class="route-summary">
            <div class="summary-item">
                <i class="fas fa-route"></i>
                <span id="routeDistance">-- km</span>
            </div>
            <div class="summary-item">
                <i class="fas fa-clock"></i>
                <span id="routeDuration">-- saat</span>
            </div>
            <div class="summary-item">
                <i class="fas fa-map-marker-alt"></i>
                <span id="routeStops">-- durak</span>
            </div>
            <div class="summary-item">
                <i class="fas fa-walking"></i>
                <span id="routeType">--</span>
            </div>
        </div>
        
        <div class="elevation-section" id="elevationSection">
            <h4>Yükseklik Profili</h4>
            <canvas id="elevationChart" width="300" height="150"></canvas>
            <div class="elevation-stats">
                <span id="minElevation">Min: --m</span>
                <span id="maxElevation">Max: --m</span>
                <span id="totalAscent">↗ --m</span>
                <span id="totalDescent">↘ --m</span>
            </div>
        </div>
        
        <div class="stops-section">
            <h4>Duraklar</h4>
            <div class="stops-list" id="stopsList">
                <!-- Durak listesi buraya dinamik olarak eklenecek -->
            </div>
        </div>
        
        <div class="export-section">
            <button class="export-btn google-maps" onclick="RouteDetailsPanel.exportToGoogleMaps()">
                <i class="fab fa-google"></i>
                Google Maps'e Aktar
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script>
        // Global variables
        let map = null;
        let markers = [];
        let routingControl = null;
        let selectedPOIs = [];
        let mediaCache = {};
        let userLocation = null;
        let startLocation = null;
        const apiBase = '/api';

        // Rating categories with their display names and icons
        const ratingCategories = {
            'doga': { name: 'Doğa', icon: 'fas fa-tree' },
            'yemek': { name: 'Yemek', icon: 'fas fa-utensils' },
            'tarihi': { name: 'Tarih', icon: 'fas fa-landmark' },
            'eglence': { name: 'Eğlence', icon: 'fas fa-gamepad' },
            'sanat_kultur': { name: 'Sanat & Kültür', icon: 'fas fa-palette' },
            'macera': { name: 'Macera', icon: 'fas fa-mountain' },
            'rahatlatici': { name: 'Rahatlatıcı', icon: 'fas fa-spa' },
            'spor': { name: 'Spor', icon: 'fas fa-running' },
            'alisveris': { name: 'Alışveriş', icon: 'fas fa-shopping-bag' },
            'gece_hayati': { name: 'Gece Hayatı', icon: 'fas fa-moon' }
        };

        // Category display names
        const categoryNames = {
            'doga_macera': 'Doğa & Macera',
            'gastronomik': 'Gastronomi',
            'konaklama': 'Konaklama',
            'kulturel': 'Kültürel',
            'sanatsal': 'Sanatsal'
        };

        // Category colors and icons for markers
        const categoryStyles = {
            'doga_macera': { color: '#2ecc71', icon: '🌿' },
            'gastronomik': { color: '#e74c3c', icon: '🍽️' },
            'konaklama': { color: '#9b59b6', icon: '🏨' },
            'kulturel': { color: '#3498db', icon: '🏛️' },
            'sanatsal': { color: '#f39c12', icon: '🎨' }
        };

        // Route Details Panel Class
        class RouteDetailsPanel {
            constructor() {
                this.panel = document.getElementById('routeDetailsPanel');
                this.currentRoute = null;
                this.elevationChart = null;
                this.isVisible = false;
            }

            static getInstance() {
                if (!window.routeDetailsPanelInstance) {
                    window.routeDetailsPanelInstance = new RouteDetailsPanel();
                }
                return window.routeDetailsPanelInstance;
            }

            show(routeData) {
                console.log('🎯 Showing route details panel with data:', routeData);
                
                this.currentRoute = routeData;
                this.updateSummary(routeData);
                this.updateStopsList(routeData);
                this.loadElevationProfile(routeData);
                
                this.panel.classList.add('show');
                this.isVisible = true;
                
                // Store bound functions for proper removal
                this.boundKeydownHandler = this.handleKeydown.bind(this);
                this.boundClickOutsideHandler = this.handleClickOutside.bind(this);
                
                // Add keyboard event listener for Escape key
                document.addEventListener('keydown', this.boundKeydownHandler);
                
                // Add click outside to close
                document.addEventListener('click', this.boundClickOutsideHandler);
            }

            hide() {
                console.log('🎯 Hiding route details panel');
                
                this.panel.classList.remove('show');
                this.isVisible = false;
                this.currentRoute = null;
                
                // Remove event listeners
                if (this.boundKeydownHandler) {
                    document.removeEventListener('keydown', this.boundKeydownHandler);
                    this.boundKeydownHandler = null;
                }
                if (this.boundClickOutsideHandler) {
                    document.removeEventListener('click', this.boundClickOutsideHandler);
                    this.boundClickOutsideHandler = null;
                }
                
                // Destroy chart if exists
                if (this.elevationChart) {
                    this.elevationChart.destroy();
                    this.elevationChart = null;
                }
            }

            handleKeydown(event) {
                if (event.key === 'Escape' && this.isVisible) {
                    this.hide();
                }
            }

            handleClickOutside(event) {
                if (this.isVisible && !this.panel.contains(event.target)) {
                    // Don't close if clicking on route lines
                    if (!event.target.closest('.leaflet-interactive')) {
                        this.hide();
                    }
                }
            }

            updateSummary(routeData) {
                const distance = routeData.total_distance || '0';
                const duration = routeData.estimated_time || '0';
                const stops = routeData.waypoints ? routeData.waypoints.length : selectedPOIs.length;
                const routeType = routeData.route_type || 'yürüyüş';

                document.getElementById('routeDistance').textContent = ${distance} km;
                document.getElementById('routeDuration').textContent = ${Math.round(duration / 60)} saat;
                document.getElementById('routeStops').textContent = ${stops} durak;
                document.getElementById('routeType').textContent = routeType;
            }

            updateStopsList(routeData) {
                const stopsList = document.getElementById('stopsList');
                let stopsHTML = '';

                // Add start location if exists
                if (startLocation) {
                    stopsHTML += 
                        <div class="stop-item" onclick="RouteDetailsPanel.highlightStop(${startLocation.latitude}, ${startLocation.longitude})">
                            <div class="stop-icon" style="background: #28a745;">
                                📍
                            </div>
                            <div class="stop-info">
                                <div class="stop-name">${startLocation.name || 'Başlangıç Noktası'}</div>
                                <div class="stop-category">Başlangıç</div>
                            </div>
                        </div>
                    ;
                }

                // Add POI stops
                selectedPOIs.forEach((poi, index) => {
                    const categoryStyle = categoryStyles[poi.category] || { color: '#667eea', icon: '📍' };
                    stopsHTML += 
                        <div class="stop-item" onclick="RouteDetailsPanel.highlightStop(${poi.latitude}, ${poi.longitude})">
                            <div class="stop-icon" style="background: ${categoryStyle.color};">
                                ${categoryStyle.icon}
                            </div>
                            <div class="stop-info">
                                <div class="stop-name">${poi.name}</div>
                                <div class="stop-category">${categoryNames[poi.category] || poi.category}</div>
                            </div>
                        </div>
                    ;
                });

                stopsList.innerHTML = stopsHTML;
            }

            static highlightStop(lat, lng) {
                console.log('🎯 Highlighting stop at:', lat, lng);
                
                // Find and highlight the marker
                markers.forEach(marker => {
                    const markerLatLng = marker.getLatLng();
                    if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lng) < 0.0001) {
                        // Center map on marker and open popup
                        map.setView([lat, lng], 16);
                        marker.openPopup();
                        
                        // Add temporary highlight effect
                        const markerElement = marker.getElement();
                        if (markerElement) {
                            markerElement.style.transform += ' scale(1.2)';
                            markerElement.style.transition = 'transform 0.3s ease';
                            
                            setTimeout(() => {
                                markerElement.style.transform = markerElement.style.transform.replace(' scale(1.2)', '');
                            }, 1000);
                        }
                    }
                });
            }

            async loadElevationProfile(routeData) {
                try {
                    // Show loading state
                    this.showElevationLoading();
                    
                    // Collect elevation data for all waypoints
                    const elevationData = await this.collectElevationData(routeData);
                    
                    // Calculate statistics
                    const stats = this.calculateElevationStats(elevationData);
                    
                    // Update statistics display
                    this.updateElevationStats(stats);
                    
                    // Create interactive chart
                    this.createElevationChart(elevationData);
                    
                } catch (error) {
                    console.error('Error loading elevation profile:', error);
                    this.showElevationError();
                }
            }

            showElevationLoading() {
                document.getElementById('minElevation').textContent = 'Min: Yükleniyor...';
                document.getElementById('maxElevation').textContent = 'Max: Yükleniyor...';
                document.getElementById('totalAscent').textContent = '↗ Yükleniyor...';
                document.getElementById('totalDescent').textContent = '↘ Yükleniyor...';
            }

            showElevationError() {
                document.getElementById('minElevation').textContent = 'Min: Hata';
                document.getElementById('maxElevation').textContent = 'Max: Hata';
                document.getElementById('totalAscent').textContent = '↗ Hata';
                document.getElementById('totalDescent').textContent = '↘ Hata';
                
                // Show error chart
                const ctx = document.getElementById('elevationChart').getContext('2d');
                if (this.elevationChart) {
                    this.elevationChart.destroy();
                }
                
                this.elevationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Veri Yüklenemedi'],
                        datasets: [{
                            label: 'Yükseklik (m)',
                            data: [0],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            async collectElevationData(routeData) {
                const waypoints = [];
                let cumulativeDistance = 0;

                // Add start location
                if (routeData.start) {
                    waypoints.push({
                        lat: routeData.start.lat,
                        lng: routeData.start.lng,
                        name: 'Başlangıç',
                        distance: 0
                    });
                }

                // Add all POI waypoints with distance calculation
                if (routeData.waypoints && routeData.waypoints.length > 0) {
                    for (let i = 0; i < routeData.waypoints.length; i++) {
                        const poi = routeData.waypoints[i];
                        const prevPoint = i === 0 ? routeData.start : routeData.waypoints[i - 1];
                        
                        if (prevPoint) {
                            const segmentDistance = this.calculateDistance(
                                prevPoint.lat || prevPoint.latitude,
                                prevPoint.lng || prevPoint.longitude,
                                poi.lat || poi.latitude,
                                poi.lng || poi.longitude
                            );
                            cumulativeDistance += segmentDistance;
                        }

                        waypoints.push({
                            lat: poi.lat || poi.latitude,
                            lng: poi.lng || poi.longitude,
                            name: poi.name,
                            distance: cumulativeDistance
                        });
                    }
                }

                // Collect elevation data with caching
                const elevationPromises = waypoints.map(async (point, index) => {
                    const elevation = await this.getElevationWithCache(point.lat, point.lng);
                    return {
                        distance: point.distance,
                        elevation: elevation,
                        name: point.name,
                        pointIndex: index,
                        lat: point.lat,
                        lng: point.lng
                    };
                });

                return Promise.all(elevationPromises);
            }

            async getElevationWithCache(lat, lng) {
                const cacheKey = elevation_${lat.toFixed(4)}_${lng.toFixed(4)};
                
                // Check localStorage cache first
                try {
                    const cached = localStorage.getItem(cacheKey);
                    if (cached) {
                        const cacheData = JSON.parse(cached);
                        const now = Date.now();
                        // Cache for 24 hours
                        if (now - cacheData.timestamp < 24 * 60 * 60 * 1000) {
                            console.log(`📦 Using cached elevation for ${lat.toFixed(4)}, ${lng.toFixed(4)}: ${cacheData.elevation}m`);
                            return cacheData.elevation;
                        }
                    }
                } catch (error) {
                    console.warn('Error reading elevation cache:', error);
                }

                // Get fresh elevation data
                const elevation = await getElevation(lat, lng);
                
                // Cache the result
                try {
                    localStorage.setItem(cacheKey, JSON.stringify({
                        elevation: elevation,
                        timestamp: Date.now()
                    }));
                } catch (error) {
                    console.warn('Error caching elevation data:', error);
                }

                return elevation;
            }

            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Earth's radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c * 1000; // Return in meters
            }

            calculateElevationStats(elevationData) {
                if (!elevationData || elevationData.length === 0) {
                    return {
                        minElevation: 0,
                        maxElevation: 0,
                        avgElevation: 0,
                        totalAscent: 0,
                        totalDescent: 0,
                        elevationGain: 0
                    };
                }

                const elevations = elevationData.map(d => d.elevation);
                const minElevation = Math.min(...elevations);
                const maxElevation = Math.max(...elevations);
                const avgElevation = Math.round(elevations.reduce((sum, e) => sum + e, 0) / elevations.length);

                let totalAscent = 0;
                let totalDescent = 0;

                // Calculate ascent and descent
                for (let i = 1; i < elevationData.length; i++) {
                    const elevationDiff = elevationData[i].elevation - elevationData[i - 1].elevation;
                    if (elevationDiff > 0) {
                        totalAscent += elevationDiff;
                    } else {
                        totalDescent += Math.abs(elevationDiff);
                    }
                }

                const elevationGain = maxElevation - minElevation;

                return {
                    minElevation,
                    maxElevation,
                    avgElevation,
                    totalAscent: Math.round(totalAscent),
                    totalDescent: Math.round(totalDescent),
                    elevationGain: Math.round(elevationGain)
                };
            }

            updateElevationStats(stats) {
                document.getElementById('minElevation').textContent = Min: ${stats.minElevation}m;
                document.getElementById('maxElevation').textContent = Max: ${stats.maxElevation}m;
                document.getElementById('totalAscent').textContent = ↗ ${stats.totalAscent}m;
                document.getElementById('totalDescent').textContent = ↘ ${stats.totalDescent}m;
            }

            createElevationChart(elevationData) {
                const ctx = document.getElementById('elevationChart').getContext('2d');
                
                if (this.elevationChart) {
                    this.elevationChart.destroy();
                }

                // Prepare chart data
                const labels = elevationData.map(d => {
                    if (d.distance === 0) return 'Başlangıç';
                    return ${(d.distance / 1000).toFixed(1)}km;
                });

                const elevations = elevationData.map(d => d.elevation);
                const names = elevationData.map(d => d.name);

                this.elevationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Yükseklik (m)',
                            data: elevations,
                            borderColor: '#4285f4',
                            backgroundColor: 'rgba(66, 133, 244, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#4285f4',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { 
                                display: false 
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        return names[index] || Nokta ${index + 1};
                                    },
                                    label: function(context) {
                                        const elevation = context.parsed.y;
                                        const distance = elevationData[context.dataIndex].distance;
                                        return [
                                            Yükseklik: ${elevation}m,
                                            Mesafe: ${(distance / 1000).toFixed(1)}km
                                        ];
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#4285f4',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Yükseklik (m)',
                                    color: '#666'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    color: '#666'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Mesafe',
                                    color: '#666'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    color: '#666',
                                    maxRotation: 45
                                }
                            }
                        },
                        onHover: (event, activeElements) => {
                            event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                        },
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                const point = elevationData[index];
                                console.log(`Clicked on elevation point: ${point.name} at ${point.elevation}m`);
                                
                                // Optional: Highlight corresponding stop in the stops list
                                const stopItems = document.querySelectorAll('.stop-item');
                                stopItems.forEach((item, i) => {
                                    item.classList.toggle('highlighted', i === index);
                                });
                            }
                        }
                    }
                });
            }

            static exportToGoogleMaps() {
                const instance = RouteDetailsPanel.getInstance();
                if (!instance.currentRoute) {
                    showNotification('❌ Aktif rota bulunamadı', 'error');
                    return;
                }

                if (selectedPOIs.length === 0) {
                    showNotification('❌ Önce POI seçin', 'error');
                    return;
                }

                let waypoints = [];

                // Add start location
                if (startLocation) {
                    waypoints.push(${startLocation.latitude},${startLocation.longitude});
                }

                // Add all POIs
                selectedPOIs.forEach(poi => {
                    waypoints.push(${poi.latitude},${poi.longitude});
                });

                if (waypoints.length < 2) {
                    showNotification('❌ En az 2 nokta gerekli', 'error');
                    return;
                }

                // Create Google Maps URL with all waypoints
                const origin = waypoints[0];
                const destination = waypoints[waypoints.length - 1];
                const intermediateWaypoints = waypoints.slice(1, -1);

                let url = https://www.google.com/maps/dir/${origin};
                
                // Add intermediate waypoints
                intermediateWaypoints.forEach(waypoint => {
                    url += /${waypoint};
                });
                
                // Add destination
                url += /${destination};

                // Open in new tab
                window.open(url, '_blank');
                
                showNotification('✅ Google Maps\'te açılıyor...', 'success');
            }

            static show(routeData) {
                const instance = RouteDetailsPanel.getInstance();
                instance.show(routeData);
            }

            static hide() {
                const instance = RouteDetailsPanel.getInstance();
                instance.hide();
            }
        }

        // Create custom marker icons
        function createCustomIcon(category, score) {
            const style = categoryStyles[category] || { color: '#667eea', icon: '📍' };

            return L.divIcon({
                html: 
                    <div style="
                        background: ${style.color};
                        width: 40px;
                        height: 40px;
                        border-radius: 50% 50% 50% 0;
                        border: 3px solid white;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 18px;
                        transform: rotate(-45deg);
                        position: relative;
                    ">
                        <span style="transform: rotate(45deg);">${style.icon}</span>
                        <div style="
                            position: absolute;
                            top: -8px;
                            right: -8px;
                            background: white;
                            color: ${style.color};
                            border-radius: 50%;
                            width: 20px;
                            height: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            font-weight: bold;
                            border: 2px solid ${style.color};
                            transform: rotate(45deg);
                        ">${score}</div>
                    </div>
                ,
                className: 'custom-poi-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }

        // Load POI media files
        async function loadPOIMedia(poiId) {
            if (mediaCache[poiId]) {
                return mediaCache[poiId];
            }

            try {
                const response = await fetch(`${apiBase}/poi/${poiId}/media`);
                if (response.ok) {
                    const apiData = await response.json();

                    // Convert API format to expected format
                    const mediaData = {
                        images: [],
                        videos: [],
                        audio: [],
                        models: []
                    };

                    if (apiData.media && Array.isArray(apiData.media)) {
                        console.log('Processing media for POI:', poiId, apiData.media);
                        apiData.media.forEach(item => {
                            switch (item.media_type) {
                                case 'image':
                                    mediaData.images.push({
                                        filename: item.filename,
                                        description: item.description || '',
                                        path: item.path,
                                        preview_path: item.preview_path
                                    });
                                    break;
                                case 'video':
                                    mediaData.videos.push({
                                        filename: item.filename,
                                        description: item.description || '',
                                        path: item.path
                                    });
                                    break;
                                case 'audio':
                                    mediaData.audio.push({
                                        filename: item.filename,
                                        description: item.description || '',
                                        path: item.path
                                    });
                                    break;
                                case 'model':
                                    mediaData.models.push({
                                        filename: item.filename,
                                        description: item.description || '',
                                        path: item.path
                                    });
                                    break;
                            }
                        });
                    }

                    mediaCache[poiId] = mediaData;
                    return mediaData;
                }
            } catch (error) {
                console.error('Error loading POI media:', error);
            }

            return { images: [], videos: [], audio: [], models: [] };
        }

        // Create media gallery HTML
        function createMediaGallery(media, poi = {}) {
            console.log('Creating media gallery with:', media);
            if (!media || (!media.images?.length && !media.videos?.length && !media.audio?.length)) {
                console.log('No media found or empty arrays');
                return '';
            }

            let galleryHTML = '<div style="margin-top: 12px; border-top: 1px solid #eee; padding-top: 12px;">';

            // Prepare all media items for navigation and cache them
            const allMediaItems = [];
            const poiCacheKey = poi_${poi.id || poi.name || Date.now()};

            // Add images to media items
            if (media.images && media.images.length > 0) {
                media.images.forEach((image, index) => {
                    allMediaItems.push({
                        type: 'image',
                        path: image.path || image.filename,
                        title: image.description || Görsel ${index + 1},
                        originalIndex: index
                    });
                });
            }

            // Add videos to media items
            if (media.videos && media.videos.length > 0) {
                media.videos.forEach((video, index) => {
                    allMediaItems.push({
                        type: 'video',
                        path: video.path || video.filename,
                        title: video.description || Video ${index + 1},
                        originalIndex: index
                    });
                });
            }

            // Add audio to media items
            if (media.audio && media.audio.length > 0) {
                media.audio.forEach((audio, index) => {
                    allMediaItems.push({
                        type: 'audio',
                        path: audio.path || audio.filename,
                        title: audio.description || Ses ${index + 1},
                        originalIndex: index
                    });
                });
            }

            // Cache the media items
            poiMediaCache[poiCacheKey] = {
                items: allMediaItems,
                poiName: poi.name || 'POI'
            };

            // Images
            if (media.images && media.images.length > 0) {
                galleryHTML += '<div style="margin-bottom: 8px;">';
                galleryHTML += '<div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px;">📸 Görseller</div>';
                galleryHTML += '<div style="display: flex; gap: 4px; overflow-x: auto; padding: 2px;">';

                media.images.slice(0, 3).forEach((image, index) => {
                    const imagePath = image.preview_path || image.path || poi_media/${image.filename};
                    const mediaItemIndex = allMediaItems.findIndex(item =>
                        item.type === 'image' && item.originalIndex === index
                    );

                    galleryHTML += 
                        <img src="/${imagePath}" 
                             style="width: 60px; height: 45px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                             onclick="showPOIMediaFromCache('${poiCacheKey}', ${mediaItemIndex})"
                             title="${image.description || 'Görsel'}" />
                    ;
                });

                if (media.images.length > 3) {
                    const firstImageIndex = allMediaItems.findIndex(item => item.type === 'image');
                    galleryHTML += 
                        <div style="width: 60px; height: 45px; background: rgba(0,0,0,0.7); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer;"
                             onclick="showPOIMediaFromCache('${poiCacheKey}', ${firstImageIndex})">
                        +${media.images.length - 3}
                        </div>
                    ;
                }

                galleryHTML += '</div></div>';
            }

            // Videos
            if (media.videos && media.videos.length > 0) {
                galleryHTML += '<div style="margin-bottom: 8px;">';
                galleryHTML += '<div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px;">🎥 Videolar</div>';
                galleryHTML += '<div style="display: flex; gap: 4px;">';

                media.videos.slice(0, 2).forEach((video, index) => {
                    const mediaItemIndex = allMediaItems.findIndex(item =>
                        item.type === 'video' && item.originalIndex === index
                    );

                    galleryHTML += 
                        <div style="background: #f0f0f0; padding: 6px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; border: 1px solid #ddd;"
                             onclick="showPOIMediaFromCache('${poiCacheKey}', ${mediaItemIndex})">
                            🎥 ${video.description || 'Video'}
                        </div>
                    ;
                });

                galleryHTML += '</div></div>';
            }

            // Audio
            if (media.audio && media.audio.length > 0) {
                galleryHTML += '<div style="margin-bottom: 8px;">';
                galleryHTML += '<div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px;">🎵 Ses Dosyaları</div>';
                galleryHTML += '<div style="display: flex; gap: 4px;">';

                media.audio.slice(0, 2).forEach((audio, index) => {
                    const mediaItemIndex = allMediaItems.findIndex(item =>
                        item.type === 'audio' && item.originalIndex === index
                    );

                    galleryHTML += 
                        <div style="background: #f0f0f0; padding: 6px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; border: 1px solid #ddd;"
                             onclick="showPOIMediaFromCache('${poiCacheKey}', ${mediaItemIndex})">
                            🎵 ${audio.description || 'Ses'}
                        </div>
                    ;
                });

                galleryHTML += '</div></div>';
            }

            galleryHTML += '</div>';
            return galleryHTML;
        }

        // Open media modal
        // Enhanced media modal with navigation functionality
        let currentMediaItems = [];
        let currentMediaIndex = 0;
        let currentPOIId = null;
        let poiMediaCache = {}; // Cache for POI media items

        function showMediaModal(mediaItems, startIndex = 0, poiId = null) {
            if (!mediaItems || mediaItems.length === 0) {
                console.warn('No media items provided');
                return;
            }

            currentMediaItems = mediaItems;
            currentMediaIndex = startIndex;
            currentPOIId = poiId;

            const modal = document.getElementById('mediaModal');
            const modalTitle = document.getElementById('mediaModalTitle');
            const modalBody = document.getElementById('mediaModalBody');
            const modalClose = document.getElementById('mediaModalClose');
            const prevBtn = document.getElementById('mediaPrevBtn');
            const nextBtn = document.getElementById('mediaNextBtn');
            const counter = document.getElementById('mediaCounter');
            const thumbnails = document.getElementById('mediaThumbnails');

            // Show modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // Update navigation visibility
            updateNavigationControls();

            // Load current media
            loadCurrentMedia();

            // Setup event handlers
            modalClose.onclick = closeMediaModal;
            prevBtn.onclick = showPreviousMedia;
            nextBtn.onclick = showNextMedia;

            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeMediaModal();
                }
            };

            // Setup keyboard handlers
            document.addEventListener('keydown', handleModalKeydown);

            // Accessibility: Focus management
            setTimeout(() => {
                modalClose.focus();
            }, 100);

            // Accessibility: Announce to screen readers
            announceToScreenReader(Medya görüntüleyici açıldı. ${currentMediaItems.length} medya öğesi mevcut.);
        }

        function loadCurrentMedia() {
            if (currentMediaIndex < 0 || currentMediaIndex >= currentMediaItems.length) {
                return;
            }

            const mediaItem = currentMediaItems[currentMediaIndex];
            const modalTitle = document.getElementById('mediaModalTitle');
            const modalBody = document.getElementById('mediaModalBody');

            // Set title
            modalTitle.textContent = mediaItem.title || Medya ${currentMediaIndex + 1};

            // Show loading state
            modalBody.innerHTML = 
                <div class="media-loading">
                    <i class="fas fa-spinner"></i>
                    <p>Medya yükleniyor...</p>
                </div>
            ;

            // Load media content
            setTimeout(() => {
                const mediaPath = mediaItem.path.startsWith('/') ? mediaItem.path : /${mediaItem.path};
                let content = '';

                if (mediaItem.type === 'image') {
                    content = 
                        <div class="media-display">
                            <div class="media-image-container">
                                <img id="currentMediaImage" 
                                     class="media-image-zoomable"
                                     src="${mediaPath}" 
                                     alt="${mediaItem.title || 'Görsel'}"
                                     onload="onImageLoad(this)"
                                     onerror="handleMediaError(this, 'Görsel')"
                                     style="opacity: 0; transition: opacity 0.3s ease;" />
                                <div class="image-zoom-controls">
                                    <button class="zoom-btn" id="zoomInBtn" onclick="zoomImage(1.2)" title="Yakınlaştır">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button class="zoom-btn" id="zoomOutBtn" onclick="zoomImage(0.8)" title="Uzaklaştır">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                    <button class="zoom-btn" id="zoomResetBtn" onclick="resetImageZoom()" title="Sıfırla">
                                        <i class="fas fa-expand-arrows-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    ;
                } else if (mediaItem.type === 'video') {
                    content = 
                        <div class="media-display">
                            <div class="media-video-container">
                                <video id="currentMediaVideo" 
                                       controls preload="metadata"
                                       onloadeddata="onVideoLoad(this)"
                                       onerror="handleMediaError(this, 'Video')"
                                       ontimeupdate="updateVideoProgress(this)"
                                       style="opacity: 0; transition: opacity 0.3s ease; max-width: 100%; max-height: 70vh; border-radius: 8px;">
                                    <source src="${mediaPath}" type="video/mp4">
                                    <source src="${mediaPath}" type="video/webm">
                                    <source src="${mediaPath}" type="video/ogg">
                                    Video formatı desteklenmiyor.
                                </video>
                                <div class="media-progress">
                                    <div class="media-progress-bar" id="videoProgressBar"></div>
                                </div>
                            </div>
                        </div>
                    ;
                } else if (mediaItem.type === 'audio') {
                    content = 
                        <div class="media-display">
                            <div class="media-audio-container">
                                <div class="audio-info">
                                    <i class="fas fa-music" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 16px;"></i>
                                    <h4>${mediaItem.title || 'Ses Dosyası'}</h4>
                                    <div class="audio-meta">
                                        <span id="audioFormat">Yükleniyor...</span>
                                    </div>
                                </div>
                                <audio id="currentMediaAudio" 
                                       controls preload="metadata" 
                                       style="width: 100%; max-width: 500px; opacity: 0; transition: opacity 0.3s ease;"
                                       onloadeddata="onAudioLoad(this)"
                                       onerror="handleMediaError(this, 'Ses')"
                                       ontimeupdate="updateAudioProgress(this)">
                                    <source src="${mediaPath}" type="audio/mpeg">
                                    <source src="${mediaPath}" type="audio/wav">
                                    <source src="${mediaPath}" type="audio/ogg">
                                    Ses formatı desteklenmiyor.
                                </audio>
                                <div class="media-progress">
                                    <div class="media-progress-bar" id="audioProgressBar"></div>
                                </div>
                            </div>
                        </div>
                    ;
                }

                modalBody.innerHTML = content;
                updateNavigationControls();
            }, 300);
        }

        function updateNavigationControls() {
            const prevBtn = document.getElementById('mediaPrevBtn');
            const nextBtn = document.getElementById('mediaNextBtn');
            const counter = document.getElementById('mediaCounter');
            const thumbnails = document.getElementById('mediaThumbnails');

            // Update navigation buttons
            prevBtn.disabled = currentMediaIndex <= 0;
            nextBtn.disabled = currentMediaIndex >= currentMediaItems.length - 1;

            // Show/hide navigation based on media count
            if (currentMediaItems.length > 1) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                counter.style.display = 'block';
                counter.textContent = ${currentMediaIndex + 1} / ${currentMediaItems.length};

                // Update thumbnails if there are images
                updateThumbnails();
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                counter.style.display = 'none';
                thumbnails.style.display = 'none';
            }
        }

        function updateThumbnails() {
            const thumbnails = document.getElementById('mediaThumbnails');

            // Only show thumbnails for images
            const imageItems = currentMediaItems.filter(item => item.type === 'image');
            if (imageItems.length <= 1) {
                thumbnails.style.display = 'none';
                return;
            }

            thumbnails.style.display = 'flex';
            thumbnails.innerHTML = '';

            currentMediaItems.forEach((item, index) => {
                if (item.type === 'image') {
                    const thumb = document.createElement('img');
                    thumb.className = 'media-thumbnail';
                    thumb.src = item.path.startsWith('/') ? item.path : /${item.path};
                    thumb.alt = item.title || Görsel ${index + 1};

                    if (index === currentMediaIndex) {
                        thumb.classList.add('active');
                    }

                    thumb.onclick = () => {
                        currentMediaIndex = index;
                        loadCurrentMedia();
                    };

                    thumbnails.appendChild(thumb);
                }
            });
        }

        function showPreviousMedia() {
            if (currentMediaIndex > 0) {
                currentMediaIndex--;
                loadCurrentMedia();
            }
        }

        function showNextMedia() {
            if (currentMediaIndex < currentMediaItems.length - 1) {
                currentMediaIndex++;
                loadCurrentMedia();
            }
        }

        function closeMediaModal() {
            const modal = document.getElementById('mediaModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            document.removeEventListener('keydown', handleModalKeydown);

            // Reset state
            currentMediaItems = [];
            currentMediaIndex = 0;
            currentPOIId = null;
        }

        function handleModalKeydown(e) {
            switch (e.key) {
                case 'Escape':
                    closeMediaModal();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    showPreviousMedia();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    showNextMedia();
                    break;
                case ' ':
                    // Spacebar for play/pause on videos and audio
                    e.preventDefault();
                    const video = document.querySelector('.media-display video');
                    const audio = document.querySelector('.media-display audio');
                    if (video) {
                        video.paused ? video.play() : video.pause();
                    } else if (audio) {
                        audio.paused ? audio.play() : audio.pause();
                    }
                    break;
            }
        }

        // Touch gesture support for mobile navigation
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;

        function setupTouchGestures() {
            const modal = document.getElementById('mediaModal');

            modal.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            });

            modal.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipeGesture();
            });
        }

        function handleSwipeGesture() {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const minSwipeDistance = 50;

            // Only handle horizontal swipes that are longer than vertical swipes
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                if (deltaX > 0) {
                    // Swipe right - show previous
                    showPreviousMedia();
                } else {
                    // Swipe left - show next
                    showNextMedia();
                }
            }
        }

        // Initialize touch gestures when modal is shown
        function initializeTouchSupport() {
            if ('ontouchstart' in window) {
                setupTouchGestures();
                document.body.classList.add('touch-device');
            }
        }

        // Call on page load - REMOVED (merged below)

        // Check if page is served over HTTPS
        function checkSecurityContext() {
            const isSecure = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';

            if (!isSecure && location.hostname !== '127.0.0.1') {
                console.warn('⚠️ Page not served over HTTPS - geolocation may not work');

                // Show a subtle warning
                const warning = document.createElement('div');
                warning.style.cssText = 
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
                    color: white;
                    padding: 12px 16px;
                    border-radius: 10px;
                    font-size: 0.9rem;
                    z-index: 9999;
                    box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
                    max-width: 300px;
                    font-family: 'Segoe UI', sans-serif;
                ;

                warning.innerHTML = 
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 1.2rem; margin-right: 8px;">🔒</span>
                        <strong>Güvenlik Uyarısı</strong>
                    </div>
                    <p style="margin: 0; font-size: 0.85rem; line-height: 1.4;">
                        Konum servisleri için HTTPS gerekli. Manuel konum seçimini kullanabilirsiniz.
                    </p>
                ;

                document.body.appendChild(warning);

                // Auto remove after 8 seconds
                setTimeout(() => {
                    if (warning.parentNode) {
                        warning.style.opacity = '0';
                        warning.style.transform = 'translateX(100%)';
                        setTimeout(() => warning.remove(), 300);
                    }
                }, 8000);
            }
        }

        // Show location permission explanation dialog
        function showLocationPermissionDialog() {
            return new Promise((resolve) => {
                const dialog = document.createElement('div');
                dialog.style.cssText = 
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10001;
                    font-family: 'Segoe UI', sans-serif;
                ;

                dialog.innerHTML = 
                    <div style="
                        background: white;
                        border-radius: 20px;
                        padding: 35px;
                        max-width: 450px;
                        margin: 20px;
                        text-align: center;
                        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
                        animation: modalSlideIn 0.4s ease-out;
                    ">
                        <div style="font-size: 4rem; margin-bottom: 20px;">📍</div>
                        <h3 style="color: #333; margin: 0 0 16px 0; font-size: 1.4rem;">Konum İzni Gerekli</h3>
                        <p style="color: #666; margin: 0 0 20px 0; line-height: 1.6; font-size: 1rem;">
                            Size en yakın POI'leri önerebilmek için konumunuza ihtiyacımız var.
                        </p>
                        
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 25px; text-align: left;">
                            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 1.3rem; margin-right: 10px;">🔒</span>
                                <strong style="color: #333;">Gizlilik Güvencesi</strong>
                            </div>
                            <ul style="margin: 0; padding-left: 20px; color: #555; font-size: 0.9rem; line-height: 1.5;">
                                <li>Konumunuz sadece öneriler için kullanılır</li>
                                <li>Hiçbir yerde saklanmaz veya paylaşılmaz</li>
                                <li>İstediğiniz zaman iptal edebilirsiniz</li>
                            </ul>
                        </div>

                        <div style="background: #e3f2fd; padding: 16px; border-radius: 12px; margin-bottom: 25px; text-align: left;">
                            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 1.3rem; margin-right: 10px;">💡</span>
                                <strong style="color: #1976d2;">Sonraki Adım</strong>
                            </div>
                            <p style="margin: 0; color: #1565c0; font-size: 0.9rem; line-height: 1.5;">
                                "İzin Ver" butonuna tıkladıktan sonra tarayıcınız konum izni isteyecek. 
                                Lütfen <strong>"İzin Ver"</strong> veya <strong>"Allow"</strong> seçeneğini seçin.
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="resolveLocationDialog(false)" 
                                    style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;">
                                İptal
                            </button>
                            <button onclick="resolveLocationDialog(true)" 
                                    style="background: linear-gradient(135deg, var(--primary-color) 0%, #5a6fd8 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                📍 İzin Ver
                            </button>
                        </div>
                    </div>
                ;

                // Add resolve function to global scope temporarily
                window.resolveLocationDialog = (accepted) => {
                    dialog.remove();
                    delete window.resolveLocationDialog;
                    resolve(accepted);
                };

                document.body.appendChild(dialog);
            });
        }

        // Accessibility helper
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.style.position = 'absolute';
            announcement.style.left = '-10000px';
            announcement.style.width = '1px';
            announcement.style.height = '1px';
            announcement.style.overflow = 'hidden';
            announcement.textContent = message;

            document.body.appendChild(announcement);

            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }

        // Debug and testing helper
        function testMediaModal() {
            const testMedia = [
                { type: 'image', path: '/test-image.jpg', title: 'Test Görsel' },
                { type: 'video', path: '/test-video.mp4', title: 'Test Video' },
                { type: 'audio', path: '/test-audio.mp3', title: 'Test Ses' }
            ];

            console.log('Testing media modal with sample data...');
            showMediaModal(testMedia, 0, 'Test POI');
        }

        // Expose test function globally for debugging
        window.testMediaModal = testMediaModal;

        function showMediaError(message, canRetry = true) {
            const modalBody = document.getElementById('mediaModalBody');
            const retryButton = canRetry ? <button onclick="retryLoadMedia()" style="margin-right: 10px;">Tekrar Dene</button> : '';

            modalBody.innerHTML = 
                <div class="media-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Medya Yüklenemedi</h3>
                    <p>${message}</p>
                    <div style="margin-top: 20px;">
                        ${retryButton}
                        <button onclick="closeMediaModal()">Kapat</button>
                    </div>
                </div>
            ;
        }

        function retryLoadMedia() {
            console.log('Retrying media load...');
            loadCurrentMedia();
        }

        // Enhanced error handling for different media types
        function handleMediaError(mediaElement, mediaType) {
            console.error(${mediaType} load error:, mediaElement.error);

            let errorMessage = 'Medya dosyası yüklenemedi';
            if (mediaElement.error) {
                switch (mediaElement.error.code) {
                    case MediaError.MEDIA_ERR_ABORTED:
                        errorMessage = 'Medya yükleme iptal edildi';
                        break;
                    case MediaError.MEDIA_ERR_NETWORK:
                        errorMessage = 'Ağ hatası nedeniyle medya yüklenemedi';
                        break;
                    case MediaError.MEDIA_ERR_DECODE:
                        errorMessage = 'Medya dosyası bozuk veya desteklenmiyor';
                        break;
                    case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        errorMessage = 'Medya formatı desteklenmiyor';
                        break;
                    default:
                        errorMessage = 'Bilinmeyen medya hatası';
                }
            }

            showMediaError(errorMessage, true);
        }

        // Performance optimization: Preload adjacent media
        function preloadAdjacentMedia() {
            if (currentMediaItems.length <= 1) return;

            const preloadNext = currentMediaIndex < currentMediaItems.length - 1;
            const preloadPrev = currentMediaIndex > 0;

            if (preloadNext) {
                const nextItem = currentMediaItems[currentMediaIndex + 1];
                preloadMediaItem(nextItem);
            }

            if (preloadPrev) {
                const prevItem = currentMediaItems[currentMediaIndex - 1];
                preloadMediaItem(prevItem);
            }
        }

        function preloadMediaItem(mediaItem) {
            if (!mediaItem) return;

            const mediaPath = mediaItem.path.startsWith('/') ? mediaItem.path : /${mediaItem.path};

            if (mediaItem.type === 'image') {
                const img = new Image();
                img.src = mediaPath;
            } else if (mediaItem.type === 'video') {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.src = mediaPath;
            }
            // Audio preloading is less critical for performance
        }

        // Helper function for POI media modal from cache
        function showPOIMediaFromCache(cacheKey, startIndex) {
            const cachedData = poiMediaCache[cacheKey];
            if (cachedData && cachedData.items) {
                showMediaModal(cachedData.items, startIndex, cachedData.poiName);
            } else {
                console.error('Media cache not found for key:', cacheKey);
                showMediaError('Medya verileri bulunamadı');
            }
        }

        // Image zoom functionality
        let currentZoom = 1;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let imagePosition = { x: 0, y: 0 };

        function onImageLoad(img) {
            img.style.opacity = '1';
            resetImageZoom();
            setupImageDrag(img);
            // Preload adjacent media after current media loads
            setTimeout(preloadAdjacentMedia, 500);
        }

        function zoomImage(factor) {
            const img = document.getElementById('currentMediaImage');
            if (!img) return;

            currentZoom *= factor;
            currentZoom = Math.max(0.5, Math.min(currentZoom, 3)); // Limit zoom between 0.5x and 3x

            img.style.transform = scale(${currentZoom}) translate(${imagePosition.x}px, ${imagePosition.y}px);

            // Update zoom button states
            document.getElementById('zoomInBtn').disabled = currentZoom >= 3;
            document.getElementById('zoomOutBtn').disabled = currentZoom <= 0.5;

            // Add/remove zoom class for cursor
            if (currentZoom > 1) {
                img.classList.add('media-image-zoomed');
            } else {
                img.classList.remove('media-image-zoomed');
            }
        }

        function resetImageZoom() {
            const img = document.getElementById('currentMediaImage');
            if (!img) return;

            currentZoom = 1;
            imagePosition = { x: 0, y: 0 };
            img.style.transform = 'scale(1) translate(0px, 0px)';
            img.classList.remove('media-image-zoomed');

            // Reset button states
            document.getElementById('zoomInBtn').disabled = false;
            document.getElementById('zoomOutBtn').disabled = false;
        }

        function setupImageDrag(img) {
            img.addEventListener('mousedown', (e) => {
                if (currentZoom <= 1) return;
                isDragging = true;
                dragStart.x = e.clientX - imagePosition.x;
                dragStart.y = e.clientY - imagePosition.y;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging || currentZoom <= 1) return;
                imagePosition.x = e.clientX - dragStart.x;
                imagePosition.y = e.clientY - dragStart.y;
                img.style.transform = scale(${currentZoom}) translate(${imagePosition.x}px, ${imagePosition.y}px);
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // Touch support for mobile
            img.addEventListener('touchstart', (e) => {
                if (currentZoom <= 1) return;
                isDragging = true;
                const touch = e.touches[0];
                dragStart.x = touch.clientX - imagePosition.x;
                dragStart.y = touch.clientY - imagePosition.y;
                e.preventDefault();
            });

            document.addEventListener('touchmove', (e) => {
                if (!isDragging || currentZoom <= 1) return;
                const touch = e.touches[0];
                imagePosition.x = touch.clientX - dragStart.x;
                imagePosition.y = touch.clientY - dragStart.y;
                img.style.transform = scale(${currentZoom}) translate(${imagePosition.x}px, ${imagePosition.y}px);
                e.preventDefault();
            });

            document.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        // Video load handler
        function onVideoLoad(video) {
            video.style.opacity = '1';
            console.log('Video loaded:', video.duration, 'seconds');
            // Preload adjacent media after current media loads
            setTimeout(preloadAdjacentMedia, 500);
        }

        function updateVideoProgress(video) {
            const progressBar = document.getElementById('videoProgressBar');
            if (progressBar && video.duration) {
                const progress = (video.currentTime / video.duration) * 100;
                progressBar.style.width = progress + '%';
            }
        }

        // Audio load handler
        function onAudioLoad(audio) {
            audio.style.opacity = '1';
            const formatSpan = document.getElementById('audioFormat');
            if (formatSpan) {
                const duration = audio.duration;
                if (duration && !isNaN(duration)) {
                    const minutes = Math.floor(duration / 60);
                    const seconds = Math.floor(duration % 60);
                    formatSpan.textContent = Süre: ${minutes}:${seconds.toString().padStart(2, '0')};
                } else {
                    formatSpan.textContent = 'Ses dosyası hazır';
                }
            }
            // Preload adjacent media after current media loads
            setTimeout(preloadAdjacentMedia, 500);
        }

        function updateAudioProgress(audio) {
            const progressBar = document.getElementById('audioProgressBar');
            if (progressBar && audio.duration) {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = progress + '%';
            }
        }

        // Backward compatibility function
        function openMediaModal(filePath, type, title = 'Medya Görüntüleyici') {
            const mediaItem = {
                path: filePath,
                type: type,
                title: title
            };
            showMediaModal([mediaItem], 0);
        }

        // Get elevation data with fallback
        async function getElevation(lat, lng) {
            try {
                // Try Open-Elevation API first
                const response = await fetch(https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const elevation = data.results[0]?.elevation || 0;
                    console.log(`🏔️ Real elevation for ${lat.toFixed(4)}, ${lng.toFixed(4)}: ${elevation}m`);
                    return Math.round(elevation);
                }
                throw new Error(`API response not ok: ${response.status}`);

            } catch (error) {
                console.warn('Elevation API failed, using estimated elevation:', error.message);

                // Fallback: Estimate elevation for Cappadocia region
                // Ürgüp is approximately 1000-1200m above sea level
                const baseElevation = 1100;
                const variation = Math.random() * 200 - 100; // ±100m variation
                const estimatedElevation = Math.round(baseElevation + variation);

                console.log(`📏 Estimated elevation for ${lat.toFixed(4)}, ${lng.toFixed(4)}: ${estimatedElevation}m`);
                return estimatedElevation;
            }
        }

        // Open in Google Maps
        function openInGoogleMaps(lat, lng, name) {
            const url = https://www.google.com/maps/search/?api=1&query=${lat},${lng}&query_place_id=${encodeURIComponent(name)};
            window.open(url, '_blank');
        }

        // Add to route with throttling
        function addToRoute(poi) {
            console.log('➕ Adding POI to route:', poi.name);
            const poiId = poi.id || poi._id;
            if (!selectedPOIs.find(p => (p.id || p._id) === poiId)) {
                poi.id = poiId; // Normalize ID
                selectedPOIs.push(poi);
                console.log('📝 Updated selectedPOIs:', selectedPOIs.length);
                updateRouteDisplay();

                // Throttle route creation to prevent rapid requests
                clearTimeout(window.routeTimeout);
                window.routeTimeout = setTimeout(() => {
                    // Create route if we have enough points
                    if (selectedPOIs.length >= 1 && (startLocation || selectedPOIs.length >= 2)) {
                        createRoute();
                    }
                }, 1000); // 1 second delay

            } else {
                console.log('⚠️ POI already in route');
                showNotification('Bu POI zaten rotada mevcut', 'info');
            }
        }

        // Remove from route
        function removeFromRoute(poiId) {
            selectedPOIs = selectedPOIs.filter(p => (p.id || p._id) !== poiId);
            updateRouteDisplay();
            if (selectedPOIs.length > 1) {
                createRoute();
            } else if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
        }

        // Update route display
        function updateRouteDisplay() {
            const routeContainer = document.getElementById('routeContainer');
            if (!routeContainer) return;

            let routeHTML = '';

            // Start location section
            routeHTML += 
                <div style="margin-bottom: 15px; padding: 12px; background: rgba(231, 76, 60, 0.1); border-radius: 12px; border-left: 4px solid #e74c3c;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h6 style="margin: 0; color: #e74c3c; font-size: 14px;">📍 Başlangıç Noktası</h6>
                        ${!startLocation ? <button onclick="setStartLocation()" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 8px; font-size: 11px; cursor: pointer;">📍 Konumu Al</button> : ''}
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ${startLocation ? ✅ ${startLocation.name} : '❌ Başlangıç noktası belirlenmedi'}
                    </div>
                </div>
            ;

            if (selectedPOIs.length === 0) {
                routeHTML += '<p style="text-align: center; color: #666; font-style: italic;">Rota oluşturmak için POI\'leri seçin</p>';
                routeContainer.innerHTML = routeHTML;
                return;
            }

            routeHTML += '<div style="margin-bottom: 15px;"><h6 style="margin: 0; color: var(--primary-color);">🗺️ Seçilen Rotanız</h6></div>';

            // Show start location in route if available
            if (startLocation) {
                routeHTML += 
                    <div style="display: flex; align-items: center; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 8px; margin-bottom: 6px; border-left: 3px solid #e74c3c;">
                        <div style="background: #e74c3c; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 10px;">
                            🏁
                        </div>
                        <div style="flex: 1; font-size: 13px;">
                            <div style="font-weight: 600;">${startLocation.name}</div>
                            <div style="color: #666; font-size: 11px;">Başlangıç</div>
                        </div>
                    </div>
                ;
            }

            selectedPOIs.forEach((poi, index) => {
                const categoryStyle = categoryStyles[poi.category] || { color: '#667eea', icon: '📍' };
                const stepNumber = startLocation ? index + 2 : index + 1;
                routeHTML += 
                    <div style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 8px; margin-bottom: 6px;">
                        <div style="background: ${categoryStyle.color}; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 10px;">
                            ${stepNumber}
                        </div>
                        <div style="flex: 1; font-size: 13px;">
                            <div style="font-weight: 600;">${poi.name}</div>
                            <div style="color: #666; font-size: 11px;">${categoryNames[poi.category] || poi.category}</div>
                        </div>
                        <button onclick="removeFromRoute('${poi.id || poi._id}')" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">×</button>
                    </div>
                ;
            });

            // Route statistics
            const stats = getRouteStatistics();
            if (stats && selectedPOIs.length > 1) {
                routeHTML += 
                    <div style="margin: 15px 0; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; border-left: 4px solid var(--primary-color);">
                        <h6 style="margin: 0 0 8px 0; color: var(--primary-color); font-size: 13px;">📊 Rota İstatistikleri</h6>
                        <div style="font-size: 11px; color: #666; line-height: 1.4;">
                            📏 <strong>Toplam Mesafe:</strong> ${stats.totalDistance.toFixed(2)} km<br>
                            ⏱️ <strong>Tahmini Süre:</strong> ${Math.round(stats.estimatedTime)} dakika<br>
                            📍 <strong>Durak Sayısı:</strong> ${stats.pointCount} nokta<br>
                            🏷️ <strong>Kategoriler:</strong> ${stats.categories.length} farklı kategori
                        </div>
                    </div>
                ;
            }

            if (selectedPOIs.length > 1) {
                routeHTML += 
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="clearRoute()" style="background: #95a5a6; color: white; border: none; padding: 8px 12px; border-radius: 15px; font-size: 12px; cursor: pointer;">🗑️ Rotayı Temizle</button>
                        <button onclick="optimizeRoute()" style="background: var(--accent-color); color: white; border: none; padding: 8px 12px; border-radius: 15px; font-size: 12px; cursor: pointer;">⚡ Optimize Et</button>
                        ${startLocation ? <button onclick="startLocation = null; updateRouteDisplay();" style="background: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 15px; font-size: 12px; cursor: pointer;">📍 Başlangıcı Sıfırla</button> : ''}
                    </div>
                ;
            }

            routeContainer.innerHTML = routeHTML;
        }

        // Create route using walking paths
        async function createRoute() {
            console.log('🚶 Creating walking route with selectedPOIs:', selectedPOIs.length, 'startLocation:', startLocation);

            if (selectedPOIs.length < 1) {
                console.log('❌ Not enough POIs for route');
                return;
            }

            if (routingControl) {
                console.log('🗑️ Removing existing route control');
                map.removeControl(routingControl);
                routingControl = null;
            }

            // Remove existing walking route layers
            map.eachLayer(function (layer) {
                if (layer.options && layer.options.className === 'walking-route') {
                    map.removeLayer(layer);
                }
            });

            // Build waypoints including start location
            let waypoints = [];

            if (startLocation) {
                waypoints.push({
                    lat: startLocation.latitude,
                    lng: startLocation.longitude,
                    name: startLocation.name
                });
                console.log('📍 Added start location to waypoints');
            }

            selectedPOIs.forEach((poi, index) => {
                waypoints.push({
                    lat: poi.latitude,
                    lng: poi.longitude,
                    name: poi.name
                });
                console.log(`📍 Added POI ${index + 1}: ${poi.name}`);
            });

            console.log('🗺️ Total waypoints:', waypoints.length);

            if (waypoints.length < 2) {
                console.log('❌ Need at least 2 waypoints for routing');
                return;
            }

            try {
                console.log('🚶 Requesting walking route from API...');

                // Call walking route API
                const response = await fetch(`${apiBase}/route/walking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        waypoints: waypoints
                    })
                });

                if (!response.ok) {
                    throw new Error(`Route API error: ${response.status}`);
                }

                const routeData = await response.json();
                console.log('🗺️ Walking route received:', routeData);

                if (routeData.success && routeData.route) {
                    // Draw walking route on map
                    drawWalkingRoute(routeData.route);

                    // Show route info
                    showRouteInfo(routeData.route);
                } else {
                    throw new Error('Invalid route data received');
                }

            } catch (error) {
                console.error('Walking route error:', error);
                console.log('🔄 Fallback: Using simple line connections...');

                // Fallback to simple line connections
                createSimpleRoute(waypoints);
            }
        }

        // Create simple route with straight lines (fallback)
        function createSimpleRoute(waypoints) {
            console.log('📏 Creating simple route with straight lines');

            if (waypoints.length < 2) return;

            // Remove any existing simple route
            if (window.simpleRouteLayer) {
                map.removeLayer(window.simpleRouteLayer);
            }

            // Create polyline with waypoints
            const latlngs = waypoints.map(wp => [wp.lat, wp.lng]);

            window.simpleRouteLayer = L.polyline(latlngs, {
                color: '#667eea',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 5' // Dashed line to indicate it's not a real route
            }).addTo(map);

            // Add popup to explain this is a simple route
            window.simpleRouteLayer.bindPopup(
                <div style="text-align: center; font-family: 'Segoe UI', sans-serif;">
                    <h6 style="margin: 0 0 8px 0; color: #667eea;">📏 Basit Rota</h6>
                    <p style="margin: 0; font-size: 12px; color: #666;">
                        Düz çizgi bağlantıları<br>
                        <small>(Gerçek yol rotası değil)</small>
                    </p>
                </div>
            );

            // Add route details panel click event
            window.simpleRouteLayer.on('click', function(e) {
                // Prevent popup from opening
                e.originalEvent.stopPropagation();
                
                // Calculate total distance
                let totalDistance = 0;
                for (let i = 0; i < latlngs.length - 1; i++) {
                    totalDistance += getDistance(latlngs[i][0], latlngs[i][1], latlngs[i + 1][0], latlngs[i + 1][1]);
                }
                
                // Show route details panel
                RouteDetailsPanel.show({
                    total_distance: totalDistance.toFixed(2),
                    estimated_time: Math.round(totalDistance * 12 * 60), // 12 minutes per km in seconds
                    route_type: 'düz çizgi',
                    waypoints: selectedPOIs,
                    segments: []
                });
            });

            // Calculate total distance
            let totalDistance = 0;
            for (let i = 0; i < latlngs.length - 1; i++) {
                totalDistance += getDistance(latlngs[i][0], latlngs[i][1], latlngs[i + 1][0], latlngs[i + 1][1]);
            }

            console.log(`📏 Basit rota oluşturuldu: ${totalDistance.toFixed(2)} km (düz çizgi mesafesi)`);

            // Show notification
            showNotification(`📏 Basit rota oluşturuldu (${totalDistance.toFixed(2)} km düz çizgi mesafesi)`, 'info');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = 
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 300px;
            ;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Clear route
        function clearRoute() {
            selectedPOIs = [];
            startLocation = null;
            updateRouteDisplay();

            // Remove routing control
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }

            // Remove simple route layer
            if (window.simpleRouteLayer) {
                map.removeLayer(window.simpleRouteLayer);
                window.simpleRouteLayer = null;
            }

            // Remove start location marker
            if (map) {
                map.eachLayer(function (layer) {
                    if (layer.options && layer.options.icon && layer.options.icon.options.className === 'start-location-marker') {
                        map.removeLayer(layer);
                    }
                });
            }

            console.log('🗑️ Route cleared');
        }

        // Optimize route (wrapper for backward compatibility)
        function optimizeRoute() {
            optimizeRouteAdvanced();
        }

        // Calculate distance between two points
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Draw walking route on map
        function drawWalkingRoute(routeInfo) {
            console.log('🎨 Drawing walking route:', routeInfo);

            // Remove existing route layers
            map.eachLayer(function (layer) {
                if (layer.options && layer.options.className === 'walking-route') {
                    map.removeLayer(layer);
                }
            });

            const routeColor = '#27ae60'; // Green for walking
            const fallbackColor = '#e74c3c'; // Red for fallback
            const routeWeight = 5;
            const routeOpacity = 0.8;

            // Draw each segment
            routeInfo.segments.forEach((segment, index) => {
                const coordinates = segment.coordinates.map(coord => [coord.lat, coord.lng]);

                const polyline = L.polyline(coordinates, {
                    color: segment.fallback ? fallbackColor : routeColor,
                    weight: routeWeight,
                    opacity: routeOpacity,
                    dashArray: segment.fallback ? '10, 5' : null,
                    className: 'walking-route'
                }).addTo(map);

                // Add detailed route popup on click
                const routePopup = L.popup({
                    maxWidth: 350,
                    className: 'route-detail-popup'
                })
                    .setContent(createRoutePopupContent(segment, index + 1, routeInfo));

                polyline.bindPopup(routePopup);

                // Add route details panel click event
                polyline.on('click', function(e) {
                    // Prevent popup from opening
                    e.originalEvent.stopPropagation();
                    
                    // Show route details panel
                    RouteDetailsPanel.show({
                        total_distance: routeInfo.total_distance,
                        estimated_time: routeInfo.estimated_time,
                        route_type: 'yürüyüş',
                        waypoints: selectedPOIs,
                        segments: routeInfo.segments
                    });
                });

                // Add hover popup for quick info
                if (coordinates.length > 1) {
                    const midpoint = coordinates[Math.floor(coordinates.length / 2)];
                    const hoverPopup = L.popup({
                        closeButton: false,
                        className: 'segment-hover-popup'
                    })
                        .setLatLng(midpoint)
                        .setContent(
                        <div style="text-align: center; font-size: 12px; font-family: 'Segoe UI', sans-serif;">
                            <strong>${segment.from} → ${segment.to}</strong><br>
                            📏 ${segment.distance.toFixed(2)} km<br>
                            🚶 ~${Math.round(segment.distance * 12)} dakika
                            ${segment.fallback ? '<br><span style="color: #e74c3c;">⚠️ Düz çizgi</span>' : '<br><span style="color: #27ae60;">✅ Yürüyüş yolu</span>'}
                            <br><small style="color: #888;">Detaylar için tıklayın</small>
                        </div>
                    );

                    polyline.on('mouseover', function () {
                        if (!map.hasLayer(routePopup)) {
                            hoverPopup.openOn(map);
                        }
                    });

                    polyline.on('mouseout', function () {
                        if (map.hasLayer(hoverPopup)) {
                            map.closePopup(hoverPopup);
                        }
                    });
                }
            });

            console.log('✅ Walking route drawn successfully');
        }

        // Create detailed route popup content
        function createRoutePopupContent(segment, segmentNumber, routeInfo) {
            const isWalkingRoute = !segment.fallback;
            const routeTypeIcon = isWalkingRoute ? '🚶' : '📏';
            const routeTypeName = isWalkingRoute ? 'Yürüyüş Rotası' : 'Düz Çizgi';
            const routeTypeColor = isWalkingRoute ? '#27ae60' : '#e74c3c';

            return 
                <div style="font-family: 'Segoe UI', sans-serif; min-width: 280px;">
                    <div style="
                        background: linear-gradient(135deg, ${routeTypeColor} 0%, ${routeTypeColor}dd 100%);
                        color: white;
                        padding: 12px;
                        margin: -10px -10px 15px -10px;
                        border-radius: 8px 8px 0 0;
                    ">
                        <h6 style="margin: 0; font-size: 16px; font-weight: 600;">
                            ${routeTypeIcon} Segment ${segmentNumber}
                        </h6>
                        <small style="opacity: 0.9; font-size: 12px;">
                            ${routeTypeName}
                        </small>
                    </div>
                    
                    <div style="padding: 0 5px;">
                        <div style="margin-bottom: 12px;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 4px;">
                                📍 ${segment.from} → ${segment.to}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 18px; font-weight: 700; color: ${routeTypeColor};">
                                    ${segment.distance.toFixed(2)}
                                </div>
                                <div style="font-size: 11px; color: #666;">km</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 18px; font-weight: 700; color: ${routeTypeColor};">
                                    ${Math.round(segment.distance * 12)}
                                </div>
                                <div style="font-size: 11px; color: #666;">dakika</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 12px; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 3px solid var(--primary-color);">
                            <div style="font-size: 12px; color: #666; line-height: 1.4;">
                                <strong>Toplam Rota:</strong> ${routeInfo.total_distance} km<br>
                                <strong>Tahmini Süre:</strong> ${routeInfo.estimated_time} dakika<br>
                                <strong>Koordinat Sayısı:</strong> ${segment.coordinates.length} nokta
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button onclick="openRouteInGoogleMaps(${JSON.stringify(segment).replace(/"/g, '&quot;')})" 
                                    style="flex: 1; background: #4285f4; color: white; border: none; padding: 8px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                🗺️ Google Maps
                            </button>
                            <button onclick="copyRouteCoordinates(${JSON.stringify(segment.coordinates).replace(/"/g, '&quot;')})" 
                                    style="flex: 1; background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                📋 Koordinatları Kopyala
                            </button>
                        </div>
                        
                        <div style="margin-top: 8px; text-align: center;">
                            <button onclick="exportFullRoute()" 
                                    style="background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
                                📤 Tüm Rotayı Dışa Aktar
                            </button>
                        </div>
                    </div>
                </div>
            ;
        }

        // Open route segment in Google Maps
        function openRouteInGoogleMaps(segment) {
            const startCoord = segment.coordinates[0];
            const endCoord = segment.coordinates[segment.coordinates.length - 1];

            // Create waypoints for Google Maps (max 25 waypoints)
            let waypoints = '';
            if (segment.coordinates.length > 2) {
                const middlePoints = segment.coordinates.slice(1, -1);
                const maxWaypoints = Math.min(middlePoints.length, 23); // Leave room for start/end
                const step = Math.max(1, Math.floor(middlePoints.length / maxWaypoints));

                const selectedWaypoints = [];
                for (let i = 0; i < middlePoints.length; i += step) {
                    selectedWaypoints.push(middlePoints[i]);
                }

                if (selectedWaypoints.length > 0) {
                    waypoints = '&waypoints=' + selectedWaypoints.map(coord => ${coord.lat},${coord.lng}).join('|');
                }
            }

            const url = https://www.google.com/maps/dir/?api=1&origin=${startCoord.lat},${startCoord.lng}&destination=${endCoord.lat},${endCoord.lng}${waypoints}&travelmode=walking;
            window.open(url, '_blank');
        }

        // Copy route coordinates to clipboard
        function copyRouteCoordinates(coordinates) {
            const coordText = coordinates.map(coord => ${coord.lat.toFixed(6)}, ${coord.lng.toFixed(6)}).join('\n');

            if (navigator.clipboard) {
                navigator.clipboard.writeText(coordText).then(() => {
                    showNotification('✅ Koordinatlar panoya kopyalandı!', 'success');
                }).catch(() => {
                    fallbackCopyToClipboard(coordText);
                });
            } else {
                fallbackCopyToClipboard(coordText);
            }
        }

        // Fallback copy method for older browsers
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showNotification('✅ Koordinatlar panoya kopyalandı!', 'success');
            } catch (err) {
                showNotification('❌ Kopyalama başarısız', 'error');
            }

            document.body.removeChild(textArea);
        }

        // Export full route to Google Maps
        function exportFullRoute() {
            if (selectedPOIs.length === 0) {
                showNotification('❌ Önce POI seçin', 'error');
                return;
            }

            let waypoints = [];

            if (startLocation) {
                waypoints.push(${startLocation.latitude},${startLocation.longitude});
            }

            selectedPOIs.forEach(poi => {
                waypoints.push(${poi.latitude},${poi.longitude});
            });

            if (waypoints.length < 2) {
                showNotification('❌ En az 2 nokta gerekli', 'error');
                return;
            }

            const origin = waypoints[0];
            const destination = waypoints[waypoints.length - 1];
            const middleWaypoints = waypoints.slice(1, -1);

            let waypointParam = '';
            if (middleWaypoints.length > 0) {
                // Google Maps allows max 25 waypoints
                const maxWaypoints = Math.min(middleWaypoints.length, 23);
                const selectedWaypoints = middleWaypoints.slice(0, maxWaypoints);
                waypointParam = '&waypoints=' + selectedWaypoints.join('|');
            }

            const url = https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypointParam}&travelmode=walking;
            window.open(url, '_blank');

            showNotification('🗺️ Google Maps\'te rota açıldı!', 'success');
        }

        // Show notification to user
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = 
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transition: all 0.3s ease;
                font-family: 'Segoe UI', sans-serif;
            ;

            switch (type) {
                case 'success':
                    notification.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Create simple route (fallback)
        function createSimpleRoute(waypoints) {
            console.log('📏 Creating simple route connections');

            // Remove existing route layers
            map.eachLayer(function (layer) {
                if (layer.options && layer.options.className === 'walking-route') {
                    map.removeLayer(layer);
                }
            });

            if (waypoints.length < 2) return;

            for (let i = 0; i < waypoints.length - 1; i++) {
                const start = waypoints[i];
                const end = waypoints[i + 1];

                const coordinates = [
                    [start.lat || start.latitude, start.lng || start.longitude],
                    [end.lat || end.latitude, end.lng || end.longitude]
                ];

                L.polyline(coordinates, {
                    color: '#f39c12',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 5',
                    className: 'walking-route'
                }).addTo(map);
            }
        }

        // Show route information
        function showRouteInfo(routeInfo) {
            console.log('📊 Showing route info:', routeInfo);

            let routeInfoDiv = document.getElementById('routeInfo');
            if (!routeInfoDiv) {
                // Create route info div if it doesn't exist
                const routeSection = document.getElementById('routeSection');
                if (routeSection) {
                    const infoDiv = document.createElement('div');
                    infoDiv.id = 'routeInfo';
                    infoDiv.style.cssText = 
                        margin-top: 15px;
                        padding: 15px;
                        background: rgba(39, 174, 96, 0.1);
                        border-radius: 12px;
                        border-left: 4px solid #27ae60;
                    ;
                    routeSection.appendChild(infoDiv);
                }
                routeInfoDiv = document.getElementById('routeInfo');
            }

            if (routeInfoDiv) {
                const networkIcon = routeInfo.network_type === 'walking' ? '🚶' : '🚗';
                const networkName = routeInfo.network_type === 'walking' ? 'Yürüyüş Rotası' : 'Araba Rotası';

                routeInfoDiv.innerHTML = 
                    <h6 style="margin: 0 0 10px 0; color: #27ae60; font-size: 14px;">
                        ${networkIcon} ${networkName} Bilgileri
                    </h6>
                    <div style="font-size: 12px; color: #666; line-height: 1.5;">
                        📏 <strong>Toplam Mesafe:</strong> ${routeInfo.total_distance} km<br>
                        ⏱️ <strong>Tahmini Süre:</strong> ${routeInfo.estimated_time} dakika<br>
                        🎯 <strong>Durak Sayısı:</strong> ${routeInfo.waypoint_count} nokta<br>
                        🛤️ <strong>Segment Sayısı:</strong> ${routeInfo.segments.length} bölüm
                        ${routeInfo.warning ? <br><span style="color: #f39c12;">⚠️ ${routeInfo.warning}</span> : ''}
                    </div>
                ;
            }
        }

        // Location permission storage
        const LocationPermission = {
            STORAGE_KEY: 'poi_location_permission',

            save(preference) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, preference);
                } catch (e) {
                    console.warn('Could not save location preference:', e);
                }
            },

            get() {
                try {
                    return localStorage.getItem(this.STORAGE_KEY);
                } catch (e) {
                    console.warn('Could not read location preference:', e);
                    return null;
                }
            },

            clear() {
                try {
                    localStorage.removeItem(this.STORAGE_KEY);
                } catch (e) {
                    console.warn('Could not clear location preference:', e);
                }
            }
        };

        // Show location permission dialog
        function showLocationDialog() {
            return new Promise((resolve, reject) => {
                const overlay = document.getElementById('locationPermissionOverlay');
                overlay.classList.add('show');

                // Store resolve/reject for later use
                window.locationPermissionResolve = resolve;
                window.locationPermissionReject = reject;
            });
        }

        // Close location permission dialog
        function closeLocationDialog() {
            const overlay = document.getElementById('locationPermissionOverlay');
            overlay.classList.remove('show');

            if (window.locationPermissionReject) {
                window.locationPermissionReject(new Error('Kullanıcı dialog\'u kapattı'));
            }
        }

        // Show browser permission help
        function showBrowserPermissionHelp() {
            const browserName = getBrowserName();
            let instructions = '';

            switch (browserName) {
                case 'Chrome':
                    instructions = 
                        <strong>Chrome'da konum iznini açmak için:</strong><br>
                        1. Adres çubuğunun solundaki <strong>🔒 kilit simgesine</strong> tıklayın<br>
                        2. "Konum" seçeneğini <strong>"İzin ver"</strong> yapın<br>
                        3. Sayfayı yenileyin (F5)
                    ;
                    break;
                case 'Firefox':
                    instructions = 
                        <strong>Firefox'ta konum iznini açmak için:</strong><br>
                        1. Adres çubuğunun solundaki <strong>🛡️ kalkan simgesine</strong> tıklayın<br>
                        2. "Konum" iznini <strong>"İzin ver"</strong> yapın<br>
                        3. Sayfayı yenileyin (F5)
                    ;
                    break;
                case 'Safari':
                    instructions = 
                        <strong>Safari'de konum iznini açmak için:</strong><br>
                        1. Safari menüsünden <strong>"Tercihler"</strong> açın<br>
                        2. <strong>"Web Siteleri"</strong> sekmesine gidin<br>
                        3. Sol taraftan <strong>"Konum"</strong> seçin<br>
                        4. Bu siteyi <strong>"İzin ver"</strong> yapın
                    ;
                    break;
                default:
                    instructions = 
                        <strong>Konum iznini açmak için:</strong><br>
                        1. Adres çubuğundaki <strong>kilit/bilgi simgesine</strong> tıklayın<br>
                        2. Konum iznini <strong>"İzin ver"</strong> yapın<br>
                        3. Sayfayı yenileyin (F5)
                    ;
            }

            showNotification(
                <div style="text-align: left; line-height: 1.6;">
                    <h4 style="color: #d93025; margin-bottom: 12px;">⚠️ Konum İzni Gerekli</h4>
                    <p style="margin-bottom: 16px;">Tarayıcınızda konum izni reddedilmiş durumda.</p>
                    ${instructions}
                    <div style="margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4285f4;">
                        <strong>💡 İpucu:</strong> İzni açtıktan sonra sayfayı yenilemeyi unutmayın!
                    </div>
                </div>
            , 'error', 10000);

            if (window.locationPermissionReject) {
                window.locationPermissionReject(new Error('Tarayıcı konum izni reddedilmiş'));
            }
        }

        // Get browser name for specific instructions
        function getBrowserName() {
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'Unknown';
        }

        // Handle location permission choice
        async function handleLocationPermission(choice) {
            console.log('🎯 User chose:', choice);
            const overlay = document.getElementById('locationPermissionOverlay');
            overlay.classList.remove('show');

            if (choice === 'never') {
                LocationPermission.save('never');
                if (window.locationPermissionReject) {
                    window.locationPermissionReject(new Error('Kullanıcı konum iznini reddetti'));
                }
                return;
            }

            if (choice === 'always') {
                LocationPermission.save('always');
            }

            // Check browser permission state before requesting
            try {
                const permission = await navigator.permissions.query({ name: 'geolocation' });
                console.log('🔍 Browser permission state:', permission.state);

                if (permission.state === 'denied') {
                    // Browser has denied permission, show detailed instructions
                    showBrowserPermissionHelp();
                    return;
                }
            } catch (e) {
                console.warn('Permission API not supported:', e);
            }

            // Proceed with actual geolocation request
            requestActualLocation();
        }

        // Request actual location from browser
        function requestActualLocation() {
            console.log('📱 Requesting actual location from browser...');
            const options = {
                enableHighAccuracy: false,
                timeout: 15000,
                maximumAge: 300000
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('✅ Position received:', position);
                    const location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    userLocation = location;
                    console.log('📍 User location set:', location);

                    if (window.locationPermissionResolve) {
                        window.locationPermissionResolve(location);
                    }
                },
                (error) => {
                    console.error('❌ Geolocation error:', error);
                    let errorMessage = 'Konum alınamadı';
                    let helpText = '';

                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Konum izni reddedildi';
                            helpText = 'Konum iznini açmak için: 1. Adres çubuğundaki kilit simgesine tıklayın 2. Konum seçeneğini İzin ver yapın 3. Sayfayı yenileyin';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Konum bilgisi mevcut değil';
                            helpText = 'GPS\'inizi açın, WiFi\'ye bağlanın veya açık alanda olduğunuzdan emin olun.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Konum alma zaman aşımı';
                            helpText = 'İnternet bağlantınızı kontrol edin ve tekrar deneyin.';
                            break;
                        default:
                            errorMessage = 'Konum hatası (Kod: ' + error.code + ')';
                            helpText = 'Tarayıcınızı yenileyin ve tekrar deneyin.';
                    }

                    const fullError = new Error(errorMessage);
                    fullError.helpText = helpText;

                    if (window.locationPermissionReject) {
                        window.locationPermissionReject(fullError);
                    }
                },
                options
            );
        }

        // Get user's current location with native browser dialog
        async function getCurrentLocation() {
            return new Promise(async (resolve, reject) => {
                console.log('🔍 Checking geolocation support...');

                // First check if we're on HTTPS or localhost
                const isSecureContext = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';
                console.log('🔒 Secure context:', isSecureContext);

                if (!navigator.geolocation) {
                    console.error('❌ Geolocation not supported');
                    const error = new Error('Bu tarayıcı konum hizmetlerini desteklemiyor');
                    error.helpText = 'Lütfen güncel bir tarayıcı kullanın (Chrome, Firefox, Safari, Edge)';
                    reject(error);
                    return;
                }

                if (!isSecureContext) {
                    console.error('❌ Not secure context');
                    const error = new Error('Konum servisleri güvenli bağlantı gerektiriyor');
                    error.helpText = 'Sayfayı HTTPS üzerinden açın veya localhost kullanın';
                    reject(error);
                    return;
                }

                // Check permission state for debugging
                try {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    console.log('🔍 Permission state:', permission.state);
                } catch (e) {
                    console.warn('Permission API not supported');
                }

                // Always try getCurrentPosition - even if permission state is 'denied'
                // This allows the native dialog to show if user has changed browser settings
                console.log('📱 Requesting geolocation permission...');

                const options = {
                    enableHighAccuracy: false,
                    timeout: 15000,
                    maximumAge: 300000
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('✅ Position received:', position);
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        userLocation = location;
                        console.log('📍 User location set:', location);
                        resolve(location);
                    },
                    (error) => {
                        console.error('❌ Geolocation error:', error);
                        let errorMessage = 'Konum alınamadı';
                        let helpText = '';

                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Konum izni reddedildi';
                                helpText = Konum iznini açmak için:
1. Chrome'da adres çubuğundaki kilit simgesine tıklayın
2. "Konum" seçeneğini "İzin ver" yapın  
3. Sayfayı yenileyin (F5)

Alternatif: chrome://settings/content/location adresinden site izinlerini kontrol edin;
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Konum bilgisi mevcut değil';
                                helpText = 'GPS\'inizi açın, WiFi\'ye bağlanın veya açık alanda olduğunuzdan emin olun.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Konum alma zaman aşımı';
                                helpText = 'İnternet bağlantınızı kontrol edin ve tekrar deneyin.';
                                break;
                            default:
                                errorMessage = 'Konum hatası (Kod: ' + error.code + ')';
                                helpText = 'Tarayıcınızı yenileyin ve tekrar deneyin.';
                        }

                        const fullError = new Error(errorMessage);
                        fullError.helpText = helpText;
                        reject(fullError);
                    },
                    options
                );
            });
        }

        // Set start location for route
        async function setStartLocation() {
            console.log('📍 Requesting user location...');

            try {
                console.log('🔍 Checking geolocation support...');
                if (!navigator.geolocation) {
                    throw new Error('Bu tarayıcı konum hizmetlerini desteklemiyor');
                }

                console.log('📱 Getting current position...');
                const location = await getCurrentLocation();
                console.log('✅ Location received:', location);

                startLocation = {
                    name: 'Mevcut Konumum',
                    latitude: location.latitude,
                    longitude: location.longitude,
                    id: 'current_location'
                };

                // Add start location marker to map
                if (map) {
                    console.log('📍 Adding start location marker to map');

                    // Remove existing start location markers
                    map.eachLayer(function (layer) {
                        if (layer.options && layer.options.icon && layer.options.icon.options.className === 'start-location-marker') {
                            map.removeLayer(layer);
                        }
                    });

                    const startIcon = L.divIcon({
                        html: 
                            <div style="
                                background: #e74c3c;
                                width: 30px;
                                height: 30px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 14px;
                                color: white;
                            ">
                                📍
                            </div>
                        ,
                        className: 'start-location-marker',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const startMarker = L.marker([location.latitude, location.longitude], { icon: startIcon })
                        .addTo(map)
                        .bindPopup(
                            <div style="text-align: center; font-family: 'Segoe UI', sans-serif;">
                                <h6 style="margin: 0 0 8px 0; color: #e74c3c;">📍 Başlangıç Noktası</h6>
                                <p style="margin: 0; font-size: 12px; color: #666;">Mevcut Konumunuz</p>
                                <div style="margin-top: 8px; font-size: 10px; color: #888;">
                                    ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}
                                </div>
                                <div style="margin-top: 8px; font-size: 10px; color: #888;">
                                    Doğruluk: ±${Math.round(location.accuracy)}m
                                </div>
                            </div>
                        );

                    // Center map on user location
                    map.setView([location.latitude, location.longitude], 15);
                    console.log('🗺️ Map centered on user location');
                }

                updateRouteDisplay();

                // Create route if POIs are selected
                if (selectedPOIs.length > 0) {
                    createRoute();
                }

                alert(✅ Başlangıç noktası belirlendi!\nKonum: ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}\nDoğruluk: ±${Math.round(location.accuracy)}m);

            } catch (error) {
                console.error('❌ Location error:', error);

                // Create a better error dialog
                const errorDialog = document.createElement('div');
                errorDialog.style.cssText = 
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    font-family: 'Segoe UI', sans-serif;
                ;

                errorDialog.innerHTML = 
                    <div style="
                        background: white;
                        border-radius: 20px;
                        padding: 35px;
                        max-width: 500px;
                        margin: 20px;
                        text-align: center;
                        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
                        animation: modalSlideIn 0.4s ease-out;
                    ">
                        <div style="font-size: 4rem; margin-bottom: 20px;">⚠️</div>
                        <h3 style="color: #e74c3c; margin: 0 0 16px 0; font-size: 1.4rem;">Konum Hatası</h3>
                        <p style="color: #666; margin: 0 0 20px 0; line-height: 1.6; font-size: 1rem;">
                            ${error.message}
                        </p>
                        ${error.helpText ? 
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 18px; border-radius: 12px; margin-bottom: 25px; text-align: left;">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <span style="font-size: 1.4rem; margin-right: 10px;">🔧</span>
                                    <strong style="color: #856404; font-size: 1.1rem;">Nasıl Düzeltilir?</strong>
                                </div>
                                <div style="color: #856404; font-size: 0.95rem; line-height: 1.6;">
                                    ${error.helpText}
                                </div>
                            </div>
                         : ''}
                        
                        <div style="background: #e8f5e8; border: 1px solid #c3e6c3; padding: 18px; border-radius: 12px; margin-bottom: 25px; text-align: left;">
                            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 1.4rem; margin-right: 10px;">🗺️</span>
                                <strong style="color: #2d5a2d; font-size: 1.1rem;">Alternatif Çözüm</strong>
                            </div>
                            <p style="margin: 0; color: #2d5a2d; font-size: 0.95rem; line-height: 1.6;">
                                Konum izni vermek istemiyorsanız, haritadan manuel olarak başlangıç noktanızı seçebilirsiniz. 
                                Haritayı açtıktan sonra istediğiniz noktaya tıklayın.
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;">
                                Anladım
                            </button>
                            <button onclick="setStartLocation(); this.parentElement.parentElement.parentElement.remove();" 
                                    style="background: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                🔄 Tekrar Dene
                            </button>
                            <button onclick="showManualLocationHelp(); this.parentElement.parentElement.parentElement.remove();" 
                                    style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                                🗺️ Manuel Seçim
                            </button>
                        </div>
                    </div>
                ;

                document.body.appendChild(errorDialog);
            }
        }

        // Show manual location selection help
        function showManualLocationHelp() {
            const helpDialog = document.createElement('div');
            helpDialog.style.cssText = 
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10002;
                font-family: 'Segoe UI', sans-serif;
            ;

            helpDialog.innerHTML = 
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 35px;
                    max-width: 500px;
                    margin: 20px;
                    text-align: center;
                    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
                    animation: modalSlideIn 0.4s ease-out;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">🗺️</div>
                    <h3 style="color: #28a745; margin: 0 0 16px 0; font-size: 1.4rem;">Manuel Konum Seçimi</h3>
                    <p style="color: #666; margin: 0 0 25px 0; line-height: 1.6; font-size: 1rem;">
                        Haritadan başlangıç noktanızı manuel olarak seçebilirsiniz.
                    </p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: left;">
                        <h4 style="color: #333; margin: 0 0 15px 0; font-size: 1.1rem;">📋 Adımlar:</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #555; line-height: 1.8;">
                            <li>Önce "Önerilerimi Getir" butonuna tıklayın</li>
                            <li>Harita açıldığında istediğiniz noktaya tıklayın</li>
                            <li>O nokta başlangıç noktanız olarak ayarlanacak</li>
                            <li>Rota planlaması bu noktadan başlayacak</li>
                        </ol>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 18px; border-radius: 12px; margin-bottom: 25px; text-align: left;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 1.3rem; margin-right: 10px;">💡</span>
                            <strong style="color: #1976d2;">İpucu</strong>
                        </div>
                        <p style="margin: 0; color: #1565c0; font-size: 0.9rem; line-height: 1.5;">
                            Otel, ev veya herhangi bir merkezi nokta seçebilirsiniz. 
                            Öneriler bu noktaya yakınlığa göre sıralanacak.
                        </p>
                    </div>
                    
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        ✅ Anladım
                    </button>
                </div>
            ;

            document.body.appendChild(helpDialog);
        }

        // Advanced route optimization using 2-opt algorithm
        function optimizeRouteAdvanced() {
            if (selectedPOIs.length < 3) {
                alert('Optimize etmek için en az 3 POI seçmelisiniz.');
                return;
            }

            console.log('🔄 Rota optimize ediliyor...');

            // Include start location if available
            let allPoints = [...selectedPOIs];
            if (startLocation) {
                allPoints.unshift(startLocation);
            }

            // Apply 2-opt optimization
            let bestRoute = [...allPoints];
            let bestDistance = calculateTotalDistance(bestRoute);
            let improved = true;
            let iterations = 0;
            const maxIterations = 100;

            while (improved && iterations < maxIterations) {
                improved = false;
                iterations++;

                for (let i = 1; i < bestRoute.length - 2; i++) {
                    for (let j = i + 1; j < bestRoute.length; j++) {
                        if (j - i === 1) continue; // Skip adjacent edges

                        // Create new route by reversing the segment between i and j
                        let newRoute = [...bestRoute];
                        let segment = newRoute.slice(i, j + 1).reverse();
                        newRoute.splice(i, j - i + 1, ...segment);

                        let newDistance = calculateTotalDistance(newRoute);

                        if (newDistance < bestDistance) {
                            bestRoute = newRoute;
                            bestDistance = newDistance;
                            improved = true;
                            console.log(`📈 İyileştirme bulundu! Yeni mesafe: ${bestDistance.toFixed(2)} km`);
                        }
                    }
                }
            }

            // Update selected POIs (excluding start location)
            if (startLocation && bestRoute[0].id === 'current_location') {
                selectedPOIs = bestRoute.slice(1);
            } else {
                selectedPOIs = bestRoute;
            }

            updateRouteDisplay();

            // Throttle route creation after optimization
            clearTimeout(window.routeTimeout);
            window.routeTimeout = setTimeout(() => {
                createRoute();
            }, 1500); // 1.5 second delay for optimization

            const improvement = ((calculateTotalDistance(allPoints) - bestDistance) / calculateTotalDistance(allPoints) * 100);
            showNotification(`✅ Rota optimize edildi! ${iterations} iterasyon, ${bestDistance.toFixed(2)} km, %${improvement.toFixed(1)} iyileştirme`, 'success');
        }

        // Calculate total distance of a route
        function calculateTotalDistance(route) {
            if (route.length < 2) return 0;

            let totalDistance = 0;
            for (let i = 0; i < route.length - 1; i++) {
                totalDistance += getDistance(
                    route[i].latitude, route[i].longitude,
                    route[i + 1].latitude, route[i + 1].longitude
                );
            }
            return totalDistance;
        }

        // Get route statistics
        function getRouteStatistics() {
            if (selectedPOIs.length < 2) return null;

            let allPoints = [...selectedPOIs];
            if (startLocation) {
                allPoints.unshift(startLocation);
            }

            const totalDistance = calculateTotalDistance(allPoints);
            const estimatedTime = totalDistance * 0.75; // Assume 45 minutes per km (walking + visit time)

            return {
                totalDistance: totalDistance,
                estimatedTime: estimatedTime,
                pointCount: allPoints.length,
                categories: [...new Set(selectedPOIs.map(poi => poi.category))]
            };
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 DOM loaded, initializing...');

            // Feature detection for touch support
            const supportsTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (supportsTouch) {
                document.body.classList.add('touch-device');
            }

            // Initialize all components
            try {
                initializeTouchSupport();
                checkSecurityContext();

                // Location dialog click outside to close
                const locationOverlay = document.getElementById('locationPermissionOverlay');
                if (locationOverlay) {
                    locationOverlay.addEventListener('click', function (e) {
                        if (e.target === locationOverlay) {
                            closeLocationDialog();
                        }
                    });
                }
                
                // Initialize sliders with a more reliable approach
                initializeSlidersReliable();
                setupEventListenersReliable();
                
                console.log('✅ All components initialized');
            } catch (error) {
                console.error('❌ Initialization error:', error);
            }

            // Debug function - remove after fixing
            setTimeout(function () {
                try {
                    debugElements();
                } catch (error) {
                    console.error('❌ Debug error:', error);
                }
            }, 1000);
        });

        // More reliable slider initialization
        function initializeSlidersReliable() {
            console.log('🎚️ Initializing sliders with reliable method...');

            // Get all sliders
            const sliders = document.querySelectorAll('input[type="range"]');
            console.log(`Found ${sliders.length} sliders`);

            sliders.forEach((slider, index) => {
                const category = slider.id;
                const valueDisplay = document.getElementById(category + '-value');
                const sliderItem = slider.closest('.slider-item');

                console.log(`Setting up slider ${index + 1}: ${category}`);

                if (!valueDisplay) {
                    console.error(`❌ Value display not found for ${category}`);
                    return;
                }

                if (!sliderItem) {
                    console.error(`❌ Slider item not found for ${category}`);
                    return;
                }

                // Create a unique handler for each slider
                const handleSliderChange = function(event) {
                    const value = parseInt(this.value);
                    console.log(`🎚️ Slider ${category} changed to: ${value}`);
                    
                    // Update display
                    valueDisplay.textContent = value;
                    
                    // Update background
                    updateSliderBackground(this);
                    
                    // Update state
                    updateSliderItemState(sliderItem, valueDisplay, value);
                    
                    // Add visual feedback
                    sliderItem.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        sliderItem.style.transform = '';
                    }, 200);
                };

                // Remove any existing listeners
                slider.removeEventListener('input', handleSliderChange);
                slider.removeEventListener('change', handleSliderChange);
                slider.removeEventListener('mousedown', handleSliderChange);
                slider.removeEventListener('touchstart', handleSliderChange);

                // Add multiple event listeners for better compatibility
                slider.addEventListener('input', handleSliderChange);
                slider.addEventListener('change', handleSliderChange);
                slider.addEventListener('mousedown', handleSliderChange);
                slider.addEventListener('touchstart', handleSliderChange);

                // Initialize the slider
                const initialValue = parseInt(slider.value) || 0;
                valueDisplay.textContent = initialValue;
                updateSliderBackground(slider);
                updateSliderItemState(sliderItem, valueDisplay, initialValue);

                console.log(`✅ Slider ${category} initialized with value: ${initialValue}`);
            });

            console.log('✅ All sliders initialized reliably');
        }

        // More reliable event listener setup
        function setupEventListenersReliable() {
            console.log('🔗 Setting up event listeners reliably...');

            const recommendBtn = document.getElementById('recommendBtn');
            if (recommendBtn) {
                console.log('✅ Recommend button found');
                
                // Remove any existing listeners
                recommendBtn.removeEventListener('click', handleRecommendClickReliable);
                recommendBtn.removeEventListener('touchstart', handleRecommendClickReliable);
                
                // Add multiple event listeners for better compatibility
                recommendBtn.addEventListener('click', handleRecommendClickReliable);
                recommendBtn.addEventListener('touchstart', handleRecommendClickReliable);
                
                // Test the button
                console.log('🔍 Recommend button details:', {
                    id: recommendBtn.id,
                    className: recommendBtn.className,
                    disabled: recommendBtn.disabled,
                    textContent: recommendBtn.textContent.trim()
                });
                
                // Add a test click to verify it works
                setTimeout(() => {
                    console.log('🧪 Testing recommend button...');
                    const testEvent = new Event('click', { bubbles: true });
                    recommendBtn.dispatchEvent(testEvent);
                }, 2000);
                
            } else {
                console.error('❌ Recommend button not found!');
                const allButtons = document.querySelectorAll('button');
                console.log('🔍 All buttons found:', allButtons.length);
                allButtons.forEach((btn, index) => {
                    console.log(`Button ${index}:`, btn.id, btn.className, btn.textContent.substring(0, 20));
                });
            }

            console.log('✅ Event listeners setup complete');
        }

        // Reliable recommend button handler
        function handleRecommendClickReliable(e) {
            console.log('🔥 Recommend button clicked reliably!');
            e.preventDefault();
            e.stopPropagation();
            
            // Add visual feedback
            const button = e.target.closest('.recommend-btn') || e.target;
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
                button.style.transform = '';
            }, 150);
            
            // Call the recommendations function
            getRecommendationsReliable();
        }

        // Reliable recommendations function
        function getRecommendationsReliable() {
            console.log('🚀 getRecommendationsReliable function called');

            const button = document.getElementById('recommendBtn');
            const resultsSection = document.getElementById('resultsSection');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultsContainer = document.getElementById('recommendationResults');

            if (!button || !resultsSection || !loadingIndicator || !resultsContainer) {
                console.error('❌ Required elements not found');
                alert('Sayfa yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin.');
                return;
            }

            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Öneriler Hazırlanıyor...';
            resultsSection.style.display = 'block';
            loadingIndicator.style.display = 'block';
            resultsContainer.innerHTML = '';

            // Get user preferences with validation
            const preferences = {};
            let totalPreference = 0;
            
            Object.keys(ratingCategories).forEach(category => {
                const slider = document.getElementById(category);
                if (slider) {
                    const value = parseInt(slider.value) || 0;
                    preferences[category] = value;
                    totalPreference += value;
                    console.log(`🎚️ ${category}: ${value}`);
                } else {
                    console.error(`❌ Slider not found for ${category}`);
                    preferences[category] = 0;
                }
            });

            console.log('User preferences:', preferences);
            console.log('Total preference:', totalPreference);

            // Check if any preferences are set
            if (totalPreference === 0) {
                console.warn('⚠️ No preferences set');
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Tercih Belirtilmedi</h3>
                        <p>Lütfen en az bir kategori için tercih belirtin. Slider'ları hareket ettirerek ilgi alanlarınızı belirtin.</p>
                        <button onclick="getRecommendationsReliable()" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 15px; cursor: pointer;">
                            🔄 Tekrar Dene
                        </button>
                    </div>`;
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-magic"></i> Önerilerimi Getir';
                loadingIndicator.style.display = 'none';
                return;
            }

            // Simulate API call for now (since we don't have a real API)
            setTimeout(() => {
                try {
                    console.log('🌐 Simulating API call...');
                    
                    // Create mock recommendations
                    const mockRecommendations = [
                        {
                            id: '1',
                            name: 'Göreme Açık Hava Müzesi',
                            category: 'kulturel',
                            description: 'UNESCO Dünya Mirası Listesi\'nde yer alan tarihi kilise ve manastırlar.',
                            latitude: 38.6425,
                            longitude: 34.8283,
                            recommendationScore: 85,
                            ratings: { tarihi: 90, sanat_kultur: 85, doga: 70 }
                        },
                        {
                            id: '2',
                            name: 'Ürgüp Taşkınpaşa Medresesi',
                            category: 'kulturel',
                            description: 'Selçuklu döneminden kalma tarihi medrese.',
                            latitude: 38.6294,
                            longitude: 34.9123,
                            recommendationScore: 80,
                            ratings: { tarihi: 85, sanat_kultur: 80 }
                        },
                        {
                            id: '3',
                            name: 'Üç Güzeller',
                            category: 'doga_macera',
                            description: 'Doğal oluşumlu peri bacaları.',
                            latitude: 38.6425,
                            longitude: 34.8283,
                            recommendationScore: 75,
                            ratings: { doga: 90, macera: 70 }
                        }
                    ];

                    console.log('Mock recommendations created:', mockRecommendations);

                    // Display results
                    displayRecommendations(mockRecommendations);

                    // Show success message
                    showNotification('✅ Öneriler başarıyla oluşturuldu!', 'success');

                } catch (error) {
                    console.error('Recommendation error:', error);
                    resultsContainer.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Bir hata oluştu</h3>
                            <p>Öneriler alınırken bir sorun yaşandı: ${error.message}</p>
                            <button onclick="getRecommendationsReliable()" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 15px; cursor: pointer;">
                                🔄 Tekrar Dene
                            </button>
                        </div>`;
                } finally {
                    // Reset button state
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-magic"></i> Önerilerimi Getir';
                    loadingIndicator.style.display = 'none';
                }
            }, 2000); // Simulate 2 second delay
        }

        // Debug function to check elements
        function debugElements() {
            console.log('🔍 DEBUG: Checking elements...');

            // Check sliders
            const sliders = document.querySelectorAll('input[type="range"]');
            console.log(`Found ${sliders.length} sliders`);
            
            sliders.forEach((slider, index) => {
                const valueDisplay = document.getElementById(slider.id + '-value');
                console.log(`Slider ${index + 1}:`, {
                    id: slider.id,
                    value: slider.value,
                    hasValueDisplay: !!valueDisplay,
                    displayValue: valueDisplay ? valueDisplay.textContent : 'N/A'
                });
            });

            // Check recommend button
            const recommendBtn = document.getElementById('recommendBtn');
            console.log('Recommend button:', {
                found: !!recommendBtn,
                id: recommendBtn ? recommendBtn.id : 'N/A',
                className: recommendBtn ? recommendBtn.className : 'N/A',
                textContent: recommendBtn ? recommendBtn.textContent.trim() : 'N/A'
            });
        }

        // Keep the helper functions
        function updateSliderBackground(slider) {
            const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
            const gradient = `linear-gradient(to right, 
                var(--primary-color) 0%, 
                var(--primary-color) ${value}%, 
                rgba(255, 255, 255, 0.8) ${value}%, 
                rgba(255, 255, 255, 0.8) 100%)`;
            slider.style.background = gradient;
        }

        function updateSliderItemState(sliderItem, valueDisplay, value) {
            // Remove existing classes
            sliderItem.classList.remove('active');
            valueDisplay.classList.remove('zero', 'high');

            if (value === 0) {
                valueDisplay.classList.add('zero');
            } else if (value >= 70) {
                sliderItem.classList.add('active');
                valueDisplay.classList.add('high');
            } else if (value > 0) {
                sliderItem.classList.add('active');
            }
        }

        // Old functions removed - using new reliable functions instead

        function calculateRecommendations(poisData, preferences) {
            const allPois = [];

            // Flatten POI data
            Object.keys(poisData).forEach(category => {
                if (Array.isArray(poisData[category])) {
                    poisData[category].forEach(poi => {
                        allPois.push({
                            ...poi,
                            category: category
                        });
                    });
                }
            });

            console.log('All POIs:', allPois.length);

            // Calculate scores for each POI
            const scoredPois = allPois.map(poi => {
                let totalScore = 0;
                let matchingCategories = 0;
                let baseScore = 30; // Base score for all POIs

                // Calculate weighted score based on user preferences
                Object.keys(preferences).forEach(category => {
                    const userWeight = preferences[category] / 100; // Convert to 0-1 scale
                    const poiRating = poi.ratings[category] || 0;

                    if (userWeight > 0) {
                        if (poiRating > 0) {
                            // Use actual rating if available
                            totalScore += (poiRating / 100) * userWeight;
                        } else {
                            // Use base score if no rating available
                            totalScore += (baseScore / 100) * userWeight;
                        }
                        matchingCategories++;
                    }
                });

                // Normalize score (0-100 scale)
                let finalScore = matchingCategories > 0 ? (totalScore / matchingCategories) * 100 : baseScore;

                // Add category bonus if POI matches user's preferred categories
                const categoryBonus = getCategoryBonus(poi.category, preferences);
                finalScore += categoryBonus;

                // Ensure score is within bounds
                finalScore = Math.min(100, Math.max(0, finalScore));

                return {
                    ...poi,
                    recommendationScore: Math.round(finalScore),
                    matchingCategories: matchingCategories
                };
            });

            // Filter and sort recommendations
            const recommendations = scoredPois
                .filter(poi => poi.recommendationScore > 0) // Show all POIs with any score
                .sort((a, b) => b.recommendationScore - a.recommendationScore)
                .slice(0, 15); // Top 15 recommendations

            console.log('Final recommendations:', recommendations);
            return recommendations;
        }

        // Get category bonus based on POI category and user preferences
        function getCategoryBonus(poiCategory, preferences) {
            const categoryMapping = {
                'doga_macera': ['doga', 'macera', 'spor'],
                'gastronomik': ['yemek'],
                'kulturel': ['tarihi', 'sanat_kultur'],
                'sanatsal': ['sanat_kultur'],
                'konaklama': ['rahatlatici']
            };

            const relatedCategories = categoryMapping[poiCategory] || [];
            let bonus = 0;

            relatedCategories.forEach(category => {
                if (preferences[category] && preferences[category] > 50) {
                    bonus += (preferences[category] - 50) * 0.2; // Max 10 point bonus
                }
            });

            return Math.min(15, bonus); // Max 15 point category bonus
        }

        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendationResults');
            const routeSection = document.getElementById('routeSection');

            if (recommendations.length === 0) {
                container.innerHTML = 
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>Öneri bulunamadı</h3>
                        <p>Tercihlerinize uygun POI bulunamadı. Slider değerlerini değiştirerek tekrar deneyin.</p>
                    </div>
                ;
                routeSection.style.display = 'none';
                return;
            }

            // Show route section
            routeSection.style.display = 'block';

            const html = recommendations.map((poi, index) => 
                <div class="poi-card">
                    <div class="poi-header">
                        <div>
                            <h3 class="poi-name">${poi.name}</h3>
                            <span class="poi-category">${categoryNames[poi.category] || poi.category}</span>
                        </div>
                        <div class="poi-score">${poi.recommendationScore}% Uygun</div>
                    </div>
                    
                    ${poi.description ? <p class="text-muted">${poi.description}</p> : ''}
                    
                    <div class="poi-ratings">
                        ${Object.keys(ratingCategories).map(category => {
                const rating = poi.ratings[category] || 0;
                if (rating > 30) {
                    return <span class="rating-badge high">
                                    <i class="${ratingCategories[category].icon}"></i>
                                    ${ratingCategories[category].name}: ${rating}%
                                </span>;
                }
                return '';
            }).join('')}
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="focusOnMap(${poi.latitude}, ${poi.longitude})" 
                                style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-map-marker-alt"></i> Haritada Göster
                        </button>
                        <button onclick="openInGoogleMaps(${poi.latitude}, ${poi.longitude}, '${poi.name.replace(/'/g, "\\'")}')" 
                                style="background: #4285f4; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="fab fa-google"></i> Google Maps
                        </button>
                        <button onclick="addToRoute({id: '${poi.id || poi._id}', name: '${poi.name.replace(/'/g, "\\'")}', latitude: ${poi.latitude}, longitude: ${poi.longitude}, category: '${poi.category}'})" 
                                style="background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-plus"></i> Rotaya Ekle
                        </button>
                    </div>
                </div>
            ).join('');

            container.innerHTML = html;
        }

        async function initializeMap(recommendations) {
            const mapContainer = document.getElementById('mapContainer');

            if (recommendations.length === 0) {
                mapContainer.style.display = 'none';
                return;
            }

            mapContainer.style.display = 'block';

            // Clear existing map
            if (map) {
                map.remove();
            }

            // Initialize map
            map = L.map('mapContainer').setView([38.632, 34.912], 13);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add map controls
            if (L.Control.Fullscreen) {
                map.addControl(new L.Control.Fullscreen());
            }

            // Clear existing markers
            markers.forEach(marker => marker.remove());
            markers = [];

            // Add markers for recommendations
            for (const [index, poi] of recommendations.entries()) {
                const customIcon = createCustomIcon(poi.category, poi.recommendationScore);
                const categoryStyle = categoryStyles[poi.category] || { color: '#667eea', icon: '📍' };

                // Load media and elevation data (with error handling)
                let media = { images: [], videos: [], audio: [], models: [] };
                let elevation = 0;

                try {
                    media = await loadPOIMedia(poi.id || poi._id);
                } catch (error) {
                    console.warn('Could not load media for POI:', poi.name, error);
                }

                try {
                    elevation = await getElevation(poi.latitude, poi.longitude);
                } catch (error) {
                    console.warn('Could not get elevation for POI:', poi.name, error);
                }

                const marker = L.marker([poi.latitude, poi.longitude], {
                    icon: customIcon
                })
                    .addTo(map)
                    .bindPopup(
                        <div style="min-width: 280px; max-width: 350px; font-family: 'Segoe UI', sans-serif;">
                            <div style="
                                background: linear-gradient(135deg, ${categoryStyle.color} 0%, ${categoryStyle.color}dd 100%);
                                color: white;
                                padding: 12px;
                                margin: -10px -10px 10px -10px;
                                border-radius: 8px 8px 0 0;
                            ">
                                <h6 style="margin: 0; font-size: 16px; font-weight: 600;">
                                    ${categoryStyle.icon} ${poi.name}
                                </h6>
                                <small style="opacity: 0.9; font-size: 12px;">
                                    ${categoryNames[poi.category] || poi.category}
                                </small>
                            </div>
                            
                            <div style="padding: 0 5px;">
                                <div style="margin-bottom: 10px; display: flex; gap: 6px; flex-wrap: wrap;">
                                    <span style="
                                        background: linear-gradient(135deg, var(--accent-color) 0%, #20c997 100%);
                                        color: white;
                                        padding: 4px 10px;
                                        border-radius: 15px;
                                        font-size: 12px;
                                        font-weight: 600;
                                        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
                                    ">
                                        ⭐ ${poi.recommendationScore}% Uygun
                                    </span>
                                    ${elevation > 0 ? 
                                        <span style="
                                            background: #3498db;
                                            color: white;
                                            padding: 4px 8px;
                                            border-radius: 12px;
                                            font-size: 11px;
                                            font-weight: 600;
                                        ">
                                            🏔️ ${elevation}m
                                        </span>
                                     : ''}
                                </div>
                                
                                ${poi.description ? 
                                    <p style="
                                        margin: 8px 0 10px 0;
                                        font-size: 13px;
                                        line-height: 1.4;
                                        color: #555;
                                    ">${poi.description}</p>
                                 : ''}

                                ${createMediaGallery(media, poi)}
                                
                                <div style="
                                    margin-top: 12px;
                                    padding-top: 10px;
                                    border-top: 1px solid #eee;
                                    display: flex;
                                    gap: 6px;
                                    flex-wrap: wrap;
                                ">
                                    <button onclick="openInGoogleMaps(${poi.latitude}, ${poi.longitude}, '${poi.name.replace(/'/g, "\\'")}')" 
                                            style="background: #4285f4; color: white; border: none; padding: 6px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                        🗺️ Google Maps
                                    </button>
                                    <button onclick="addToRoute({id: '${poi.id || poi._id}', name: '${poi.name.replace(/'/g, "\\'")}', latitude: ${poi.latitude}, longitude: ${poi.longitude}, category: '${poi.category}'})" 
                                            style="background: var(--primary-color); color: white; border: none; padding: 6px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                        ➕ Rotaya Ekle
                                    </button>
                                </div>
                                
                                <div style="
                                    margin-top: 8px;
                                    font-size: 10px;
                                    color: #888;
                                    text-align: center;
                                ">
                                    📍 ${poi.latitude.toFixed(4)}, ${poi.longitude.toFixed(4)}
                                </div>
                            </div>
                        </div>
                    , {
                        maxWidth: 400,
                        className: 'custom-popup'
                    });

                markers.push(marker);
            }

            // Fit map to show all markers
            if (recommendations.length > 1) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function focusOnMap(lat, lng) {
            if (map) {
                map.setView([lat, lng], 16);

                // Find and open the popup for this location
                markers.forEach(marker => {
                    const markerLatLng = marker.getLatLng();
                    if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lng) < 0.0001) {
                        marker.openPopup();
                    }
                });
            }
        }
    </script>
</body>

</html>