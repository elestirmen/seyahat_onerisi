<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POI Y√∂netim Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="static/css/route-admin.css">
    <style>
        body {
            background: #f8f9fa;
        }

        .poi-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .pointer {
            cursor: pointer;
        }

        .pointer:hover {
            background-color: rgba(0, 123, 255, 0.1);
            transition: background-color 0.2s ease;
        }

        #map {
            height: 60vh;
            min-height: 350px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        #map.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1050;
            border-radius: 0;
            margin: 0;
        }

        body.map-fullscreen {
            overflow: hidden;
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }

        /* Birle≈üik Panel Tab Stilleri */
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 8px 8px 0 0;
            background: transparent;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .nav-tabs .nav-link:hover:not(.active) {
            background: #f8f9fa;
            color: #495057;
            transform: translateY(-2px);
        }

        .tab-content {
            border: none;
            padding: 0;
        }

        .tab-pane {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced POI Detail Styles in Details Tab */
        .poi-detail-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .poi-detail-info {
            background: white;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #007bff;
            margin-bottom: 16px;
        }

        .poi-detail-images {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e9ecef;
            margin-bottom: 16px;
        }

        .image-card-enhanced {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-card-enhanced:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25) !important;
        }

        .poi-detail-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-top: 1px solid #e9ecef;
        }

        .poi-detail-actions .btn {
            transition: all 0.2s ease;
        }

        .poi-detail-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .highlight-marker {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0.7);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            display: none;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .sortable:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }

        .table-responsive {
            border-radius: 8px;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-outline-primary:hover,
        .btn-outline-danger:hover {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }

        @media (max-width: 768px) {
            #map {
                height: 40vh;
            }

            .container-fluid {
                padding: 0.5rem;
            }
        }

        /* Rota Y√∂netimi Stilleri */
        .route-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .route-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .route-card.border-primary {
            border-color: #007bff !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .poi-item {
            transition: all 0.2s ease;
        }

        .poi-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }

        .selected-poi-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .sortable-list {
            min-height: 100px;
        }

        .selected-poi-item .fas.fa-grip-vertical {
            color: #6c757d;
        }

        .selected-poi-item:hover .fas.fa-grip-vertical {
            color: #007bff;
        }

        #routePoiSelection {
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
        }

        /* Route management tab visibility fix */
        #route-management.active {
            display: block !important;
            opacity: 1 !important;
        }

        /* Force route management tab to be visible when active */
        #route-management {
            transition: none !important;
        }

        #route-management.active,
        #route-management.show,
        #route-management.active.show {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            height: auto !important;
        }

        /* Override Bootstrap fade class for route management */
        #route-management.fade {
            transition: none !important;
            opacity: 1 !important;
        }

        #route-management.fade.show {
            opacity: 1 !important;
        }

        /* Force visibility when tab is clicked */
        #route-management.active {
            display: block !important;
        }

        /* Drag-and-drop stilleri */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #f8f9fa;
        }

        .sortable-chosen {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .sortable-drag {
            transform: rotate(5deg);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .drag-handle:hover {
            color: #007bff !important;
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .selected-poi-item .form-control-sm {
            font-size: 0.75rem;
        }

        .selected-poi-item .form-check-input {
            margin-top: 0.1rem;
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Y√ºkleniyor...</span>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">üó∫Ô∏è POI Y√∂netim Paneli</h2>
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <small class="text-muted">Oturum: </small>
                    <span class="badge bg-success" id="sessionStatus">Aktif</span>
                </div>
                <button type="button" class="btn btn-outline-warning btn-sm me-2" onclick="showPasswordChangeModal()"
                    id="changePasswordBtn">
                    <i class="fas fa-key me-1"></i> ≈ûifre Deƒüi≈ütir
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="logout()" id="logoutBtn">
                    <i class="fas fa-sign-out-alt me-1"></i> √áƒ±kƒ±≈ü
                </button>
            </div>
        </div>

        <!-- Harita B√∂l√ºm√º -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Harita</h5>
                            <small class="text-muted">POI'leri g√∂rmek i√ßin haritaya tƒ±klayƒ±n. Yeni POI eklemek i√ßin haritada
                                bir noktaya √ßift tƒ±klayƒ±n.</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleFullscreenBtn" onclick="toggleMapFullscreen()">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ana Navigasyon -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="mainTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="poi-management-tab" data-bs-toggle="tab"
                                    data-bs-target="#poi-management" type="button" role="tab">
                                    <i class="fas fa-map-marker-alt me-2"></i>POI Y√∂netimi
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="route-management-tab" data-bs-toggle="tab"
                                    data-bs-target="#route-management" type="button" role="tab">
                                    <i class="fas fa-route me-2"></i>Rota Y√∂netimi
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab ƒ∞√ßerikleri -->
        <div class="tab-content" id="mainTabContent">
            <!-- POI Y√∂netimi Sekmesi -->
            <div class="tab-pane fade show active" id="poi-management" role="tabpanel">
                <div class="row">
                    <!-- Sol Panel: Birle≈üik POI Y√∂netim Paneli -->
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="panelTitle">üÜï Yeni POI Ekle</h5>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary me-1"
                                            onclick="selectLocationFromMap()" id="mapSelectBtn">
                                            üìç Haritadan Se√ß
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info d-none"
                                            onclick="clearForm()" id="newPoiBtn">
                                            ‚ûï Yeni POI
                                        </button>
                                    </div>
                                </div>

                                <!-- Tab Navigation -->
                                <ul class="nav nav-tabs mt-3" id="poiTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="form-tab" data-bs-toggle="tab"
                                            data-bs-target="#form-content" type="button" role="tab">
                                            <i class="fas fa-edit me-1"></i>Form
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation" style="display: none;"
                                        id="details-tab-container">
                                        <button class="nav-link" id="details-tab" data-bs-toggle="tab"
                                            data-bs-target="#details-content" type="button" role="tab">
                                            <i class="fas fa-info-circle me-1"></i>Detaylar
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="categories-tab" data-bs-toggle="tab"
                                            data-bs-target="#categories-content" type="button" role="tab">
                                            <i class="fas fa-tags me-1"></i>Kategoriler
                                        </button>
                                    </li>
                                </ul>
                            </div>

                            <div class="card-body">
                                <div class="tab-content" id="poiTabContent">
                                    <!-- Form Content -->
                                    <div class="tab-pane fade show active" id="form-content" role="tabpanel">
                                        <form id="poiForm">
                                            <input type="hidden" id="poiId">
                                            <div class="mb-2">
                                                <label class="form-label">Adƒ± *</label>
                                                <input type="text" class="form-control" id="poiName" required>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">Kategori *</label>
                                                <select class="form-select" id="poiCategory" required>
                                                    <option value="">Se√ßiniz</option>
                                                    <!-- Kategoriler dinamik olarak y√ºklenecek -->
                                                </select>
                                            </div>
                                            <div class="row">
                                                <div class="col-6 mb-2">
                                                    <label class="form-label">Enlem *</label>
                                                    <input type="number" step="any" class="form-control" id="poiLat"
                                                        required>
                                                </div>
                                                <div class="col-6 mb-2">
                                                    <label class="form-label">Boylam *</label>
                                                    <input type="number" step="any" class="form-control" id="poiLon"
                                                        required>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">A√ßƒ±klama</label>
                                                <textarea class="form-control" id="poiDesc" rows="3"></textarea>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">Etiketler</label>
                                                <input type="text" class="form-control" id="poiTags"
                                                    placeholder="etiket1, etiket2, etiket3...">
                                            </div>

                                            <!-- POI Rating Sistemi (Yeni!) -->
                                            <div class="mb-3" id="ratingSystemSection">
                                                <label class="form-label">‚≠ê POI Nitelik Puanlarƒ± (0-100)</label>
                                                <div class="border rounded p-3"
                                                    style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                                    <small class="text-muted mb-3 d-block">
                                                        <i class="fas fa-info-circle text-primary"></i>
                                                        Bu POI'nin farklƒ± niteliklerde ne kadar deƒüerli olduƒüunu 0-100
                                                        arasƒ± puanlayƒ±n.
                                                    </small>

                                                    <div class="row g-3">
                                                        <!-- Tarihi -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #8B4513;">
                                                                    <i class="fas fa-landmark me-1"></i> Tarihi
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_tarihi"
                                                                        oninput="updateRatingDisplay('tarihi', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_tarihi_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Sanat ve K√ºlt√ºr -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #9B59B6;">
                                                                    <i class="fas fa-palette me-1"></i> Sanat & K√ºlt√ºr
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_sanat_kultur"
                                                                        oninput="updateRatingDisplay('sanat_kultur', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_sanat_kultur_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Doƒüa -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #27AE60;">
                                                                    <i class="fas fa-leaf me-1"></i> Doƒüa
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_doga"
                                                                        oninput="updateRatingDisplay('doga', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_doga_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Eƒülence -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #E74C3C;">
                                                                    <i class="fas fa-music me-1"></i> Eƒülence
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_eglence"
                                                                        oninput="updateRatingDisplay('eglence', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_eglence_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Alƒ±≈üveri≈ü -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #F39C12;">
                                                                    <i class="fas fa-shopping-cart me-1"></i> Alƒ±≈üveri≈ü
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_alisveris"
                                                                        oninput="updateRatingDisplay('alisveris', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_alisveris_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Spor -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #34495E;">
                                                                    <i class="fas fa-dumbbell me-1"></i> Spor
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_spor"
                                                                        oninput="updateRatingDisplay('spor', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_spor_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Macera -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #D35400;">
                                                                    <i class="fas fa-mountain me-1"></i> Macera
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_macera"
                                                                        oninput="updateRatingDisplay('macera', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_macera_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Rahatlatƒ±cƒ± -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #1ABC9C;">
                                                                    <i class="fas fa-spa me-1"></i> Rahatlatƒ±cƒ±
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_rahatlatici"
                                                                        oninput="updateRatingDisplay('rahatlatici', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_rahatlatici_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Yemek -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #E67E22;">
                                                                    <i class="fas fa-utensils me-1"></i> Yemek
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_yemek"
                                                                        oninput="updateRatingDisplay('yemek', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_yemek_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Gece Hayatƒ± -->
                                                        <div class="col-md-6">
                                                            <div class="rating-item">
                                                                <label class="form-label small fw-bold"
                                                                    style="color: #6C3483;">
                                                                    <i class="fas fa-moon me-1"></i> Gece Hayatƒ±
                                                                </label>
                                                                <div class="d-flex align-items-center">
                                                                    <input type="range" class="form-range me-2" min="0"
                                                                        max="100" value="0" id="rating_gece_hayati"
                                                                        oninput="updateRatingDisplay('gece_hayati', this.value)">
                                                                    <span class="badge bg-secondary"
                                                                        id="rating_gece_hayati_display">0</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Rating √ñzeti -->
                                                    <div class="mt-3 p-2 bg-white rounded">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small class="text-muted">
                                                                <i class="fas fa-chart-bar me-1"></i> Toplam Puan:
                                                            </small>
                                                            <span class="badge bg-primary fs-6"
                                                                id="totalRatingScore">0/1000</span>
                                                        </div>
                                                        <div class="progress mt-1" style="height: 8px;">
                                                            <div class="progress-bar" id="totalRatingProgress"
                                                                style="width: 0%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Medya Y√∂netimi B√∂l√ºm√º (G√∂rsel, Video, Ses, 3D) -->
                                            <div class="mb-3" id="mediaManagementSection">
                                                <label class="form-label">üé¨ Medya Y√∂netimi</label>
                                                <div class="border rounded p-3 bg-light">
                                                    <div class="mb-2">
                                                        <input type="file" class="form-control form-control-sm"
                                                            id="mediaFile"
                                                            accept="image/*,video/*,audio/*,.glb,.gltf,.obj,.fbx,.dae,.ply,.stl">
                                                        <small class="form-text text-muted">
                                                            <i class="fas fa-info-circle text-primary"></i>
                                                            <strong>Desteklenen formatlar:</strong><br>
                                                            üì∏ <strong>G√∂rsel:</strong> PNG, JPG, JPEG, GIF, WebP (Max:
                                                            15MB)<br>
                                                            üé• <strong>Video:</strong> MP4, AVI, MOV, WebM, MKV (Max:
                                                            100MB)<br>
                                                            üéµ <strong>Ses:</strong> MP3, WAV, OGG, M4A, AAC, FLAC (Max:
                                                            50MB)<br>
                                                            üßä <strong>3D Model:</strong> GLB, GLTF, OBJ, FBX, DAE, PLY,
                                                            STL (Max: 50MB)
                                                        </small>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <select class="form-select form-select-sm" id="mediaType"
                                                                onchange="updateMediaTypeOptions()">
                                                                <option value="auto">üîç Otomatik Tespit</option>
                                                                <option value="image">üì∏ G√∂rsel</option>
                                                                <option value="video">üé• Video</option>
                                                                <option value="audio">üéµ Ses</option>
                                                                <option value="model_3d">üßä 3D Model</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-6">
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="mediaCaption" placeholder="A√ßƒ±klama">
                                                        </div>
                                                    </div>
                                                    <div class="form-check mt-2">
                                                        <input class="form-check-input" type="checkbox"
                                                            id="isPrimaryMedia">
                                                        <label class="form-check-label" for="isPrimaryMedia">Ana
                                                            medya</label>
                                                    </div>
                                                    <button type="button"
                                                        class="btn btn-outline-primary btn-sm mt-2 w-100"
                                                        onclick="uploadPOIMedia()">
                                                        üì§ Medya Y√ºkle
                                                    </button>
                                                </div>

                                                <!-- Mevcut Medya Dosyalarƒ± -->
                                                <div id="currentMedia" class="mt-2"></div>

                                                <!-- Geriye Uyumluluk i√ßin Eski G√∂rsel B√∂l√ºm√º (Gizli) -->
                                                <div id="currentImages" class="mt-2" style="display: none;"></div>
                                            </div>

                                            <div class="d-grid gap-2">
                                                <button type="button" class="btn btn-primary" id="saveBtn"
                                                    onclick="handleFormSubmit(event)">üíæ Kaydet</button>
                                                <button type="button" class="btn btn-outline-danger d-none"
                                                    id="deleteBtn" onclick="deleteCurrentPOI()">
                                                    üóëÔ∏è POI'yi Sil
                                                </button>
                                                <button type="button" class="btn btn-secondary d-none"
                                                    id="cancelEditBtn" onclick="clearForm()">
                                                    ‚ùå ƒ∞ptal
                                                </button>
                                            </div>
                                        </form>
                                    </div>

                                    <!-- Details Content -->
                                    <div class="tab-pane fade" id="details-content" role="tabpanel">
                                        <div id="poiDetailContent">
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                                <p>POI detaylarƒ± burada g√∂r√ºnecek</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Categories Management Content -->
                                    <div class="tab-pane fade" id="categories-content" role="tabpanel">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-plus-circle me-2"></i>Yeni Kategori Ekle</h6>
                                                <form id="categoryForm" class="mb-4">
                                                    <div class="mb-3">
                                                        <label class="form-label">Kategori Adƒ± *</label>
                                                        <input type="text" class="form-control" id="categoryName"
                                                            required placeholder="√ñrn: yeni_kategori" pattern="[a-z_]+"
                                                            title="Sadece k√º√ß√ºk harf ve alt √ßizgi kullanƒ±n">
                                                        <div class="form-text">Sadece k√º√ß√ºk harf ve alt √ßizgi (_)
                                                            kullanƒ±n</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">G√∂r√ºnen Ad *</label>
                                                        <input type="text" class="form-control" id="categoryDisplayName"
                                                            required placeholder="√ñrn: üé≠ Yeni Kategori">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Renk *</label>
                                                        <input type="color" class="form-control form-control-color"
                                                            id="categoryColor" value="#007bff" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">ƒ∞kon *</label>
                                                        <input type="text" class="form-control" id="categoryIcon"
                                                            required placeholder="√ñrn: star, heart, map-pin">
                                                        <div class="form-text">FontAwesome ikon adƒ± (fa- olmadan)</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">A√ßƒ±klama</label>
                                                        <textarea class="form-control" id="categoryDescription" rows="2"
                                                            placeholder="Kategori a√ßƒ±klamasƒ±..."></textarea>
                                                    </div>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-plus me-1"></i>Kategori Ekle
                                                    </button>
                                                </form>
                                            </div>

                                            <div class="col-md-6">
                                                <h6><i class="fas fa-list me-2"></i>Mevcut Kategoriler</h6>
                                                <div id="categoriesList" class="border rounded p-3"
                                                    style="max-height: 400px; overflow-y: auto;">
                                                    <div class="text-center text-muted py-3">
                                                        <i class="fas fa-spinner fa-spin"></i>
                                                        <p class="mb-0">Kategoriler y√ºkleniyor...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kategori D√ºzenleme Modal -->
                    <div class="modal fade" id="editCategoryModal" tabindex="-1"
                        aria-labelledby="editCategoryModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editCategoryModalLabel">
                                        <i class="fas fa-edit me-2"></i>Kategori D√ºzenle
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editCategoryForm">
                                        <input type="hidden" id="editCategoryOriginalName">

                                        <div class="mb-3">
                                            <label class="form-label">Kategori Adƒ± *</label>
                                            <input type="text" class="form-control" id="editCategoryName" required
                                                pattern="[a-z_]+" title="Sadece k√º√ß√ºk harf ve alt √ßizgi kullanƒ±n"
                                                readonly>
                                            <div class="form-text">Kategori adƒ± deƒüi≈ütirilemez (POI'lerde kullanƒ±ldƒ±ƒüƒ±
                                                i√ßin)</div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">G√∂r√ºnen Ad *</label>
                                            <input type="text" class="form-control" id="editCategoryDisplayName"
                                                required placeholder="√ñrn: üé≠ Yeni Kategori">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Renk *</label>
                                            <input type="color" class="form-control form-control-color"
                                                id="editCategoryColor" required>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">ƒ∞kon *</label>
                                            <input type="text" class="form-control" id="editCategoryIcon" required
                                                placeholder="√ñrn: star, heart, map-pin">
                                            <div class="form-text">FontAwesome ikon adƒ± (fa- olmadan)</div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">A√ßƒ±klama</label>
                                            <textarea class="form-control" id="editCategoryDescription" rows="2"
                                                placeholder="Kategori a√ßƒ±klamasƒ±..."></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>ƒ∞ptal
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="updateCategory()">
                                        <i class="fas fa-save me-1"></i>G√ºncelle
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Saƒü Panel: Liste -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h5 class="mb-0">POI Listesi</h5>
                                    </div>
                                    <div class="col-auto">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="searchPOI"
                                                placeholder="POI ara...">
                                            <select id="filterCategory" class="form-select">
                                                <option value="">T√ºm Kategoriler</option>
                                                <!-- Kategoriler dinamik olarak y√ºklenecek -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body poi-list p-0">
                                <table class="table table-hover mb-0" id="poiTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="sortable" data-sort="name">Adƒ± <span class="sort-icon">‚ÜïÔ∏è</span>
                                            </th>
                                            <th class="sortable" data-sort="category">Kategori <span
                                                    class="sort-icon">‚ÜïÔ∏è</span>
                                            </th>
                                            <th class="sortable" data-sort="lat">Enlem <span class="sort-icon">‚ÜïÔ∏è</span>
                                            </th>
                                            <th class="sortable" data-sort="lon">Boylam <span
                                                    class="sort-icon">‚ÜïÔ∏è</span></th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="poiTableBody"></tbody>
                                </table>
                                <div class="text-center p-3 d-none" id="noDataMessage">
                                    <p class="text-muted mb-0">Herhangi bir POI bulunamadƒ±.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rota Y√∂netimi Sekmesi -->
            <div class="tab-pane fade" id="route-management" role="tabpanel">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Rota Y√∂netimi sekmesi y√ºklendi!
                </div>
                <div class="row">
                    <!-- Sol Panel: Rota Y√∂netim Paneli -->
                    <div class="col-md-4">
                        <div class="card mb-3 route-management-panel">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="routePanelTitle">üõ£Ô∏è Rota Y√∂netimi</h5>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="showNewRouteForm()"
                                        id="newRouteBtn">
                                        ‚ûï Yeni Rota
                                    </button>
                                </div>
                            </div>

                            <div class="card-body">
                                <!-- Yeni Rota Formu (Ba≈ülangƒ±√ßta gizli) -->
                                <div id="newRouteForm" style="display: none;">
                                    <form id="routeForm">
                                        <input type="hidden" id="routeId">
                                        
                                        <!-- Dosya ƒ∞√ße Aktarma Se√ßeneƒüi -->
                                        <div class="mb-3">
                                            <div class="card border-info">
                                                <div class="card-header bg-light">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-file-import text-info me-2"></i>
                                                            Dosyadan ƒ∞√ße Aktar
                                                        </h6>
                                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                                onclick="toggleFileImport()" id="toggleFileImportBtn">
                                                            <i class="fas fa-chevron-down"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="card-body collapse" id="fileImportSection">
                                                    <div class="mb-3">
                                                        <label class="form-label">KML/KMZ/GPX Dosyasƒ± Se√ß</label>
                                                        <input type="file" class="form-control" id="routeFileInput" 
                                                               accept=".kml,.kmz,.gpx" onchange="handleRouteFileSelect(event)">
                                                        <small class="form-text text-muted">
                                                            <i class="fas fa-info-circle text-info"></i>
                                                            Desteklenen formatlar: KML, KMZ, GPX (Maksimum 10MB)
                                                        </small>
                                                    </div>
                                                    
                                                    <!-- Dosya Parse Durumu -->
                                                    <div id="fileParseStatus" style="display: none;">
                                                        <div class="alert alert-info mb-3">
                                                            <div class="d-flex align-items-center">
                                                                <div class="spinner-border spinner-border-sm text-info me-2" role="status">
                                                                    <span class="visually-hidden">Y√ºkleniyor...</span>
                                                                </div>
                                                                <span>Dosya i≈üleniyor...</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Parse Sonucu -->
                                                    <div id="parseResult" style="display: none;">
                                                        <div class="alert alert-success">
                                                            <h6><i class="fas fa-check-circle me-2"></i>Dosya Ba≈üarƒ±yla ƒ∞≈ülendi</h6>
                                                            <div id="parseResultContent"></div>
                                                            
                                                            <!-- Rota Se√ßimi (√áoklu rota durumunda) -->
                                                            <div id="routeSelection" style="display: none;">
                                                                <label class="form-label mt-2">ƒ∞√ße Aktarƒ±lacak Rota:</label>
                                                                <select class="form-select" id="selectedRouteIndex">
                                                                    <!-- Rotalar dinamik olarak y√ºklenecek -->
                                                                </select>
                                                            </div>
                                                            
                                                            <!-- Waypoint'leri POI olarak ekle se√ßeneƒüi -->
                                                            <div class="form-check mt-2">
                                                                <input class="form-check-input" type="checkbox" id="importWaypointsAsPois">
                                                                <label class="form-check-label" for="importWaypointsAsPois">
                                                                    Waypoint'leri POI olarak ekle
                                                                </label>
                                                            </div>
                                                            
                                                            <div class="mt-3">
                                                                <button type="button" class="btn btn-success btn-sm" 
                                                                        onclick="applyImportedRouteData()">
                                                                    <i class="fas fa-download me-1"></i>Rota Verilerini Uygula
                                                                </button>
                                                                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" 
                                                                        onclick="clearFileImport()">
                                                                    <i class="fas fa-times me-1"></i>Temizle
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Hata Durumu -->
                                                    <div id="parseError" style="display: none;">
                                                        <div class="alert alert-danger">
                                                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Dosya ƒ∞≈üleme Hatasƒ±</h6>
                                                            <div id="parseErrorContent"></div>
                                                            <button type="button" class="btn btn-outline-danger btn-sm mt-2" 
                                                                    onclick="clearFileImport()">
                                                                <i class="fas fa-redo me-1"></i>Tekrar Dene
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Rota Adƒ± *</label>
                                            <input type="text" class="form-control" id="routeName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">A√ßƒ±klama</label>
                                            <textarea class="form-control" id="routeDescription" rows="3"></textarea>
                                        </div>
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Rota Tipi *</label>
                                                <select class="form-select" id="routeType" required>
                                                    <option value="">Se√ßiniz</option>
                                                    <option value="walking">üö∂ Y√ºr√ºy√º≈ü</option>
                                                    <option value="hiking">ü•æ Doƒüa Y√ºr√ºy√º≈ü√º</option>
                                                    <option value="cycling">üö¥ Bisiklet</option>
                                                    <option value="driving">üöó Ara√ß</option>
                                                </select>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Zorluk Seviyesi *</label>
                                                <select class="form-select" id="routeDifficulty" required>
                                                    <option value="">Se√ßiniz</option>
                                                    <option value="1">‚≠ê √áok Kolay</option>
                                                    <option value="2">‚≠ê‚≠ê Kolay</option>
                                                    <option value="3">‚≠ê‚≠ê‚≠ê Orta</option>
                                                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Zor</option>
                                                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê √áok Zor</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Tahmini S√ºre (dakika)</label>
                                                <input type="number" class="form-control" id="routeDuration" min="1">
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Mesafe (km)</label>
                                                <div class="input-group">
                                                    <input type="number" step="0.1" class="form-control"
                                                        id="routeDistance" min="0">
                                                    <button class="btn btn-outline-primary" type="button"
                                                        id="calculateRouteBtn" onclick="calculateRouteDistance()"
                                                        title="Yol aƒüƒ±na g√∂re mesafe hesapla">
                                                        <i class="fas fa-route"></i> Hesapla
                                                    </button>
                                                </div>
                                                <small class="text-muted">Otomatik hesaplama i√ßin "Hesapla" butonuna
                                                    tƒ±klayƒ±n</small>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Etiketler</label>
                                            <input type="text" class="form-control" id="routeTags"
                                                placeholder="tarihi, doƒüa, aile dostu...">
                                            <small class="form-text text-muted">Virg√ºlle ayƒ±rƒ±n</small>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="routeIsCircular">
                                                <label class="form-check-label" for="routeIsCircular">
                                                    Dairesel rota (ba≈ülangƒ±√ß ve biti≈ü aynƒ± nokta)
                                                </label>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-1"></i>Kaydet
                                            </button>
                                            <button type="button" class="btn btn-secondary"
                                                onclick="hideNewRouteForm()">
                                                <i class="fas fa-times me-1"></i>ƒ∞ptal
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Rota Listesi -->
                                <div id="routesList">
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="searchRoute"
                                            placeholder="üîç Rota ara..." onkeyup="filterRoutes()">
                                    </div>
                                    <div id="routesContainer">
                                        <div class="text-center p-3 text-muted">
                                            <i class="fas fa-route fa-2x mb-2"></i>
                                            <p class="mb-0">Hen√ºz rota eklenmemi≈ü</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Saƒü Panel: Rota Detaylarƒ± ve POI Se√ßimi -->
                    <div class="col-md-8">
                        <div class="card route-detail-panel">
                            <div class="card-header">
                                <h5 class="mb-0" id="routeDetailTitle">üìç Rota Detaylarƒ±</h5>
                            </div>
                            <div class="card-body">
                                <div id="routeDetailContent">
                                    <div class="route-detail-empty">
                                        <i class="fas fa-map-marked-alt"></i>
                                        <h6>Rota Se√ßin</h6>
                                        <p class="mb-0">Detaylarƒ± g√∂rmek i√ßin sol panelden bir rota se√ßin</p>
                                    </div>
                                </div>

                                <!-- POI Se√ßimi B√∂l√ºm√º -->
                                <div id="routePoiSelection" style="display: block;">
                                    <hr>
                                    <h6 class="mb-3" id="poiSelectionTitle">
                                        <i class="fas fa-map-marker-alt me-2"></i>POI Se√ßimi ve Sƒ±ralama
                                    </h6>

                                    <!-- POI Filtreleme -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <select class="form-select" id="poiCategoryFilter"
                                                onchange="filterAvailablePOIs()">
                                                <option value="">T√ºm Kategoriler</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" id="poiSearchFilter"
                                                placeholder="POI ara..." onkeyup="filterAvailablePOIs()">
                                        </div>
                                    </div>

                                    <div class="row">
                                        <!-- Mevcut POI'ler -->
                                        <div class="col-md-6">
                                            <div class="poi-list-container">
                                                <h6>Mevcut POI'ler</h6>
                                                <div id="availablePOIs">
                                                    <!-- POI'ler dinamik olarak y√ºklenecek -->
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Se√ßilen POI'ler (Sƒ±ralanabilir) -->
                                        <div class="col-md-6">
                                            <div class="poi-list-container">
                                                <h6>Rota POI'leri (S√ºr√ºkleyerek sƒ±ralayƒ±n)</h6>
                                                <div id="selectedPOIs" class="sortable-list">
                                                    <div class="empty-state">
                                                        <i class="fas fa-arrow-left"></i>
                                                        <p>Sol panelden POI se√ßin</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Rota √ñnizleme Haritasƒ± -->
                                    <div class="mt-3">
                                        <h6 class="text-muted mb-2">
                                            <i class="fas fa-map me-2"></i>Rota √ñnizlemesi
                                        </h6>
                                        <div id="routePreviewMap" style="height: 200px; border-radius: 8px;"></div>
                                    </div>

                                    <div class="route-action-buttons">
                                        <button type="button" class="btn btn-outline-primary"
                                            onclick="updateRoutePreview()">
                                            <i class="fas fa-sync"></i>√ñnizlemeyi G√ºncelle
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        const apiBase = '/api';
        let map;
        let csrfToken = null;

        // Authentication functions
        async function checkAuthStatus() {
            console.log('üîê Checking auth status...');
            try {
                const response = await fetch('/auth/status');
                console.log('üîê Auth status response:', response.status, response.ok);

                if (response.ok) {
                    const data = await response.json();
                    console.log('üîê Auth status data:', data);

                    if (data.authenticated) {
                        csrfToken = data.csrf_token;
                        console.log('üîê Authentication successful, CSRF token:', csrfToken);
                        updateSessionStatus(data.session_info);
                        return true;
                    } else {
                        console.log('üîê Not authenticated');
                    }
                } else {
                    console.log('üîê Auth status request failed');
                }
                // If not authenticated, redirect to login
                console.log('üîê Redirecting to login...');
                window.location.href = '/auth/login';
                return false;
            } catch (error) {
                console.error('üîê Auth status check failed:', error);
                window.location.href = '/auth/login';
                return false;
            }
        }

        function updateSessionStatus(sessionInfo) {
            const statusElement = document.getElementById('sessionStatus');
            if (sessionInfo) {
                statusElement.textContent = 'Aktif';
                statusElement.className = 'badge bg-success';

                // Update session timeout warning if needed
                if (sessionInfo.expires_at) {
                    const expiresAt = new Date(sessionInfo.expires_at);
                    const now = new Date();
                    const timeLeft = expiresAt - now;

                    // Show different status based on time left
                    if (timeLeft <= 0) {
                        statusElement.textContent = 'S√ºresi Doldu';
                        statusElement.className = 'badge bg-danger';
                        // Redirect to login
                        setTimeout(() => {
                            window.location.href = '/auth/login';
                        }, 1000);
                    } else if (timeLeft < 5 * 60 * 1000) { // Less than 5 minutes
                        const minutesLeft = Math.floor(timeLeft / (60 * 1000));
                        const secondsLeft = Math.floor((timeLeft % (60 * 1000)) / 1000);
                        statusElement.textContent = `${minutesLeft}:${secondsLeft.toString().padStart(2, '0')}`;
                        statusElement.className = 'badge bg-danger';
                    } else if (timeLeft < 10 * 60 * 1000) { // Less than 10 minutes
                        const minutesLeft = Math.floor(timeLeft / (60 * 1000));
                        statusElement.textContent = `${minutesLeft}dk kaldƒ±`;
                        statusElement.className = 'badge bg-warning';
                    }
                }
            } else {
                statusElement.textContent = 'Bilinmiyor';
                statusElement.className = 'badge bg-secondary';
            }
        }

        async function logout() {
            if (!confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        csrf_token: csrfToken
                    })
                });

                if (response.ok) {
                    showToast('Ba≈üarƒ±yla √ßƒ±kƒ±≈ü yapƒ±ldƒ±', 'success');
                    setTimeout(() => {
                        window.location.href = '/auth/login';
                    }, 1000);
                } else {
                    const error = await response.json();
                    showToast('√áƒ±kƒ±≈ü yapƒ±lƒ±rken hata olu≈ütu: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showToast('√áƒ±kƒ±≈ü yapƒ±lƒ±rken hata olu≈ütu', 'error');
                // Force redirect even if logout request failed
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 2000);
            }
        }

        // Get CSRF token
        async function getCSRFToken() {
            if (csrfToken) {
                return csrfToken;
            }

            try {
                const response = await fetch('/auth/csrf-token');
                if (response.ok) {
                    const data = await response.json();
                    csrfToken = data.csrf_token;
                    return csrfToken;
                }
            } catch (error) {
                console.error('Failed to get CSRF token:', error);
            }

            return csrfToken || '';
        }

        // Enhanced fetch function with authentication
        async function authenticatedFetch(url, options = {}) {
            // Add CSRF token to requests that modify data
            if (options.method && ['POST', 'PUT', 'DELETE'].includes(options.method.toUpperCase())) {
                if (!options.headers) {
                    options.headers = {};
                }

                if (options.body && typeof options.body === 'string') {
                    try {
                        const bodyData = JSON.parse(options.body);
                        bodyData.csrf_token = csrfToken;
                        options.body = JSON.stringify(bodyData);
                    } catch (e) {
                        // If body is not JSON, add CSRF token as form data
                        if (options.body instanceof FormData) {
                            options.body.append('csrf_token', csrfToken);
                        }
                    }
                } else if (options.body instanceof FormData) {
                    options.body.append('csrf_token', csrfToken);
                }
            }

            const response = await fetch(url, options);

            // Handle authentication errors
            if (response.status === 401) {
                showToast('Oturum s√ºresi doldu, yeniden giri≈ü yapƒ±lƒ±yor...', 'warning');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 2000);
                throw new Error('Authentication required');
            }

            return response;
        }
        let poiMarkers = [];
        let allPOIs = [];
        let currentSort = { field: 'name', direction: 'asc' };
        let isSelectingLocation = false;
        let selectedPOI = null;
        let highlightedMarker = null; // Vurgulanan POI marker'ƒ±

        // Harita ba≈ülatma
        function initMap() {
            map = L.map('map').setView([38.6322, 34.9115], 16); // √úrg√ºp merkezi

            // Farklƒ± harita katmanlarƒ± tanƒ±mla
            const baseLayers = {
                "üó∫Ô∏è OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 20
                }),

                "üõ∞Ô∏è Uydu G√∂r√ºnt√ºs√º": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri, Maxar, Earthstar Geographics',
                    maxZoom: 19
                }),

                "üèîÔ∏è Topografik": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenTopoMap (CC-BY-SA)',
                    maxZoom: 17
                }),

                "üé® CartoDB Positron": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap ¬© CartoDB',
                    maxZoom: 19
                }),

                "üåô CartoDB Dark": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap ¬© CartoDB',
                    maxZoom: 19
                })
            };

            // Varsayƒ±lan katmanƒ± ekle
            baseLayers["üó∫Ô∏è OpenStreetMap"].addTo(map);

            // Katman kontrol√ºn√º ekle
            L.control.layers(baseLayers).addTo(map);

            // Haritaya √ßift tƒ±klama ile POI ekleme
            map.on('dblclick', function (e) {
                if (!isSelectingLocation) {
                    const { lat, lng } = e.latlng;
                    document.getElementById('poiLat').value = lat.toFixed(6);
                    document.getElementById('poiLon').value = lng.toFixed(6);
                    document.getElementById('poiName').focus();
                    showToast('Konum se√ßildi! POI bilgilerini doldurun.', 'success');
                }
            });

            // Haritadan konum se√ßme modu
            map.on('click', function (e) {
                if (isSelectingLocation) {
                    const { lat, lng } = e.latlng;
                    document.getElementById('poiLat').value = lat.toFixed(6);
                    document.getElementById('poiLon').value = lng.toFixed(6);
                    exitLocationSelectionMode();
                    showToast('Konum se√ßildi!', 'success');
                }
            });
        }

        function toggleMapFullscreen() {
            const mapEl = document.getElementById('map');
            const btn = document.getElementById('toggleFullscreenBtn');
            mapEl.classList.toggle('fullscreen');
            document.body.classList.toggle('map-fullscreen');

            const icon = btn.querySelector('i');
            if (mapEl.classList.contains('fullscreen')) {
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
            } else {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }

            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        }

        // Konum se√ßme modu
        function selectLocationFromMap() {
            isSelectingLocation = true;
            document.getElementById('mapSelectBtn').innerHTML = '‚ùå ƒ∞ptal';
            document.getElementById('mapSelectBtn').onclick = exitLocationSelectionMode;
            map.getContainer().style.cursor = 'crosshair';
            showToast('Haritadan bir konum se√ßin...', 'info');
        }

        function exitLocationSelectionMode() {
            isSelectingLocation = false;
            document.getElementById('mapSelectBtn').innerHTML = 'üìç Haritadan Se√ß';
            document.getElementById('mapSelectBtn').onclick = selectLocationFromMap;
            map.getContainer().style.cursor = '';
        }

        // Loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Toast bildirimleri
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Loading states
        function showLoading() {
            // Kaydet butonuna loading ekle
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Kaydediliyor...';
                saveBtn.disabled = true;
            }

            // POI tablosuna loading overlay ekle
            const poiTableContainer = document.querySelector('.table-responsive');
            if (poiTableContainer && !document.getElementById('tableLoading')) {
                const overlay = document.createElement('div');
                overlay.id = 'tableLoading';
                overlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;
                overlay.innerHTML = '<div class="spinner-border text-primary"></div>';
                poiTableContainer.style.position = 'relative';
                poiTableContainer.appendChild(overlay);
            }
        }

        function hideLoading() {
            // Kaydet butonunu resetle
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.innerHTML = 'üíæ Kaydet';
                saveBtn.disabled = false;
            }

            // Table loading overlay'i kaldƒ±r
            const overlay = document.getElementById('tableLoading');
            if (overlay) {
                overlay.remove();
            }
        }

        // Global kategori verileri
        let categoryData = {};

        // Kategorileri y√ºkle
        async function loadCategories() {
            try {
                console.log('üìã Kategoriler y√ºkleniyor...');
                const response = await authenticatedFetch(`${apiBase}/categories`);

                if (!response.ok) {
                    throw new Error('Kategoriler y√ºklenemedi');
                }

                const categories = await response.json();
                console.log('‚úÖ Kategoriler y√ºklendi:', categories);

                // POI ekleme formundaki kategori dropdown'ƒ±nƒ± g√ºncelle
                const poiCategorySelect = document.getElementById('poiCategory');
                poiCategorySelect.innerHTML = '<option value="">Se√ßiniz</option>';

                // Filtre dropdown'ƒ±nƒ± g√ºncelle
                const filterCategorySelect = document.getElementById('filterCategory');
                filterCategorySelect.innerHTML = '<option value="">T√ºm Kategoriler</option>';

                // Global kategori verilerini g√ºncelle
                categoryData = {};
                categories.forEach(category => {
                    categoryData[category.name] = {
                        display_name: category.display_name,
                        color: category.color,
                        icon: category.icon,
                        description: category.description
                    };

                    // POI ekleme formu i√ßin option
                    const poiOption = document.createElement('option');
                    poiOption.value = category.name;
                    poiOption.textContent = category.display_name;
                    poiCategorySelect.appendChild(poiOption);

                    // Filtre i√ßin option
                    const filterOption = document.createElement('option');
                    filterOption.value = category.name;
                    filterOption.textContent = category.display_name;
                    filterCategorySelect.appendChild(filterOption);
                });

                console.log('‚úÖ Kategori dropdown\'larƒ± ve renk verileri g√ºncellendi');

            } catch (error) {
                console.error('‚ùå Kategori y√ºkleme hatasƒ±:', error);
                showToast('Kategoriler y√ºklenirken hata olu≈ütu', 'error');
            }
        }

        // POI'leri getir
        async function fetchPOIs(category = '') {
            console.log('üîç fetchPOIs called with category:', category);
            console.log('üîç apiBase:', apiBase);
            console.log('üîç csrfToken:', csrfToken);

            showLoading();
            try {
                const url = `${apiBase}/pois${category ? `?category=${encodeURIComponent(category)}` : ''}`;
                console.log('üîç Fetching URL:', url);

                // Timeout ile fetch
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000); // 10 saniye timeout

                console.log('üîç Making authenticated fetch request...');
                const response = await authenticatedFetch(url, {
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                clearTimeout(timeout);

                console.log('üîç Response status:', response.status);
                console.log('üîç Response ok:', response.ok);

                if (!response.ok) {
                    throw new Error(`API call failed with status ${response.status}`);
                }
                const data = await response.json();

                let pois = [];
                if (category) {
                    // A single category is returned as an array of POIs
                    pois = data.map(poi => ({ ...poi, category: category }));
                } else {
                    // All POIs are returned in a structured object by category
                    for (const cat in data) {
                        if (Array.isArray(data[cat])) {
                            const categoryPois = data[cat].map(poi => ({ ...poi, category: cat }));
                            pois.push(...categoryPois);
                        }
                    }
                }

                allPOIs = pois;
                filterAndSortPOIs(); // This function calls renderPOITable and updateMapMarkers
            } catch (error) {
                console.error('Error fetching POIs:', error);
                if (error.name === 'AbortError') {
                    showToast('ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.', 'error');
                } else if (error.message.includes('fetch')) {
                    showToast('Sunucuya baƒülanƒ±lamƒ±yor. API √ßalƒ±≈üƒ±yor mu kontrol edin.', 'error');
                } else {
                    showToast('POIs could not be loaded: ' + error.message, 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // Harita markerlarƒ±nƒ± g√ºncelle
        function updateMapMarkers(pois) {
            // Mevcut markerlarƒ± ve vurgulamayƒ± temizle
            poiMarkers.forEach(marker => map.removeLayer(marker));
            poiMarkers = [];

            // Vurgulama marker'ƒ±nƒ± da temizle
            if (highlightedMarker) {
                map.removeLayer(highlightedMarker);
                highlightedMarker = null;
            }

            // Yeni markerlarƒ± ekle
            pois.forEach(poi => {
                if (poi.latitude === undefined || poi.longitude === undefined) {
                    console.warn('Skipping POI with missing coordinates:', poi);
                    return;
                }

                // Dinamik kategori rengini al
                const categoryColor = getCategoryColor(poi.category);

                const marker = L.circleMarker([poi.latitude, poi.longitude], {
                    color: '#ffffff',
                    fillColor: categoryColor,
                    fillOpacity: 0.9,
                    radius: 12,
                    weight: 3,
                    opacity: 1
                }).addTo(map);

                marker.bindPopup(`
            <strong>${poi.name}</strong><br>
            <small>${getCategoryDisplayName(poi.category)}</small><br>
            <button class="btn btn-sm btn-primary mt-1" onclick="showPOIDetail('${poi._id}')">Details</button>
        `);

                marker.on('click', () => {
                    showPOIDetail(poi._id);
                });

                poiMarkers.push(marker);
            });
        }

        // Kategori g√∂r√ºnt√º adƒ±nƒ± getir (dinamik)
        function getCategoryDisplayName(category) {
            if (categoryData[category]) {
                return categoryData[category].display_name;
            }

            // Fallback i√ßin sabit deƒüerler
            const fallbackNames = {
                'gastronomik': 'üçΩÔ∏è Gastronomik',
                'kulturel': 'üèõÔ∏è K√ºlt√ºrel',
                'sanatsal': 'üé® Sanatsal',
                'doga_macera': 'üåø Doƒüa & Macera',
                'konaklama': 'üè® Konaklama'
            };
            return fallbackNames[category] || category;
        }

        // Kategori rengini getir (dinamik)
        function getCategoryColor(category) {
            if (categoryData[category]) {
                return categoryData[category].color;
            }

            // Fallback i√ßin sabit renkler
            const fallbackColors = {
                'gastronomik': '#e74c3c',
                'kulturel': '#3498db',
                'sanatsal': '#2ecc71',
                'doga_macera': '#f39c12',
                'konaklama': '#9b59b6',
                'dini': '#8B4513',
                'tarihi': '#CD853F',
                'mimari': '#4682B4',
                'mezarlik': '#696969',
                'saray_kale': '#B8860B',
                'diger': '#708090'
            };
            return fallbackColors[category] || '#666666';
        }

        // POI'yi haritada vurgula
        function highlightPOIOnMap(poiId) {
            console.log('üéØ highlightPOIOnMap called with ID:', poiId);
            console.log('üìä Total POIs in allPOIs:', allPOIs.length);

            // √ñnceki vurgulamayƒ± temizle
            if (highlightedMarker) {
                map.removeLayer(highlightedMarker);
                highlightedMarker = null;
            }

            // POI'yi bul - hem string hem number kar≈üƒ±la≈ütƒ±rmasƒ±
            const poi = allPOIs.find(p => p._id == poiId || p._id === poiId || p._id === parseInt(poiId) || p._id === String(poiId));
            console.log('üîç Found POI:', poi);
            console.log('üîç Searching for ID (type):', poiId, typeof poiId);
            console.log('üîç Available IDs in allPOIs:', allPOIs.map(p => ({ id: p._id, type: typeof p._id })));

            if (!poi) {
                console.warn('‚ùå POI not found with ID:', poiId);
                showToast(`POI bulunamadƒ± (ID: ${poiId}, Type: ${typeof poiId})`, 'error');
                return;
            }

            if (poi.latitude === undefined || poi.longitude === undefined) {
                console.warn('‚ùå POI missing coordinates:', poi);
                showToast(`POI koordinatlarƒ± eksik: ${poi.name}`, 'error');
                return;
            }

            // Vurgulama marker'ƒ± olu≈ütur
            highlightedMarker = L.circleMarker([poi.latitude, poi.longitude], {
                color: '#ff0000',
                fillColor: '#ff0000',
                fillOpacity: 0.3,
                radius: 15,
                weight: 3,
                className: 'highlight-marker'
            }).addTo(map);

            // Haritayƒ± POI'ye odakla
            map.setView([poi.latitude, poi.longitude], Math.max(map.getZoom(), 15), {
                animate: true,
                duration: 0.5
            });

            // Kullanƒ±cƒ±ya bilgi ver
            showToast(`üìç "${poi.name}" haritada vurgulandƒ±`, 'success');

            // Vurgulama animasyonu i√ßin pulse efekti
            let pulseCount = 0;
            const pulseInterval = setInterval(() => {
                if (highlightedMarker && pulseCount < 6) {
                    const currentRadius = highlightedMarker.getRadius();
                    highlightedMarker.setRadius(currentRadius === 15 ? 20 : 15);
                    pulseCount++;
                } else {
                    clearInterval(pulseInterval);
                    if (highlightedMarker) {
                        highlightedMarker.setRadius(15);
                    }
                }
            }, 200);
        }

        // POI tablosunu render et
        function renderPOITable(pois) {
            const tbody = document.getElementById('poiTableBody');
            const noDataMessage = document.getElementById('noDataMessage');

            if (pois.length === 0) {
                tbody.innerHTML = '';
                noDataMessage.classList.remove('d-none');
                return;
            }

            noDataMessage.classList.add('d-none');
            tbody.innerHTML = '';

            pois.forEach(poi => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                                                <td class="pointer text-primary" onclick="
                                        console.log('üñ±Ô∏è POI tƒ±klandƒ±:', '${poi.name}', 'ID:', ${poi._id});
                                        try {
                                            highlightPOIOnMap(${poi._id}); 
                                            showPOIDetail(${poi._id});
                                            autoLoadRatingsOnPOIChange(${poi._id});
                                        } catch(e) {
                                            console.error('‚ùå POI tƒ±klama hatasƒ±:', e);
                                            autoLoadRatingsOnPOIChange(${poi._id});
                                        }
                                    " title="Haritada g√∂ster ve detaylarƒ± a√ß">${poi.name}</td>
            <td class="pointer" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">
                <div class="d-flex align-items-center">
                    <div class="category-color-indicator me-2" 
                         style="width: 12px; height: 12px; background-color: ${getCategoryColor(poi.category)}; border-radius: 50%; border: 1px solid #ccc;"></div>
                    ${getCategoryDisplayName(poi.category)}
                </div>
            </td>
            <td class="pointer text-muted" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">${(poi.latitude || 0).toFixed(6)}</td>
            <td class="pointer text-muted" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">${(poi.longitude || 0).toFixed(6)}</td>
            <td>
                <button class="btn btn-outline-primary btn-sm me-1" onclick="editPOI(${poi._id})" title="Edit">‚úèÔ∏è</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deletePOI(${poi._id})" title="Delete">üóëÔ∏è</button>
                <button class="btn btn-outline-success btn-sm" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">üìç</button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // POI detayƒ±nƒ± g√∂ster - Yeni birle≈üik panel i√ßin g√ºncellendi
        async function showPOIDetail(poiId) {
            console.log('üéØ showPOIDetail √áAƒûRILDI! POI ID:', poiId);
            showLoading();
            try {
                console.log('üì° POI detayƒ± API\'den alƒ±nƒ±yor...');
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}`);
                if (!response.ok) throw new Error('POI not found');
                const poi = await response.json();
                console.log('‚úÖ POI detayƒ± alƒ±ndƒ±:', poi.name);

                selectedPOI = poi;

                // Form alanlarƒ±nƒ± doldur (d√ºzenleme i√ßin hazƒ±r hale getir)
                document.getElementById('poiId').value = poi._id;
                document.getElementById('poiName').value = poi.name;
                document.getElementById('poiCategory').value = poi.category;
                document.getElementById('poiLat').value = poi.latitude;
                document.getElementById('poiLon').value = poi.longitude;
                document.getElementById('poiDesc').value = poi.description || '';
                document.getElementById('poiTags').value = (poi.tags || []).join(', ');

                // Bootstrap tab ge√ßi≈üi - FORM tab'ƒ±nƒ± aktif yap ki rating'ler g√∂r√ºns√ºn
                const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
                formTab.show();

                // Rating'leri y√ºkle - BASƒ∞T VERSƒ∞YON
                setTimeout(() => {
                    console.log('üöÄ POI deƒüi≈üti, rating\'ler y√ºklenecek. POI ID:', poi._id);
                    loadPOIRatings(poi._id);
                }, 500); // Biraz daha uzun bekle

                // Formu d√ºzenleme moduna ge√ßir
                document.getElementById('saveBtn').innerHTML = 'üîÑ G√ºncelle';
                document.getElementById('deleteBtn').classList.remove('d-none');
                document.getElementById('cancelEditBtn').classList.remove('d-none');

                // Panel ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
                document.getElementById('panelTitle').textContent = `üìù ${poi.name}`;
                document.getElementById('newPoiBtn').classList.remove('d-none');

                // Detaylar tab'ƒ±nƒ± g√∂ster
                document.getElementById('details-tab-container').style.display = 'block';

                // Detay HTML'ini olu≈ütur
                let detailHtml = `
                    <div class="poi-detail-header">
                        <h5 class="mb-2 fw-bold">${poi.name}</h5>
                        <span class="badge bg-light text-dark fs-6">${getCategoryDisplayName(poi.category)}</span>
                    </div>
                    
                    <div class="poi-detail-info">
                        <p class="mb-2"><i class="fas fa-map-marker-alt text-danger me-2"></i> <strong>Konum:</strong> ${poi.latitude.toFixed(6)}, ${poi.longitude.toFixed(6)}</p>`;

                if (poi.description) {
                    detailHtml += `<p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i> <strong>A√ßƒ±klama:</strong> ${poi.description}</p>`;
                }
                if (poi.tags && poi.tags.length > 0) {
                    detailHtml += `<p class="mb-2"><i class="fas fa-tags text-success me-2"></i> <strong>Etiketler:</strong> ${poi.tags.join(', ')}</p>`;
                }

                detailHtml += `</div>`;

                // G√∂rselleri y√ºkle ve g√∂ster
                try {
                    const imagesResponse = await authenticatedFetch(`${apiBase}/poi/${poiId}/images`);
                    if (imagesResponse.ok) {
                        const imagesData = await imagesResponse.json();
                        const images = imagesData.images || [];

                        if (images.length > 0) {
                            detailHtml += `
                                <div class="poi-detail-images mt-3">
                                    <h6 class="mb-3"><i class="fas fa-images text-warning"></i> G√∂rseller (${images.length})</h6>
                                    <div class="row g-3">`;

                            images.forEach((image, index) => {
                                const imagePath = image.thumbnail_path || image.path;
                                const fullImagePath = image.path;
                                detailHtml += `
                                    <div class="col-6">
                                        <div class="image-card-enhanced" style="position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                            <img src="/${imagePath}" 
                                                 class="img-fluid" 
                                                 style="height: 120px; width: 100%; object-fit: cover; cursor: pointer; transition: transform 0.3s ease;" 
                                                 alt="${image.filename}"
                                                 onclick="showImageModal('/${fullImagePath}', '${poi.name}', '${image.filename}')"
                                                 onmouseover="this.style.transform='scale(1.05)'"
                                                 onmouseout="this.style.transform='scale(1)'">
                                            <div class="image-info-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 8px 12px;">
                                                <small class="text-white fw-bold">${getImageTypeIcon(image.filename)} ${(image.size / 1024).toFixed(0)}KB</small>
                                            </div>
                                            <button class="image-delete-btn-enhanced btn btn-danger" 
                                                    style="position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; padding: 0; font-size: 0.9rem; z-index: 10; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(220,53,69,0.4); transition: all 0.3s ease;"
                                                    onclick="deletePOIImageWithConfirm('${poi._id}', '${image.filename}', this)"
                                                    title="G√∂rseli sil - ${image.filename}"
                                                    onmouseover="this.style.transform='scale(1.2)'; this.style.boxShadow='0 6px 16px rgba(220,53,69,0.6)'"
                                                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(220,53,69,0.4)'">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>`;
                            });

                            detailHtml += `
                                    </div>
                                </div>`;
                        }
                    }
                } catch (imageError) {
                    console.log('G√∂rseller y√ºklenemedi:', imageError);
                }


                detailHtml += `
                    <div class="poi-detail-actions">
                        <button class="btn btn-primary btn-sm" onclick="focusOnMap(${poi.latitude}, ${poi.longitude})">
                            <i class="fas fa-crosshairs me-1"></i> Haritada G√∂ster
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="switchToFormTab()">
                            <i class="fas fa-edit me-1"></i> D√ºzenle
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCurrentPOI()">
                            <i class="fas fa-trash me-1"></i> Sil
                        </button>
                    </div>`;

                document.getElementById('poiDetailContent').innerHTML = detailHtml;

                // Mevcut g√∂rselleri form b√∂l√ºm√ºnde de y√ºkle
                await loadPOIImages(poiId);

            } catch (error) {
                console.error('‚ùå showPOIDetail HATASI:', error);
                showToast('POI detaylarƒ± y√ºklenirken hata olu≈ütu: ' + error.message, 'error');

                // Hata durumunda da rating'leri temizle
                setDefaultRatings();
            } finally {
                hideLoading();
            }
        }

        // Form tab'ƒ±na ge√ßi≈ü yap
        function switchToFormTab() {
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();
        }

        // Mevcut POI'yi sil
        async function deleteCurrentPOI() {
            const poiId = document.getElementById('poiId').value;
            if (poiId) {
                await deletePOI(poiId);
            }
        }

        // Haritada odaklan
        function focusOnMap(lat, lon) {
            map.setView([lat, lon], 16);
        }

        // POI d√ºzenle - Yeni birle≈üik panel i√ßin g√ºncellendi
        async function editPOI(poiId) {
            console.log('üéØ editPOI BA≈ûLADI, POI ID:', poiId);

            // √ñnce POI detaylarƒ±nƒ± y√ºkle
            await showPOIDetail(poiId);

            // Form tab'ƒ±na ge√ß ve tab deƒüi≈üimi tamamlanana kadar bekle
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();

            // Tab deƒüi≈üimi event'ini dinle
            document.getElementById('form-tab').addEventListener('shown.bs.tab', function tabShownHandler() {
                console.log('üìã Form tab aktif oldu, rating\'ler y√ºkleniyor...');

                // Event listener'ƒ± kaldƒ±r (sadece bir kez √ßalƒ±≈üsƒ±n)
                document.getElementById('form-tab').removeEventListener('shown.bs.tab', tabShownHandler);

                // Rating'leri y√ºkle
                setTimeout(() => {
                    loadRatingsSimple(poiId);
                }, 200);
            });

            // Fallback - eƒüer event √ßalƒ±≈ümazsa
            setTimeout(() => {
                console.log('üîÑ Fallback: Rating\'ler y√ºkleniyor...');
                loadRatingsSimple(poiId);
            }, 2000);

            showToast('POI d√ºzenleme moduna ge√ßildi', 'info');
        }

        // Form temizle ve yeni POI moduna ge√ß
        function clearForm() {
            document.getElementById('poiForm').reset();
            document.getElementById('poiId').value = '';
            document.getElementById('saveBtn').innerHTML = 'üíæ Kaydet';
            document.getElementById('deleteBtn').classList.add('d-none');
            document.getElementById('cancelEditBtn').classList.add('d-none');
            document.getElementById('panelTitle').textContent = 'üÜï Yeni POI Ekle';
            document.getElementById('newPoiBtn').classList.add('d-none');

            // Detaylar tab'ƒ±nƒ± gizle ve form tab'ƒ±nƒ± aktif yap
            document.getElementById('details-tab-container').style.display = 'none';
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();

            // Detay content'ini temizle
            document.getElementById('poiDetailContent').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>POI detaylarƒ± burada g√∂r√ºnecek</p>
                </div>
            `;

            // Mevcut g√∂rseller alanƒ±nƒ± temizle
            document.getElementById('currentImages').innerHTML = '';

            // Rating'leri sƒ±fƒ±rla
            setDefaultRatings();

            selectedPOI = null;
            showToast('Yeni POI ekleme moduna ge√ßildi', 'info');
        }

        // Form g√∂nder - Tamamen yeni yakla≈üƒ±m
        function handleFormSubmit(e) {
            e.preventDefault();
            e.stopPropagation();

            console.log('üöÄ Form submit ba≈üladƒ±');

            // √áift submit'i √∂nle
            const submitBtn = document.getElementById('saveBtn');
            if (submitBtn.disabled) {
                console.log('‚ö†Ô∏è Form zaten g√∂nderiliyor, √ßift submit √∂nlendi');
                return false;
            }

            submitBtn.disabled = true;
            showLoading();

            // Async i≈ülemi ayrƒ± fonksiyonda yap
            processFormSubmit();
            return false;
        }

        async function processFormSubmit() {

            try {
                const idVal = document.getElementById('poiId').value;
                const name = document.getElementById('poiName').value.trim();
                const category = document.getElementById('poiCategory').value;
                const lat = parseFloat(document.getElementById('poiLat').value);
                const lon = parseFloat(document.getElementById('poiLon').value);
                const description = document.getElementById('poiDesc').value;
                const tags = document.getElementById('poiTags').value.split(',').map(t => t.trim()).filter(Boolean);
                // Rating'leri al
                const ratings = getRatingValues();

                const poiData = {
                    name, category, latitude: lat, longitude: lon,
                    description, tags, ratings
                };

                let response;
                if (idVal) {
                    // G√ºncelle
                    response = await authenticatedFetch(`${apiBase}/poi/${idVal}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                } else {
                    // Ekle
                    response = await authenticatedFetch(`${apiBase}/poi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                }

                if (response.ok) {
                    const isUpdate = idVal ? true : false;
                    showToast(isUpdate ? 'POI ba≈üarƒ±yla g√ºncellendi!' : 'POI ba≈üarƒ±yla eklendi!', 'success');

                    if (isUpdate) {
                        // G√ºncelleme sonrasƒ± detaylarƒ± yenile
                        await showPOIDetail(idVal);
                        showToast('POI detaylarƒ± g√ºncellendi', 'info');
                    } else {
                        // Yeni POI eklendikten sonra formu temizle
                        clearForm();
                    }

                    await fetchPOIs(document.getElementById('filterCategory').value);
                } else {
                    throw new Error('ƒ∞≈ülem ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                showToast('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
            } finally {
                hideLoading();
                // Submit butonunu tekrar aktif et
                document.getElementById('saveBtn').disabled = false;
            }
        }

        // Form submit event'i artƒ±k gerekli deƒüil - buton onclick kullanƒ±yor

        // POI sil
        async function deletePOI(poiId) {
            const poiToDelete = allPOIs.find(p => p._id === poiId);
            const poiName = poiToDelete ? poiToDelete.name : "Unknown POI";
            if (!confirm(`Are you sure you want to delete "${poiName}"?\n\nThis will set the POI as inactive.`)) return;

            showLoading();
            try {
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('POI successfully deleted!', 'success');
                    await fetchPOIs(document.getElementById('filterCategory').value);
                } else {
                    throw new Error('Deletion failed');
                }
            } catch (error) {
                showToast('Error during deletion: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Arama ve filtreleme
        function filterAndSortPOIs() {
            const searchTerm = document.getElementById('searchPOI').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;

            let filteredPOIs = allPOIs.filter(poi => {
                const matchesSearch = poi.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || poi.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            // Sƒ±ralama
            filteredPOIs.sort((a, b) => {
                let aVal = a[currentSort.field];
                let bVal = b[currentSort.field];

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (currentSort.direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });

            updateMapMarkers(filteredPOIs);
            renderPOITable(filteredPOIs);
        }

        // Sƒ±ralama
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('sortable') || e.target.parentElement.classList.contains('sortable')) {
                const sortField = e.target.dataset.sort || e.target.parentElement.dataset.sort;

                if (currentSort.field === sortField) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = sortField;
                    currentSort.direction = 'asc';
                }

                // Sƒ±ralama iconlarƒ±nƒ± g√ºncelle
                document.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.textContent = '‚ÜïÔ∏è';
                });

                const currentIcon = document.querySelector(`[data-sort="${sortField}"] .sort-icon`);
                if (currentIcon) {
                    currentIcon.textContent = currentSort.direction === 'asc' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                }

                filterAndSortPOIs();
            }
        });

        // Form validation ve submit
        function validatePOIForm() {
            const name = document.getElementById('poiName').value.trim();
            const lat = parseFloat(document.getElementById('poiLat').value);
            const lng = parseFloat(document.getElementById('poiLon').value);
            const category = document.getElementById('poiCategory').value;

            if (!name) {
                showToast('POI adƒ± gerekli!', 'error');
                return false;
            }

            if (name.length < 2) {
                showToast('POI adƒ± en az 2 karakter olmalƒ±!', 'error');
                return false;
            }

            if (isNaN(lat) || lat < -90 || lat > 90) {
                showToast('Ge√ßerli bir enlem deƒüeri girin (-90 ile 90 arasƒ±nda)!', 'error');
                return false;
            }

            if (isNaN(lng) || lng < -180 || lng > 180) {
                showToast('Ge√ßerli bir boylam deƒüeri girin (-180 ile 180 arasƒ±nda)!', 'error');
                return false;
            }

            if (!category) {
                showToast('Kategori se√ßimi gerekli!', 'error');
                return false;
            }

            return true;
        }

        // Form submit handler
        document.getElementById('poiForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!validatePOIForm()) {
                return;
            }

            showLoading();
            try {
                const idVal = document.getElementById('poiId').value;
                const name = document.getElementById('poiName').value.trim();
                const latitude = parseFloat(document.getElementById('poiLat').value);
                const longitude = parseFloat(document.getElementById('poiLon').value);
                const category = document.getElementById('poiCategory').value;
                const description = document.getElementById('poiDesc').value.trim();
                const tags = document.getElementById('poiTags').value.trim();

                const poiData = {
                    name, category, latitude, longitude,
                    description, tags
                };

                let response;
                if (idVal) {
                    // G√ºncelle
                    response = await fetch(`${apiBase}/poi/${idVal}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                } else {
                    // Ekle
                    response = await fetch(`${apiBase}/poi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                }

                if (response.ok) {
                    const isUpdate = idVal ? true : false;
                    let finalPoiId = idVal;

                    // Yeni POI eklendiyse response'dan ID'yi al
                    if (!isUpdate) {
                        const responseData = await response.json();
                        finalPoiId = responseData.id;
                    }

                    // Rating'leri kaydet
                    const ratings = getRatingValues();
                    const ratingSaved = await savePOIRatings(finalPoiId, ratings);

                    showToast(isUpdate ? 'POI ba≈üarƒ±yla g√ºncellendi!' : 'POI ba≈üarƒ±yla eklendi!', 'success');

                    if (ratingSaved) {
                        showToast('Rating\'ler kaydedildi', 'success');
                    } else {
                        showToast('Rating kaydetme sƒ±rasƒ±nda sorun olu≈ütu', 'warning');
                    }

                    if (isUpdate) {
                        // G√ºncelleme sonrasƒ± detaylarƒ± yenile
                        await showPOIDetail(finalPoiId);
                        showToast('POI detaylarƒ± g√ºncellendi', 'info');
                    } else {
                        // Yeni POI eklendikten sonra formu temizle
                        clearForm();
                    }

                    await fetchPOIs(document.getElementById('filterCategory').value);
                } else {
                    throw new Error('ƒ∞≈ülem ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                showToast('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        // Event listeners
        document.getElementById('searchPOI').addEventListener('input', filterAndSortPOIs);
        document.getElementById('filterCategory').addEventListener('change', function () {
            fetchPOIs(this.value);
        });

        // G√∂rsel modal ve yardƒ±mcƒ± fonksiyonlar
        function showImageModal(imagePath, poiName, filename) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">üì∏ ${filename}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imagePath}" class="img-fluid rounded shadow" alt="${poiName}" style="max-height: 70vh;">
                            <div class="mt-2">
                                <small class="text-muted">${poiName}</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="${imagePath}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt"></i> Yeni Sekmede A√ß
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        function getImageTypeIcon(filename) {
            const name = filename.toLowerCase();
            if (name.includes('exterior') || name.includes('dis')) return 'üè¢';
            if (name.includes('interior') || name.includes('ic')) return 'üè†';
            if (name.includes('food') || name.includes('yemek')) return 'üçΩÔ∏è';
            if (name.includes('menu')) return 'üìã';
            if (name.includes('logo')) return 'üè∑Ô∏è';
            return 'üì∑';
        }

        // Medya y√∂netimi fonksiyonlarƒ±
        function updateMediaTypeOptions() {
            // Gelecekte medya t√ºr√ºne g√∂re ek se√ßenekler eklenebilir
        }

        function getMediaTypeIcon(mediaType, filename) {
            switch (mediaType) {
                case 'image': return 'üì∏';
                case 'video': return 'üé•';
                case 'audio': return 'üéµ';
                case 'model_3d': return 'üßä';
                default: return 'üìÑ';
            }
        }

        function getMediaMaxSize(mediaType) {
            const sizes = {
                'image': 15,
                'video': 100,
                'audio': 50,
                'model_3d': 50
            };
            return sizes[mediaType] || 15;
        }

        // Rating sistemi fonksiyonlarƒ±

        // POI se√ßiminde otomatik rating y√ºkleme (fallback)
        function autoLoadRatingsOnPOIChange(poiId) {
            if (!poiId) return;

            console.log('üîÑ autoLoadRatingsOnPOIChange √ßaƒürƒ±ldƒ±. POI ID:', poiId);

            // 1 saniye sonra kontrol et ve zorla doƒüru rating'leri y√ºkle
            setTimeout(() => {
                console.log('üîç Backup kontrol ba≈ülƒ±yor. POI ID:', poiId);

                fetch(`${apiBase}/poi/${poiId}/ratings`)
                    .then(r => r.json())
                    .then(data => {
                        console.log('üîç Backup API response:', data.ratings);

                        // Mevcut slider deƒüerlerini kontrol et
                        const currentDoga = document.getElementById('rating_doga')?.value || 0;
                        const expectedDoga = data.ratings?.doga || 0;

                        console.log(`üîç Doƒüa slider kontrol: mevcut=${currentDoga}, beklenen=${expectedDoga}`);

                        // ZORLA rating'leri g√ºncelle
                        console.log('‚ö° Rating deƒüerleri ZORLA g√ºncelleniyor...');
                        updateSlidersDirectly(data.ratings || {});
                    })
                    .catch(e => console.error('‚ùå Backup rating kontrol hatasƒ±:', e));

            }, 1000); // 1 saniyeye d√º≈ü√ºrd√ºm
        }

        // DEBUG: Manual test fonksiyonu (console'da √ßaƒüƒ±rƒ±labilir)
        window.testRatings = function (poiId = 63) {
            console.log('üß™ MANUAL TEST ba≈ülƒ±yor...');
            console.log('üß™ POI ID:', poiId);

            // 1. API test
            fetch(`${apiBase}/poi/${poiId}/ratings`)
                .then(r => {
                    console.log('üß™ API Response status:', r.status);
                    return r.json();
                })
                .then(data => {
                    console.log('üß™ API Data:', data);
                    console.log('üß™ Ratings:', data.ratings);

                    // 2. Slider test
                    console.log('üß™ Slider testleri:');
                    Object.keys(data.ratings || {}).forEach(category => {
                        const slider = document.getElementById(`rating_${category}`);
                        console.log(`üß™ ${category} slider:`, !!slider);
                        if (slider) {
                            console.log(`üß™ ${category} mevcut deƒüer:`, slider.value);
                        }
                    });

                    // 3. Manual set test
                    if (data.ratings && data.ratings.doga) {
                        console.log('üß™ Manuel doƒüa slider set test...');
                        const dogaSlider = document.getElementById('rating_doga');
                        if (dogaSlider) {
                            dogaSlider.value = data.ratings.doga;
                            updateRatingDisplay('doga', data.ratings.doga);
                            console.log('‚úÖ Doƒüa slider manual set edildi:', data.ratings.doga);
                        }
                    }
                })
                .catch(e => console.error('üß™ Test hatasƒ±:', e));
        };

        function updateRatingDisplay(category, value) {
            const displayElement = document.getElementById(`rating_${category}_display`);
            if (displayElement) {
                displayElement.textContent = value;

                // Badge rengini puana g√∂re ayarla
                displayElement.className = 'badge ' + getRatingBadgeClass(parseInt(value));
            }

            // Toplam puanƒ± g√ºncelle
            updateTotalRating();
        }

        function getRatingBadgeClass(value) {
            if (value >= 80) return 'bg-success';
            if (value >= 60) return 'bg-info';
            if (value >= 40) return 'bg-warning';
            if (value >= 20) return 'bg-secondary';
            return 'bg-light text-dark';
        }

        function updateTotalRating() {
            const categories = ['tarihi', 'sanat_kultur', 'doga', 'eglence', 'alisveris',
                'spor', 'macera', 'rahatlatici', 'yemek', 'gece_hayati'];

            let totalScore = 0;
            categories.forEach(category => {
                const slider = document.getElementById(`rating_${category}`);
                if (slider) {
                    totalScore += parseInt(slider.value);
                }
            });

            const totalScoreElement = document.getElementById('totalRatingScore');
            const totalProgressElement = document.getElementById('totalRatingProgress');

            if (totalScoreElement) {
                totalScoreElement.textContent = `${totalScore}/1000`;
            }

            if (totalProgressElement) {
                const percentage = (totalScore / 1000) * 100;
                totalProgressElement.style.width = `${percentage}%`;

                // Progress bar rengini puana g√∂re ayarla
                totalProgressElement.className = 'progress-bar ' + getProgressBarClass(percentage);
            }
        }

        function getProgressBarClass(percentage) {
            if (percentage >= 80) return 'bg-success';
            if (percentage >= 60) return 'bg-info';
            if (percentage >= 40) return 'bg-warning';
            if (percentage >= 20) return 'bg-secondary';
            return 'bg-danger';
        }

        // BASIT VE Dƒ∞REKT YAKLA≈ûIM
        function loadPOIRatings(poiId) {
            console.log('üöÄ BASIT loadPOIRatings ba≈üladƒ±, POI ID:', poiId);

            // √ñnce t√ºm slider'larƒ± sƒ±fƒ±rla
            clearAllRatings();

            if (!poiId) {
                console.log('‚ùå POI ID yok, rating\'ler temizlendi');
                return;
            }

            // API'den rating'leri al
            console.log('üì° API\'den rating\'ler alƒ±nƒ±yor...');
            fetch(`${apiBase}/poi/${poiId}/ratings`)
                .then(response => response.json())
                .then(data => {
                    console.log('üì¶ API Response:', data);
                    if (data && data.ratings) {
                        console.log('‚úÖ Rating\'ler bulundu:', data.ratings);
                        // Direkt slider'larƒ± g√ºncelle
                        updateSlidersDirectly(data.ratings);
                    } else {
                        console.log('‚ö†Ô∏è Rating data bo≈ü');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Rating API hatasƒ±:', error);
                });
        }

        // T√ºm rating'leri temizle
        function clearAllRatings() {
            console.log('üßπ T√ºm rating\'ler temizleniyor...');
            const categories = ['tarihi', 'sanat_kultur', 'doga', 'eglence', 'alisveris',
                'spor', 'macera', 'rahatlatici', 'yemek', 'gece_hayati'];

            categories.forEach(category => {
                const slider = document.getElementById(`rating_${category}`);
                const display = document.getElementById(`rating_${category}_display`);

                if (slider) {
                    slider.value = 0;
                    // ZORLA G√ñRSELƒ∞ G√úNCELLE
                    slider.dispatchEvent(new Event('input'));
                    slider.dispatchEvent(new Event('change'));
                    console.log(`üßπ ${category} slider = 0`);
                }
                if (display) {
                    display.textContent = '0';
                    display.className = 'badge bg-secondary';
                }
            });
        }

        // Slider'larƒ± direkt g√ºncelle
        function updateSlidersDirectly(ratings) {
            console.log('üéöÔ∏è Slider\'lar direkt g√ºncelleniyor:', ratings);

            Object.keys(ratings).forEach(category => {
                const value = parseInt(ratings[category]) || 0;
                const slider = document.getElementById(`rating_${category}`);
                const display = document.getElementById(`rating_${category}_display`);

                if (slider && display) {
                    slider.value = value;

                    // ZORLA G√ñRSELƒ∞ G√úNCELLE
                    slider.dispatchEvent(new Event('input'));
                    slider.dispatchEvent(new Event('change'));

                    display.textContent = value;

                    // Badge rengini g√ºncelle
                    if (value >= 80) display.className = 'badge bg-success';
                    else if (value >= 60) display.className = 'badge bg-info';
                    else if (value >= 40) display.className = 'badge bg-warning';
                    else if (value >= 20) display.className = 'badge bg-secondary';
                    else display.className = 'badge bg-danger';

                    console.log(`‚úÖ ${category}: ${value} (slider=${slider.value}, display=${display.textContent})`);
                } else {
                    console.warn(`‚ö†Ô∏è ${category} elementleri bulunamadƒ±: slider=${!!slider}, display=${!!display}`);
                }
            });

            updateTotalRating();
        }

        function setDefaultRatings() {
            console.log('üîÑ setDefaultRatings: T√ºm rating\'ler sƒ±fƒ±rlanƒ±yor');
            const categories = ['tarihi', 'sanat_kultur', 'doga', 'eglence', 'alisveris',
                'spor', 'macera', 'rahatlatici', 'yemek', 'gece_hayati'];

            categories.forEach(category => {
                const slider = document.getElementById(`rating_${category}`);
                if (slider) {
                    slider.value = 0;
                    updateRatingDisplay(category, 0);
                } else {
                    console.warn(`‚ö†Ô∏è ${category} slider'ƒ± bulunamadƒ±!`);
                }
            });
            updateTotalRating();
            console.log('‚úÖ Varsayƒ±lan rating\'ler y√ºklendi');
        }

        function setRatingValues(ratings) {
            console.log('üéõÔ∏è setRatingValues √ßaƒürƒ±ldƒ± (YENƒ∞ BASIT VERSƒ∞YON):', ratings);
            // Yeni basit fonksiyonu kullan
            updateSlidersDirectly(ratings || {});
        }

        // ACIL TEST FONKSIYONU - Tarayƒ±cƒ± konsolundan √ßaƒüƒ±r
        function testSliders() {
            console.log('üß™ ACIL TEST ba≈ülƒ±yor...');

            // 1. Slider'larƒ± bul
            const tarihi = document.getElementById('rating_tarihi');
            const doga = document.getElementById('rating_doga');
            const yemek = document.getElementById('rating_yemek');

            console.log('Slider durumu:');
            console.log('- Tarihi:', tarihi ? 'VAR' : 'YOK');
            console.log('- Doƒüa:', doga ? 'VAR' : 'YOK');
            console.log('- Yemek:', yemek ? 'VAR' : 'YOK');

            if (tarihi) {
                console.log('- Tarihi deƒüeri:', tarihi.value);
                tarihi.value = 90;
                // ZORLA G√ñRSELƒ∞ G√úNCELLE
                tarihi.dispatchEvent(new Event('input'));
                tarihi.dispatchEvent(new Event('change'));
                console.log('- Tarihi yeni deƒüer:', tarihi.value);
            }

            if (doga) {
                console.log('- Doƒüa deƒüeri:', doga.value);
                doga.value = 85;
                // ZORLA G√ñRSELƒ∞ G√úNCELLE
                doga.dispatchEvent(new Event('input'));
                doga.dispatchEvent(new Event('change'));
                console.log('- Doƒüa yeni deƒüer:', doga.value);
            }

            if (yemek) {
                yemek.value = 95;
                yemek.dispatchEvent(new Event('input'));
                yemek.dispatchEvent(new Event('change'));
            }

            // Display'leri g√ºncelle
            const tarihiDisplay = document.getElementById('rating_tarihi_display');
            const dogaDisplay = document.getElementById('rating_doga_display');
            const yemekDisplay = document.getElementById('rating_yemek_display');

            if (tarihiDisplay) {
                tarihiDisplay.textContent = '90';
                tarihiDisplay.className = 'badge bg-success';
            }
            if (dogaDisplay) {
                dogaDisplay.textContent = '85';
                dogaDisplay.className = 'badge bg-success';
            }
            if (yemekDisplay) {
                yemekDisplay.textContent = '95';
                yemekDisplay.className = 'badge bg-success';
            }

            console.log('‚úÖ Test tamamlandƒ± - Slider\'lar g√∂rsel olarak g√ºncellendi');
        }

        // Mevcut POI'nin rating'lerini y√ºkle
        function loadCurrentPOIRatings() {
            const poiId = document.getElementById('poiId').value;
            console.log('üîÑ Manuel rating y√ºkleme, POI ID:', poiId);
            if (poiId) {
                loadRatingsSimple(poiId);
            } else {
                console.log('‚ùå POI ID bulunamadƒ±');
                clearAllRatings();
            }
        }

        // S√úPER BASƒ∞T RATING Y√úKLEME
        function loadRatingsSimple(poiId) {
            console.log('üöÄ S√úPER BASƒ∞T rating y√ºkleme, POI:', poiId);

            if (!poiId) {
                clearAllRatings();
                return;
            }

            fetch(`${apiBase}/poi/${poiId}/ratings`)
                .then(r => r.json())
                .then(data => {
                    console.log('üì¶ Rating data:', data);

                    // √ñnce t√ºm slider'larƒ± temizle
                    clearAllRatings();

                    if (data.ratings) {
                        // Direkt slider'larƒ± g√ºncelle
                        for (let category in data.ratings) {
                            const value = parseInt(data.ratings[category]) || 0;
                            const slider = document.getElementById(`rating_${category}`);
                            const display = document.getElementById(`rating_${category}_display`);

                            if (slider && value > 0) {
                                slider.value = value;
                                // ZORLA G√ñRSELƒ∞ G√úNCELLE
                                slider.dispatchEvent(new Event('input'));
                                slider.dispatchEvent(new Event('change'));
                                console.log(`‚úÖ ${category} = ${value}`);
                            }
                            if (display && value > 0) {
                                display.textContent = value;
                                // Badge rengini g√ºncelle
                                if (value >= 80) display.className = 'badge bg-success';
                                else if (value >= 60) display.className = 'badge bg-info';
                                else if (value >= 40) display.className = 'badge bg-warning';
                                else if (value >= 20) display.className = 'badge bg-secondary';
                                else display.className = 'badge bg-danger';
                            }
                        }
                        console.log('‚úÖ Rating\'ler ba≈üarƒ±yla y√ºklendi ve g√∂rsel olarak g√ºncellendi');
                    } else {
                        console.log('‚ö†Ô∏è Rating data bo≈ü');
                    }
                })
                .catch(e => {
                    console.error('‚ùå Rating hatasƒ±:', e);
                    clearAllRatings();
                });
        }

        function getRatingValues() {
            console.log('üìä getRatingValues √ßaƒürƒ±ldƒ±');
            const categories = ['tarihi', 'sanat_kultur', 'doga', 'eglence', 'alisveris',
                'spor', 'macera', 'rahatlatici', 'yemek', 'gece_hayati'];

            const ratings = {};
            categories.forEach(category => {
                const slider = document.getElementById(`rating_${category}`);
                if (slider) {
                    const value = parseInt(slider.value);
                    ratings[category] = value;
                    console.log(`üìä ${category}: ${value}`);
                } else {
                    console.warn(`‚ö†Ô∏è ${category} slider'ƒ± bulunamadƒ±!`);
                }
            });

            console.log('üìä Toplanan rating deƒüerleri:', ratings);
            return ratings;
        }

        async function savePOIRatings(poiId, ratings) {
            if (!poiId || !ratings) {
                console.error('‚ùå savePOIRatings: POI ID veya ratings eksik', { poiId, ratings });
                return false;
            }

            console.log('üíæ Rating kaydetme ba≈ülƒ±yor...', { poiId, ratings });

            try {
                const requestData = { ratings: ratings };
                console.log('üì§ API\'ye g√∂nderilen data:', requestData);

                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/ratings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('üì° API response status:', response.status);

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('‚úÖ Rating\'ler ba≈üarƒ±yla kaydedildi:', responseData);
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Rating kaydetme hatasƒ± - Status:', response.status, 'Error:', errorText);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Rating kaydetme exception:', error);
                return false;
            }
        }

        async function uploadPOIMedia() {
            const fileInput = document.getElementById('mediaFile');
            const mediaTypeSelect = document.getElementById('mediaType');
            const mediaCaption = document.getElementById('mediaCaption').value;
            const isPrimary = document.getElementById('isPrimaryMedia').checked;

            // POI ID'sini al (d√ºzenleme modundaysa)
            const poiId = document.getElementById('poiId').value;
            if (!poiId) {
                alert('√ñnce POI\'yi kaydedin, sonra medya ekleyin.');
                return;
            }

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('L√ºtfen bir medya dosyasƒ± se√ßin.');
                return;
            }

            const file = fileInput.files[0];
            const filename = file.name.toLowerCase();

            // Medya t√ºr√ºn√º tespit et
            let mediaType = mediaTypeSelect.value;
            if (mediaType === 'auto') {
                if (filename.match(/\.(jpg|jpeg|png|gif|webp|bmp|tiff)$/)) {
                    mediaType = 'image';
                } else if (filename.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|m4v)$/)) {
                    mediaType = 'video';
                } else if (filename.match(/\.(mp3|wav|ogg|m4a|aac|flac)$/)) {
                    mediaType = 'audio';
                } else if (filename.match(/\.(glb|gltf|obj|fbx|dae|ply|stl)$/)) {
                    mediaType = 'model_3d';
                } else {
                    alert('Dosya t√ºr√º tespit edilemedi. L√ºtfen medya t√ºr√ºn√º manuel olarak se√ßin.');
                    return;
                }
            }

            // Dosya boyutu kontrol√º
            const maxSize = getMediaMaxSize(mediaType) * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`Dosya boyutu ${getMediaMaxSize(mediaType)}MB'dan k√º√ß√ºk olmalƒ±dƒ±r.\n\nSe√ßilen dosya: ${(file.size / 1024 / 1024).toFixed(1)}MB`);
                return;
            }

            const formData = new FormData();
            formData.append('media', file);
            formData.append('caption', mediaCaption);
            formData.append('is_primary', isPrimary);

            try {
                showLoading();
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/media`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Medya y√ºkleme ba≈üarƒ±sƒ±z');
                }

                const result = await response.json();

                if (result.media && result.media.compression_ratio && result.media.compression_ratio !== "0%") {
                    showToast(`${getMediaTypeIcon(mediaType)} ${mediaType.toUpperCase()} ba≈üarƒ±yla y√ºklendi!\nüì¶ Boyut azalmasƒ±: ${result.media.compression_ratio}`, 'success');
                } else {
                    showToast(`${getMediaTypeIcon(mediaType)} ${mediaType.toUpperCase()} ba≈üarƒ±yla y√ºklendi!`, 'success');
                }

                // Form alanlarƒ±nƒ± temizle
                fileInput.value = '';
                document.getElementById('mediaCaption').value = '';
                document.getElementById('isPrimaryMedia').checked = false;
                mediaTypeSelect.value = 'auto';

                // Mevcut medya dosyalarƒ±nƒ± yenile
                await loadPOIMedia(poiId);

            } catch (error) {
                console.error('Medya y√ºkleme hatasƒ±:', error);
                alert('Medya y√ºkleme hatasƒ±: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Geriye uyumluluk i√ßin eski g√∂rsel y√ºkleme fonksiyonu
        async function uploadPOIImage() {
            // Yeni medya fonksiyonunu kullan
            document.getElementById('mediaType').value = 'image';
            await uploadPOIMedia();
        }

        async function loadPOIMedia(poiId) {
            if (!poiId) return;

            try {
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/media`);
                if (!response.ok) return;

                const data = await response.json();
                const mediaFiles = data.media || [];

                const container = document.getElementById('currentMedia');
                if (mediaFiles.length === 0) {
                    container.innerHTML = '<small class="text-muted">Hen√ºz medya dosyasƒ± eklenmemi≈ü.</small>';
                    return;
                }

                // Medya t√ºrlerine g√∂re grupla
                const groupedMedia = {};
                mediaFiles.forEach(media => {
                    const type = media.media_type || 'unknown';
                    if (!groupedMedia[type]) groupedMedia[type] = [];
                    groupedMedia[type].push(media);
                });

                let mediaHtml = '';

                // Her medya t√ºr√º i√ßin ayrƒ± b√∂l√ºm olu≈ütur
                Object.keys(groupedMedia).forEach(mediaType => {
                    const typeIcon = getMediaTypeIcon(mediaType);
                    const typeLabel = {
                        'image': 'G√∂rseller',
                        'video': 'Videolar',
                        'audio': 'Ses Dosyalarƒ±',
                        'model_3d': '3D Modeller',
                        'unknown': 'Diƒüer'
                    }[mediaType] || mediaType.toUpperCase();

                    mediaHtml += `
                        <div class="mb-3">
                            <h6 class="fw-bold text-primary">${typeIcon} ${typeLabel} (${groupedMedia[mediaType].length})</h6>
                            <div class="row g-2">`;

                    groupedMedia[mediaType].forEach((media, index) => {
                        const previewPath = media.preview_path || media.thumbnail_path || media.path;
                        const isImage = mediaType === 'image';

                        mediaHtml += `
                             <div class="col-6">
                                 <div class="card">
                                     <div class="position-relative">
                                         ${isImage ?
                                `<img src="/${previewPath}" class="card-img-top" style="height: 80px; object-fit: cover;" 
                                                  alt="${media.filename}" onclick="showMediaModal('/${media.path}', '${media.filename}', '${mediaType}')">` :
                                `<div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 80px;" 
                                                  onclick="showMediaModal('/${media.path}', '${media.filename}', '${mediaType}')">
                                                  ${getMediaTypeIcon(mediaType)} <span class="ms-2 small">${media.format?.toUpperCase() || ''}</span>
                                              </div>`
                            }
                                         <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                 style="width: 25px; height: 25px; padding: 0; font-size: 0.7rem;" 
                                                 onclick="deleteMediaFile('${poiId}', '${media.filename}')" 
                                                 title="Sil">
                                             √ó
                                         </button>
                                     </div>
                                     <div class="card-body p-2">
                                         <small class="text-muted d-block">${media.filename}</small>
                                         <small class="text-muted">${(media.size / 1024).toFixed(0)}KB</small>
                                     </div>
                                 </div>
                             </div>`;
                    });

                    mediaHtml += `
                             </div>
                         </div>`;
                });

                container.innerHTML = mediaHtml;

            } catch (error) {
                console.error('Medya y√ºkleme hatasƒ±:', error);
            }
        }

        // Geriye uyumluluk i√ßin eski g√∂rsel y√ºkleme fonksiyonu
        async function loadPOIImages(poiId) {
            // Yeni medya fonksiyonunu kullan
            await loadPOIMedia(poiId);

            // Eski format i√ßin de g√∂rselleri currentImages container'ƒ±na y√ºkle
            try {
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/images`);
                if (!response.ok) return;

                const data = await response.json();
                const images = data.images || [];

                const container = document.getElementById('currentImages');
                if (images.length === 0) {
                    container.innerHTML = '<small class="text-muted">Hen√ºz g√∂rsel eklenmemi≈ü.</small>';
                    return;
                }

                let imagesHtml = '<div class="row g-2">';
                images.forEach((image, index) => {
                    const imagePath = image.thumbnail_path || image.path;
                    imagesHtml += `
                        <div class="col-6">
                            <div class="card">
                                <img src="/${imagePath}" class="card-img-top" style="height: 80px; object-fit: cover;" 
                                     alt="${image.filename}">
                                <div class="card-body p-2">
                                    <small class="text-muted d-block">${image.filename}</small>
                                    <small class="text-muted">${(image.size / 1024).toFixed(0)}KB</small>
                                    <button class="btn btn-danger btn-sm mt-1" onclick="deleteMediaFile('${poiId}', '${image.filename}')">
                                        üóëÔ∏è Sil
                                    </button>
                                </div>
                            </div>
                        </div>`;
                });
                imagesHtml += '</div>';
                container.innerHTML = imagesHtml;

            } catch (error) {
                console.error('G√∂rsel y√ºkleme hatasƒ±:', error);
            }
        }

        // Medya modal g√∂sterimi
        function showMediaModal(mediaPath, filename, mediaType) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';

            let modalContent = '';
            if (mediaType === 'image') {
                modalContent = `<img src="${mediaPath}" class="img-fluid rounded-3 shadow-lg" alt="${filename}" style="max-height: 70vh;">`;
            } else if (mediaType === 'video') {
                modalContent = `
                    <video controls class="w-100 rounded-3 shadow-lg" style="max-height: 70vh;">
                        <source src="${mediaPath}" type="video/mp4">
                        Tarayƒ±cƒ±nƒ±z video oynatmayƒ± desteklemiyor.
                    </video>`;
            } else if (mediaType === 'audio') {
                modalContent = `
                    <div class="text-center p-4">
                        <i class="fas fa-music fa-3x text-primary mb-3"></i>
                        <h5>${filename}</h5>
                        <audio controls class="w-100 mt-3">
                            <source src="${mediaPath}">
                            Tarayƒ±cƒ±nƒ±z ses oynatmayƒ± desteklemiyor.
                        </audio>
                    </div>`;
            } else if (mediaType === 'model_3d') {
                modalContent = `
                    <div class="text-center p-4">
                        <i class="fas fa-cube fa-3x text-primary mb-3"></i>
                        <h5>${filename}</h5>
                        <p class="text-muted">3D model dosyasƒ± - indirip uygun bir uygulamada g√∂r√ºnt√ºleyebilirsiniz.</p>
                    </div>`;
            } else {
                modalContent = `
                    <div class="text-center p-4">
                        <i class="fas fa-file fa-3x text-primary mb-3"></i>
                        <h5>${filename}</h5>
                        <p class="text-muted">Medya dosyasƒ±</p>
                    </div>`;
            }

            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold"><i class="fas fa-file me-2"></i>${filename}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center p-4">
                            ${modalContent}
                        </div>
                        <div class="modal-footer justify-content-center">
                            <a href="${mediaPath}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt me-1"></i> Yeni Sekmede A√ß/ƒ∞ndir
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i> Kapat
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        // Medya dosyasƒ± silme
        async function deleteMediaFile(poiId, filename) {
            if (!confirm(`'${filename}' dosyasƒ±nƒ± silmek istediƒüinizden emin misiniz?`)) {
                return;
            }

            try {
                showLoading();
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/media/${filename}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Dosya silinemedi');
                }

                showToast('Medya dosyasƒ± ba≈üarƒ±yla silindi', 'success');

                // Medya listesini yenile
                await loadPOIMedia(poiId);

            } catch (error) {
                console.error('Medya silme hatasƒ±:', error);
                alert('Medya silme hatasƒ±: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Session timeout monitoring for POI manager
        let sessionTimeoutWarning = null;
        let sessionWarningShown = false;

        function startSessionTimeoutMonitoring() {
            // Check session status every 30 seconds for better responsiveness
            setInterval(async () => {
                try {
                    const response = await fetch('/auth/status');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.authenticated && data.session_info) {
                            updateSessionStatus(data.session_info);
                            checkSessionTimeoutWarning(data.session_info);
                        } else {
                            window.location.href = '/auth/login';
                        }
                    } else {
                        window.location.href = '/auth/login';
                    }
                } catch (error) {
                    console.error('Session check failed:', error);
                }
            }, 30 * 1000); // 30 seconds
        }

        function checkSessionTimeoutWarning(sessionInfo) {
            if (!sessionInfo.expires_at) return;

            const expiresAt = new Date(sessionInfo.expires_at);
            const now = new Date();
            const timeLeft = expiresAt - now;

            // Show warning if less than 10 minutes left
            if (timeLeft < 10 * 60 * 1000 && timeLeft > 0) {
                showSessionTimeoutWarning(timeLeft);
            } else if (timeLeft <= 0) {
                handleSessionExpired();
            } else {
                clearSessionTimeoutWarning();
            }
        }

        function showSessionTimeoutWarning(timeLeft) {
            if (sessionWarningShown) {
                updateSessionTimeoutWarning(timeLeft);
                return;
            }

            const minutes = Math.ceil(timeLeft / (60 * 1000));
            const warningId = 'poi-session-timeout-warning';

            const warningHtml = `
                <div class="alert alert-warning alert-dismissible fade show position-fixed" 
                     id="${warningId}" 
                     style="top: 80px; right: 20px; z-index: 9999; min-width: 350px;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2"></i>
                        <div class="flex-grow-1">
                            <strong>Oturum Uyarƒ±sƒ±</strong><br>
                            <span class="session-time-left">Oturumunuz ${minutes} dakika i√ßinde sona erecek.</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-warning me-2" onclick="extendSession()">
                            <i class="fas fa-refresh me-1"></i>Oturumu Uzat
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="dismissSessionTimeoutWarning()">
                            Kapat
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', warningHtml);
            sessionWarningShown = true;
            sessionTimeoutWarning = document.getElementById(warningId);
        }

        function updateSessionTimeoutWarning(timeLeft) {
            if (!sessionTimeoutWarning) return;

            const minutes = Math.ceil(timeLeft / (60 * 1000));
            const timeLeftElement = sessionTimeoutWarning.querySelector('.session-time-left');

            if (timeLeftElement) {
                if (minutes <= 1) {
                    const seconds = Math.max(0, Math.ceil(timeLeft / 1000));
                    timeLeftElement.innerHTML = `Oturumunuz <strong class="text-danger">${seconds} saniye</strong> i√ßinde sona erecek.`;
                    sessionTimeoutWarning.classList.remove('alert-warning');
                    sessionTimeoutWarning.classList.add('alert-danger');
                } else {
                    timeLeftElement.textContent = `Oturumunuz ${minutes} dakika i√ßinde sona erecek.`;
                }
            }
        }

        async function extendSession() {
            try {
                // Make a simple authenticated request to extend session
                const response = await fetch('/auth/status', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    dismissSessionTimeoutWarning();
                    showToast('Oturum ba≈üarƒ±yla uzatƒ±ldƒ±.', 'success');
                } else {
                    showToast('Oturum uzatƒ±lamadƒ±. L√ºtfen yeniden giri≈ü yapƒ±n.', 'error');
                    handleSessionExpired();
                }
            } catch (error) {
                console.error('Session extend failed:', error);
                showToast('Oturum uzatƒ±lƒ±rken hata olu≈ütu.', 'error');
            }
        }

        function dismissSessionTimeoutWarning() {
            clearSessionTimeoutWarning();
        }

        function clearSessionTimeoutWarning() {
            if (sessionTimeoutWarning) {
                sessionTimeoutWarning.remove();
                sessionTimeoutWarning = null;
            }
            sessionWarningShown = false;
        }

        function handleSessionExpired() {
            clearSessionTimeoutWarning();
            showToast('Oturum s√ºresi doldu. Yeniden giri≈ü yapƒ±lƒ±yor...', 'warning');
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 2000);
        }

        // Password Change Functionality
        function showPasswordChangeModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'passwordChangeModal';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title fw-bold">
                                <i class="fas fa-key me-2"></i>≈ûifre Deƒüi≈ütir
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="passwordChangeForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">
                                        <i class="fas fa-lock me-1"></i>Mevcut ≈ûifre
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="currentPassword" 
                                               name="current_password" required>
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="togglePasswordVisibility('currentPassword', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">
                                        <i class="fas fa-key me-1"></i>Yeni ≈ûifre
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="newPassword" 
                                               name="new_password" required>
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="togglePasswordVisibility('newPassword', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            ≈ûifre en az 8 karakter olmalƒ± ve b√ºy√ºk harf, k√º√ß√ºk harf, rakam ve √∂zel karakter i√ßermelidir.
                                        </small>
                                    </div>
                                    <div id="passwordStrength" class="mt-2"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">
                                        <i class="fas fa-check me-1"></i>Yeni ≈ûifre Tekrar
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="confirmPassword" 
                                               name="confirm_password" required>
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="togglePasswordVisibility('confirmPassword', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div id="passwordMatch" class="mt-1"></div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>√ñnemli:</strong> ≈ûifre deƒüi≈ütirildikten sonra t√ºm aktif oturumlar sonlandƒ±rƒ±lacak 
                                    ve yeniden giri≈ü yapmanƒ±z gerekecek.
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>ƒ∞ptal
                            </button>
                            <button type="button" class="btn btn-warning" onclick="changePassword()" id="changePasswordSubmitBtn">
                                <i class="fas fa-key me-1"></i>≈ûifreyi Deƒüi≈ütir
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            // Add event listeners for password validation
            const newPasswordInput = modal.querySelector('#newPassword');
            const confirmPasswordInput = modal.querySelector('#confirmPassword');

            newPasswordInput.addEventListener('input', function () {
                validatePasswordStrength(this.value);
                checkPasswordMatch();
            });

            confirmPasswordInput.addEventListener('input', checkPasswordMatch);

            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function validatePasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            if (!strengthDiv) return;

            let score = 0;
            let feedback = [];

            // Length check
            if (password.length >= 8) {
                score += 1;
            } else {
                feedback.push('En az 8 karakter');
            }

            // Uppercase check
            if (/[A-Z]/.test(password)) {
                score += 1;
            } else {
                feedback.push('B√ºy√ºk harf');
            }

            // Lowercase check
            if (/[a-z]/.test(password)) {
                score += 1;
            } else {
                feedback.push('K√º√ß√ºk harf');
            }

            // Number check
            if (/\d/.test(password)) {
                score += 1;
            } else {
                feedback.push('Rakam');
            }

            // Special character check
            if (/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) {
                score += 1;
            } else {
                feedback.push('√ñzel karakter');
            }

            let strengthText = '';
            let strengthClass = '';

            if (score === 5) {
                strengthText = '<i class="fas fa-check-circle text-success me-1"></i>G√º√ßl√º ≈üifre';
                strengthClass = 'text-success';
            } else if (score >= 3) {
                strengthText = '<i class="fas fa-exclamation-circle text-warning me-1"></i>Orta g√º√ßl√ºkte';
                strengthClass = 'text-warning';
            } else {
                strengthText = '<i class="fas fa-times-circle text-danger me-1"></i>Zayƒ±f ≈üifre';
                strengthClass = 'text-danger';
            }

            if (feedback.length > 0) {
                strengthText += ` (Eksik: ${feedback.join(', ')})`;
            }

            strengthDiv.innerHTML = `<small class="${strengthClass}">${strengthText}</small>`;
        }

        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword')?.value;
            const confirmPassword = document.getElementById('confirmPassword')?.value;
            const matchDiv = document.getElementById('passwordMatch');

            if (!matchDiv || !confirmPassword) return;

            if (newPassword === confirmPassword) {
                matchDiv.innerHTML = '<small class="text-success"><i class="fas fa-check me-1"></i>≈ûifreler e≈üle≈üiyor</small>';
            } else {
                matchDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times me-1"></i>≈ûifreler e≈üle≈ümiyor</small>';
            }
        }

        async function changePassword() {
            const form = document.getElementById('passwordChangeForm');
            const submitBtn = document.getElementById('changePasswordSubmitBtn');

            if (!form) return;

            const formData = new FormData(form);
            const currentPassword = formData.get('current_password');
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');

            // Basic validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('L√ºtfen t√ºm alanlarƒ± doldurun', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('Yeni ≈üifre ve tekrarƒ± e≈üle≈ümiyor', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showToast('Yeni ≈üifre en az 8 karakter olmalƒ±dƒ±r', 'error');
                return;
            }

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deƒüi≈ütiriliyor...';

            try {
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword,
                        csrf_token: csrfToken
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('≈ûifre ba≈üarƒ±yla deƒüi≈ütirildi. Yeniden giri≈ü yapƒ±lƒ±yor...', 'success');

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('passwordChangeModal'));
                    if (modal) modal.hide();

                    // Redirect to login after a short delay
                    setTimeout(() => {
                        window.location.href = '/auth/login';
                    }, 2000);

                } else {
                    showToast(data.error || '≈ûifre deƒüi≈ütirilemedi', 'error');
                }

            } catch (error) {
                console.error('Password change error:', error);
                showToast('≈ûifre deƒüi≈ütirirken hata olu≈ütu', 'error');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-key me-1"></i>≈ûifreyi Deƒüi≈ütir';
            }
        }

        // Kategori Y√∂netimi Fonksiyonlarƒ±
        async function loadCategoriesManagement() {
            try {
                console.log('üìã Kategori y√∂netimi y√ºkleniyor...');
                const response = await authenticatedFetch(`${apiBase}/categories`);

                if (!response.ok) {
                    throw new Error('Kategoriler y√ºklenemedi');
                }

                const categories = await response.json();
                console.log('‚úÖ Kategoriler y√ºklendi:', categories);

                renderCategoriesManagement(categories);

            } catch (error) {
                console.error('‚ùå Kategori y√∂netimi y√ºkleme hatasƒ±:', error);
                document.getElementById('categoriesList').innerHTML = `
                    <div class="text-center text-danger py-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p class="mb-0">Kategoriler y√ºklenirken hata olu≈ütu</p>
                    </div>
                `;
            }
        }

        async function renderCategoriesManagement(categories) {
            const container = document.getElementById('categoriesList');

            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-tags"></i>
                        <p class="mb-0">Hen√ºz kategori yok</p>
                    </div>
                `;
                return;
            }

            // Her kategori i√ßin POI sayƒ±sƒ±nƒ± al
            let categoriesWithCounts = [];
            for (const category of categories) {
                try {
                    const response = await authenticatedFetch(`${apiBase}/pois?category=${category.name}`);
                    if (response.ok) {
                        const pois = await response.json();
                        categoriesWithCounts.push({
                            ...category,
                            poiCount: Array.isArray(pois) ? pois.length : 0
                        });
                    } else {
                        categoriesWithCounts.push({ ...category, poiCount: 0 });
                    }
                } catch (error) {
                    categoriesWithCounts.push({ ...category, poiCount: 0 });
                }
            }

            let html = '';
            categoriesWithCounts.forEach(category => {
                const canDelete = category.poiCount === 0;
                html += `
                    <div class="category-item border rounded p-3 mb-3 bg-light" data-category="${category.name}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-start flex-grow-1">
                                <div class="category-color-box me-3 mt-1" 
                                     style="width: 24px; height: 24px; background-color: ${category.color}; border-radius: 4px; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="fas fa-${category.icon} me-2 text-muted"></i>
                                        <strong class="text-dark">${category.display_name}</strong>
                                        <span class="badge bg-secondary ms-2">${category.poiCount} POI</span>
                                    </div>
                                    <div class="text-muted small mb-1">
                                        <code>${category.name}</code>
                                    </div>
                                    ${category.description ? `<div class="text-muted small">${category.description}</div>` : ''}
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm ms-2">
                                <button class="btn btn-outline-primary" onclick="editCategory('${category.name}')" 
                                        title="Kategoriyi D√ºzenle">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger ${!canDelete ? 'disabled' : ''}" 
                                        onclick="deleteCategory('${category.name}')" 
                                        title="${canDelete ? 'Kategoriyi Sil' : 'Bu kategoriyi kullanan POI\'ler var, silinemez'}"
                                        ${!canDelete ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function addCategory(categoryData) {
            try {
                showLoading();
                console.log('üì§ Yeni kategori ekleniyor:', categoryData);

                const response = await authenticatedFetch(`${apiBase}/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categoryData)
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('Kategori ba≈üarƒ±yla eklendi!', 'success');
                    document.getElementById('categoryForm').reset();
                    await loadCategoriesManagement();
                    await loadCategories(); // Dropdown'larƒ± g√ºncelle
                } else {
                    throw new Error(result.error || 'Kategori eklenemedi');
                }

            } catch (error) {
                console.error('‚ùå Kategori ekleme hatasƒ±:', error);
                showToast(`Kategori ekleme hatasƒ±: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteCategory(categoryName) {
            if (!confirm(`"${categoryName}" kategorisini silmek istediƒüinizden emin misiniz?\n\nBu kategoriyi kullanan POI'ler varsa silme i≈ülemi ba≈üarƒ±sƒ±z olacaktƒ±r.`)) {
                return;
            }

            try {
                showLoading();
                console.log('üóëÔ∏è Kategori siliniyor:', categoryName);

                const response = await authenticatedFetch(`${apiBase}/categories?name=${encodeURIComponent(categoryName)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('Kategori ba≈üarƒ±yla silindi!', 'success');
                    await loadCategoriesManagement();
                    await loadCategories(); // Dropdown'larƒ± g√ºncelle
                    await fetchPOIs(); // POI listesini g√ºncelle
                } else {
                    throw new Error(result.error || 'Kategori silinemedi');
                }

            } catch (error) {
                console.error('‚ùå Kategori silme hatasƒ±:', error);
                showToast(`Kategori silme hatasƒ±: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function editCategory(categoryName) {
            try {
                console.log('‚úèÔ∏è Kategori d√ºzenleme a√ßƒ±lƒ±yor:', categoryName);

                // Kategori bilgilerini al
                const response = await authenticatedFetch(`${apiBase}/categories`);
                if (!response.ok) {
                    throw new Error('Kategoriler y√ºklenemedi');
                }

                const categories = await response.json();
                const category = categories.find(cat => cat.name === categoryName);

                if (!category) {
                    throw new Error('Kategori bulunamadƒ±');
                }

                // Modal form alanlarƒ±nƒ± doldur
                document.getElementById('editCategoryOriginalName').value = category.name;
                document.getElementById('editCategoryName').value = category.name;
                document.getElementById('editCategoryDisplayName').value = category.display_name;
                document.getElementById('editCategoryColor').value = category.color;
                document.getElementById('editCategoryIcon').value = category.icon;
                document.getElementById('editCategoryDescription').value = category.description || '';

                // Modal'ƒ± a√ß
                const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
                modal.show();

            } catch (error) {
                console.error('‚ùå Kategori d√ºzenleme hatasƒ±:', error);
                showToast(`Kategori d√ºzenleme hatasƒ±: ${error.message}`, 'error');
            }
        }

        async function updateCategory() {
            try {
                showLoading();

                const originalName = document.getElementById('editCategoryOriginalName').value;
                const categoryData = {
                    name: originalName, // Kategori adƒ± deƒüi≈ümez
                    display_name: document.getElementById('editCategoryDisplayName').value.trim(),
                    color: document.getElementById('editCategoryColor').value,
                    icon: document.getElementById('editCategoryIcon').value.trim(),
                    description: document.getElementById('editCategoryDescription').value.trim()
                };

                // Validasyon (name hari√ß)
                const validationData = { ...categoryData, name: 'valid_name' }; // Ge√ßici ge√ßerli name
                const errors = validateCategoryForm(validationData);
                if (errors.length > 0) {
                    showToast(errors.join('<br>'), 'error');
                    return;
                }

                console.log('üì§ Kategori g√ºncelleniyor:', categoryData);

                const response = await authenticatedFetch(`${apiBase}/categories`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categoryData)
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('Kategori ba≈üarƒ±yla g√ºncellendi!', 'success');

                    // Modal'ƒ± kapat
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
                    modal.hide();

                    // Listeleri g√ºncelle
                    await loadCategoriesManagement();
                    await loadCategories(); // Dropdown'larƒ± g√ºncelle

                    // Harita marker'larƒ±nƒ± g√ºncelle (yeni renklerle)
                    if (allPOIs && allPOIs.length > 0) {
                        updateMapMarkers(allPOIs);
                    }

                } else {
                    throw new Error(result.error || 'Kategori g√ºncellenemedi');
                }

            } catch (error) {
                console.error('‚ùå Kategori g√ºncelleme hatasƒ±:', error);
                showToast(`Kategori g√ºncelleme hatasƒ±: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Form validasyon fonksiyonlarƒ±
        function validateCategoryForm(formData) {
            const errors = [];

            if (!formData.name || !formData.name.match(/^[a-z_]+$/)) {
                errors.push('Kategori adƒ± sadece k√º√ß√ºk harf ve alt √ßizgi i√ßerebilir');
            }

            if (!formData.display_name || formData.display_name.length < 2) {
                errors.push('G√∂r√ºnen ad en az 2 karakter olmalƒ±dƒ±r');
            }

            if (!formData.color || !formData.color.match(/^#[0-9A-Fa-f]{6}$/)) {
                errors.push('Ge√ßerli bir renk kodu se√ßin');
            }

            if (!formData.icon || formData.icon.length < 2) {
                errors.push('Ge√ßerli bir ikon adƒ± girin');
            }

            return errors;
        }

        // Kategori formu submit event'i
        document.addEventListener('DOMContentLoaded', function () {
            const categoryForm = document.getElementById('categoryForm');
            if (categoryForm) {
                categoryForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const categoryData = {
                        name: document.getElementById('categoryName').value.trim(),
                        display_name: document.getElementById('categoryDisplayName').value.trim(),
                        color: document.getElementById('categoryColor').value,
                        icon: document.getElementById('categoryIcon').value.trim(),
                        description: document.getElementById('categoryDescription').value.trim()
                    };

                    // Validasyon
                    const errors = validateCategoryForm(categoryData);
                    if (errors.length > 0) {
                        showToast(errors.join('<br>'), 'error');
                        return;
                    }

                    await addCategory(categoryData);
                });
            }

            // D√ºzenleme modal form validasyonu
            const editCategoryForm = document.getElementById('editCategoryForm');
            if (editCategoryForm) {
                editCategoryForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateCategory();
                });
            }
        });

        // Kategori sekmesi a√ßƒ±ldƒ±ƒüƒ±nda kategorileri y√ºkle
        document.addEventListener('DOMContentLoaded', function () {
            const categoriesTab = document.getElementById('categories-tab');
            if (categoriesTab) {
                categoriesTab.addEventListener('shown.bs.tab', function () {
                    loadCategoriesManagement();
                });
            }
        });

        // ===== ROTA Y√ñNETƒ∞Mƒ∞ FONKSƒ∞YONLARI =====

        let allRoutes = [];
        let selectedRoute = null;
        let availablePOIs = [];
        let selectedRoutePOIs = [];
        let routePreviewMap = null;

        // Rota y√∂netimi sekmesi a√ßƒ±ldƒ±ƒüƒ±nda rotalarƒ± y√ºkle
        document.addEventListener('DOMContentLoaded', function () {
            const routeTab = document.getElementById('route-management-tab');
            console.log('üîç Route tab element:', routeTab);
            if (routeTab) {
                routeTab.addEventListener('shown.bs.tab', function () {
                    console.log('üõ£Ô∏è Route management tab activated');

                    // Tab pane'in show class'ƒ±na sahip olduƒüundan emin ol
                    const tabPane = document.getElementById('route-management');
                    if (!tabPane.classList.contains('show')) {
                        console.log('üîß Force adding show class');
                        tabPane.classList.add('show');
                    }

                    loadRoutes();
                    loadPOIsForRoutes();

                    // Harita container'ƒ± g√∂r√ºn√ºr olduktan sonra haritayƒ± ba≈ülat
                    setTimeout(() => {
                        const mapContainer = document.getElementById('routePreviewMap');
                        if (mapContainer && mapContainer.offsetWidth > 0) {
                            console.log('üó∫Ô∏è Initializing route preview map after tab activation');
                            initRoutePreviewMap();
                        }
                    }, 200);
                });

                // Tab'a tƒ±klandƒ±ƒüƒ±nda da √ßalƒ±≈ütƒ±r
                routeTab.addEventListener('click', function (e) {
                    console.log('üñ±Ô∏è Route tab clicked');
                    e.preventDefault();

                    // T√ºm tab'larƒ± deaktif et
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active', 'show');
                    });

                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                    });

                    // Route management tab'ƒ±nƒ± aktif et
                    const tabPane = document.getElementById('route-management');
                    const tabButton = document.getElementById('route-management-tab');

                    tabPane.classList.add('active', 'show');
                    tabButton.classList.add('active');

                    console.log('üîß Manually activated route management tab');

                    setTimeout(() => {
                        loadRoutes();
                        loadPOIsForRoutes();

                        // Harita container'ƒ± g√∂r√ºn√ºr olduktan sonra haritayƒ± ba≈ülat
                        setTimeout(() => {
                            const mapContainer = document.getElementById('routePreviewMap');
                            if (mapContainer && mapContainer.offsetWidth > 0) {
                                console.log('üó∫Ô∏è Initializing route preview map after manual tab activation');
                                initRoutePreviewMap();
                            }
                        }, 200);
                    }, 100);
                });
            } else {
                console.error('‚ùå Route management tab not found!');
            }
        });

        // Rotalarƒ± y√ºkle
        async function loadRoutes() {
            console.log('üîÑ Loading routes...');
            try {
                showLoading();
                const response = await authenticatedFetch(`${apiBase}/admin/routes`);
                console.log('üì° Routes API response:', response.status);

                if (response.ok) {
                    allRoutes = await response.json();
                    console.log('‚úÖ Routes loaded:', allRoutes.length, 'routes');
                    renderRoutesList();
                } else {
                    // Fallback: Bo≈ü liste g√∂ster
                    console.warn('Routes API not available, showing empty list');
                    allRoutes = [];
                    renderRoutesList();
                }
            } catch (error) {
                console.error('‚ùå Rota y√ºkleme hatasƒ±:', error);
                // Fallback: Bo≈ü liste g√∂ster
                allRoutes = [];
                renderRoutesList();
                showToast(`Rotalar y√ºklenemedi: ${error.message}. API endpoint'leri kontrol edin.`, 'warning');
            } finally {
                hideLoading();
            }
        }

        // Rota listesini render et
        function renderRoutesList() {
            console.log('üé® Rendering routes list...');
            const container = document.getElementById('routesContainer');
            console.log('üì¶ Routes container:', container);
            console.log('üìä Routes to render:', allRoutes.length);

            if (!container) {
                console.error('‚ùå Routes container not found!');
                return;
            }

            if (allRoutes.length === 0) {
                console.log('üìù Showing empty routes message');
                container.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <i class="fas fa-route fa-2x mb-2"></i>
                        <p class="mb-0">Hen√ºz rota eklenmemi≈ü</p>
                    </div>
                `;
                return;
            }

            try {
                const routeHTML = allRoutes.map(route => {
                    console.log('üîß Processing route:', route.name, route.id);
                    return `
                        <div class="card mb-2 route-card" data-route-id="${route.id}">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1" onclick="selectRoute(${route.id})" style="cursor: pointer;">
                                        <h6 class="mb-1">${route.name}</h6>
                                        <small class="text-muted">
                                            ${getRouteTypeIcon(route.route_type)} ${route.route_type} ‚Ä¢ 
                                            ${getDifficultyStars(route.difficulty_level)} ‚Ä¢ 
                                            ${route.estimated_duration || 0} dk
                                        </small>
                                        ${route.description ? `<p class="mb-0 mt-1 small text-muted">${route.description}</p>` : ''}
                                    </div>
                                    <div class="dropdown dropup">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                                data-bs-toggle="dropdown" data-bs-display="static">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#" onclick="editRoute(${route.id})">
                                                <i class="fas fa-edit me-2"></i>D√ºzenle
                                            </a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteRoute(${route.id})">
                                                <i class="fas fa-trash me-2"></i>Sil
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                console.log('üìù Generated HTML length:', routeHTML.length);
                container.innerHTML = routeHTML;

                // Container'ƒ±n g√∂r√ºn√ºrl√ºƒü√ºn√º kontrol et
                const containerStyle = window.getComputedStyle(container);
                console.log('üì¶ Container visibility:', {
                    display: containerStyle.display,
                    visibility: containerStyle.visibility,
                    opacity: containerStyle.opacity,
                    height: containerStyle.height,
                    overflow: containerStyle.overflow
                });

                console.log('‚úÖ Routes rendered successfully');
            } catch (error) {
                console.error('‚ùå Error rendering routes:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Rotalar y√ºklenirken hata olu≈ütu: ${error.message}
                    </div>
                `;
            }
        }

        // Yeni rota formu g√∂ster
        function showNewRouteForm() {
            document.getElementById('newRouteForm').style.display = 'block';
            document.getElementById('routesList').style.display = 'none';
            document.getElementById('routePanelTitle').textContent = '‚ûï Yeni Rota Ekle';
            document.getElementById('routeForm').reset();
            document.getElementById('routeId').value = '';

            // Form validation sƒ±nƒ±flarƒ±nƒ± temizle
            clearFormValidation();

            // POI se√ßimi b√∂l√ºm√ºn√º g√∂ster ve temizle
            document.getElementById('routePoiSelection').style.display = 'block';
            document.getElementById('poiSelectionTitle').innerHTML = '<i class="fas fa-map-marker-alt me-2"></i>POI Se√ßimi (Yeni Rota)';
            selectedRoute = null; // Ge√ßici olarak null yap
            selectedRoutePOIs = []; // POI listesini temizle

            // POI listelerini g√ºncelle
            renderAvailablePOIs();
            renderSelectedPOIs();

            // Rota √∂nizlemesini temizle
            if (routePreviewMap) {
                routePreviewMap.eachLayer(function (layer) {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        routePreviewMap.removeLayer(layer);
                    }
                });
            }

            showToast('üí° Rota bilgilerini doldurun ve POI ekleyin. Kaydetme i≈üleminden sonra POIler rotaya baƒülanacak.', 'info');
        }

        // Form validation sƒ±nƒ±flarƒ±nƒ± temizle
        function clearFormValidation() {
            const formElements = document.querySelectorAll('#routeForm .form-control, #routeForm .form-select');
            formElements.forEach(element => {
                element.classList.remove('is-valid', 'is-invalid');
            });
        }

        // Yeni rota formunu gizle
        function hideNewRouteForm() {
            document.getElementById('newRouteForm').style.display = 'none';
            document.getElementById('routesList').style.display = 'block';
            document.getElementById('routePanelTitle').textContent = 'üõ£Ô∏è Rota Y√∂netimi';

            // POI se√ßimi ba≈ülƒ±ƒüƒ±nƒ± sƒ±fƒ±rla
            document.getElementById('poiSelectionTitle').innerHTML = '<i class="fas fa-map-marker-alt me-2"></i>POI Se√ßimi ve Sƒ±ralama';

            // Se√ßili rota yoksa POI se√ßimi b√∂l√ºm√ºn√º gizle
            if (!selectedRoute) {
                selectedRoutePOIs = [];
                renderSelectedPOIs();
                renderAvailablePOIs();
            }
        }

        // Rota se√ß
        function selectRoute(routeId) {
            selectedRoute = allRoutes.find(r => r.id === routeId);
            if (!selectedRoute) return;

            // Se√ßili rotayƒ± vurgula
            document.querySelectorAll('.route-card').forEach(card => {
                card.classList.remove('border-primary');
            });
            document.querySelector(`[data-route-id="${routeId}"]`).classList.add('border-primary');

            // Rota detaylarƒ±nƒ± g√∂ster
            showRouteDetails(selectedRoute);

            // POI se√ßimi b√∂l√ºm√ºn√º g√∂ster
            document.getElementById('routePoiSelection').style.display = 'block';
            document.getElementById('poiSelectionTitle').innerHTML = `<i class="fas fa-map-marker-alt me-2"></i>POI Se√ßimi - ${selectedRoute.name}`;

            // Rota POI'lerini y√ºkle
            loadRoutePOIs(routeId);

            // √ñnizleme haritasƒ±nƒ± ba≈ülat
            setTimeout(() => {
                initRoutePreviewMap();
                updateRoutePreview();
            }, 100);
        }

        // Rota detaylarƒ±nƒ± g√∂ster
        function showRouteDetails(route) {
            const content = document.getElementById('routeDetailContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">${route.name}</h6>
                        <p class="text-muted mb-2">${route.description || 'A√ßƒ±klama yok'}</p>
                        <div class="mb-2">
                            <small class="text-muted">Tip:</small> 
                            <span class="badge bg-secondary">${getRouteTypeIcon(route.route_type)} ${route.route_type}</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Zorluk:</small> 
                            <span>${getDifficultyStars(route.difficulty_level)}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-2">
                            <small class="text-muted">S√ºre:</small> 
                            <strong>${route.estimated_duration || 0} dakika</strong>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Mesafe:</small> 
                            <strong>${route.total_distance || 0} km</strong>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Dairesel:</small> 
                            <span class="badge ${route.is_circular ? 'bg-success' : 'bg-warning'}">${route.is_circular ? 'Evet' : 'Hayƒ±r'}</span>
                        </div>
                        ${route.tags ? `<div class="mb-2">
                            <small class="text-muted">Etiketler:</small><br>
                            ${route.tags.split(',').map(tag => `<span class="badge bg-light text-dark me-1">${tag.trim()}</span>`).join('')}
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        // Rota i√ßin POI'leri y√ºkle
        async function loadRoutePOIs(routeId) {
            console.log('üîÑ Loading POIs for route:', routeId);
            try {
                const response = await authenticatedFetch(`${apiBase}/admin/routes/${routeId}/pois`);
                console.log('üì° Route POIs response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Route POIs data:', data);

                    // API response yapƒ±sƒ±nƒ± kontrol et - API doƒürudan array d√∂nd√ºr√ºyor
                    if (Array.isArray(data)) {
                        selectedRoutePOIs = data;
                    } else if (data && Array.isArray(data.pois)) {
                        selectedRoutePOIs = data.pois;
                    } else {
                        selectedRoutePOIs = [];
                    }

                    console.log('‚úÖ Loaded route POIs:', selectedRoutePOIs.length, 'POIs');
                    renderSelectedPOIs();
                    renderAvailablePOIs(); // Mevcut POI'leri de g√ºncelle

                    setTimeout(() => {
                        updateRoutePreview();
                    }, 100);
                } else {
                    console.error('‚ùå Failed to load route POIs:', response.status);
                    selectedRoutePOIs = [];
                    renderSelectedPOIs();
                }
            } catch (error) {
                console.error('‚ùå Rota POI y√ºkleme hatasƒ±:', error);
                selectedRoutePOIs = [];
                renderSelectedPOIs();
            }
        }

        // POI'leri rota y√∂netimi i√ßin y√ºkle
        async function loadPOIsForRoutes() {
            console.log('üîÑ Loading POIs for routes...');
            try {
                const response = await authenticatedFetch(`${apiBase}/pois`);
                console.log('üì° POIs API response:', response.status);

                if (response.ok) {
                    const poisData = await response.json();
                    console.log('üìä POIs data received:', poisData);

                    // API'den gelen veri yapƒ±sƒ±nƒ± kontrol et
                    if (poisData && poisData.pois && Array.isArray(poisData.pois)) {
                        // Eƒüer {pois: [...]} formatƒ±ndaysa
                        availablePOIs = poisData.pois;
                    } else if (Array.isArray(poisData)) {
                        // Eƒüer doƒürudan array formatƒ±ndaysa
                        availablePOIs = poisData;
                    } else if (typeof poisData === 'object') {
                        // Eƒüer kategorilere g√∂re gruplandƒ±rƒ±lmƒ±≈üsa (dogal_miras, tarihi_yapilar, vb.)
                        availablePOIs = [];
                        Object.keys(poisData).forEach(category => {
                            if (Array.isArray(poisData[category])) {
                                // POI'leri normalize et (latitude/longitude -> lat/lon)
                                const normalizedPOIs = poisData[category].map(poi => ({
                                    ...poi,
                                    id: poi._id || poi.id,
                                    lat: poi.latitude || poi.lat,
                                    lon: poi.longitude || poi.lon
                                }));
                                availablePOIs = availablePOIs.concat(normalizedPOIs);
                            }
                        });
                        console.log('üîÑ Flattened and normalized POIs:', availablePOIs.length);
                    } else {
                        console.warn('‚ö†Ô∏è Unexpected POIs data format:', poisData);
                        availablePOIs = [];
                    }

                    console.log('‚úÖ Available POIs loaded:', availablePOIs.length);
                    renderAvailablePOIs();

                    // POI kategori filtresini doldur
                    const categoryFilter = document.getElementById('poiCategoryFilter');
                    if (categoryFilter && availablePOIs.length > 0) {
                        const categories = [...new Set(availablePOIs.map(poi => poi.category))];
                        categoryFilter.innerHTML = '<option value="">T√ºm Kategoriler</option>' +
                            categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                    }
                } else {
                    console.error('‚ùå POIs API failed:', response.status);
                    availablePOIs = [];
                    renderAvailablePOIs();
                }
            } catch (error) {
                console.error('‚ùå POI y√ºkleme hatasƒ±:', error);
                availablePOIs = [];
                renderAvailablePOIs();
            }
        }

        // Mevcut POI'leri render et
        function renderAvailablePOIs() {
            const container = document.getElementById('availablePOIs');
            if (!container) return;

            // Ensure availablePOIs is an array
            if (!Array.isArray(availablePOIs)) {
                availablePOIs = [];
            }

            const categoryFilter = document.getElementById('poiCategoryFilter');
            const searchFilter = document.getElementById('poiSearchFilter');

            const categoryValue = categoryFilter ? categoryFilter.value : '';
            const searchValue = searchFilter ? searchFilter.value.toLowerCase() : '';

            let filteredPOIs = availablePOIs.filter(poi => {
                const matchesCategory = !categoryValue || poi.category === categoryValue;
                const matchesSearch = !searchValue || poi.name.toLowerCase().includes(searchValue);
                const notSelected = !selectedRoutePOIs.find(rp => rp.poi_id === poi.id);
                return matchesCategory && matchesSearch && notSelected;
            });

            if (filteredPOIs.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                        <p class="mb-0">POI bulunamadƒ±</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredPOIs.map(poi => `
                <div class="poi-item p-2 border rounded mb-2" style="cursor: pointer;" 
                     onclick="addPOIToRoute(${poi.id})">
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            <i class="fas fa-map-marker-alt text-primary"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${poi.name}</div>
                            <small class="text-muted">${poi.category || 'Kategori yok'}</small>
                        </div>
                        <div>
                            <i class="fas fa-plus text-success"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Se√ßilen POI'leri render et
        function renderSelectedPOIs() {
            const container = document.getElementById('selectedPOIs');

            if (selectedRoutePOIs.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <i class="fas fa-arrow-left me-2"></i>
                        Sol panelden POI se√ßin
                    </div>
                `;
                return;
            }

            // Sƒ±raya g√∂re sƒ±rala
            selectedRoutePOIs.sort((a, b) => a.order_in_route - b.order_in_route);

            container.innerHTML = selectedRoutePOIs.map((routePoi, index) => {
                const poi = availablePOIs.find(p => p.id === routePoi.poi_id);
                if (!poi) return '';

                return `
                    <div class="selected-poi-item p-2 border rounded mb-2" data-poi-id="${poi.id}">
                        <div class="d-flex align-items-center">
                            <div class="me-2">
                                <span class="badge bg-primary">${index + 1}</span>
                            </div>
                            <div class="me-2">
                                <i class="fas fa-grip-vertical text-muted drag-handle" style="cursor: move;"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">${poi.name}</div>
                                <small class="text-muted">${poi.category}</small>
                                <div class="mt-1">
                                    <small class="text-muted">S√ºre:</small>
                                    <input type="number" class="form-control form-control-sm d-inline-block" 
                                           style="width: 60px;" min="1" max="300" 
                                           value="${routePoi.estimated_time_at_poi || 30}"
                                           onchange="updatePOITime(${poi.id}, this.value)">
                                    <small class="text-muted">dk</small>
                                    <div class="form-check form-check-inline ms-2">
                                        <input class="form-check-input" type="checkbox" 
                                               ${routePoi.is_mandatory ? 'checked' : ''}
                                               onchange="updatePOIMandatory(${poi.id}, this.checked)">
                                        <label class="form-check-label small">Zorunlu</label>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-danger" onclick="removePOIFromRoute(${poi.id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Drag-and-drop √∂zelliƒüini etkinle≈ütir
            initializeSortable();
        }

        // Drag-and-drop i√ßin Sortable.js'i ba≈ülat
        function initializeSortable() {
            const container = document.getElementById('selectedPOIs');
            if (container && selectedRoutePOIs.length > 0) {
                new Sortable(container, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onEnd: function (evt) {
                        // Sƒ±ralama deƒüi≈ütiƒüinde POI sƒ±ralarƒ±nƒ± g√ºncelle
                        updatePOIOrder();
                    }
                });
            }
        }

        // POI sƒ±ralamasƒ±nƒ± g√ºncelle
        function updatePOIOrder() {
            const poiElements = document.querySelectorAll('#selectedPOIs .selected-poi-item');
            poiElements.forEach((element, index) => {
                const poiId = parseInt(element.dataset.poiId);
                const routePoi = selectedRoutePOIs.find(rp => rp.poi_id === poiId);
                if (routePoi) {
                    routePoi.order_in_route = index + 1;
                }
            });

            // Sƒ±ra numaralarƒ±nƒ± g√ºncelle
            poiElements.forEach((element, index) => {
                const badge = element.querySelector('.badge');
                if (badge) {
                    badge.textContent = index + 1;
                }
            });

            // √ñnizlemeyi g√ºncelle
            updateRoutePreview();
        }

        // POI s√ºresini g√ºncelle
        function updatePOITime(poiId, time) {
            const routePoi = selectedRoutePOIs.find(rp => rp.poi_id === poiId);
            if (routePoi) {
                routePoi.estimated_time_at_poi = parseInt(time) || 30;
            }
        }

        // POI zorunluluk durumunu g√ºncelle
        function updatePOIMandatory(poiId, isMandatory) {
            const routePoi = selectedRoutePOIs.find(rp => rp.poi_id === poiId);
            if (routePoi) {
                routePoi.is_mandatory = isMandatory;
            }
        }

        // POI'yi rotaya ekle
        function addPOIToRoute(poiId) {
            // Yeni rota olu≈ütururken de POI ekleyebilmek i√ßin selectedRoute kontrol√ºn√º esnetle
            const isNewRoute = !selectedRoute && document.getElementById('newRouteForm').style.display === 'block';

            if (!selectedRoute && !isNewRoute) {
                showToast('√ñnce bir rota se√ßin veya yeni rota olu≈üturun', 'warning');
                return;
            }

            // POI'nin zaten rotada olup olmadƒ±ƒüƒ±nƒ± kontrol et
            const existingPOI = selectedRoutePOIs.find(rp => rp.poi_id === poiId);
            if (existingPOI) {
                showToast('Bu POI zaten rotada mevcut', 'warning');
                return;
            }

            const newOrder = selectedRoutePOIs.length + 1;
            selectedRoutePOIs.push({
                poi_id: poiId,
                order_in_route: newOrder,
                is_mandatory: true,
                estimated_time_at_poi: 30
            });

            renderSelectedPOIs();
            renderAvailablePOIs();

            // Harita g√ºncellemesini biraz geciktir
            setTimeout(() => {
                updateRoutePreview();
            }, 50);

            // Yeni rota olu≈ütururken bilgilendirici mesaj
            if (isNewRoute) {
                showToast('‚úÖ POI eklendi. Rotayƒ± kaydettiƒüinizde POI\'ler otomatik olarak baƒülanacak.', 'success');
            }
        }

        // POI'yi rotadan √ßƒ±kar
        function removePOIFromRoute(poiId) {
            selectedRoutePOIs = selectedRoutePOIs.filter(rp => rp.poi_id !== poiId);

            // Sƒ±ralarƒ± yeniden d√ºzenle
            selectedRoutePOIs.forEach((rp, index) => {
                rp.order_in_route = index + 1;
            });

            renderSelectedPOIs();
            renderAvailablePOIs();

            // Harita g√ºncellemesini biraz geciktir
            setTimeout(() => {
                updateRoutePreview();
            }, 50);
        }

        // Rota POI'lerini kaydet
        async function saveRoutePOIs() {
            if (!selectedRoute) {
                showToast('√ñnce bir rota se√ßin', 'warning');
                return;
            }

            if (selectedRoutePOIs.length === 0) {
                showToast('Rotaya en az bir POI eklemelisiniz', 'warning');
                return;
            }

            console.log('üíæ Saving route POIs:', {
                routeId: selectedRoute.id,
                routeName: selectedRoute.name,
                poisCount: selectedRoutePOIs.length,
                pois: selectedRoutePOIs
            });

            try {
                showLoading();

                // CSRF token'ƒ± al
                const currentCSRFToken = await getCSRFToken();

                const requestData = {
                    pois: selectedRoutePOIs,
                    csrf_token: currentCSRFToken
                };

                console.log('üì° Sending request data:', requestData);

                const response = await authenticatedFetch(`${apiBase}/admin/routes/${selectedRoute.id}/pois`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': currentCSRFToken
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('üì° Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Save successful:', result);
                    showToast('POI ili≈ükileri ba≈üarƒ±yla kaydedildi!', 'success');

                    // Rotayƒ± yeniden y√ºkle
                    await loadRoutePOIs(selectedRoute.id);
                } else {
                    const errorData = await response.json();
                    console.error('‚ùå Save failed:', errorData);
                    throw new Error(errorData.error || 'POI ili≈ükileri kaydedilemedi');
                }
            } catch (error) {
                console.error('‚ùå POI kaydetme hatasƒ±:', error);
                showToast(`POI kaydetme hatasƒ±: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // POI filtreleme
        function filterAvailablePOIs() {
            renderAvailablePOIs();
        }

        // Rota filtreleme
        function filterRoutes() {
            const searchTerm = document.getElementById('searchRoute').value.toLowerCase();
            const filteredRoutes = allRoutes.filter(route =>
                route.name.toLowerCase().includes(searchTerm) ||
                (route.description && route.description.toLowerCase().includes(searchTerm))
            );

            const container = document.getElementById('routesContainer');
            container.innerHTML = filteredRoutes.map(route => `
                <div class="card mb-2 route-card" data-route-id="${route.id}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1" onclick="selectRoute(${route.id})" style="cursor: pointer;">
                                <h6 class="mb-1">${route.name}</h6>
                                <small class="text-muted">
                                    ${getRouteTypeIcon(route.route_type)} ${route.route_type} ‚Ä¢ 
                                    ${getDifficultyStars(route.difficulty_level)} ‚Ä¢ 
                                    ${route.estimated_duration || 0} dk
                                </small>
                                ${route.description ? `<p class="mb-0 mt-1 small text-muted">${route.description}</p>` : ''}
                            </div>
                            <div class="dropdown dropup">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" data-bs-display="static">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="editRoute(${route.id})">
                                        <i class="fas fa-edit me-2"></i>D√ºzenle
                                    </a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteRoute(${route.id})">
                                        <i class="fas fa-trash me-2"></i>Sil
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Rota formu submit ve real-time validation
        document.addEventListener('DOMContentLoaded', function () {
            const routeForm = document.getElementById('routeForm');
            if (routeForm) {
                routeForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    await saveRoute();
                });

                // Real-time validation
                const routeName = document.getElementById('routeName');
                const routeType = document.getElementById('routeType');
                const routeDifficulty = document.getElementById('routeDifficulty');
                const routeDuration = document.getElementById('routeDuration');
                const routeDistance = document.getElementById('routeDistance');

                if (routeName) {
                    routeName.addEventListener('blur', function () {
                        if (this.value.trim().length < 2) {
                            this.classList.add('is-invalid');
                        } else {
                            this.classList.remove('is-invalid');
                            this.classList.add('is-valid');
                        }
                    });
                }

                if (routeType) {
                    routeType.addEventListener('change', function () {
                        if (this.value) {
                            this.classList.remove('is-invalid');
                            this.classList.add('is-valid');
                        } else {
                            this.classList.add('is-invalid');
                        }
                    });
                }

                if (routeDifficulty) {
                    routeDifficulty.addEventListener('change', function () {
                        if (this.value) {
                            this.classList.remove('is-invalid');
                            this.classList.add('is-valid');
                        } else {
                            this.classList.add('is-invalid');
                        }
                    });
                }

                if (routeDuration) {
                    routeDuration.addEventListener('input', function () {
                        const value = parseInt(this.value);
                        if (this.value && (isNaN(value) || value < 1)) {
                            this.classList.add('is-invalid');
                        } else {
                            this.classList.remove('is-invalid');
                            if (this.value) this.classList.add('is-valid');
                        }
                    });
                }

                if (routeDistance) {
                    routeDistance.addEventListener('input', function () {
                        const value = parseFloat(this.value);
                        if (this.value && (isNaN(value) || value < 0)) {
                            this.classList.add('is-invalid');
                        } else {
                            this.classList.remove('is-invalid');
                            if (this.value) this.classList.add('is-valid');
                        }
                    });
                }
            }
        });

        // Rota form validasyonu
        function validateRouteForm(routeData) {
            const errors = [];

            if (!routeData.name || routeData.name.length < 2) {
                errors.push('Rota adƒ± en az 2 karakter olmalƒ±dƒ±r');
            }

            if (!routeData.route_type) {
                errors.push('Rota tipi se√ßilmelidir');
            }

            if (!routeData.difficulty_level || routeData.difficulty_level < 1 || routeData.difficulty_level > 5) {
                errors.push('Zorluk seviyesi 1-5 arasƒ±nda olmalƒ±dƒ±r');
            }

            if (routeData.estimated_duration && routeData.estimated_duration < 1) {
                errors.push('Tahmini s√ºre pozitif bir deƒüer olmalƒ±dƒ±r');
            }

            if (routeData.total_distance && routeData.total_distance < 0) {
                errors.push('Mesafe negatif olamaz');
            }

            return errors;
        }

        // Rota kaydet
        async function saveRoute() {
            try {
                showLoading();

                const routeData = {
                    name: document.getElementById('routeName').value.trim(),
                    description: document.getElementById('routeDescription').value.trim(),
                    route_type: document.getElementById('routeType').value,
                    difficulty_level: parseInt(document.getElementById('routeDifficulty').value),
                    estimated_duration: parseInt(document.getElementById('routeDuration').value) || null,
                    total_distance: parseFloat(document.getElementById('routeDistance').value) || null,
                    tags: document.getElementById('routeTags').value.trim(),
                    is_circular: document.getElementById('routeIsCircular').checked
                };

                // Form validasyonu
                const errors = validateRouteForm(routeData);
                if (errors.length > 0) {
                    showToast(errors.join('<br>'), 'error');
                    return;
                }

                const routeId = document.getElementById('routeId').value;
                const isEdit = !!routeId;

                const normalizedName = routeData.name.toLowerCase();
                const existingRoute = allRoutes.find(r => r.name.toLowerCase() === normalizedName);

                let url, method, targetRouteId;
                if (isEdit) {
                    targetRouteId = routeId;
                    url = `${apiBase}/admin/routes/${routeId}`;
                    method = 'PUT';
                } else if (existingRoute) {
                    targetRouteId = existingRoute.id;
                    url = `${apiBase}/admin/routes/${existingRoute.id}`;
                    method = 'PUT';
                } else {
                    url = `${apiBase}/admin/routes`;
                    method = 'POST';
                }

                const response = await authenticatedFetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(routeData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(`Rota ba≈üarƒ±yla ${method === 'PUT' ? 'g√ºncellendi' : 'eklendi'}!`, 'success');

                    // Rotalarƒ± yeniden y√ºkle
                    await loadRoutes();

                    // Yeni olu≈üturulan/g√ºncellenen rotayƒ± otomatik se√ß
                    const savedRouteId = method === 'PUT' ? targetRouteId : result.id;
                    if (savedRouteId) {
                        selectedRoute = allRoutes.find(r => r.id === parseInt(savedRouteId));

                        if (selectedRoutePOIs.length > 0) {
                            showToast('üîÑ POI\'ler rotaya baƒülanƒ±yor...', 'info');
                            try {
                                await saveRoutePOIs();
                                await calculateAndSaveRouteGeometry(savedRouteId);
                            } catch (poiError) {
                                console.error('POI kaydetme hatasƒ±:', poiError);
                                showToast('‚ö†Ô∏è Rota kaydedildi ancak POI ili≈ükileri baƒülanamadƒ±.', 'warning');
                            }
                        } else {
                            showToast('‚úÖ Rota se√ßildi, ≈üimdi POI ekleyebilirsiniz!', 'info');
                        }

                        selectRoute(parseInt(savedRouteId));
                    } else {
                        hideNewRouteForm();
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Rota kaydedilemedi');
                }
            } catch (error) {
                console.error('‚ùå Rota kaydetme hatasƒ±:', error);
                showToast(`Rota kaydetme hatasƒ±: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Rota d√ºzenle
        function editRoute(routeId) {
            const route = allRoutes.find(r => r.id === routeId);
            if (!route) return;

            // Formu doldur
            document.getElementById('routeId').value = route.id;
            document.getElementById('routeName').value = route.name;
            document.getElementById('routeDescription').value = route.description || '';
            document.getElementById('routeType').value = route.route_type;
            document.getElementById('routeDifficulty').value = route.difficulty_level;
            document.getElementById('routeDuration').value = route.estimated_duration || '';
            document.getElementById('routeDistance').value = route.total_distance || '';
            document.getElementById('routeTags').value = route.tags || '';
            document.getElementById('routeIsCircular').checked = route.is_circular;

            // Formu g√∂ster
            document.getElementById('newRouteForm').style.display = 'block';
            document.getElementById('routesList').style.display = 'none';
            document.getElementById('routePanelTitle').textContent = '‚úèÔ∏è Rota D√ºzenle';

            // Form validation sƒ±nƒ±flarƒ±nƒ± temizle
            clearFormValidation();
        }

        // Rota sil
        async function deleteRoute(routeId) {
            const route = allRoutes.find(r => r.id === routeId);
            if (!route) return;

            if (!confirm(`"${route.name}" rotasƒ±nƒ± silmek istediƒüinizden emin misiniz?`)) {
                return;
            }

            try {
                showLoading();
                const currentCSRFToken = await getCSRFToken();
                const response = await authenticatedFetch(`${apiBase}/admin/routes/${routeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': currentCSRFToken
                    },
                    body: JSON.stringify({ csrf_token: currentCSRFToken })
                });

                if (response.ok) {
                    showToast('Rota ba≈üarƒ±yla silindi!', 'success');
                    await loadRoutes();

                    // Se√ßili rota silinmi≈üse detaylarƒ± temizle
                    if (selectedRoute && selectedRoute.id === routeId) {
                        selectedRoute = null;
                        document.getElementById('routeDetailContent').innerHTML = `
                            <div class="text-center p-5 text-muted">
                                <i class="fas fa-map-marked-alt fa-3x mb-3"></i>
                                <h6>Rota Se√ßin</h6>
                                <p class="mb-0">Detaylarƒ± g√∂rmek i√ßin sol panelden bir rota se√ßin</p>
                            </div>
                        `;
                        document.getElementById('routePoiSelection').style.display = 'none';
                    }
                } else {
                    throw new Error('Rota silinemedi');
                }
            } catch (error) {
                console.error('‚ùå Rota silme hatasƒ±:', error);
                showToast(`Rota silme hatasƒ±: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Yardƒ±mcƒ± fonksiyonlar
        function getRouteTypeIcon(type) {
            const icons = {
                'walking': 'üö∂',
                'hiking': 'ü•æ',
                'cycling': 'üö¥',
                'driving': 'üöó'
            };
            return icons[type] || 'üõ£Ô∏è';
        }

        function getDifficultyStars(level) {
            return '‚≠ê'.repeat(level || 1);
        }

        // Rota √∂nizleme haritasƒ±nƒ± ba≈ülat
        function initRoutePreviewMap() {
            try {
                // Leaflet'in y√ºklendiƒüinden emin ol
                if (typeof L === 'undefined') {
                    console.error('Leaflet library not loaded');
                    setTimeout(initRoutePreviewMap, 100);
                    return;
                }

                if (routePreviewMap) {
                    routePreviewMap.remove();
                    routePreviewMap = null;
                }

                // Harita container'ƒ±nƒ±n mevcut olduƒüundan emin ol
                const mapContainer = document.getElementById('routePreviewMap');
                if (!mapContainer) {
                    console.error('Route preview map container not found');
                    return;
                }

                // Container'ƒ±n g√∂r√ºn√ºr olduƒüundan emin ol
                if (mapContainer.offsetWidth === 0 || mapContainer.offsetHeight === 0) {
                    console.warn('Map container not visible, retrying...');
                    setTimeout(initRoutePreviewMap, 100);
                    return;
                }

                routePreviewMap = L.map('routePreviewMap').setView([38.6431, 34.8288], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(routePreviewMap);

                // Harita y√ºklendikten sonra boyutunu ayarla
                setTimeout(() => {
                    if (routePreviewMap) {
                        routePreviewMap.invalidateSize();
                    }
                }, 100);

                console.log('Route preview map initialized successfully');
            } catch (error) {
                console.error('Error initializing route preview map:', error);
                routePreviewMap = null;
            }
        }

        // Rota mesafesi hesaplama fonksiyonu
        async function calculateRouteDistance() {
            console.log('üßÆ Calculating route distance...');
            console.log('üîç selectedRoutePOIs:', selectedRoutePOIs);
            console.log('üîç availablePOIs:', availablePOIs);

            if (selectedRoutePOIs.length === 0) {
                showToast('Rotaya POI ekleyin', 'warning');
                return;
            }

            const calculateBtn = document.getElementById('calculateRouteBtn');
            const distanceInput = document.getElementById('routeDistance');

            // Loading state
            calculateBtn.disabled = true;
            calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Hesaplanƒ±yor...';

            try {
                // POI'leri sƒ±raya g√∂re sƒ±rala
                const sortedPOIs = [...selectedRoutePOIs].sort((a, b) => a.order_in_route - b.order_in_route);

                // Waypoint'leri hazƒ±rla
                const waypoints = sortedPOIs.map(routePoi => {
                    const poi = availablePOIs.find(p => p.id === routePoi.poi_id);
                    console.log('üîç Looking for POI ID:', routePoi.poi_id, 'Found:', poi);
                    if (!poi) return null;

                    return {
                        lat: poi.lat,
                        lng: poi.lon,
                        name: poi.name
                    };
                }).filter(wp => wp !== null);

                console.log('üó∫Ô∏è Prepared waypoints:', waypoints);

                if (waypoints.length < 2) {
                    showToast('En az 2 POI gerekli', 'warning');
                    return;
                }

                console.log('üó∫Ô∏è Calculating route for waypoints:', waypoints);

                // Smart route API'sini √ßaƒüƒ±r
                console.log('üì° Calling route API with waypoints:', waypoints);
                const response = await fetch('/api/route/smart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        waypoints: waypoints
                    })
                });

                console.log('üì° API Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error response:', errorText);
                    throw new Error(`Route API error: ${response.status} - ${errorText}`);
                }

                const routeData = await response.json();
                console.log('üó∫Ô∏è Route calculation result:', routeData);

                if (routeData.success && routeData.route && routeData.route.total_distance) {
                    console.log('‚úÖ Route data valid, total_distance:', routeData.route.total_distance);

                    // Mesafeyi km cinsinden g√∂ster (API'den km olarak geliyor)
                    const distanceKm = routeData.route.total_distance.toFixed(1);
                    console.log('üìè Setting distance to:', distanceKm, 'km');
                    distanceInput.value = distanceKm;

                    // S√ºreyi de g√ºncelle (eƒüer varsa)
                    const durationInput = document.getElementById('routeDuration');
                    if (durationInput && routeData.route.estimated_time) {
                        const durationMinutes = Math.round(routeData.route.estimated_time); // API'den dakika olarak geliyor
                        console.log('‚è±Ô∏è Setting duration to:', durationMinutes, 'minutes');
                        durationInput.value = durationMinutes;
                    }

                    showToast(`‚úÖ Rota mesafesi hesaplandƒ±: ${distanceKm} km`, 'success');

                    // Rota √∂nizlemesini g√ºncelle
                    updateRoutePreviewWithRealRoute(routeData.route);

                    // Rota geometrisini veritabanƒ±na kaydet (eƒüer se√ßili rota varsa)
                    if (selectedRoute && routeData.route.segments) {
                        saveRouteGeometry(selectedRoute.id, routeData.route);
                    }

                } else {
                    throw new Error('Invalid route data received');
                }

            } catch (error) {
                console.error('Route calculation error:', error);

                // Fallback: Ku≈ü u√ßumu hesaplama
                console.log('üîÑ Fallback: Using straight-line distance calculation...');
                const straightLineDistance = calculateStraightLineDistance();
                if (straightLineDistance > 0) {
                    distanceInput.value = straightLineDistance.toFixed(1);
                    showToast(`‚ö†Ô∏è Yol aƒüƒ± hesaplanamadƒ±, ku≈ü u√ßumu mesafe: ${straightLineDistance.toFixed(1)} km`, 'warning');
                } else {
                    showToast('‚ùå Mesafe hesaplanamadƒ±', 'error');
                }
            } finally {
                // Reset button state
                calculateBtn.disabled = false;
                calculateBtn.innerHTML = '<i class="fas fa-route"></i> Hesapla';
            }
        }

        // Ku≈ü u√ßumu mesafe hesaplama (fallback)
        function calculateStraightLineDistance() {
            if (selectedRoutePOIs.length === 0) return 0;

            const sortedPOIs = [...selectedRoutePOIs].sort((a, b) => a.order_in_route - b.order_in_route);
            let totalDistance = 0;

            for (let i = 1; i < sortedPOIs.length; i++) {
                const poi1 = availablePOIs.find(p => p.id === sortedPOIs[i - 1].poi_id);
                const poi2 = availablePOIs.find(p => p.id === sortedPOIs[i].poi_id);

                if (poi1 && poi2) {
                    const distance = getDistanceFromLatLonInKm(poi1.lat, poi1.lon, poi2.lat, poi2.lon);
                    totalDistance += distance;
                }
            }

            // Dairesel rotaysa son POI'den ilk POI'ye mesafeyi ekle
            if (selectedRoute && selectedRoute.is_circular && sortedPOIs.length > 2) {
                const firstPoi = availablePOIs.find(p => p.id === sortedPOIs[0].poi_id);
                const lastPoi = availablePOIs.find(p => p.id === sortedPOIs[sortedPOIs.length - 1].poi_id);

                if (firstPoi && lastPoi) {
                    const distance = getDistanceFromLatLonInKm(lastPoi.lat, lastPoi.lon, firstPoi.lat, firstPoi.lon);
                    totalDistance += distance;
                }
            }

            return totalDistance;
        }

        // Haversine formula ile mesafe hesaplama
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // Yeni rota i√ßin geometri hesapla ve kaydet
        async function calculateAndSaveRouteGeometry(routeId) {
            try {
                console.log('üßÆ Calculating and saving geometry for new route:', routeId);

                // Rota POI'lerini al
                const routePOIs = selectedRoutePOIs;
                if (routePOIs.length < 2) {
                    console.log('‚ö†Ô∏è Not enough POIs for route geometry calculation');
                    return;
                }

                // POI'leri sƒ±raya g√∂re sƒ±rala
                const sortedPOIs = [...routePOIs].sort((a, b) => a.order_in_route - b.order_in_route);

                // Waypoint'leri hazƒ±rla
                const waypoints = sortedPOIs.map(routePoi => {
                    const poi = availablePOIs.find(p => p.id === routePoi.poi_id);
                    if (!poi) return null;

                    return {
                        lat: poi.lat,
                        lng: poi.lon,
                        name: poi.name
                    };
                }).filter(wp => wp !== null);

                if (waypoints.length < 2) {
                    console.log('‚ö†Ô∏è Not enough valid waypoints for route calculation');
                    return;
                }

                console.log('üó∫Ô∏è Calculating route geometry for waypoints:', waypoints);

                // Smart route API'sini √ßaƒüƒ±r
                const response = await fetch('/api/route/smart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        waypoints: waypoints
                    })
                });

                if (!response.ok) {
                    throw new Error(`Route API error: ${response.status}`);
                }

                const routeData = await response.json();
                console.log('üó∫Ô∏è Route calculation result for new route:', routeData);

                if (routeData.success && routeData.route && routeData.route.segments) {
                    // Geometriyi kaydet
                    await saveRouteGeometry(routeId, routeData.route);

                    // Mesafe ve s√ºreyi de g√ºncelle
                    if (routeData.route.total_distance) {
                        const distanceKm = routeData.route.total_distance.toFixed(1); // API'den km olarak geliyor
                        const estimatedMinutes = routeData.route.estimated_time ? Math.round(routeData.route.estimated_time) : null; // API'den dakika olarak geliyor

                        // Rota bilgilerini g√ºncelle
                        const updateData = {
                            total_distance: parseFloat(distanceKm)
                        };

                        if (estimatedMinutes) {
                            updateData.estimated_duration = estimatedMinutes;
                        }

                        const updateResponse = await authenticatedFetch(`${apiBase}/admin/routes/${routeId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateData)
                        });

                        if (updateResponse.ok) {
                            console.log('‚úÖ Route distance and duration updated');
                            showToast(`‚úÖ Rota geometrisi kaydedildi (${distanceKm} km)`, 'success');

                            // Rota listesini yenile
                            await loadRoutes();
                        }
                    }
                } else {
                    console.warn('‚ö†Ô∏è Could not calculate route geometry for new route');
                }

            } catch (error) {
                console.error('‚ùå Error calculating and saving route geometry:', error);
            }
        }

        // Rota geometrisini veritabanƒ±na kaydet
        async function saveRouteGeometry(routeId, routeData) {
            try {
                console.log('üíæ Saving route geometry for route:', routeId);

                const geometryData = {
                    route_id: routeId,
                    geometry: routeData.segments,
                    total_distance: routeData.total_distance * 1000, // km'den metre'ye √ßevir (veritabanƒ± i√ßin)
                    estimated_time: routeData.estimated_time * 60, // dakika'dan saniye'ye √ßevir (veritabanƒ± i√ßin)
                    waypoints: routeData.waypoints || []
                };

                console.log('üì° Sending geometry data:', geometryData);

                const response = await authenticatedFetch(`${apiBase}/admin/routes/${routeId}/geometry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(geometryData)
                });

                if (response.ok) {
                    console.log('‚úÖ Route geometry saved successfully');
                } else {
                    console.warn('‚ö†Ô∏è Failed to save route geometry:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Error saving route geometry:', error);
            }
        }

        // Ger√ßek rota ile √∂nizleme g√ºncelleme
        function updateRoutePreviewWithRealRoute(routeData) {
            if (!routePreviewMap) {
                initRoutePreviewMap();
                return;
            }

            // Mevcut route layer'larƒ± temizle
            routePreviewMap.eachLayer(function (layer) {
                if (layer instanceof L.Polyline && layer.options.className === 'real-route') {
                    routePreviewMap.removeLayer(layer);
                }
            });

            // Ger√ßek rota √ßizgilerini √ßiz
            if (routeData.segments && routeData.segments.length > 0) {
                routeData.segments.forEach((segment, index) => {
                    if (segment.coordinates && segment.coordinates.length > 0) {
                        const coordinates = segment.coordinates.map(coord => [coord.lat, coord.lng]);

                        const routeLine = L.polyline(coordinates, {
                            color: segment.fallback ? '#ff6b6b' : '#4ecdc4',
                            weight: 4,
                            opacity: 0.8,
                            className: 'real-route',
                            dashArray: segment.fallback ? '10, 5' : null
                        }).addTo(routePreviewMap);

                        // Segment bilgisi popup'ƒ±
                        routeLine.bindPopup(`
                            <strong>Segment ${index + 1}</strong><br>
                            <small>Mesafe: ${(segment.distance * 1000).toFixed(0)}m</small><br>
                            <small>Tip: ${segment.fallback ? 'D√ºz √ßizgi' : 'Y√ºr√ºy√º≈ü yolu'}</small>
                        `);
                    }
                });
            }
        }

        // Rota √∂nizlemesini g√ºncelle
        function updateRoutePreview() {
            if (!routePreviewMap) {
                initRoutePreviewMap();
            }

            // Haritanƒ±n tam olarak y√ºklendiƒüinden emin ol
            if (!routePreviewMap || typeof routePreviewMap.eachLayer !== 'function') {
                console.warn('Route preview map not properly initialized, retrying...');
                setTimeout(updateRoutePreview, 100);
                return;
            }

            // Mevcut marker'larƒ± temizle
            routePreviewMap.eachLayer(function (layer) {
                if (layer instanceof L.Marker || (layer instanceof L.Polyline && layer.options.className !== 'real-route')) {
                    routePreviewMap.removeLayer(layer);
                }
            });

            if (selectedRoutePOIs.length === 0) {
                return;
            }

            // POI'leri sƒ±raya g√∂re sƒ±rala
            const sortedPOIs = [...selectedRoutePOIs].sort((a, b) => a.order_in_route - b.order_in_route);
            const poiCoordinates = [];

            // POI marker'larƒ±nƒ± ekle
            sortedPOIs.forEach((routePoi, index) => {
                const poi = availablePOIs.find(p => p.id === routePoi.poi_id);
                if (poi) {
                    const marker = L.marker([poi.lat, poi.lon])
                        .addTo(routePreviewMap)
                        .bindPopup(`
                            <strong>${index + 1}. ${poi.name}</strong><br>
                            <small>${poi.category}</small><br>
                            <small>S√ºre: ${routePoi.estimated_time_at_poi}dk</small><br>
                            <small>${routePoi.is_mandatory ? 'üî¥ Zorunlu' : 'üü° ƒ∞steƒüe baƒülƒ±'}</small>
                        `);

                    // Marker'ƒ± numaralandƒ±r
                    marker.setIcon(L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #007bff; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">${index + 1}</div>`,
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    }));

                    poiCoordinates.push([poi.lat, poi.lon]);
                }
            });

            // POI'ler arasƒ±nda basit √ßizgi √ßek (ger√ßek rota yoksa)
            if (poiCoordinates.length > 1) {
                const polyline = L.polyline(poiCoordinates, {
                    color: '#007bff',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '5, 10'
                }).addTo(routePreviewMap);

                // Dairesel rotaysa ba≈ülangƒ±√ß ve biti≈ü noktasƒ±nƒ± birle≈ütir
                if (selectedRoute && selectedRoute.is_circular && poiCoordinates.length > 2) {
                    const circularLine = L.polyline([poiCoordinates[poiCoordinates.length - 1], poiCoordinates[0]], {
                        color: '#28a745',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '10, 5'
                    }).addTo(routePreviewMap);
                }
            }

            // Haritayƒ± POI'lere odakla
            if (poiCoordinates.length > 0) {
                // T√ºm marker'larƒ± topla
                const markers = [];
                routePreviewMap.eachLayer(function (layer) {
                    if (layer instanceof L.Marker) {
                        markers.push(layer);
                    }
                });

                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    routePreviewMap.fitBounds(group.getBounds().pad(0.1));
                } else if (poiCoordinates.length === 1) {
                    // Tek POI varsa o noktaya odakla
                    routePreviewMap.setView(poiCoordinates[0], 15);
                }
            }
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', async function () {
            // First check authentication
            const isAuthenticated = await checkAuthStatus();
            if (isAuthenticated) {
                initMap();
                await loadCategories(); // √ñnce kategorileri y√ºkle
                fetchPOIs();

                // Start enhanced session monitoring
                startSessionTimeoutMonitoring();
            }
        });

        // KML/GPX Dosya ƒ∞√ße Aktarma Fonksiyonlarƒ±
        let parsedRouteData = null;

        // Dosya i√ße aktarma b√∂l√ºm√ºn√º a√ß/kapat
        function toggleFileImport() {
            const section = document.getElementById('fileImportSection');
            const btn = document.getElementById('toggleFileImportBtn');
            const icon = btn.querySelector('i');
            
            if (section.classList.contains('show')) {
                section.classList.remove('show');
                icon.className = 'fas fa-chevron-down';
            } else {
                section.classList.add('show');
                icon.className = 'fas fa-chevron-up';
            }
        }

        // Dosya se√ßildiƒüinde √ßalƒ±≈üƒ±r
        async function handleRouteFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Dosya tipini kontrol et
            const allowedTypes = ['application/vnd.google-earth.kml+xml', 'application/vnd.google-earth.kmz', 'application/gpx+xml', 'text/xml', 'application/xml', 'application/zip'];
            const allowedExtensions = ['.kml', '.kmz', '.gpx'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!allowedExtensions.includes(fileExtension)) {
                showToast('Desteklenmeyen dosya formatƒ±. Sadece KML, KMZ ve GPX dosyalarƒ± desteklenir.', 'error');
                clearFileImport();
                return;
            }

            // Dosya boyutunu kontrol et (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('Dosya √ßok b√ºy√ºk. Maksimum 10MB desteklenir.', 'error');
                clearFileImport();
                return;
            }

            // Parse durumunu g√∂ster
            showFileParseStatus();

            try {
                // FormData olu≈ütur
                const formData = new FormData();
                formData.append('file', file);

                // API'ye g√∂nder
                const response = await fetch('/api/admin/routes/import', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRF-Token': csrfToken
                    }
                });

                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    // JSON parse hatasƒ± - muhtemelen HTML error sayfasƒ± d√∂nd√º
                    const textResponse = await response.text();
                    console.error('API Response (not JSON):', textResponse);
                    throw new Error(`API hatasƒ± (${response.status}): JSON parse edilemedi`);
                }

                if (response.ok && result.success) {
                    parsedRouteData = result.data;
                    showParseResult(result.data, result.message);
                } else {
                    throw new Error(result.error || 'Dosya i≈üleme hatasƒ±');
                }

            } catch (error) {
                console.error('File import error:', error);
                showParseError(error.message);
            }
        }

        // Parse durumunu g√∂ster
        function showFileParseStatus() {
            document.getElementById('fileParseStatus').style.display = 'block';
            document.getElementById('parseResult').style.display = 'none';
            document.getElementById('parseError').style.display = 'none';
        }

        // Parse sonucunu g√∂ster
        function showParseResult(data, message) {
            document.getElementById('fileParseStatus').style.display = 'none';
            document.getElementById('parseError').style.display = 'none';
            
            const resultDiv = document.getElementById('parseResult');
            const contentDiv = document.getElementById('parseResultContent');
            
            // Sonu√ß bilgilerini g√∂ster
            let content = `
                <div class="row">
                    <div class="col-6">
                        <strong>Format:</strong> ${data.format.toUpperCase()}<br>
                        <strong>Toplam Rota:</strong> ${data.total_routes}<br>
                        <strong>Waypoint:</strong> ${data.total_waypoints}
                    </div>
                    <div class="col-6">
                        <strong>Dosya Adƒ±:</strong> ${data.metadata.name || 'Bilinmiyor'}<br>
                        <strong>Olu≈üturan:</strong> ${data.metadata.creator || 'Bilinmiyor'}
                    </div>
                </div>
            `;

            // Rota se√ßimi (√ßoklu rota varsa)
            const allRoutes = [...data.routes, ...data.tracks];
            if (allRoutes.length > 1) {
                const routeSelect = document.getElementById('selectedRouteIndex');
                routeSelect.innerHTML = '';
                
                allRoutes.forEach((route, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${route.name} (${route.distance}km, ${route.points.length} nokta)`;
                    routeSelect.appendChild(option);
                });
                
                document.getElementById('routeSelection').style.display = 'block';
            } else {
                document.getElementById('routeSelection').style.display = 'none';
            }

            contentDiv.innerHTML = content;
            resultDiv.style.display = 'block';
        }

        // Parse hatasƒ±nƒ± g√∂ster
        function showParseError(errorMessage) {
            document.getElementById('fileParseStatus').style.display = 'none';
            document.getElementById('parseResult').style.display = 'none';
            
            const errorDiv = document.getElementById('parseError');
            const errorContent = document.getElementById('parseErrorContent');
            
            errorContent.innerHTML = `<p class="mb-0">${errorMessage}</p>`;
            errorDiv.style.display = 'block';
        }

        // ƒ∞√ße aktarƒ±lan rota verilerini forma uygula
        async function applyImportedRouteData() {
            if (!parsedRouteData) {
                showToast('ƒ∞√ße aktarƒ±lacak veri bulunamadƒ±', 'error');
                return;
            }

            try {
                showLoading();

                // Se√ßilen rota indeksini al
                const routeIndex = document.getElementById('selectedRouteIndex').value || 0;
                const importWaypoints = document.getElementById('importWaypointsAsPois').checked;

                // API'ye rota olu≈üturma isteƒüi g√∂nder
                const response = await fetch('/api/admin/routes/import/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        parsed_data: parsedRouteData,
                        route_index: parseInt(routeIndex),
                        import_waypoints_as_pois: importWaypoints,
                        custom_settings: {} // Kullanƒ±cƒ± √∂zel ayarlarƒ± buraya eklenebilir
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Ba≈üarƒ±lƒ± - rota verilerini forma doldur
                    const routeData = result.route_data;
                    
                    // Form alanlarƒ±nƒ± doldur
                    document.getElementById('routeName').value = routeData.name || '';
                    document.getElementById('routeType').value = routeData.type || 'walking';
                    document.getElementById('routeDistance').value = routeData.distance || '';
                    document.getElementById('routeDuration').value = routeData.duration || '';
                    
                    // Dosya i√ße aktarma b√∂l√ºm√ºn√º kapat
                    clearFileImport();
                    
                    // Ba≈üarƒ± mesajƒ±
                    showToast(`Rota ba≈üarƒ±yla olu≈üturuldu! (ID: ${result.route_id})`, 'success');
                    
                    // Rota listesini yenile
                    await loadRoutes();
                    
                    // Formu temizle ve listeye d√∂n
                    hideNewRouteForm();
                    
                } else {
                    throw new Error(result.error || 'Rota olu≈üturulamadƒ±');
                }

            } catch (error) {
                console.error('Route creation error:', error);
                showToast('Rota olu≈üturma hatasƒ±: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Dosya i√ße aktarma i≈ülemini temizle
        function clearFileImport() {
            // Dosya input'unu temizle
            document.getElementById('routeFileInput').value = '';
            
            // Durumlarƒ± gizle
            document.getElementById('fileParseStatus').style.display = 'none';
            document.getElementById('parseResult').style.display = 'none';
            document.getElementById('parseError').style.display = 'none';
            
            // Rota se√ßimini gizle
            document.getElementById('routeSelection').style.display = 'none';
            
            // Checkbox'ƒ± temizle
            document.getElementById('importWaypointsAsPois').checked = false;
            
            // Parse edilmi≈ü veriyi temizle
            parsedRouteData = null;
        }
    </script>
</body>

</html>