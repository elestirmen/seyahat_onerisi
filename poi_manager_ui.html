<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POI Y√∂netim Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        body {
            background: #f8f9fa;
        }

        .poi-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .pointer {
            cursor: pointer;
        }

        .pointer:hover {
            background-color: rgba(0, 123, 255, 0.1);
            transition: background-color 0.2s ease;
        }

        #map {
            height: 60vh;
            min-height: 350px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }

        /* Birle≈üik Panel Tab Stilleri */
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 8px 8px 0 0;
            background: transparent;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }

        .nav-tabs .nav-link:hover:not(.active) {
            background: #f8f9fa;
            color: #495057;
            transform: translateY(-2px);
        }

        .tab-content {
            border: none;
            padding: 0;
        }

        .tab-pane {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced POI Detail Styles in Details Tab */
        .poi-detail-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .poi-detail-info {
            background: white;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #007bff;
            margin-bottom: 16px;
        }

        .poi-detail-images {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e9ecef;
            margin-bottom: 16px;
        }

        .image-card-enhanced {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-card-enhanced:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25) !important;
        }

        .poi-detail-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-top: 1px solid #e9ecef;
        }

        .poi-detail-actions .btn {
            transition: all 0.2s ease;
        }

        .poi-detail-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .highlight-marker {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0.7);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            display: none;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .sortable:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }

        .table-responsive {
            border-radius: 8px;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-outline-primary:hover,
        .btn-outline-danger:hover {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }

        @media (max-width: 768px) {
            #map {
                height: 40vh;
            }

            .container-fluid {
                padding: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Y√ºkleniyor...</span>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">üó∫Ô∏è POI Y√∂netim Paneli</h2>
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <small class="text-muted">Oturum: </small>
                    <span class="badge bg-success" id="sessionStatus">Aktif</span>
                </div>
                <button type="button" class="btn btn-outline-warning btn-sm me-2" onclick="showPasswordChangeModal()" id="changePasswordBtn">
                    <i class="fas fa-key me-1"></i> ≈ûifre Deƒüi≈ütir
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="logout()" id="logoutBtn">
                    <i class="fas fa-sign-out-alt me-1"></i> √áƒ±kƒ±≈ü
                </button>
            </div>
        </div>

        <!-- Harita B√∂l√ºm√º -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Harita</h5>
                        <small class="text-muted">POI'leri g√∂rmek i√ßin haritaya tƒ±klayƒ±n. Yeni POI eklemek i√ßin haritada
                            bir noktaya √ßift tƒ±klayƒ±n.</small>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sol Panel: Birle≈üik POI Y√∂netim Paneli -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" id="panelTitle">üÜï Yeni POI Ekle</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="selectLocationFromMap()" id="mapSelectBtn">
                                    üìç Haritadan Se√ß
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info d-none" onclick="clearForm()" id="newPoiBtn">
                                    ‚ûï Yeni POI
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs mt-3" id="poiTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-content" type="button" role="tab">
                                    <i class="fas fa-edit me-1"></i>Form
                                </button>
                            </li>
                            <li class="nav-item" role="presentation" style="display: none;" id="details-tab-container">
                                <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-content" type="button" role="tab">
                                    <i class="fas fa-info-circle me-1"></i>Detaylar
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="card-body">
                        <div class="tab-content" id="poiTabContent">
                            <!-- Form Content -->
                            <div class="tab-pane fade show active" id="form-content" role="tabpanel">
                                <form id="poiForm">
                                    <input type="hidden" id="poiId">
                                    <div class="mb-2">
                                        <label class="form-label">Adƒ± *</label>
                                        <input type="text" class="form-control" id="poiName" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Kategori *</label>
                                        <select class="form-select" id="poiCategory" required>
                                            <option value="">Se√ßiniz</option>
                                            <option value="gastronomik">üçΩÔ∏è Gastronomik</option>
                                            <option value="kulturel">üèõÔ∏è K√ºlt√ºrel</option>
                                            <option value="sanatsal">üé® Sanatsal</option>
                                            <option value="doga_macera">üåø Doƒüa & Macera</option>
                                            <option value="konaklama">üè® Konaklama</option>
                                        </select>
                                    </div>
                                    <div class="row">
                                        <div class="col-6 mb-2">
                                            <label class="form-label">Enlem *</label>
                                            <input type="number" step="any" class="form-control" id="poiLat" required>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <label class="form-label">Boylam *</label>
                                            <input type="number" step="any" class="form-control" id="poiLon" required>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">A√ßƒ±klama</label>
                                        <textarea class="form-control" id="poiDesc" rows="3"></textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Etiketler</label>
                                        <input type="text" class="form-control" id="poiTags"
                                            placeholder="etiket1, etiket2, etiket3...">
                                    </div>
                                    
                                    <!-- POI Rating Sistemi (Yeni!) -->
                                    <div class="mb-3" id="ratingSystemSection">
                                        <label class="form-label">‚≠ê POI Nitelik Puanlarƒ± (0-100)</label>
                                        <div class="border rounded p-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                            <small class="text-muted mb-3 d-block">
                                                <i class="fas fa-info-circle text-primary"></i>
                                                Bu POI'nin farklƒ± niteliklerde ne kadar deƒüerli olduƒüunu 0-100 arasƒ± puanlayƒ±n.
                                            </small>
                                            
                                            <div class="row g-3">
                                                <!-- Tarihi -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #8B4513;">
                                                            <i class="fas fa-landmark me-1"></i> Tarihi
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_tarihi" oninput="updateRatingDisplay('tarihi', this.value)">
                                                            <span class="badge bg-secondary" id="rating_tarihi_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Sanat ve K√ºlt√ºr -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #9B59B6;">
                                                            <i class="fas fa-palette me-1"></i> Sanat & K√ºlt√ºr
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_sanat_kultur" oninput="updateRatingDisplay('sanat_kultur', this.value)">
                                                            <span class="badge bg-secondary" id="rating_sanat_kultur_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Doƒüa -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #27AE60;">
                                                            <i class="fas fa-leaf me-1"></i> Doƒüa
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_doga" oninput="updateRatingDisplay('doga', this.value)">
                                                            <span class="badge bg-secondary" id="rating_doga_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Eƒülence -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #E74C3C;">
                                                            <i class="fas fa-music me-1"></i> Eƒülence
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_eglence" oninput="updateRatingDisplay('eglence', this.value)">
                                                            <span class="badge bg-secondary" id="rating_eglence_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Alƒ±≈üveri≈ü -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #F39C12;">
                                                            <i class="fas fa-shopping-cart me-1"></i> Alƒ±≈üveri≈ü
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_alisveris" oninput="updateRatingDisplay('alisveris', this.value)">
                                                            <span class="badge bg-secondary" id="rating_alisveris_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Spor -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #34495E;">
                                                            <i class="fas fa-dumbbell me-1"></i> Spor
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_spor" oninput="updateRatingDisplay('spor', this.value)">
                                                            <span class="badge bg-secondary" id="rating_spor_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Macera -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #D35400;">
                                                            <i class="fas fa-mountain me-1"></i> Macera
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_macera" oninput="updateRatingDisplay('macera', this.value)">
                                                            <span class="badge bg-secondary" id="rating_macera_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Rahatlatƒ±cƒ± -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #1ABC9C;">
                                                            <i class="fas fa-spa me-1"></i> Rahatlatƒ±cƒ±
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_rahatlatici" oninput="updateRatingDisplay('rahatlatici', this.value)">
                                                            <span class="badge bg-secondary" id="rating_rahatlatici_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Yemek -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #E67E22;">
                                                            <i class="fas fa-utensils me-1"></i> Yemek
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_yemek" oninput="updateRatingDisplay('yemek', this.value)">
                                                            <span class="badge bg-secondary" id="rating_yemek_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Gece Hayatƒ± -->
                                                <div class="col-md-6">
                                                    <div class="rating-item">
                                                        <label class="form-label small fw-bold" style="color: #6C3483;">
                                                            <i class="fas fa-moon me-1"></i> Gece Hayatƒ±
                                                        </label>
                                                        <div class="d-flex align-items-center">
                                                            <input type="range" class="form-range me-2" min="0" max="100" value="0" 
                                                                   id="rating_gece_hayati" oninput="updateRatingDisplay('gece_hayati', this.value)">
                                                            <span class="badge bg-secondary" id="rating_gece_hayati_display">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Rating √ñzeti -->
                                            <div class="mt-3 p-2 bg-white rounded">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">
                                                        <i class="fas fa-chart-bar me-1"></i> Toplam Puan:
                                                    </small>
                                                    <span class="badge bg-primary fs-6" id="totalRatingScore">0/1000</span>
                                                </div>
                                                <div class="progress mt-1" style="height: 8px;">
                                                    <div class="progress-bar" id="totalRatingProgress" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Medya Y√∂netimi B√∂l√ºm√º (G√∂rsel, Video, Ses, 3D) -->
                                    <div class="mb-3" id="mediaManagementSection">
                                        <label class="form-label">üé¨ Medya Y√∂netimi</label>
                                        <div class="border rounded p-3 bg-light">
                                            <div class="mb-2">
                                                <input type="file" class="form-control form-control-sm" id="mediaFile" 
                                                       accept="image/*,video/*,audio/*,.glb,.gltf,.obj,.fbx,.dae,.ply,.stl">
                                                <small class="form-text text-muted">
                                                    <i class="fas fa-info-circle text-primary"></i>
                                                    <strong>Desteklenen formatlar:</strong><br>
                                                    üì∏ <strong>G√∂rsel:</strong> PNG, JPG, JPEG, GIF, WebP (Max: 15MB)<br>
                                                    üé• <strong>Video:</strong> MP4, AVI, MOV, WebM, MKV (Max: 100MB)<br>
                                                    üéµ <strong>Ses:</strong> MP3, WAV, OGG, M4A, AAC, FLAC (Max: 50MB)<br>
                                                    üßä <strong>3D Model:</strong> GLB, GLTF, OBJ, FBX, DAE, PLY, STL (Max: 50MB)
                                                </small>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <select class="form-select form-select-sm" id="mediaType" onchange="updateMediaTypeOptions()">
                                                        <option value="auto">üîç Otomatik Tespit</option>
                                                        <option value="image">üì∏ G√∂rsel</option>
                                                        <option value="video">üé• Video</option>
                                                        <option value="audio">üéµ Ses</option>
                                                        <option value="model_3d">üßä 3D Model</option>
                                                    </select>
                                                </div>
                                                <div class="col-6">
                                                    <input type="text" class="form-control form-control-sm" id="mediaCaption" placeholder="A√ßƒ±klama">
                                                </div>
                                            </div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="isPrimaryMedia">
                                                <label class="form-check-label" for="isPrimaryMedia">Ana medya</label>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary btn-sm mt-2 w-100" onclick="uploadPOIMedia()">
                                                üì§ Medya Y√ºkle
                                            </button>
                                        </div>
                                        
                                        <!-- Mevcut Medya Dosyalarƒ± -->
                                        <div id="currentMedia" class="mt-2"></div>
                                        
                                        <!-- Geriye Uyumluluk i√ßin Eski G√∂rsel B√∂l√ºm√º (Gizli) -->
                                        <div id="currentImages" class="mt-2" style="display: none;"></div>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-primary" id="saveBtn" onclick="handleFormSubmit(event)">üíæ Kaydet</button>
                                        <button type="button" class="btn btn-outline-danger d-none" id="deleteBtn" onclick="deleteCurrentPOI()">
                                            üóëÔ∏è POI'yi Sil
                                        </button>
                                        <button type="button" class="btn btn-secondary d-none" id="cancelEditBtn" onclick="clearForm()">
                                            ‚ùå ƒ∞ptal
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Details Content -->
                            <div class="tab-pane fade" id="details-content" role="tabpanel">
                                <div id="poiDetailContent">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                                        <p>POI detaylarƒ± burada g√∂r√ºnecek</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saƒü Panel: Liste -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">POI Listesi</h5>
                            </div>
                            <div class="col-auto">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchPOI" placeholder="POI ara...">
                                    <select id="filterCategory" class="form-select">
                                        <option value="">T√ºm Kategoriler</option>
                                        <option value="gastronomik">üçΩÔ∏è Gastronomik</option>
                                        <option value="kulturel">üèõÔ∏è K√ºlt√ºrel</option>
                                        <option value="sanatsal">üé® Sanatsal</option>
                                        <option value="doga_macera">üåø Doƒüa & Macera</option>
                                        <option value="konaklama">üè® Konaklama</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body poi-list p-0">
                        <table class="table table-hover mb-0" id="poiTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-sort="name">Adƒ± <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th class="sortable" data-sort="category">Kategori <span class="sort-icon">‚ÜïÔ∏è</span>
                                    </th>
                                    <th class="sortable" data-sort="lat">Enlem <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th class="sortable" data-sort="lon">Boylam <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="poiTableBody"></tbody>
                        </table>
                        <div class="text-center p-3 d-none" id="noDataMessage">
                            <p class="text-muted mb-0">Herhangi bir POI bulunamadƒ±.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const apiBase = '/api';
        let map;
        let csrfToken = null;

        // Authentication functions
        async function checkAuthStatus() {
            console.log('üîê Checking auth status...');
            try {
                const response = await fetch('/auth/status');
                console.log('üîê Auth status response:', response.status, response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üîê Auth status data:', data);
                    
                    if (data.authenticated) {
                        csrfToken = data.csrf_token;
                        console.log('üîê Authentication successful, CSRF token:', csrfToken);
                        updateSessionStatus(data.session_info);
                        return true;
                    } else {
                        console.log('üîê Not authenticated');
                    }
                } else {
                    console.log('üîê Auth status request failed');
                }
                // If not authenticated, redirect to login
                console.log('üîê Redirecting to login...');
                window.location.href = '/auth/login';
                return false;
            } catch (error) {
                console.error('üîê Auth status check failed:', error);
                window.location.href = '/auth/login';
                return false;
            }
        }

        function updateSessionStatus(sessionInfo) {
            const statusElement = document.getElementById('sessionStatus');
            if (sessionInfo) {
                statusElement.textContent = 'Aktif';
                statusElement.className = 'badge bg-success';
                
                // Update session timeout warning if needed
                if (sessionInfo.expires_at) {
                    const expiresAt = new Date(sessionInfo.expires_at);
                    const now = new Date();
                    const timeLeft = expiresAt - now;
                    
                    // Show different status based on time left
                    if (timeLeft <= 0) {
                        statusElement.textContent = 'S√ºresi Doldu';
                        statusElement.className = 'badge bg-danger';
                        // Redirect to login
                        setTimeout(() => {
                            window.location.href = '/auth/login';
                        }, 1000);
                    } else if (timeLeft < 5 * 60 * 1000) { // Less than 5 minutes
                        const minutesLeft = Math.floor(timeLeft / (60 * 1000));
                        const secondsLeft = Math.floor((timeLeft % (60 * 1000)) / 1000);
                        statusElement.textContent = `${minutesLeft}:${secondsLeft.toString().padStart(2, '0')}`;
                        statusElement.className = 'badge bg-danger';
                    } else if (timeLeft < 10 * 60 * 1000) { // Less than 10 minutes
                        const minutesLeft = Math.floor(timeLeft / (60 * 1000));
                        statusElement.textContent = `${minutesLeft}dk kaldƒ±`;
                        statusElement.className = 'badge bg-warning';
                    }
                }
            } else {
                statusElement.textContent = 'Bilinmiyor';
                statusElement.className = 'badge bg-secondary';
            }
        }

        async function logout() {
            if (!confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        csrf_token: csrfToken
                    })
                });

                if (response.ok) {
                    showToast('Ba≈üarƒ±yla √ßƒ±kƒ±≈ü yapƒ±ldƒ±', 'success');
                    setTimeout(() => {
                        window.location.href = '/auth/login';
                    }, 1000);
                } else {
                    const error = await response.json();
                    showToast('√áƒ±kƒ±≈ü yapƒ±lƒ±rken hata olu≈ütu: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showToast('√áƒ±kƒ±≈ü yapƒ±lƒ±rken hata olu≈ütu', 'error');
                // Force redirect even if logout request failed
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 2000);
            }
        }

        // Enhanced fetch function with authentication
        async function authenticatedFetch(url, options = {}) {
            // Add CSRF token to requests that modify data
            if (options.method && ['POST', 'PUT', 'DELETE'].includes(options.method.toUpperCase())) {
                if (!options.headers) {
                    options.headers = {};
                }
                
                if (options.body && typeof options.body === 'string') {
                    try {
                        const bodyData = JSON.parse(options.body);
                        bodyData.csrf_token = csrfToken;
                        options.body = JSON.stringify(bodyData);
                    } catch (e) {
                        // If body is not JSON, add CSRF token as form data
                        if (options.body instanceof FormData) {
                            options.body.append('csrf_token', csrfToken);
                        }
                    }
                } else if (options.body instanceof FormData) {
                    options.body.append('csrf_token', csrfToken);
                }
            }

            const response = await fetch(url, options);
            
            // Handle authentication errors
            if (response.status === 401) {
                showToast('Oturum s√ºresi doldu, yeniden giri≈ü yapƒ±lƒ±yor...', 'warning');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 2000);
                throw new Error('Authentication required');
            }
            
            return response;
        }
        let poiMarkers = [];
        let allPOIs = [];
        let currentSort = { field: 'name', direction: 'asc' };
        let isSelectingLocation = false;
        let selectedPOI = null;
        let highlightedMarker = null; // Vurgulanan POI marker'ƒ±

        // Harita ba≈ülatma
        function initMap() {
            map = L.map('map').setView([38.6322, 34.9115], 16); // √úrg√ºp merkezi

            // Farklƒ± harita katmanlarƒ± tanƒ±mla
            const baseLayers = {
                "üó∫Ô∏è OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 20
                }),

                "üõ∞Ô∏è Uydu G√∂r√ºnt√ºs√º": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri, Maxar, Earthstar Geographics',
                    maxZoom: 19
                }),

                "üèîÔ∏è Topografik": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenTopoMap (CC-BY-SA)',
                    maxZoom: 17
                }),

                "üé® CartoDB Positron": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap ¬© CartoDB',
                    maxZoom: 19
                }),

                "üåô CartoDB Dark": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap ¬© CartoDB',
                    maxZoom: 19
                })
            };

            // Varsayƒ±lan katmanƒ± ekle
            baseLayers["üó∫Ô∏è OpenStreetMap"].addTo(map);

            // Katman kontrol√ºn√º ekle
            L.control.layers(baseLayers).addTo(map);

            // Haritaya √ßift tƒ±klama ile POI ekleme
            map.on('dblclick', function (e) {
                if (!isSelectingLocation) {
                    const { lat, lng } = e.latlng;
                    document.getElementById('poiLat').value = lat.toFixed(6);
                    document.getElementById('poiLon').value = lng.toFixed(6);
                    document.getElementById('poiName').focus();
                    showToast('Konum se√ßildi! POI bilgilerini doldurun.', 'success');
                }
            });

            // Haritadan konum se√ßme modu
            map.on('click', function (e) {
                if (isSelectingLocation) {
                    const { lat, lng } = e.latlng;
                    document.getElementById('poiLat').value = lat.toFixed(6);
                    document.getElementById('poiLon').value = lng.toFixed(6);
                    exitLocationSelectionMode();
                    showToast('Konum se√ßildi!', 'success');
                }
            });
        }

        // Konum se√ßme modu
        function selectLocationFromMap() {
            isSelectingLocation = true;
            document.getElementById('mapSelectBtn').innerHTML = '‚ùå ƒ∞ptal';
            document.getElementById('mapSelectBtn').onclick = exitLocationSelectionMode;
            map.getContainer().style.cursor = 'crosshair';
            showToast('Haritadan bir konum se√ßin...', 'info');
        }

        function exitLocationSelectionMode() {
            isSelectingLocation = false;
            document.getElementById('mapSelectBtn').innerHTML = 'üìç Haritadan Se√ß';
            document.getElementById('mapSelectBtn').onclick = selectLocationFromMap;
            map.getContainer().style.cursor = '';
        }

        // Loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Toast bildirimleri
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Loading states
        function showLoading() {
            // Kaydet butonuna loading ekle
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Kaydediliyor...';
                saveBtn.disabled = true;
            }

            // POI tablosuna loading overlay ekle
            const poiTableContainer = document.querySelector('.table-responsive');
            if (poiTableContainer && !document.getElementById('tableLoading')) {
                const overlay = document.createElement('div');
                overlay.id = 'tableLoading';
                overlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;
                overlay.innerHTML = '<div class="spinner-border text-primary"></div>';
                poiTableContainer.style.position = 'relative';
                poiTableContainer.appendChild(overlay);
            }
        }

        function hideLoading() {
            // Kaydet butonunu resetle
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.innerHTML = 'üíæ Kaydet';
                saveBtn.disabled = false;
            }

            // Table loading overlay'i kaldƒ±r
            const overlay = document.getElementById('tableLoading');
            if (overlay) {
                overlay.remove();
            }
        }

        // POI'leri getir
        async function fetchPOIs(category = '') {
            console.log('üîç fetchPOIs called with category:', category);
            console.log('üîç apiBase:', apiBase);
            console.log('üîç csrfToken:', csrfToken);
            
            showLoading();
            try {
                const url = `${apiBase}/pois${category ? `?category=${encodeURIComponent(category)}` : ''}`;
                console.log('üîç Fetching URL:', url);

                // Timeout ile fetch
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000); // 10 saniye timeout

                console.log('üîç Making authenticated fetch request...');
                const response = await authenticatedFetch(url, {
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                clearTimeout(timeout);
                
                console.log('üîç Response status:', response.status);
                console.log('üîç Response ok:', response.ok);

                if (!response.ok) {
                    throw new Error(`API call failed with status ${response.status}`);
                }
                const data = await response.json();

                let pois = [];
                if (category) {
                    // A single category is returned as an array of POIs
                    pois = data.map(poi => ({ ...poi, category: category }));
                } else {
                    // All POIs are returned in a structured object by category
                    for (const cat in data) {
                        if (Array.isArray(data[cat])) {
                            const categoryPois = data[cat].map(poi => ({ ...poi, category: cat }));
                            pois.push(...categoryPois);
                        }
                    }
                }

                allPOIs = pois;
                filterAndSortPOIs(); // This function calls renderPOITable and updateMapMarkers
            } catch (error) {
                console.error('Error fetching POIs:', error);
                if (error.name === 'AbortError') {
                    showToast('ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.', 'error');
                } else if (error.message.includes('fetch')) {
                    showToast('Sunucuya baƒülanƒ±lamƒ±yor. API √ßalƒ±≈üƒ±yor mu kontrol edin.', 'error');
                } else {
                    showToast('POIs could not be loaded: ' + error.message, 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // Harita markerlarƒ±nƒ± g√ºncelle
        function updateMapMarkers(pois) {
            // Mevcut markerlarƒ± ve vurgulamayƒ± temizle
            poiMarkers.forEach(marker => map.removeLayer(marker));
            poiMarkers = [];

            // Vurgulama marker'ƒ±nƒ± da temizle
            if (highlightedMarker) {
                map.removeLayer(highlightedMarker);
                highlightedMarker = null;
            }

            // Kategori renkleri
            const categoryColors = {
                'gastronomik': '#e74c3c',
                'kulturel': '#3498db',
                'sanatsal': '#2ecc71',
                'doga_macera': '#f39c12',
                'konaklama': '#9b59b6'
            };

            // Yeni markerlarƒ± ekle
            pois.forEach(poi => {
                if (poi.latitude === undefined || poi.longitude === undefined) {
                    console.warn('Skipping POI with missing coordinates:', poi);
                    return;
                }
                const marker = L.circleMarker([poi.latitude, poi.longitude], {
                    color: '#ffffff',
                    fillColor: categoryColors[poi.category] || '#666',
                    fillOpacity: 0.9,
                    radius: 12,
                    weight: 3,
                    opacity: 1
                }).addTo(map);

                marker.bindPopup(`
            <strong>${poi.name}</strong><br>
            <small>${getCategoryDisplayName(poi.category)}</small><br>
            <button class="btn btn-sm btn-primary mt-1" onclick="showPOIDetail('${poi._id}')">Details</button>
        `);

                marker.on('click', () => {
                    showPOIDetail(poi._id);
                });

                poiMarkers.push(marker);
            });
        }

        // Kategori g√∂r√ºnt√º adƒ±nƒ± getir
        function getCategoryDisplayName(category) {
            const names = {
                'gastronomik': 'üçΩÔ∏è Gastronomik',
                'kulturel': 'üèõÔ∏è K√ºlt√ºrel',
                'sanatsal': 'üé® Sanatsal',
                'doga_macera': 'üåø Doƒüa & Macera',
                'konaklama': 'üè® Konaklama'
            };
            return names[category] || category;
        }

        // POI'yi haritada vurgula
        function highlightPOIOnMap(poiId) {
            console.log('üéØ highlightPOIOnMap called with ID:', poiId);
            console.log('üìä Total POIs in allPOIs:', allPOIs.length);

            // √ñnceki vurgulamayƒ± temizle
            if (highlightedMarker) {
                map.removeLayer(highlightedMarker);
                highlightedMarker = null;
            }

            // POI'yi bul - hem string hem number kar≈üƒ±la≈ütƒ±rmasƒ±
            const poi = allPOIs.find(p => p._id == poiId || p._id === poiId || p._id === parseInt(poiId) || p._id === String(poiId));
            console.log('üîç Found POI:', poi);
            console.log('üîç Searching for ID (type):', poiId, typeof poiId);
            console.log('üîç Available IDs in allPOIs:', allPOIs.map(p => ({ id: p._id, type: typeof p._id })));

            if (!poi) {
                console.warn('‚ùå POI not found with ID:', poiId);
                showToast(`POI bulunamadƒ± (ID: ${poiId}, Type: ${typeof poiId})`, 'error');
                return;
            }

            if (poi.latitude === undefined || poi.longitude === undefined) {
                console.warn('‚ùå POI missing coordinates:', poi);
                showToast(`POI koordinatlarƒ± eksik: ${poi.name}`, 'error');
                return;
            }

            // Vurgulama marker'ƒ± olu≈ütur
            highlightedMarker = L.circleMarker([poi.latitude, poi.longitude], {
                color: '#ff0000',
                fillColor: '#ff0000',
                fillOpacity: 0.3,
                radius: 15,
                weight: 3,
                className: 'highlight-marker'
            }).addTo(map);

            // Haritayƒ± POI'ye odakla
            map.setView([poi.latitude, poi.longitude], Math.max(map.getZoom(), 15), {
                animate: true,
                duration: 0.5
            });

            // Kullanƒ±cƒ±ya bilgi ver
            showToast(`üìç "${poi.name}" haritada vurgulandƒ±`, 'success');

            // Vurgulama animasyonu i√ßin pulse efekti
            let pulseCount = 0;
            const pulseInterval = setInterval(() => {
                if (highlightedMarker && pulseCount < 6) {
                    const currentRadius = highlightedMarker.getRadius();
                    highlightedMarker.setRadius(currentRadius === 15 ? 20 : 15);
                    pulseCount++;
                } else {
                    clearInterval(pulseInterval);
                    if (highlightedMarker) {
                        highlightedMarker.setRadius(15);
                    }
                }
            }, 200);
        }

        // POI tablosunu render et
        function renderPOITable(pois) {
            const tbody = document.getElementById('poiTableBody');
            const noDataMessage = document.getElementById('noDataMessage');

            if (pois.length === 0) {
                tbody.innerHTML = '';
                noDataMessage.classList.remove('d-none');
                return;
            }

            noDataMessage.classList.add('d-none');
            tbody.innerHTML = '';

            pois.forEach(poi => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                                                <td class="pointer text-primary" onclick="
                                        console.log('üñ±Ô∏è POI tƒ±klandƒ±:', '${poi.name}', 'ID:', ${poi._id});
                                        try {
                                            highlightPOIOnMap(${poi._id}); 
                                            showPOIDetail(${poi._id});
                                            autoLoadRatingsOnPOIChange(${poi._id});
                                        } catch(e) {
                                            console.error('‚ùå POI tƒ±klama hatasƒ±:', e);
                                            autoLoadRatingsOnPOIChange(${poi._id});
                                        }
                                    " title="Haritada g√∂ster ve detaylarƒ± a√ß">${poi.name}</td>
            <td class="pointer" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">${getCategoryDisplayName(poi.category)}</td>
            <td class="pointer text-muted" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">${(poi.latitude || 0).toFixed(6)}</td>
            <td class="pointer text-muted" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">${(poi.longitude || 0).toFixed(6)}</td>
            <td>
                <button class="btn btn-outline-primary btn-sm me-1" onclick="editPOI(${poi._id})" title="Edit">‚úèÔ∏è</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deletePOI(${poi._id})" title="Delete">üóëÔ∏è</button>
                <button class="btn btn-outline-success btn-sm" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">üìç</button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // POI detayƒ±nƒ± g√∂ster - Yeni birle≈üik panel i√ßin g√ºncellendi
        async function showPOIDetail(poiId) {
            console.log('üéØ showPOIDetail √áAƒûRILDI! POI ID:', poiId);
            showLoading();
            try {
                console.log('üì° POI detayƒ± API\'den alƒ±nƒ±yor...');
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}`);
                if (!response.ok) throw new Error('POI not found');
                const poi = await response.json();
                console.log('‚úÖ POI detayƒ± alƒ±ndƒ±:', poi.name);

                selectedPOI = poi;

                // Form alanlarƒ±nƒ± doldur (d√ºzenleme i√ßin hazƒ±r hale getir)
                document.getElementById('poiId').value = poi._id;
                document.getElementById('poiName').value = poi.name;
                document.getElementById('poiCategory').value = poi.category;
                document.getElementById('poiLat').value = poi.latitude;
                document.getElementById('poiLon').value = poi.longitude;
                document.getElementById('poiDesc').value = poi.description || '';
                document.getElementById('poiTags').value = (poi.tags || []).join(', ');

                // Bootstrap tab ge√ßi≈üi - FORM tab'ƒ±nƒ± aktif yap ki rating'ler g√∂r√ºns√ºn
                const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
                formTab.show();
                
                // Rating'leri y√ºkle - BASƒ∞T VERSƒ∞YON
                setTimeout(() => {
                    console.log('üöÄ POI deƒüi≈üti, rating\'ler y√ºklenecek. POI ID:', poi._id);
                    loadPOIRatings(poi._id);
                }, 500); // Biraz daha uzun bekle

                // Formu d√ºzenleme moduna ge√ßir
                document.getElementById('saveBtn').innerHTML = 'üîÑ G√ºncelle';
                document.getElementById('deleteBtn').classList.remove('d-none');
                document.getElementById('cancelEditBtn').classList.remove('d-none');

                // Panel ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
                document.getElementById('panelTitle').textContent = `üìù ${poi.name}`;
                document.getElementById('newPoiBtn').classList.remove('d-none');

                // Detaylar tab'ƒ±nƒ± g√∂ster
                document.getElementById('details-tab-container').style.display = 'block';

                // Detay HTML'ini olu≈ütur
                let detailHtml = `
                    <div class="poi-detail-header">
                        <h5 class="mb-2 fw-bold">${poi.name}</h5>
                        <span class="badge bg-light text-dark fs-6">${getCategoryDisplayName(poi.category)}</span>
                    </div>
                    
                    <div class="poi-detail-info">
                        <p class="mb-2"><i class="fas fa-map-marker-alt text-danger me-2"></i> <strong>Konum:</strong> ${poi.latitude.toFixed(6)}, ${poi.longitude.toFixed(6)}</p>`;

                if (poi.description) {
                    detailHtml += `<p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i> <strong>A√ßƒ±klama:</strong> ${poi.description}</p>`;
                }
                if (poi.tags && poi.tags.length > 0) {
                    detailHtml += `<p class="mb-2"><i class="fas fa-tags text-success me-2"></i> <strong>Etiketler:</strong> ${poi.tags.join(', ')}</p>`;
                }
                
                detailHtml += `</div>`;

                // G√∂rselleri y√ºkle ve g√∂ster
                try {
                    const imagesResponse = await authenticatedFetch(`${apiBase}/poi/${poiId}/images`);
                    if (imagesResponse.ok) {
                        const imagesData = await imagesResponse.json();
                        const images = imagesData.images || [];
                        
                        if (images.length > 0) {
                            detailHtml += `
                                <div class="poi-detail-images mt-3">
                                    <h6 class="mb-3"><i class="fas fa-images text-warning"></i> G√∂rseller (${images.length})</h6>
                                    <div class="row g-3">`;
                            
                            images.forEach((image, index) => {
                                const imagePath = image.thumbnail_path || image.path;
                                const fullImagePath = image.path;
                                detailHtml += `
                                    <div class="col-6">
                                        <div class="image-card-enhanced" style="position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                            <img src="/${imagePath}" 
                                                 class="img-fluid" 
                                                 style="height: 120px; width: 100%; object-fit: cover; cursor: pointer; transition: transform 0.3s ease;" 
                                                 alt="${image.filename}"
                                                 onclick="showImageModal('/${fullImagePath}', '${poi.name}', '${image.filename}')"
                                                 onmouseover="this.style.transform='scale(1.05)'"
                                                 onmouseout="this.style.transform='scale(1)'">
                                            <div class="image-info-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 8px 12px;">
                                                <small class="text-white fw-bold">${getImageTypeIcon(image.filename)} ${(image.size / 1024).toFixed(0)}KB</small>
                                            </div>
                                            <button class="image-delete-btn-enhanced btn btn-danger" 
                                                    style="position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; padding: 0; font-size: 0.9rem; z-index: 10; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(220,53,69,0.4); transition: all 0.3s ease;"
                                                    onclick="deletePOIImageWithConfirm('${poi._id}', '${image.filename}', this)"
                                                    title="G√∂rseli sil - ${image.filename}"
                                                    onmouseover="this.style.transform='scale(1.2)'; this.style.boxShadow='0 6px 16px rgba(220,53,69,0.6)'"
                                                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(220,53,69,0.4)'">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>`;
                            });
                            
                            detailHtml += `
                                    </div>
                                </div>`;
                        }
                    }
                } catch (imageError) {
                    console.log('G√∂rseller y√ºklenemedi:', imageError);
                }


                detailHtml += `
                    <div class="poi-detail-actions">
                        <button class="btn btn-primary btn-sm" onclick="focusOnMap(${poi.latitude}, ${poi.longitude})">
                            <i class="fas fa-crosshairs me-1"></i> Haritada G√∂ster
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="switchToFormTab()">
                            <i class="fas fa-edit me-1"></i> D√ºzenle
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCurrentPOI()">
                            <i class="fas fa-trash me-1"></i> Sil
                        </button>
                    </div>`;

                document.getElementById('poiDetailContent').innerHTML = detailHtml;

                // Mevcut g√∂rselleri form b√∂l√ºm√ºnde de y√ºkle
                await loadPOIImages(poiId);

            } catch (error) {
                console.error('‚ùå showPOIDetail HATASI:', error);
                showToast('POI detaylarƒ± y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
                
                // Hata durumunda da rating'leri temizle
                setDefaultRatings();
            } finally {
                hideLoading();
            }
        }

        // Form tab'ƒ±na ge√ßi≈ü yap
        function switchToFormTab() {
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();
        }

        // Mevcut POI'yi sil
        async function deleteCurrentPOI() {
            const poiId = document.getElementById('poiId').value;
            if (poiId) {
                await deletePOI(poiId);
            }
        }

        // Haritada odaklan
        function focusOnMap(lat, lon) {
            map.setView([lat, lon], 16);
        }

        // POI d√ºzenle - Yeni birle≈üik panel i√ßin g√ºncellendi
        async function editPOI(poiId) {
            console.log('üéØ editPOI BA≈ûLADI, POI ID:', poiId);
            
            // √ñnce POI detaylarƒ±nƒ± y√ºkle
            await showPOIDetail(poiId);
            
            // Form tab'ƒ±na ge√ß ve tab deƒüi≈üimi tamamlanana kadar bekle
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();
            
            // Tab deƒüi≈üimi event'ini dinle
            document.getElementById('form-tab').addEventListener('shown.bs.tab', function tabShownHandler() {
                console.log('üìã Form tab aktif oldu, rating\'ler y√ºkleniyor...');
                
                // Event listener'ƒ± kaldƒ±r (sadece bir kez √ßalƒ±≈üsƒ±n)
                document.getElementById('form-tab').removeEventListener('shown.bs.tab', tabShownHandler);
                
                // Rating'leri y√ºkle
                setTimeout(() => {
                    loadRatingsSimple(poiId);
                }, 200);
            });
            
            // Fallback - eƒüer event √ßalƒ±≈ümazsa
            setTimeout(() => {
                console.log('üîÑ Fallback: Rating\'ler y√ºkleniyor...');
                loadRatingsSimple(poiId);
            }, 2000);
            
            showToast('POI d√ºzenleme moduna ge√ßildi', 'info');
        }

        // Form temizle ve yeni POI moduna ge√ß
        function clearForm() {
            document.getElementById('poiForm').reset();
            document.getElementById('poiId').value = '';
            document.getElementById('saveBtn').innerHTML = 'üíæ Kaydet';
            document.getElementById('deleteBtn').classList.add('d-none');
            document.getElementById('cancelEditBtn').classList.add('d-none');
            document.getElementById('panelTitle').textContent = 'üÜï Yeni POI Ekle';
            document.getElementById('newPoiBtn').classList.add('d-none');
            
            // Detaylar tab'ƒ±nƒ± gizle ve form tab'ƒ±nƒ± aktif yap
            document.getElementById('details-tab-container').style.display = 'none';
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();
            
            // Detay content'ini temizle
            document.getElementById('poiDetailContent').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>POI detaylarƒ± burada g√∂r√ºnecek</p>
                </div>
            `;
            
            // Mevcut g√∂rseller alanƒ±nƒ± temizle
            document.getElementById('currentImages').innerHTML = '';
            
            // Rating'leri sƒ±fƒ±rla
            setDefaultRatings();
            
            selectedPOI = null;
            showToast('Yeni POI ekleme moduna ge√ßildi', 'info');
        }

        // Form g√∂nder - Tamamen yeni yakla≈üƒ±m
        function handleFormSubmit(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üöÄ Form submit ba≈üladƒ±');
            
            // √áift submit'i √∂nle
            const submitBtn = document.getElementById('saveBtn');
            if (submitBtn.disabled) {
                console.log('‚ö†Ô∏è Form zaten g√∂nderiliyor, √ßift submit √∂nlendi');
                return false;
            }
            
            submitBtn.disabled = true;
            showLoading();
            
            // Async i≈ülemi ayrƒ± fonksiyonda yap
            processFormSubmit();
            return false;
        }
        
        async function processFormSubmit() {

            try {
                const idVal = document.getElementById('poiId').value;
                const name = document.getElementById('poiName').value.trim();
                const category = document.getElementById('poiCategory').value;
                const lat = parseFloat(document.getElementById('poiLat').value);
                const lon = parseFloat(document.getElementById('poiLon').value);
                const description = document.getElementById('poiDesc').value;
                const tags = document.getElementById('poiTags').value.split(',').map(t => t.trim()).filter(Boolean);
                // Rating'leri al
                const ratings = getRatingValues();
                
                const poiData = {
                    name, category, latitude: lat, longitude: lon,
                    description, tags, ratings
                };

                let response;
                if (idVal) {
                    // G√ºncelle
                    response = await authenticatedFetch(`${apiBase}/poi/${idVal}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                } else {
                    // Ekle
                    response = await authenticatedFetch(`${apiBase}/poi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                }

                if (response.ok) {
                    const isUpdate = idVal ? true : false;
                    showToast(isUpdate ? 'POI ba≈üarƒ±yla g√ºncellendi!' : 'POI ba≈üarƒ±yla eklendi!', 'success');
                    
                    if (isUpdate) {
                        // G√ºncelleme sonrasƒ± detaylarƒ± yenile
                        await showPOIDetail(idVal);
                        showToast('POI detaylarƒ± g√ºncellendi', 'info');
                    } else {
                        // Yeni POI eklendikten sonra formu temizle
                        clearForm();
                    }
                    
                    await fetchPOIs(document.getElementById('filterCategory').value);
                } else {
                    throw new Error('ƒ∞≈ülem ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                showToast('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
            } finally {
                hideLoading();
                // Submit butonunu tekrar aktif et
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        // Form submit event'i artƒ±k gerekli deƒüil - buton onclick kullanƒ±yor

        // POI sil
        async function deletePOI(poiId) {
            const poiToDelete = allPOIs.find(p => p._id === poiId);
            const poiName = poiToDelete ? poiToDelete.name : "Unknown POI";
            if (!confirm(`Are you sure you want to delete "${poiName}"?\n\nThis will set the POI as inactive.`)) return;

            showLoading();
            try {
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('POI successfully deleted!', 'success');
                    await fetchPOIs(document.getElementById('filterCategory').value);
                } else {
                    throw new Error('Deletion failed');
                }
            } catch (error) {
                showToast('Error during deletion: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Arama ve filtreleme
        function filterAndSortPOIs() {
            const searchTerm = document.getElementById('searchPOI').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;

            let filteredPOIs = allPOIs.filter(poi => {
                const matchesSearch = poi.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || poi.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            // Sƒ±ralama
            filteredPOIs.sort((a, b) => {
                let aVal = a[currentSort.field];
                let bVal = b[currentSort.field];

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (currentSort.direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });

            updateMapMarkers(filteredPOIs);
            renderPOITable(filteredPOIs);
        }

        // Sƒ±ralama
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('sortable') || e.target.parentElement.classList.contains('sortable')) {
                const sortField = e.target.dataset.sort || e.target.parentElement.dataset.sort;

                if (currentSort.field === sortField) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = sortField;
                    currentSort.direction = 'asc';
                }

                // Sƒ±ralama iconlarƒ±nƒ± g√ºncelle
                document.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.textContent = '‚ÜïÔ∏è';
                });

                const currentIcon = document.querySelector(`[data-sort="${sortField}"] .sort-icon`);
                if (currentIcon) {
                    currentIcon.textContent = currentSort.direction === 'asc' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                }

                filterAndSortPOIs();
            }
        });

        // Form validation ve submit
        function validatePOIForm() {
            const name = document.getElementById('poiName').value.trim();
            const lat = parseFloat(document.getElementById('poiLat').value);
            const lng = parseFloat(document.getElementById('poiLon').value);
            const category = document.getElementById('poiCategory').value;

            if (!name) {
                showToast('POI adƒ± gerekli!', 'error');
                return false;
            }

            if (name.length < 2) {
                showToast('POI adƒ± en az 2 karakter olmalƒ±!', 'error');
                return false;
            }

            if (isNaN(lat) || lat < -90 || lat > 90) {
                showToast('Ge√ßerli bir enlem deƒüeri girin (-90 ile 90 arasƒ±nda)!', 'error');
                return false;
            }

            if (isNaN(lng) || lng < -180 || lng > 180) {
                showToast('Ge√ßerli bir boylam deƒüeri girin (-180 ile 180 arasƒ±nda)!', 'error');
                return false;
            }

            if (!category) {
                showToast('Kategori se√ßimi gerekli!', 'error');
                return false;
            }

            return true;
        }

        // Form submit handler
        document.getElementById('poiForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!validatePOIForm()) {
                return;
            }

            showLoading();
            try {
                const idVal = document.getElementById('poiId').value;
                const name = document.getElementById('poiName').value.trim();
                const latitude = parseFloat(document.getElementById('poiLat').value);
                const longitude = parseFloat(document.getElementById('poiLon').value);
                const category = document.getElementById('poiCategory').value;
                const description = document.getElementById('poiDesc').value.trim();
                const tags = document.getElementById('poiTags').value.trim();

                const poiData = {
                    name, category, latitude, longitude,
                    description, tags
                };

                let response;
                if (idVal) {
                    // G√ºncelle
                    response = await fetch(`${apiBase}/poi/${idVal}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                } else {
                    // Ekle
                    response = await fetch(`${apiBase}/poi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                }

                if (response.ok) {
                    const isUpdate = idVal ? true : false;
                    let finalPoiId = idVal;
                    
                    // Yeni POI eklendiyse response'dan ID'yi al
                    if (!isUpdate) {
                        const responseData = await response.json();
                        finalPoiId = responseData.id;
                    }
                    
                    // Rating'leri kaydet
                    const ratings = getRatingValues();
                    const ratingSaved = await savePOIRatings(finalPoiId, ratings);
                    
                    showToast(isUpdate ? 'POI ba≈üarƒ±yla g√ºncellendi!' : 'POI ba≈üarƒ±yla eklendi!', 'success');
                    
                    if (ratingSaved) {
                        showToast('Rating\'ler kaydedildi', 'success');
                    } else {
                        showToast('Rating kaydetme sƒ±rasƒ±nda sorun olu≈ütu', 'warning');
                    }
                    
                    if (isUpdate) {
                        // G√ºncelleme sonrasƒ± detaylarƒ± yenile
                        await showPOIDetail(finalPoiId);
                        showToast('POI detaylarƒ± g√ºncellendi', 'info');
                    } else {
                        // Yeni POI eklendikten sonra formu temizle
                        clearForm();
                    }
                    
                    await fetchPOIs(document.getElementById('filterCategory').value);
                } else {
                    throw new Error('ƒ∞≈ülem ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                showToast('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        // Event listeners
        document.getElementById('searchPOI').addEventListener('input', filterAndSortPOIs);
        document.getElementById('filterCategory').addEventListener('change', function () {
            fetchPOIs(this.value);
        });

        // G√∂rsel modal ve yardƒ±mcƒ± fonksiyonlar
        function showImageModal(imagePath, poiName, filename) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">üì∏ ${filename}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imagePath}" class="img-fluid rounded shadow" alt="${poiName}" style="max-height: 70vh;">
                            <div class="mt-2">
                                <small class="text-muted">${poiName}</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="${imagePath}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt"></i> Yeni Sekmede A√ß
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        function getImageTypeIcon(filename) {
            const name = filename.toLowerCase();
            if (name.includes('exterior') || name.includes('dis')) return 'üè¢';
            if (name.includes('interior') || name.includes('ic')) return 'üè†';
            if (name.includes('food') || name.includes('yemek')) return 'üçΩÔ∏è';
            if (name.includes('menu')) return 'üìã';
            if (name.includes('logo')) return 'üè∑Ô∏è';
            return 'üì∑';
        }

        // Medya y√∂netimi fonksiyonlarƒ±
        function updateMediaTypeOptions() {
            // Gelecekte medya t√ºr√ºne g√∂re ek se√ßenekler eklenebilir
        }
        
        function getMediaTypeIcon(mediaType, filename) {
            switch(mediaType) {
                case 'image': return 'üì∏';
                case 'video': return 'üé•';
                case 'audio': return 'üéµ';
                case 'model_3d': return 'üßä';
                default: return 'üìÑ';
            }
        }
        
        function getMediaMaxSize(mediaType) {
            const sizes = {
                'image': 15,
                'video': 100,
                'audio': 50,
                'model_3d': 50
            };
            return sizes[mediaType] || 15;
        }

        // Rating sistemi fonksiyonlarƒ±
        
        // POI se√ßiminde otomatik rating y√ºkleme (fallback)
        function autoLoadRatingsOnPOIChange(poiId) {
            if (!poiId) return;
            
            console.log('üîÑ autoLoadRatingsOnPOIChange √ßaƒürƒ±ldƒ±. POI ID:', poiId);
            
            // 1 saniye sonra kontrol et ve zorla doƒüru rating'leri y√ºkle
            setTimeout(() => {
                console.log('üîç Backup kontrol ba≈ülƒ±yor. POI ID:', poiId);
                
                fetch(`${apiBase}/poi/${poiId}/ratings`)
                    .then(r => r.json())
                    .then(data => {
                        console.log('üîç Backup API response:', data.ratings);
                        
                        // Mevcut slider deƒüerlerini kontrol et
                        const currentDoga = document.getElementById('rating_doga')?.value || 0;
                        const expectedDoga = data.ratings?.doga || 0;
                        
                        console.log(`üîç Doƒüa slider kontrol: mevcut=${currentDoga}, beklenen=${expectedDoga}`);
                        
                        // ZORLA rating'leri g√ºncelle
                        console.log('‚ö° Rating deƒüerleri ZORLA g√ºncelleniyor...');
                        updateSlidersDirectly(data.ratings || {});
                    })
                    .catch(e => console.error('‚ùå Backup rating kontrol hatasƒ±:', e));
                    
            }, 1000); // 1 saniyeye d√º≈ü√ºrd√ºm
        }
        
        // DEBUG: Manual test fonksiyonu (console'da √ßaƒüƒ±rƒ±labilir)
        window.testRatings = function(poiId = 63) {
            console.log('üß™ MANUAL TEST ba≈ülƒ±yor...');
            console.log('üß™ POI ID:', poiId);
            
            // 1. API test
            fetch(`${apiBase}/poi/${poiId}/ratings`)
                .then(r => {
                    console.log('üß™ API Response status:', r.status);
                    return r.json();
                })
                .then(data => {
                    console.log('üß™ API Data:', data);
                    console.log('üß™ Ratings:', data.ratings);
                    
                    // 2. Slider test
                    console.log('üß™ Slider testleri:');
                    Object.keys(data.ratings || {}).forEach(category => {
                        const slider = document.getElementById(`rating_${category}`);
                        console.log(`üß™ ${category} slider:`, !!slider);
                        if (slider) {
                            console.log(`üß™ ${category} mevcut deƒüer:`, slider.value);
                        }
                    });
                    
                    // 3. Manual set test
                    if (data.ratings && data.ratings.doga) {
                        console.log('üß™ Manuel doƒüa slider set test...');
                        const dogaSlider = document.getElementById('rating_doga');
                        if (dogaSlider) {
                            dogaSlider.value = data.ratings.doga;
                            updateRatingDisplay('doga', data.ratings.doga);
                            console.log('‚úÖ Doƒüa slider manual set edildi:', data.ratings.doga);
                        }
                    }
                })
                .catch(e => console.error('üß™ Test hatasƒ±:', e));
        };
        
        function updateRatingDisplay(category, value) {
            const displayElement = document.getElementById(`rating_${category}_display`);
            if (displayElement) {
                displayElement.textContent = value;
                
                // Badge rengini puana g√∂re ayarla
                displayElement.className = 'badge ' + getRatingBadgeClass(parseInt(value));
            }
            
            // Toplam puanƒ± g√ºncelle
            updateTotalRating();
        }

        function getRatingBadgeClass(value) {
            if (value >= 80) return 'bg-success';
            if (value >= 60) return 'bg-info';
            if (value >= 40) return 'bg-warning';
            if (value >= 20) return 'bg-secondary';
            return 'bg-light text-dark';
        }

        function updateTotalRating() {
            const categories = ['tarihi', 'sanat_kultur', 'doga', 'eglence', 'alisveris', 
                              'spor', 'macera', 'rahatlatici', 'yemek', 'gece_hayati'];
            
            let totalScore = 0;
            categories.forEach(category => {
                const slider = document.getElementById(`rating_${category}`);
                if (slider) {
                    totalScore += parseInt(slider.value);
                }
            });
            
            const totalScoreElement = document.getElementById('totalRatingScore');
            const totalProgressElement = document.getElementById('totalRatingProgress');
            
            if (totalScoreElement) {
                totalScoreElement.textContent = `${totalScore}/1000`;
            }
            
            if (totalProgressElement) {
                const percentage = (totalScore / 1000) * 100;
                totalProgressElement.style.width = `${percentage}%`;
                
                // Progress bar rengini puana g√∂re ayarla
                totalProgressElement.className = 'progress-bar ' + getProgressBarClass(percentage);
            }
        }

        function getProgressBarClass(percentage) {
            if (percentage >= 80) return 'bg-success';
            if (percentage >= 60) return 'bg-info';
            if (percentage >= 40) return 'bg-warning';
            if (percentage >= 20) return 'bg-secondary';
            return 'bg-danger';
        }

        // BASIT VE Dƒ∞REKT YAKLA≈ûIM
        function loadPOIRatings(poiId) {
            console.log('üöÄ BASIT loadPOIRatings ba≈üladƒ±, POI ID:', poiId);
            
            // √ñnce t√ºm slider'larƒ± sƒ±fƒ±rla
            clearAllRatings();
            
            if (!poiId) {
                console.log('‚ùå POI ID yok, rating\'ler temizlendi');
                return;
            }
            
            // API'den rating'leri al
            console.log('üì° API\'den rating\'ler alƒ±nƒ±yor...');
            fetch(`${apiBase}/poi/${poiId}/ratings`)
                .then(response => response.json())
                .then(data => {
                    console.log('üì¶ API Response:', data);
                    if (data && data.ratings) {
                        console.log('‚úÖ Rating\'ler bulundu:', data.ratings);
                        // Direkt slider'larƒ± g√ºncelle
                        updateSlidersDirectly(data.ratings);
                    } else {
                        console.log('‚ö†Ô∏è Rating data bo≈ü');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Rating API hatasƒ±:', error);
                });
        }
        
        // T√ºm rating'leri temizle
        function clearAllRatings() {
            console.log('üßπ T√ºm rating\'ler temizleniyor...');
            const categories = ['tarihi', 'sanat_kultur', 'doga', 'eglence', 'alisveris', 
                              'spor', 'macera', 'rahatlatici', 'yemek', 'gece_hayati'];
            
            categories.forEach(category => {
                const slider = document.getElementById(`rating_${category}`);
                const display = document.getElementById(`rating_${category}_display`);
                
                if (slider) {
                    slider.value = 0;
                    // ZORLA G√ñRSELƒ∞ G√úNCELLE
                    slider.dispatchEvent(new Event('input'));
                    slider.dispatchEvent(new Event('change'));
                    console.log(`üßπ ${category} slider = 0`);
                }
                if (display) {
                    display.textContent = '0';
                    display.className = 'badge bg-secondary';
                }
            });
        }
        
        // Slider'larƒ± direkt g√ºncelle
        function updateSlidersDirectly(ratings) {
            console.log('üéöÔ∏è Slider\'lar direkt g√ºncelleniyor:', ratings);
            
            Object.keys(ratings).forEach(category => {
                const value = parseInt(ratings[category]) || 0;
                const slider = document.getElementById(`rating_${category}`);
                const display = document.getElementById(`rating_${category}_display`);
                
                if (slider && display) {
                    slider.value = value;
                    
                    // ZORLA G√ñRSELƒ∞ G√úNCELLE
                    slider.dispatchEvent(new Event('input'));
                    slider.dispatchEvent(new Event('change'));
                    
                    display.textContent = value;
                    
                    // Badge rengini g√ºncelle
                    if (value >= 80) display.className = 'badge bg-success';
                    else if (value >= 60) display.className = 'badge bg-info';
                    else if (value >= 40) display.className = 'badge bg-warning';
                    else if (value >= 20) display.className = 'badge bg-secondary';
                    else display.className = 'badge bg-danger';
                    
                    console.log(`‚úÖ ${category}: ${value} (slider=${slider.value}, display=${display.textContent})`);
                } else {
                    console.warn(`‚ö†Ô∏è ${category} elementleri bulunamadƒ±: slider=${!!slider}, display=${!!display}`);
                }
            });
            
            updateTotalRating();
        }

        function setDefaultRatings() {
            console.log('üîÑ setDefaultRatings: T√ºm rating\'ler sƒ±fƒ±rlanƒ±yor');
            const categories = ['tarihi', 'sanat_kultur', 'doga', 'eglence', 'alisveris', 
                              'spor', 'macera', 'rahatlatici', 'yemek', 'gece_hayati'];
            
            categories.forEach(category => {
                const slider = document.getElementById(`rating_${category}`);
                if (slider) {
                    slider.value = 0;
                    updateRatingDisplay(category, 0);
                } else {
                    console.warn(`‚ö†Ô∏è ${category} slider'ƒ± bulunamadƒ±!`);
                }
            });
            updateTotalRating();
            console.log('‚úÖ Varsayƒ±lan rating\'ler y√ºklendi');
        }

        function setRatingValues(ratings) {
            console.log('üéõÔ∏è setRatingValues √ßaƒürƒ±ldƒ± (YENƒ∞ BASIT VERSƒ∞YON):', ratings);
            // Yeni basit fonksiyonu kullan
            updateSlidersDirectly(ratings || {});
        }
        
        // ACIL TEST FONKSIYONU - Tarayƒ±cƒ± konsolundan √ßaƒüƒ±r
        function testSliders() {
            console.log('üß™ ACIL TEST ba≈ülƒ±yor...');
            
            // 1. Slider'larƒ± bul
            const tarihi = document.getElementById('rating_tarihi');
            const doga = document.getElementById('rating_doga');
            const yemek = document.getElementById('rating_yemek');
            
            console.log('Slider durumu:');
            console.log('- Tarihi:', tarihi ? 'VAR' : 'YOK');
            console.log('- Doƒüa:', doga ? 'VAR' : 'YOK');
            console.log('- Yemek:', yemek ? 'VAR' : 'YOK');
            
            if (tarihi) {
                console.log('- Tarihi deƒüeri:', tarihi.value);
                tarihi.value = 90;
                // ZORLA G√ñRSELƒ∞ G√úNCELLE
                tarihi.dispatchEvent(new Event('input'));
                tarihi.dispatchEvent(new Event('change'));
                console.log('- Tarihi yeni deƒüer:', tarihi.value);
            }
            
            if (doga) {
                console.log('- Doƒüa deƒüeri:', doga.value);
                doga.value = 85;
                // ZORLA G√ñRSELƒ∞ G√úNCELLE
                doga.dispatchEvent(new Event('input'));
                doga.dispatchEvent(new Event('change'));
                console.log('- Doƒüa yeni deƒüer:', doga.value);
            }
            
            if (yemek) {
                yemek.value = 95;
                yemek.dispatchEvent(new Event('input'));
                yemek.dispatchEvent(new Event('change'));
            }
            
            // Display'leri g√ºncelle
            const tarihiDisplay = document.getElementById('rating_tarihi_display');
            const dogaDisplay = document.getElementById('rating_doga_display');
            const yemekDisplay = document.getElementById('rating_yemek_display');
            
            if (tarihiDisplay) {
                tarihiDisplay.textContent = '90';
                tarihiDisplay.className = 'badge bg-success';
            }
            if (dogaDisplay) {
                dogaDisplay.textContent = '85';
                dogaDisplay.className = 'badge bg-success';
            }
            if (yemekDisplay) {
                yemekDisplay.textContent = '95';
                yemekDisplay.className = 'badge bg-success';
            }
            
            console.log('‚úÖ Test tamamlandƒ± - Slider\'lar g√∂rsel olarak g√ºncellendi');
        }
        
        // Mevcut POI'nin rating'lerini y√ºkle
        function loadCurrentPOIRatings() {
            const poiId = document.getElementById('poiId').value;
            console.log('üîÑ Manuel rating y√ºkleme, POI ID:', poiId);
            if (poiId) {
                loadRatingsSimple(poiId);
            } else {
                console.log('‚ùå POI ID bulunamadƒ±');
                clearAllRatings();
            }
        }
        
        // S√úPER BASƒ∞T RATING Y√úKLEME
        function loadRatingsSimple(poiId) {
            console.log('üöÄ S√úPER BASƒ∞T rating y√ºkleme, POI:', poiId);
            
            if (!poiId) {
                clearAllRatings();
                return;
            }
            
            fetch(`${apiBase}/poi/${poiId}/ratings`)
                .then(r => r.json())
                .then(data => {
                    console.log('üì¶ Rating data:', data);
                    
                    // √ñnce t√ºm slider'larƒ± temizle
                    clearAllRatings();
                    
                    if (data.ratings) {
                        // Direkt slider'larƒ± g√ºncelle
                        for (let category in data.ratings) {
                            const value = parseInt(data.ratings[category]) || 0;
                            const slider = document.getElementById(`rating_${category}`);
                            const display = document.getElementById(`rating_${category}_display`);
                            
                            if (slider && value > 0) {
                                slider.value = value;
                                // ZORLA G√ñRSELƒ∞ G√úNCELLE
                                slider.dispatchEvent(new Event('input'));
                                slider.dispatchEvent(new Event('change'));
                                console.log(`‚úÖ ${category} = ${value}`);
                            }
                            if (display && value > 0) {
                                display.textContent = value;
                                // Badge rengini g√ºncelle
                                if (value >= 80) display.className = 'badge bg-success';
                                else if (value >= 60) display.className = 'badge bg-info';
                                else if (value >= 40) display.className = 'badge bg-warning';
                                else if (value >= 20) display.className = 'badge bg-secondary';
                                else display.className = 'badge bg-danger';
                            }
                        }
                        console.log('‚úÖ Rating\'ler ba≈üarƒ±yla y√ºklendi ve g√∂rsel olarak g√ºncellendi');
                    } else {
                        console.log('‚ö†Ô∏è Rating data bo≈ü');
                    }
                })
                .catch(e => {
                    console.error('‚ùå Rating hatasƒ±:', e);
                    clearAllRatings();
                });
        }

        function getRatingValues() {
            console.log('üìä getRatingValues √ßaƒürƒ±ldƒ±');
            const categories = ['tarihi', 'sanat_kultur', 'doga', 'eglence', 'alisveris', 
                              'spor', 'macera', 'rahatlatici', 'yemek', 'gece_hayati'];
            
            const ratings = {};
            categories.forEach(category => {
                const slider = document.getElementById(`rating_${category}`);
                if (slider) {
                    const value = parseInt(slider.value);
                    ratings[category] = value;
                    console.log(`üìä ${category}: ${value}`);
                } else {
                    console.warn(`‚ö†Ô∏è ${category} slider'ƒ± bulunamadƒ±!`);
                }
            });
            
            console.log('üìä Toplanan rating deƒüerleri:', ratings);
            return ratings;
        }

        async function savePOIRatings(poiId, ratings) {
            if (!poiId || !ratings) {
                console.error('‚ùå savePOIRatings: POI ID veya ratings eksik', {poiId, ratings});
                return false;
            }
            
            console.log('üíæ Rating kaydetme ba≈ülƒ±yor...', {poiId, ratings});
            
            try {
                const requestData = { ratings: ratings };
                console.log('üì§ API\'ye g√∂nderilen data:', requestData);
                
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/ratings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('üì° API response status:', response.status);
                
                if (response.ok) {
                    const responseData = await response.json();
                    console.log('‚úÖ Rating\'ler ba≈üarƒ±yla kaydedildi:', responseData);
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Rating kaydetme hatasƒ± - Status:', response.status, 'Error:', errorText);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Rating kaydetme exception:', error);
                return false;
            }
        }
        
        async function uploadPOIMedia() {
            const fileInput = document.getElementById('mediaFile');
            const mediaTypeSelect = document.getElementById('mediaType');
            const mediaCaption = document.getElementById('mediaCaption').value;
            const isPrimary = document.getElementById('isPrimaryMedia').checked;
            
            // POI ID'sini al (d√ºzenleme modundaysa)
            const poiId = document.getElementById('poiId').value;
            if (!poiId) {
                alert('√ñnce POI\'yi kaydedin, sonra medya ekleyin.');
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('L√ºtfen bir medya dosyasƒ± se√ßin.');
                return;
            }
            
            const file = fileInput.files[0];
            const filename = file.name.toLowerCase();
            
            // Medya t√ºr√ºn√º tespit et
            let mediaType = mediaTypeSelect.value;
            if (mediaType === 'auto') {
                if (filename.match(/\.(jpg|jpeg|png|gif|webp|bmp|tiff)$/)) {
                    mediaType = 'image';
                } else if (filename.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|m4v)$/)) {
                    mediaType = 'video';
                } else if (filename.match(/\.(mp3|wav|ogg|m4a|aac|flac)$/)) {
                    mediaType = 'audio';
                } else if (filename.match(/\.(glb|gltf|obj|fbx|dae|ply|stl)$/)) {
                    mediaType = 'model_3d';
                } else {
                    alert('Dosya t√ºr√º tespit edilemedi. L√ºtfen medya t√ºr√ºn√º manuel olarak se√ßin.');
                    return;
                }
            }
            
            // Dosya boyutu kontrol√º
            const maxSize = getMediaMaxSize(mediaType) * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`Dosya boyutu ${getMediaMaxSize(mediaType)}MB'dan k√º√ß√ºk olmalƒ±dƒ±r.\n\nSe√ßilen dosya: ${(file.size / 1024 / 1024).toFixed(1)}MB`);
                return;
            }
            
            const formData = new FormData();
            formData.append('media', file);
            formData.append('caption', mediaCaption);
            formData.append('is_primary', isPrimary);
            
            try {
                showLoading();
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/media`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Medya y√ºkleme ba≈üarƒ±sƒ±z');
                }
                
                const result = await response.json();
                
                if (result.media && result.media.compression_ratio && result.media.compression_ratio !== "0%") {
                    showToast(`${getMediaTypeIcon(mediaType)} ${mediaType.toUpperCase()} ba≈üarƒ±yla y√ºklendi!\nüì¶ Boyut azalmasƒ±: ${result.media.compression_ratio}`, 'success');
                } else {
                    showToast(`${getMediaTypeIcon(mediaType)} ${mediaType.toUpperCase()} ba≈üarƒ±yla y√ºklendi!`, 'success');
                }
                
                // Form alanlarƒ±nƒ± temizle
                fileInput.value = '';
                document.getElementById('mediaCaption').value = '';
                document.getElementById('isPrimaryMedia').checked = false;
                mediaTypeSelect.value = 'auto';
                
                // Mevcut medya dosyalarƒ±nƒ± yenile
                await loadPOIMedia(poiId);
                
            } catch (error) {
                console.error('Medya y√ºkleme hatasƒ±:', error);
                alert('Medya y√ºkleme hatasƒ±: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Geriye uyumluluk i√ßin eski g√∂rsel y√ºkleme fonksiyonu
        async function uploadPOIImage() {
            // Yeni medya fonksiyonunu kullan
            document.getElementById('mediaType').value = 'image';
            await uploadPOIMedia();
        }
        
        async function loadPOIMedia(poiId) {
            if (!poiId) return;
            
            try {
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/media`);
                if (!response.ok) return;
                
                const data = await response.json();
                const mediaFiles = data.media || [];
                
                const container = document.getElementById('currentMedia');
                if (mediaFiles.length === 0) {
                    container.innerHTML = '<small class="text-muted">Hen√ºz medya dosyasƒ± eklenmemi≈ü.</small>';
                    return;
                }
                
                // Medya t√ºrlerine g√∂re grupla
                const groupedMedia = {};
                mediaFiles.forEach(media => {
                    const type = media.media_type || 'unknown';
                    if (!groupedMedia[type]) groupedMedia[type] = [];
                    groupedMedia[type].push(media);
                });
                
                let mediaHtml = '';
                
                // Her medya t√ºr√º i√ßin ayrƒ± b√∂l√ºm olu≈ütur
                Object.keys(groupedMedia).forEach(mediaType => {
                    const typeIcon = getMediaTypeIcon(mediaType);
                    const typeLabel = {
                        'image': 'G√∂rseller',
                        'video': 'Videolar', 
                        'audio': 'Ses Dosyalarƒ±',
                        'model_3d': '3D Modeller',
                        'unknown': 'Diƒüer'
                    }[mediaType] || mediaType.toUpperCase();
                    
                    mediaHtml += `
                        <div class="mb-3">
                            <h6 class="fw-bold text-primary">${typeIcon} ${typeLabel} (${groupedMedia[mediaType].length})</h6>
                            <div class="row g-2">`;
                    
                                         groupedMedia[mediaType].forEach((media, index) => {
                         const previewPath = media.preview_path || media.thumbnail_path || media.path;
                         const isImage = mediaType === 'image';
                         
                         mediaHtml += `
                             <div class="col-6">
                                 <div class="card">
                                     <div class="position-relative">
                                         ${isImage ? 
                                             `<img src="/${previewPath}" class="card-img-top" style="height: 80px; object-fit: cover;" 
                                                  alt="${media.filename}" onclick="showMediaModal('/${media.path}', '${media.filename}', '${mediaType}')">` :
                                             `<div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 80px;" 
                                                  onclick="showMediaModal('/${media.path}', '${media.filename}', '${mediaType}')">
                                                  ${getMediaTypeIcon(mediaType)} <span class="ms-2 small">${media.format?.toUpperCase() || ''}</span>
                                              </div>`
                                         }
                                         <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                 style="width: 25px; height: 25px; padding: 0; font-size: 0.7rem;" 
                                                 onclick="deleteMediaFile('${poiId}', '${media.filename}')" 
                                                 title="Sil">
                                             √ó
                                         </button>
                                     </div>
                                     <div class="card-body p-2">
                                         <small class="text-muted d-block">${media.filename}</small>
                                         <small class="text-muted">${(media.size / 1024).toFixed(0)}KB</small>
                                     </div>
                                 </div>
                             </div>`;
                     });
                     
                     mediaHtml += `
                             </div>
                         </div>`;
                 });
                 
                 container.innerHTML = mediaHtml;
                 
            } catch (error) {
                console.error('Medya y√ºkleme hatasƒ±:', error);
            }
        }
        
        // Geriye uyumluluk i√ßin eski g√∂rsel y√ºkleme fonksiyonu
        async function loadPOIImages(poiId) {
            // Yeni medya fonksiyonunu kullan
            await loadPOIMedia(poiId);
            
            // Eski format i√ßin de g√∂rselleri currentImages container'ƒ±na y√ºkle
            try {
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/images`);
                if (!response.ok) return;
                
                const data = await response.json();
                const images = data.images || [];
                
                const container = document.getElementById('currentImages');
                if (images.length === 0) {
                    container.innerHTML = '<small class="text-muted">Hen√ºz g√∂rsel eklenmemi≈ü.</small>';
                    return;
                }
                
                let imagesHtml = '<div class="row g-2">';
                images.forEach((image, index) => {
                    const imagePath = image.thumbnail_path || image.path;
                    imagesHtml += `
                        <div class="col-6">
                            <div class="card">
                                <img src="/${imagePath}" class="card-img-top" style="height: 80px; object-fit: cover;" 
                                     alt="${image.filename}">
                                <div class="card-body p-2">
                                    <small class="text-muted d-block">${image.filename}</small>
                                    <small class="text-muted">${(image.size / 1024).toFixed(0)}KB</small>
                                    <button class="btn btn-danger btn-sm mt-1" onclick="deleteMediaFile('${poiId}', '${image.filename}')">
                                        üóëÔ∏è Sil
                                    </button>
                                </div>
                            </div>
                        </div>`;
                });
                imagesHtml += '</div>';
                container.innerHTML = imagesHtml;
                
            } catch (error) {
                console.error('G√∂rsel y√ºkleme hatasƒ±:', error);
            }
        }
        
        // Medya modal g√∂sterimi
        function showMediaModal(mediaPath, filename, mediaType) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            
            let modalContent = '';
            if (mediaType === 'image') {
                modalContent = `<img src="${mediaPath}" class="img-fluid rounded-3 shadow-lg" alt="${filename}" style="max-height: 70vh;">`;
            } else if (mediaType === 'video') {
                modalContent = `
                    <video controls class="w-100 rounded-3 shadow-lg" style="max-height: 70vh;">
                        <source src="${mediaPath}" type="video/mp4">
                        Tarayƒ±cƒ±nƒ±z video oynatmayƒ± desteklemiyor.
                    </video>`;
            } else if (mediaType === 'audio') {
                modalContent = `
                    <div class="text-center p-4">
                        <i class="fas fa-music fa-3x text-primary mb-3"></i>
                        <h5>${filename}</h5>
                        <audio controls class="w-100 mt-3">
                            <source src="${mediaPath}">
                            Tarayƒ±cƒ±nƒ±z ses oynatmayƒ± desteklemiyor.
                        </audio>
                    </div>`;
            } else if (mediaType === 'model_3d') {
                modalContent = `
                    <div class="text-center p-4">
                        <i class="fas fa-cube fa-3x text-primary mb-3"></i>
                        <h5>${filename}</h5>
                        <p class="text-muted">3D model dosyasƒ± - indirip uygun bir uygulamada g√∂r√ºnt√ºleyebilirsiniz.</p>
                    </div>`;
            } else {
                modalContent = `
                    <div class="text-center p-4">
                        <i class="fas fa-file fa-3x text-primary mb-3"></i>
                        <h5>${filename}</h5>
                        <p class="text-muted">Medya dosyasƒ±</p>
                    </div>`;
            }
            
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold"><i class="fas fa-file me-2"></i>${filename}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center p-4">
                            ${modalContent}
                        </div>
                        <div class="modal-footer justify-content-center">
                            <a href="${mediaPath}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt me-1"></i> Yeni Sekmede A√ß/ƒ∞ndir
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i> Kapat
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }
        
        // Medya dosyasƒ± silme
        async function deleteMediaFile(poiId, filename) {
            if (!confirm(`'${filename}' dosyasƒ±nƒ± silmek istediƒüinizden emin misiniz?`)) {
                return;
            }
            
            try {
                showLoading();
                const response = await authenticatedFetch(`${apiBase}/poi/${poiId}/media/${filename}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Dosya silinemedi');
                }
                
                showToast('Medya dosyasƒ± ba≈üarƒ±yla silindi', 'success');
                
                // Medya listesini yenile
                await loadPOIMedia(poiId);
                
            } catch (error) {
                console.error('Medya silme hatasƒ±:', error);
                alert('Medya silme hatasƒ±: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Session timeout monitoring for POI manager
        let sessionTimeoutWarning = null;
        let sessionWarningShown = false;
        
        function startSessionTimeoutMonitoring() {
            // Check session status every 30 seconds for better responsiveness
            setInterval(async () => {
                try {
                    const response = await fetch('/auth/status');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.authenticated && data.session_info) {
                            updateSessionStatus(data.session_info);
                            checkSessionTimeoutWarning(data.session_info);
                        } else {
                            window.location.href = '/auth/login';
                        }
                    } else {
                        window.location.href = '/auth/login';
                    }
                } catch (error) {
                    console.error('Session check failed:', error);
                }
            }, 30 * 1000); // 30 seconds
        }
        
        function checkSessionTimeoutWarning(sessionInfo) {
            if (!sessionInfo.expires_at) return;
            
            const expiresAt = new Date(sessionInfo.expires_at);
            const now = new Date();
            const timeLeft = expiresAt - now;
            
            // Show warning if less than 10 minutes left
            if (timeLeft < 10 * 60 * 1000 && timeLeft > 0) {
                showSessionTimeoutWarning(timeLeft);
            } else if (timeLeft <= 0) {
                handleSessionExpired();
            } else {
                clearSessionTimeoutWarning();
            }
        }
        
        function showSessionTimeoutWarning(timeLeft) {
            if (sessionWarningShown) {
                updateSessionTimeoutWarning(timeLeft);
                return;
            }
            
            const minutes = Math.ceil(timeLeft / (60 * 1000));
            const warningId = 'poi-session-timeout-warning';
            
            const warningHtml = `
                <div class="alert alert-warning alert-dismissible fade show position-fixed" 
                     id="${warningId}" 
                     style="top: 80px; right: 20px; z-index: 9999; min-width: 350px;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2"></i>
                        <div class="flex-grow-1">
                            <strong>Oturum Uyarƒ±sƒ±</strong><br>
                            <span class="session-time-left">Oturumunuz ${minutes} dakika i√ßinde sona erecek.</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-warning me-2" onclick="extendSession()">
                            <i class="fas fa-refresh me-1"></i>Oturumu Uzat
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="dismissSessionTimeoutWarning()">
                            Kapat
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', warningHtml);
            sessionWarningShown = true;
            sessionTimeoutWarning = document.getElementById(warningId);
        }
        
        function updateSessionTimeoutWarning(timeLeft) {
            if (!sessionTimeoutWarning) return;
            
            const minutes = Math.ceil(timeLeft / (60 * 1000));
            const timeLeftElement = sessionTimeoutWarning.querySelector('.session-time-left');
            
            if (timeLeftElement) {
                if (minutes <= 1) {
                    const seconds = Math.max(0, Math.ceil(timeLeft / 1000));
                    timeLeftElement.innerHTML = `Oturumunuz <strong class="text-danger">${seconds} saniye</strong> i√ßinde sona erecek.`;
                    sessionTimeoutWarning.classList.remove('alert-warning');
                    sessionTimeoutWarning.classList.add('alert-danger');
                } else {
                    timeLeftElement.textContent = `Oturumunuz ${minutes} dakika i√ßinde sona erecek.`;
                }
            }
        }
        
        async function extendSession() {
            try {
                // Make a simple authenticated request to extend session
                const response = await fetch('/auth/status', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    dismissSessionTimeoutWarning();
                    showToast('Oturum ba≈üarƒ±yla uzatƒ±ldƒ±.', 'success');
                } else {
                    showToast('Oturum uzatƒ±lamadƒ±. L√ºtfen yeniden giri≈ü yapƒ±n.', 'error');
                    handleSessionExpired();
                }
            } catch (error) {
                console.error('Session extend failed:', error);
                showToast('Oturum uzatƒ±lƒ±rken hata olu≈ütu.', 'error');
            }
        }
        
        function dismissSessionTimeoutWarning() {
            clearSessionTimeoutWarning();
        }
        
        function clearSessionTimeoutWarning() {
            if (sessionTimeoutWarning) {
                sessionTimeoutWarning.remove();
                sessionTimeoutWarning = null;
            }
            sessionWarningShown = false;
        }
        
        function handleSessionExpired() {
            clearSessionTimeoutWarning();
            showToast('Oturum s√ºresi doldu. Yeniden giri≈ü yapƒ±lƒ±yor...', 'warning');
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 2000);
        }

        // Password Change Functionality
        function showPasswordChangeModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'passwordChangeModal';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title fw-bold">
                                <i class="fas fa-key me-2"></i>≈ûifre Deƒüi≈ütir
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="passwordChangeForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">
                                        <i class="fas fa-lock me-1"></i>Mevcut ≈ûifre
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="currentPassword" 
                                               name="current_password" required>
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="togglePasswordVisibility('currentPassword', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">
                                        <i class="fas fa-key me-1"></i>Yeni ≈ûifre
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="newPassword" 
                                               name="new_password" required>
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="togglePasswordVisibility('newPassword', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            ≈ûifre en az 8 karakter olmalƒ± ve b√ºy√ºk harf, k√º√ß√ºk harf, rakam ve √∂zel karakter i√ßermelidir.
                                        </small>
                                    </div>
                                    <div id="passwordStrength" class="mt-2"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">
                                        <i class="fas fa-check me-1"></i>Yeni ≈ûifre Tekrar
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="confirmPassword" 
                                               name="confirm_password" required>
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="togglePasswordVisibility('confirmPassword', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div id="passwordMatch" class="mt-1"></div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>√ñnemli:</strong> ≈ûifre deƒüi≈ütirildikten sonra t√ºm aktif oturumlar sonlandƒ±rƒ±lacak 
                                    ve yeniden giri≈ü yapmanƒ±z gerekecek.
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>ƒ∞ptal
                            </button>
                            <button type="button" class="btn btn-warning" onclick="changePassword()" id="changePasswordSubmitBtn">
                                <i class="fas fa-key me-1"></i>≈ûifreyi Deƒüi≈ütir
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Add event listeners for password validation
            const newPasswordInput = modal.querySelector('#newPassword');
            const confirmPasswordInput = modal.querySelector('#confirmPassword');
            
            newPasswordInput.addEventListener('input', function() {
                validatePasswordStrength(this.value);
                checkPasswordMatch();
            });
            
            confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }
        
        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }
        
        function validatePasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            if (!strengthDiv) return;
            
            let score = 0;
            let feedback = [];
            
            // Length check
            if (password.length >= 8) {
                score += 1;
            } else {
                feedback.push('En az 8 karakter');
            }
            
            // Uppercase check
            if (/[A-Z]/.test(password)) {
                score += 1;
            } else {
                feedback.push('B√ºy√ºk harf');
            }
            
            // Lowercase check
            if (/[a-z]/.test(password)) {
                score += 1;
            } else {
                feedback.push('K√º√ß√ºk harf');
            }
            
            // Number check
            if (/\d/.test(password)) {
                score += 1;
            } else {
                feedback.push('Rakam');
            }
            
            // Special character check
            if (/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) {
                score += 1;
            } else {
                feedback.push('√ñzel karakter');
            }
            
            let strengthText = '';
            let strengthClass = '';
            
            if (score === 5) {
                strengthText = '<i class="fas fa-check-circle text-success me-1"></i>G√º√ßl√º ≈üifre';
                strengthClass = 'text-success';
            } else if (score >= 3) {
                strengthText = '<i class="fas fa-exclamation-circle text-warning me-1"></i>Orta g√º√ßl√ºkte';
                strengthClass = 'text-warning';
            } else {
                strengthText = '<i class="fas fa-times-circle text-danger me-1"></i>Zayƒ±f ≈üifre';
                strengthClass = 'text-danger';
            }
            
            if (feedback.length > 0) {
                strengthText += ` (Eksik: ${feedback.join(', ')})`;
            }
            
            strengthDiv.innerHTML = `<small class="${strengthClass}">${strengthText}</small>`;
        }
        
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword')?.value;
            const confirmPassword = document.getElementById('confirmPassword')?.value;
            const matchDiv = document.getElementById('passwordMatch');
            
            if (!matchDiv || !confirmPassword) return;
            
            if (newPassword === confirmPassword) {
                matchDiv.innerHTML = '<small class="text-success"><i class="fas fa-check me-1"></i>≈ûifreler e≈üle≈üiyor</small>';
            } else {
                matchDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times me-1"></i>≈ûifreler e≈üle≈ümiyor</small>';
            }
        }
        
        async function changePassword() {
            const form = document.getElementById('passwordChangeForm');
            const submitBtn = document.getElementById('changePasswordSubmitBtn');
            
            if (!form) return;
            
            const formData = new FormData(form);
            const currentPassword = formData.get('current_password');
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');
            
            // Basic validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('L√ºtfen t√ºm alanlarƒ± doldurun', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Yeni ≈üifre ve tekrarƒ± e≈üle≈ümiyor', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showToast('Yeni ≈üifre en az 8 karakter olmalƒ±dƒ±r', 'error');
                return;
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deƒüi≈ütiriliyor...';
            
            try {
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword,
                        csrf_token: csrfToken
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('≈ûifre ba≈üarƒ±yla deƒüi≈ütirildi. Yeniden giri≈ü yapƒ±lƒ±yor...', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('passwordChangeModal'));
                    if (modal) modal.hide();
                    
                    // Redirect to login after a short delay
                    setTimeout(() => {
                        window.location.href = '/auth/login';
                    }, 2000);
                    
                } else {
                    showToast(data.error || '≈ûifre deƒüi≈ütirilemedi', 'error');
                }
                
            } catch (error) {
                console.error('Password change error:', error);
                showToast('≈ûifre deƒüi≈ütirirken hata olu≈ütu', 'error');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-key me-1"></i>≈ûifreyi Deƒüi≈ütir';
            }
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', async function () {
            // First check authentication
            const isAuthenticated = await checkAuthStatus();
            if (isAuthenticated) {
                initMap();
                fetchPOIs();
                
                // Start enhanced session monitoring
                startSessionTimeoutMonitoring();
            }
        });
    </script>
</body>

</html>
