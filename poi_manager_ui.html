<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POI Y√∂netim Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        body {
            background: #f8f9fa;
        }

        .poi-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .pointer {
            cursor: pointer;
        }

        .pointer:hover {
            background-color: rgba(0, 123, 255, 0.1);
            transition: background-color 0.2s ease;
        }

        #map {
            height: 60vh;
            min-height: 350px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }

        /* Birle≈üik Panel Tab Stilleri */
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 8px 8px 0 0;
            background: transparent;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }

        .nav-tabs .nav-link:hover:not(.active) {
            background: #f8f9fa;
            color: #495057;
            transform: translateY(-2px);
        }

        .tab-content {
            border: none;
            padding: 0;
        }

        .tab-pane {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced POI Detail Styles in Details Tab */
        .poi-detail-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .poi-detail-info {
            background: white;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #007bff;
            margin-bottom: 16px;
        }

        .poi-detail-images {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e9ecef;
            margin-bottom: 16px;
        }

        .image-card-enhanced {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-card-enhanced:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25) !important;
        }

        .poi-detail-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-top: 1px solid #e9ecef;
        }

        .poi-detail-actions .btn {
            transition: all 0.2s ease;
        }

        .poi-detail-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .highlight-marker {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0.7);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            display: none;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .sortable:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }

        .table-responsive {
            border-radius: 8px;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-outline-primary:hover,
        .btn-outline-danger:hover {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }

        @media (max-width: 768px) {
            #map {
                height: 40vh;
            }

            .container-fluid {
                padding: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Y√ºkleniyor...</span>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <div class="container-fluid py-4">
        <h2 class="mb-4">üó∫Ô∏è POI Y√∂netim Paneli</h2>

        <!-- Harita B√∂l√ºm√º -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Harita</h5>
                        <small class="text-muted">POI'leri g√∂rmek i√ßin haritaya tƒ±klayƒ±n. Yeni POI eklemek i√ßin haritada
                            bir noktaya √ßift tƒ±klayƒ±n.</small>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sol Panel: Birle≈üik POI Y√∂netim Paneli -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" id="panelTitle">üÜï Yeni POI Ekle</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="selectLocationFromMap()" id="mapSelectBtn">
                                    üìç Haritadan Se√ß
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info d-none" onclick="clearForm()" id="newPoiBtn">
                                    ‚ûï Yeni POI
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs mt-3" id="poiTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-content" type="button" role="tab">
                                    <i class="fas fa-edit me-1"></i>Form
                                </button>
                            </li>
                            <li class="nav-item" role="presentation" style="display: none;" id="details-tab-container">
                                <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-content" type="button" role="tab">
                                    <i class="fas fa-info-circle me-1"></i>Detaylar
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="card-body">
                        <div class="tab-content" id="poiTabContent">
                            <!-- Form Content -->
                            <div class="tab-pane fade show active" id="form-content" role="tabpanel">
                                <form id="poiForm">
                                    <input type="hidden" id="poiId">
                                    <div class="mb-2">
                                        <label class="form-label">Adƒ± *</label>
                                        <input type="text" class="form-control" id="poiName" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Kategori *</label>
                                        <select class="form-select" id="poiCategory" required>
                                            <option value="">Se√ßiniz</option>
                                            <option value="gastronomik">üçΩÔ∏è Gastronomik</option>
                                            <option value="kulturel">üèõÔ∏è K√ºlt√ºrel</option>
                                            <option value="sanatsal">üé® Sanatsal</option>
                                            <option value="doga_macera">üåø Doƒüa & Macera</option>
                                            <option value="konaklama">üè® Konaklama</option>
                                        </select>
                                    </div>
                                    <div class="row">
                                        <div class="col-6 mb-2">
                                            <label class="form-label">Enlem *</label>
                                            <input type="number" step="any" class="form-control" id="poiLat" required>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <label class="form-label">Boylam *</label>
                                            <input type="number" step="any" class="form-control" id="poiLon" required>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">A√ßƒ±klama</label>
                                        <textarea class="form-control" id="poiDesc" rows="3"></textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Etiketler</label>
                                        <input type="text" class="form-control" id="poiTags"
                                            placeholder="etiket1, etiket2, etiket3...">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Resim URL'si</label>
                                        <input type="url" class="form-control" id="poiImageUrl" placeholder="https://...">
                                    </div>
                                    
                                    <!-- G√∂rsel Y√∂netimi B√∂l√ºm√º -->
                                    <div class="mb-3" id="imageManagementSection">
                                        <label class="form-label">üì∏ G√∂rsel Y√∂netimi</label>
                                        <div class="border rounded p-3 bg-light">
                                            <div class="mb-2">
                                                <input type="file" class="form-control form-control-sm" id="imageFile" accept="image/*">
                                                <small class="form-text text-muted">
                                                    <i class="fas fa-info-circle text-primary"></i>
                                                    PNG, JPG, JPEG, GIF formatlarƒ± kabul edilir. G√∂rseller otomatik olarak WebP formatƒ±na d√∂n√º≈üt√ºr√ºl√ºr (boyut %50-80 k√º√ß√ºl√ºr).
                                                </small>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <select class="form-select form-select-sm" id="imageType">
                                                        <option value="photo">üì∑ Fotoƒüraf</option>
                                                        <option value="exterior">üè¢ Dƒ±≈ü G√∂r√ºn√ºm</option>
                                                        <option value="interior">üè† ƒ∞√ß Mekan</option>
                                                        <option value="food">üçΩÔ∏è Yemek</option>
                                                        <option value="menu">üìã Men√º</option>
                                                    </select>
                                                </div>
                                                <div class="col-6">
                                                    <input type="text" class="form-control form-control-sm" id="imageCaption" placeholder="A√ßƒ±klama">
                                                </div>
                                            </div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="isPrimaryImage">
                                                <label class="form-check-label" for="isPrimaryImage">Ana g√∂rsel</label>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary btn-sm mt-2 w-100" onclick="uploadPOIImage()">
                                                üì§ G√∂rsel Y√ºkle
                                            </button>
                                        </div>
                                        
                                        <!-- Mevcut G√∂rseller -->
                                        <div id="currentImages" class="mt-2"></div>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary" id="saveBtn">üíæ Kaydet</button>
                                        <button type="button" class="btn btn-outline-danger d-none" id="deleteBtn" onclick="deleteCurrentPOI()">
                                            üóëÔ∏è POI'yi Sil
                                        </button>
                                        <button type="button" class="btn btn-secondary d-none" id="cancelEditBtn" onclick="clearForm()">
                                            ‚ùå ƒ∞ptal
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Details Content -->
                            <div class="tab-pane fade" id="details-content" role="tabpanel">
                                <div id="poiDetailContent">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                                        <p>POI detaylarƒ± burada g√∂r√ºnecek</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saƒü Panel: Liste -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">POI Listesi</h5>
                            </div>
                            <div class="col-auto">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchPOI" placeholder="POI ara...">
                                    <select id="filterCategory" class="form-select">
                                        <option value="">T√ºm Kategoriler</option>
                                        <option value="gastronomik">üçΩÔ∏è Gastronomik</option>
                                        <option value="kulturel">üèõÔ∏è K√ºlt√ºrel</option>
                                        <option value="sanatsal">üé® Sanatsal</option>
                                        <option value="doga_macera">üåø Doƒüa & Macera</option>
                                        <option value="konaklama">üè® Konaklama</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body poi-list p-0">
                        <table class="table table-hover mb-0" id="poiTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-sort="name">Adƒ± <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th class="sortable" data-sort="category">Kategori <span class="sort-icon">‚ÜïÔ∏è</span>
                                    </th>
                                    <th class="sortable" data-sort="lat">Enlem <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th class="sortable" data-sort="lon">Boylam <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="poiTableBody"></tbody>
                        </table>
                        <div class="text-center p-3 d-none" id="noDataMessage">
                            <p class="text-muted mb-0">Herhangi bir POI bulunamadƒ±.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const apiBase = '/api';
        let map;
        let poiMarkers = [];
        let allPOIs = [];
        let currentSort = { field: 'name', direction: 'asc' };
        let isSelectingLocation = false;
        let selectedPOI = null;
        let highlightedMarker = null; // Vurgulanan POI marker'ƒ±

        // Harita ba≈ülatma
        function initMap() {
            map = L.map('map').setView([38.6322, 34.9115], 16); // √úrg√ºp merkezi

            // Farklƒ± harita katmanlarƒ± tanƒ±mla
            const baseLayers = {
                "üó∫Ô∏è OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 20
                }),

                "üõ∞Ô∏è Uydu G√∂r√ºnt√ºs√º": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri, Maxar, Earthstar Geographics',
                    maxZoom: 19
                }),

                "üèîÔ∏è Topografik": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenTopoMap (CC-BY-SA)',
                    maxZoom: 17
                }),

                "üé® CartoDB Positron": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap ¬© CartoDB',
                    maxZoom: 19
                }),

                "üåô CartoDB Dark": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap ¬© CartoDB',
                    maxZoom: 19
                })
            };

            // Varsayƒ±lan katmanƒ± ekle
            baseLayers["üó∫Ô∏è OpenStreetMap"].addTo(map);

            // Katman kontrol√ºn√º ekle
            L.control.layers(baseLayers).addTo(map);

            // Haritaya √ßift tƒ±klama ile POI ekleme
            map.on('dblclick', function (e) {
                if (!isSelectingLocation) {
                    const { lat, lng } = e.latlng;
                    document.getElementById('poiLat').value = lat.toFixed(6);
                    document.getElementById('poiLon').value = lng.toFixed(6);
                    document.getElementById('poiName').focus();
                    showToast('Konum se√ßildi! POI bilgilerini doldurun.', 'success');
                }
            });

            // Haritadan konum se√ßme modu
            map.on('click', function (e) {
                if (isSelectingLocation) {
                    const { lat, lng } = e.latlng;
                    document.getElementById('poiLat').value = lat.toFixed(6);
                    document.getElementById('poiLon').value = lng.toFixed(6);
                    exitLocationSelectionMode();
                    showToast('Konum se√ßildi!', 'success');
                }
            });
        }

        // Konum se√ßme modu
        function selectLocationFromMap() {
            isSelectingLocation = true;
            document.getElementById('mapSelectBtn').innerHTML = '‚ùå ƒ∞ptal';
            document.getElementById('mapSelectBtn').onclick = exitLocationSelectionMode;
            map.getContainer().style.cursor = 'crosshair';
            showToast('Haritadan bir konum se√ßin...', 'info');
        }

        function exitLocationSelectionMode() {
            isSelectingLocation = false;
            document.getElementById('mapSelectBtn').innerHTML = 'üìç Haritadan Se√ß';
            document.getElementById('mapSelectBtn').onclick = selectLocationFromMap;
            map.getContainer().style.cursor = '';
        }

        // Loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Toast bildirimleri
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Loading states
        function showLoading() {
            // Kaydet butonuna loading ekle
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Kaydediliyor...';
                saveBtn.disabled = true;
            }

            // POI tablosuna loading overlay ekle
            const poiTableContainer = document.querySelector('.table-responsive');
            if (poiTableContainer && !document.getElementById('tableLoading')) {
                const overlay = document.createElement('div');
                overlay.id = 'tableLoading';
                overlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;
                overlay.innerHTML = '<div class="spinner-border text-primary"></div>';
                poiTableContainer.style.position = 'relative';
                poiTableContainer.appendChild(overlay);
            }
        }

        function hideLoading() {
            // Kaydet butonunu resetle
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.innerHTML = 'üíæ Kaydet';
                saveBtn.disabled = false;
            }

            // Table loading overlay'i kaldƒ±r
            const overlay = document.getElementById('tableLoading');
            if (overlay) {
                overlay.remove();
            }
        }

        // POI'leri getir
        async function fetchPOIs(category = '') {
            showLoading();
            try {
                const url = `${apiBase}/pois${category ? `?category=${encodeURIComponent(category)}` : ''}`;

                // Timeout ile fetch
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000); // 10 saniye timeout

                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                clearTimeout(timeout);

                if (!response.ok) {
                    throw new Error(`API call failed with status ${response.status}`);
                }
                const data = await response.json();

                let pois = [];
                if (category) {
                    // A single category is returned as an array of POIs
                    pois = data.map(poi => ({ ...poi, category: category }));
                } else {
                    // All POIs are returned in a structured object by category
                    for (const cat in data) {
                        if (Array.isArray(data[cat])) {
                            const categoryPois = data[cat].map(poi => ({ ...poi, category: cat }));
                            pois.push(...categoryPois);
                        }
                    }
                }

                allPOIs = pois;
                filterAndSortPOIs(); // This function calls renderPOITable and updateMapMarkers
            } catch (error) {
                console.error('Error fetching POIs:', error);
                if (error.name === 'AbortError') {
                    showToast('ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.', 'error');
                } else if (error.message.includes('fetch')) {
                    showToast('Sunucuya baƒülanƒ±lamƒ±yor. API √ßalƒ±≈üƒ±yor mu kontrol edin.', 'error');
                } else {
                    showToast('POIs could not be loaded: ' + error.message, 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // Harita markerlarƒ±nƒ± g√ºncelle
        function updateMapMarkers(pois) {
            // Mevcut markerlarƒ± ve vurgulamayƒ± temizle
            poiMarkers.forEach(marker => map.removeLayer(marker));
            poiMarkers = [];

            // Vurgulama marker'ƒ±nƒ± da temizle
            if (highlightedMarker) {
                map.removeLayer(highlightedMarker);
                highlightedMarker = null;
            }

            // Kategori renkleri
            const categoryColors = {
                'gastronomik': '#e74c3c',
                'kulturel': '#3498db',
                'sanatsal': '#2ecc71',
                'doga_macera': '#f39c12',
                'konaklama': '#9b59b6'
            };

            // Yeni markerlarƒ± ekle
            pois.forEach(poi => {
                if (poi.latitude === undefined || poi.longitude === undefined) {
                    console.warn('Skipping POI with missing coordinates:', poi);
                    return;
                }
                const marker = L.circleMarker([poi.latitude, poi.longitude], {
                    color: '#ffffff',
                    fillColor: categoryColors[poi.category] || '#666',
                    fillOpacity: 0.9,
                    radius: 12,
                    weight: 3,
                    opacity: 1
                }).addTo(map);

                marker.bindPopup(`
            <strong>${poi.name}</strong><br>
            <small>${getCategoryDisplayName(poi.category)}</small><br>
            <button class="btn btn-sm btn-primary mt-1" onclick="showPOIDetail('${poi._id}')">Details</button>
        `);

                marker.on('click', () => {
                    showPOIDetail(poi._id);
                });

                poiMarkers.push(marker);
            });
        }

        // Kategori g√∂r√ºnt√º adƒ±nƒ± getir
        function getCategoryDisplayName(category) {
            const names = {
                'gastronomik': 'üçΩÔ∏è Gastronomik',
                'kulturel': 'üèõÔ∏è K√ºlt√ºrel',
                'sanatsal': 'üé® Sanatsal',
                'doga_macera': 'üåø Doƒüa & Macera',
                'konaklama': 'üè® Konaklama'
            };
            return names[category] || category;
        }

        // POI'yi haritada vurgula
        function highlightPOIOnMap(poiId) {
            console.log('üéØ highlightPOIOnMap called with ID:', poiId);
            console.log('üìä Total POIs in allPOIs:', allPOIs.length);

            // √ñnceki vurgulamayƒ± temizle
            if (highlightedMarker) {
                map.removeLayer(highlightedMarker);
                highlightedMarker = null;
            }

            // POI'yi bul - hem string hem number kar≈üƒ±la≈ütƒ±rmasƒ±
            const poi = allPOIs.find(p => p._id == poiId || p._id === poiId || p._id === parseInt(poiId) || p._id === String(poiId));
            console.log('üîç Found POI:', poi);
            console.log('üîç Searching for ID (type):', poiId, typeof poiId);
            console.log('üîç Available IDs in allPOIs:', allPOIs.map(p => ({ id: p._id, type: typeof p._id })));

            if (!poi) {
                console.warn('‚ùå POI not found with ID:', poiId);
                showToast(`POI bulunamadƒ± (ID: ${poiId}, Type: ${typeof poiId})`, 'error');
                return;
            }

            if (poi.latitude === undefined || poi.longitude === undefined) {
                console.warn('‚ùå POI missing coordinates:', poi);
                showToast(`POI koordinatlarƒ± eksik: ${poi.name}`, 'error');
                return;
            }

            // Vurgulama marker'ƒ± olu≈ütur
            highlightedMarker = L.circleMarker([poi.latitude, poi.longitude], {
                color: '#ff0000',
                fillColor: '#ff0000',
                fillOpacity: 0.3,
                radius: 15,
                weight: 3,
                className: 'highlight-marker'
            }).addTo(map);

            // Haritayƒ± POI'ye odakla
            map.setView([poi.latitude, poi.longitude], Math.max(map.getZoom(), 15), {
                animate: true,
                duration: 0.5
            });

            // Kullanƒ±cƒ±ya bilgi ver
            showToast(`üìç "${poi.name}" haritada vurgulandƒ±`, 'success');

            // Vurgulama animasyonu i√ßin pulse efekti
            let pulseCount = 0;
            const pulseInterval = setInterval(() => {
                if (highlightedMarker && pulseCount < 6) {
                    const currentRadius = highlightedMarker.getRadius();
                    highlightedMarker.setRadius(currentRadius === 15 ? 20 : 15);
                    pulseCount++;
                } else {
                    clearInterval(pulseInterval);
                    if (highlightedMarker) {
                        highlightedMarker.setRadius(15);
                    }
                }
            }, 200);
        }

        // POI tablosunu render et
        function renderPOITable(pois) {
            const tbody = document.getElementById('poiTableBody');
            const noDataMessage = document.getElementById('noDataMessage');

            if (pois.length === 0) {
                tbody.innerHTML = '';
                noDataMessage.classList.remove('d-none');
                return;
            }

            noDataMessage.classList.add('d-none');
            tbody.innerHTML = '';

            pois.forEach(poi => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td class="pointer text-primary" onclick="highlightPOIOnMap(${poi._id}); showPOIDetail(${poi._id})" title="Haritada g√∂ster ve detaylarƒ± a√ß">${poi.name}</td>
            <td class="pointer" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">${getCategoryDisplayName(poi.category)}</td>
            <td class="pointer text-muted" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">${(poi.latitude || 0).toFixed(6)}</td>
            <td class="pointer text-muted" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">${(poi.longitude || 0).toFixed(6)}</td>
            <td>
                <button class="btn btn-outline-primary btn-sm me-1" onclick="editPOI(${poi._id})" title="Edit">‚úèÔ∏è</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deletePOI(${poi._id})" title="Delete">üóëÔ∏è</button>
                <button class="btn btn-outline-success btn-sm" onclick="highlightPOIOnMap(${poi._id})" title="Haritada g√∂ster">üìç</button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // POI detayƒ±nƒ± g√∂ster - Yeni birle≈üik panel i√ßin g√ºncellendi
        async function showPOIDetail(poiId) {
            showLoading();
            try {
                const response = await fetch(`${apiBase}/poi/${poiId}`);
                if (!response.ok) throw new Error('POI not found');
                const poi = await response.json();

                selectedPOI = poi;

                // Form alanlarƒ±nƒ± doldur (d√ºzenleme i√ßin hazƒ±r hale getir)
                document.getElementById('poiId').value = poi._id;
                document.getElementById('poiName').value = poi.name;
                document.getElementById('poiCategory').value = poi.category;
                document.getElementById('poiLat').value = poi.latitude;
                document.getElementById('poiLon').value = poi.longitude;
                document.getElementById('poiDesc').value = poi.description || '';
                document.getElementById('poiTags').value = (poi.tags || []).join(', ');
                document.getElementById('poiImageUrl').value = poi.imageUrl || '';

                // Formu d√ºzenleme moduna ge√ßir
                document.getElementById('saveBtn').innerHTML = 'üîÑ G√ºncelle';
                document.getElementById('deleteBtn').classList.remove('d-none');
                document.getElementById('cancelEditBtn').classList.remove('d-none');

                // Panel ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
                document.getElementById('panelTitle').textContent = `üìù ${poi.name}`;
                document.getElementById('newPoiBtn').classList.remove('d-none');

                // Detaylar tab'ƒ±nƒ± g√∂ster ve aktif yap
                document.getElementById('details-tab-container').style.display = 'block';
                
                // Bootstrap tab ge√ßi≈üi
                const detailsTab = new bootstrap.Tab(document.getElementById('details-tab'));
                detailsTab.show();

                // Detay HTML'ini olu≈ütur
                let detailHtml = `
                    <div class="poi-detail-header">
                        <h5 class="mb-2 fw-bold">${poi.name}</h5>
                        <span class="badge bg-light text-dark fs-6">${getCategoryDisplayName(poi.category)}</span>
                    </div>
                    
                    <div class="poi-detail-info">
                        <p class="mb-2"><i class="fas fa-map-marker-alt text-danger me-2"></i> <strong>Konum:</strong> ${poi.latitude.toFixed(6)}, ${poi.longitude.toFixed(6)}</p>`;

                if (poi.description) {
                    detailHtml += `<p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i> <strong>A√ßƒ±klama:</strong> ${poi.description}</p>`;
                }
                if (poi.tags && poi.tags.length > 0) {
                    detailHtml += `<p class="mb-2"><i class="fas fa-tags text-success me-2"></i> <strong>Etiketler:</strong> ${poi.tags.join(', ')}</p>`;
                }
                
                detailHtml += `</div>`;

                // G√∂rselleri y√ºkle ve g√∂ster
                try {
                    const imagesResponse = await fetch(`${apiBase}/poi/${poiId}/images`);
                    if (imagesResponse.ok) {
                        const imagesData = await imagesResponse.json();
                        const images = imagesData.images || [];
                        
                        if (images.length > 0) {
                            detailHtml += `
                                <div class="poi-detail-images mt-3">
                                    <h6 class="mb-3"><i class="fas fa-images text-warning"></i> G√∂rseller (${images.length})</h6>
                                    <div class="row g-3">`;
                            
                            images.forEach((image, index) => {
                                const imagePath = image.thumbnail_path || image.path;
                                const fullImagePath = image.path;
                                detailHtml += `
                                    <div class="col-6">
                                        <div class="image-card-enhanced" style="position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                            <img src="/${imagePath}" 
                                                 class="img-fluid" 
                                                 style="height: 120px; width: 100%; object-fit: cover; cursor: pointer; transition: transform 0.3s ease;" 
                                                 alt="${image.filename}"
                                                 onclick="showImageModal('/${fullImagePath}', '${poi.name}', '${image.filename}')"
                                                 onmouseover="this.style.transform='scale(1.05)'"
                                                 onmouseout="this.style.transform='scale(1)'">
                                            <div class="image-info-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 8px 12px;">
                                                <small class="text-white fw-bold">${getImageTypeIcon(image.filename)} ${(image.size / 1024).toFixed(0)}KB</small>
                                            </div>
                                            <button class="image-delete-btn-enhanced btn btn-danger" 
                                                    style="position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; padding: 0; font-size: 0.9rem; z-index: 10; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(220,53,69,0.4); transition: all 0.3s ease;"
                                                    onclick="deletePOIImageWithConfirm('${poi._id}', '${image.filename}', this)"
                                                    title="G√∂rseli sil - ${image.filename}"
                                                    onmouseover="this.style.transform='scale(1.2)'; this.style.boxShadow='0 6px 16px rgba(220,53,69,0.6)'"
                                                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(220,53,69,0.4)'">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>`;
                            });
                            
                            detailHtml += `
                                    </div>
                                </div>`;
                        }
                    }
                } catch (imageError) {
                    console.log('G√∂rseller y√ºklenemedi:', imageError);
                }

                // Eski imageUrl desteƒüi (geriye uyumluluk)
                if (poi.imageUrl && !detailHtml.includes('poi-detail-images')) {
                    detailHtml += `
                        <div class="poi-detail-images mt-3">
                            <h6 class="mb-2"><i class="fas fa-image text-warning"></i> G√∂rsel</h6>
                            <img src="${poi.imageUrl}" 
                                 class="img-fluid rounded shadow" 
                                 alt="${poi.name}"
                                 onclick="showImageModal('${poi.imageUrl}', '${poi.name}', 'POI G√∂rseli')">
                        </div>`;
                }

                detailHtml += `
                    <div class="poi-detail-actions">
                        <button class="btn btn-primary btn-sm" onclick="focusOnMap(${poi.latitude}, ${poi.longitude})">
                            <i class="fas fa-crosshairs me-1"></i> Haritada G√∂ster
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="switchToFormTab()">
                            <i class="fas fa-edit me-1"></i> D√ºzenle
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCurrentPOI()">
                            <i class="fas fa-trash me-1"></i> Sil
                        </button>
                    </div>`;

                document.getElementById('poiDetailContent').innerHTML = detailHtml;

                // Mevcut g√∂rselleri form b√∂l√ºm√ºnde de y√ºkle
                await loadPOIImages(poiId);

            } catch (error) {
                showToast('POI detaylarƒ± y√ºklenirken hata olu≈ütu', 'error');
            } finally {
                hideLoading();
            }
        }

        // Form tab'ƒ±na ge√ßi≈ü yap
        function switchToFormTab() {
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();
        }

        // Mevcut POI'yi sil
        async function deleteCurrentPOI() {
            const poiId = document.getElementById('poiId').value;
            if (poiId) {
                await deletePOI(poiId);
            }
        }

        // Haritada odaklan
        function focusOnMap(lat, lon) {
            map.setView([lat, lon], 16);
        }

        // POI d√ºzenle - Yeni birle≈üik panel i√ßin g√ºncellendi
        async function editPOI(poiId) {
            // √ñnce POI detaylarƒ±nƒ± y√ºkle (form alanlarƒ±nƒ± doldurur)
            await showPOIDetail(poiId);
            
            // Form tab'ƒ±na ge√ßi≈ü yap
            setTimeout(() => {
                switchToFormTab();
                showToast('POI d√ºzenleme moduna ge√ßildi', 'info');
            }, 300);
        }

        // Form temizle ve yeni POI moduna ge√ß
        function clearForm() {
            document.getElementById('poiForm').reset();
            document.getElementById('poiId').value = '';
            document.getElementById('saveBtn').innerHTML = 'üíæ Kaydet';
            document.getElementById('deleteBtn').classList.add('d-none');
            document.getElementById('cancelEditBtn').classList.add('d-none');
            document.getElementById('panelTitle').textContent = 'üÜï Yeni POI Ekle';
            document.getElementById('newPoiBtn').classList.add('d-none');
            
            // Detaylar tab'ƒ±nƒ± gizle ve form tab'ƒ±nƒ± aktif yap
            document.getElementById('details-tab-container').style.display = 'none';
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();
            
            // Detay content'ini temizle
            document.getElementById('poiDetailContent').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>POI detaylarƒ± burada g√∂r√ºnecek</p>
                </div>
            `;
            
            // Mevcut g√∂rseller alanƒ±nƒ± temizle
            document.getElementById('currentImages').innerHTML = '';
            
            selectedPOI = null;
            showToast('Yeni POI ekleme moduna ge√ßildi', 'info');
        }

        // Form g√∂nder
        document.getElementById('poiForm').onsubmit = async function (e) {
            e.preventDefault();
            showLoading();

            try {
                const idVal = document.getElementById('poiId').value;
                const name = document.getElementById('poiName').value.trim();
                const category = document.getElementById('poiCategory').value;
                const lat = parseFloat(document.getElementById('poiLat').value);
                const lon = parseFloat(document.getElementById('poiLon').value);
                const description = document.getElementById('poiDesc').value;
                const tags = document.getElementById('poiTags').value.split(',').map(t => t.trim()).filter(Boolean);
                const imageUrl = document.getElementById('poiImageUrl').value;

                const poiData = {
                    name, category, latitude: lat, longitude: lon,
                    description, tags, imageUrl
                };

                let response;
                if (idVal) {
                    // G√ºncelle
                    response = await fetch(`${apiBase}/poi/${idVal}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                } else {
                    // Ekle
                    response = await fetch(`${apiBase}/poi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                }

                if (response.ok) {
                    const isUpdate = idVal ? true : false;
                    showToast(isUpdate ? 'POI ba≈üarƒ±yla g√ºncellendi!' : 'POI ba≈üarƒ±yla eklendi!', 'success');
                    
                    if (isUpdate) {
                        // G√ºncelleme sonrasƒ± detaylarƒ± yenile
                        await showPOIDetail(idVal);
                        showToast('POI detaylarƒ± g√ºncellendi', 'info');
                    } else {
                        // Yeni POI eklendikten sonra formu temizle
                        clearForm();
                    }
                    
                    await fetchPOIs(document.getElementById('filterCategory').value);
                } else {
                    throw new Error('ƒ∞≈ülem ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                showToast('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        };

        // POI sil
        async function deletePOI(poiId) {
            const poiToDelete = allPOIs.find(p => p._id === poiId);
            const poiName = poiToDelete ? poiToDelete.name : "Unknown POI";
            if (!confirm(`Are you sure you want to delete "${poiName}"?\n\nThis will set the POI as inactive.`)) return;

            showLoading();
            try {
                const response = await fetch(`${apiBase}/poi/${poiId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('POI successfully deleted!', 'success');
                    await fetchPOIs(document.getElementById('filterCategory').value);
                } else {
                    throw new Error('Deletion failed');
                }
            } catch (error) {
                showToast('Error during deletion: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Arama ve filtreleme
        function filterAndSortPOIs() {
            const searchTerm = document.getElementById('searchPOI').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;

            let filteredPOIs = allPOIs.filter(poi => {
                const matchesSearch = poi.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || poi.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            // Sƒ±ralama
            filteredPOIs.sort((a, b) => {
                let aVal = a[currentSort.field];
                let bVal = b[currentSort.field];

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (currentSort.direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });

            updateMapMarkers(filteredPOIs);
            renderPOITable(filteredPOIs);
        }

        // Sƒ±ralama
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('sortable') || e.target.parentElement.classList.contains('sortable')) {
                const sortField = e.target.dataset.sort || e.target.parentElement.dataset.sort;

                if (currentSort.field === sortField) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = sortField;
                    currentSort.direction = 'asc';
                }

                // Sƒ±ralama iconlarƒ±nƒ± g√ºncelle
                document.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.textContent = '‚ÜïÔ∏è';
                });

                const currentIcon = document.querySelector(`[data-sort="${sortField}"] .sort-icon`);
                if (currentIcon) {
                    currentIcon.textContent = currentSort.direction === 'asc' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                }

                filterAndSortPOIs();
            }
        });

        // Form validation ve submit
        function validatePOIForm() {
            const name = document.getElementById('poiName').value.trim();
            const lat = parseFloat(document.getElementById('poiLat').value);
            const lng = parseFloat(document.getElementById('poiLon').value);
            const category = document.getElementById('poiCategory').value;

            if (!name) {
                showToast('POI adƒ± gerekli!', 'error');
                return false;
            }

            if (name.length < 2) {
                showToast('POI adƒ± en az 2 karakter olmalƒ±!', 'error');
                return false;
            }

            if (isNaN(lat) || lat < -90 || lat > 90) {
                showToast('Ge√ßerli bir enlem deƒüeri girin (-90 ile 90 arasƒ±nda)!', 'error');
                return false;
            }

            if (isNaN(lng) || lng < -180 || lng > 180) {
                showToast('Ge√ßerli bir boylam deƒüeri girin (-180 ile 180 arasƒ±nda)!', 'error');
                return false;
            }

            if (!category) {
                showToast('Kategori se√ßimi gerekli!', 'error');
                return false;
            }

            return true;
        }

        // Form submit handler
        document.getElementById('poiForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!validatePOIForm()) {
                return;
            }

            showLoading();
            try {
                const idVal = document.getElementById('poiId').value;
                const name = document.getElementById('poiName').value.trim();
                const latitude = parseFloat(document.getElementById('poiLat').value);
                const longitude = parseFloat(document.getElementById('poiLon').value);
                const category = document.getElementById('poiCategory').value;
                const description = document.getElementById('poiDesc').value.trim();
                const tags = document.getElementById('poiTags').value.trim();
                const imageUrl = document.getElementById('poiImageUrl').value.trim();

                const poiData = {
                    name, category, latitude, longitude,
                    description, tags, imageUrl
                };

                let response;
                if (idVal) {
                    // G√ºncelle
                    response = await fetch(`${apiBase}/poi/${idVal}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                } else {
                    // Ekle
                    response = await fetch(`${apiBase}/poi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(poiData)
                    });
                }

                if (response.ok) {
                    const isUpdate = idVal ? true : false;
                    showToast(isUpdate ? 'POI ba≈üarƒ±yla g√ºncellendi!' : 'POI ba≈üarƒ±yla eklendi!', 'success');
                    
                    if (isUpdate) {
                        // G√ºncelleme sonrasƒ± detaylarƒ± yenile
                        await showPOIDetail(idVal);
                        showToast('POI detaylarƒ± g√ºncellendi', 'info');
                    } else {
                        // Yeni POI eklendikten sonra formu temizle
                        clearForm();
                    }
                    
                    await fetchPOIs(document.getElementById('filterCategory').value);
                } else {
                    throw new Error('ƒ∞≈ülem ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                showToast('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        // Event listeners
        document.getElementById('searchPOI').addEventListener('input', filterAndSortPOIs);
        document.getElementById('filterCategory').addEventListener('change', function () {
            fetchPOIs(this.value);
        });

        // G√∂rsel modal ve yardƒ±mcƒ± fonksiyonlar
        function showImageModal(imagePath, poiName, filename) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">üì∏ ${filename}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imagePath}" class="img-fluid rounded shadow" alt="${poiName}" style="max-height: 70vh;">
                            <div class="mt-2">
                                <small class="text-muted">${poiName}</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="${imagePath}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt"></i> Yeni Sekmede A√ß
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        function getImageTypeIcon(filename) {
            const name = filename.toLowerCase();
            if (name.includes('exterior') || name.includes('dis')) return 'üè¢';
            if (name.includes('interior') || name.includes('ic')) return 'üè†';
            if (name.includes('food') || name.includes('yemek')) return 'üçΩÔ∏è';
            if (name.includes('menu')) return 'üìã';
            if (name.includes('logo')) return 'üè∑Ô∏è';
            return 'üì∑';
        }

        // G√∂rsel y√∂netimi fonksiyonlarƒ±
        async function uploadPOIImage() {
            const fileInput = document.getElementById('imageFile');
            const imageType = document.getElementById('imageType').value;
            const imageCaption = document.getElementById('imageCaption').value;
            const isPrimary = document.getElementById('isPrimaryImage').checked;
            
            // POI ID'sini al (d√ºzenleme modundaysa)
            const poiId = document.getElementById('poiId').value;
            if (!poiId) {
                alert('√ñnce POI\'yi kaydedin, sonra g√∂rsel ekleyin.');
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('L√ºtfen bir g√∂rsel dosyasƒ± se√ßin.');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Dosya boyutu kontrol√º (15MB - WebP d√∂n√º≈ü√ºm√º sayesinde)
            if (file.size > 15 * 1024 * 1024) {
                alert('Dosya boyutu 15MB\'dan k√º√ß√ºk olmalƒ±dƒ±r.\n\nNot: G√∂rseliniz otomatik olarak WebP formatƒ±na d√∂n√º≈üt√ºr√ºlecek ve boyutu %50-80 oranƒ±nda k√º√ß√ºlt√ºlecektir.');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            formData.append('type', imageType);
            formData.append('caption', imageCaption);
            formData.append('is_primary', isPrimary);
            
            try {
                showLoading();
                const response = await fetch(`${apiBase}/poi/${poiId}/images`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'G√∂rsel y√ºkleme ba≈üarƒ±sƒ±z');
                }
                
                const result = await response.json();
                
                if (result.image && result.image.compression_ratio) {
                    showToast(`G√∂rsel ba≈üarƒ±yla y√ºklendi ve WebP formatƒ±na d√∂n√º≈üt√ºr√ºld√º!\nüì¶ Boyut azalmasƒ±: ${result.image.compression_ratio}`, 'success');
                } else {
                    showToast('G√∂rsel ba≈üarƒ±yla y√ºklendi!', 'success');
                }
                
                // Form alanlarƒ±nƒ± temizle
                fileInput.value = '';
                document.getElementById('imageCaption').value = '';
                document.getElementById('isPrimaryImage').checked = false;
                
                // Mevcut g√∂rselleri yenile
                await loadPOIImages(poiId);
                
            } catch (error) {
                console.error('G√∂rsel y√ºkleme hatasƒ±:', error);
                alert('G√∂rsel y√ºkleme hatasƒ±: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function loadPOIImages(poiId) {
            if (!poiId) return;
            
            try {
                const response = await fetch(`${apiBase}/poi/${poiId}/images`);
                if (!response.ok) return;
                
                const data = await response.json();
                const images = data.images || [];
                
                const container = document.getElementById('currentImages');
                if (images.length === 0) {
                    container.innerHTML = '<small class="text-muted">Hen√ºz g√∂rsel eklenmemi≈ü.</small>';
                    return;
                }
                
                let imagesHtml = '<div class="row g-2">';
                images.forEach((image, index) => {
                    const imagePath = image.thumbnail_path || image.path;
                    imagesHtml += `
                        <div class="col-6">
                            <div class="card">
                                <img src="/${imagePath}" class="card-img-top" style="height: 80px; object-fit: cover;" 
                                     alt="${image.filename}">
                                <div class="card-body p-2">
                                    <small class="text-muted">${image.filename}</small>
                                    <br><small>${(image.size / 1024).toFixed(1)} KB</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                imagesHtml += '</div>';
                
                container.innerHTML = imagesHtml;
                
            } catch (error) {
                console.error('G√∂rseller y√ºklenirken hata:', error);
            }
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function () {
            initMap();
            fetchPOIs();
        });
    </script>
</body>

</html>