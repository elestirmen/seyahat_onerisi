<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yakın POI Özelliği Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>🧪 Yakın POI Özelliği Test</h2>
        
        <div class="card">
            <div class="card-body">
                <h5>Test Rotası: Yamaha R6 Gezisi (ID: 59)</h5>
                
                <div class="mb-3">
                    <button id="loginBtn" class="btn btn-primary">1. Login</button>
                    <span id="loginStatus" class="ms-2"></span>
                </div>
                
                <div class="mb-3">
                    <button id="findNearbyBtn" class="btn btn-info" disabled>2. Yakın POI'leri Bul</button>
                    <span id="findStatus" class="ms-2"></span>
                </div>
                
                <div class="mb-3">
                    <button id="autoAssociateBtn" class="btn btn-success" disabled>3. Otomatik Ekle</button>
                    <span id="autoStatus" class="ms-2"></span>
                </div>
                
                <div id="results" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script>
        const apiBase = '/api';
        const routeId = 59;
        let isLoggedIn = false;

        // Login test
        document.getElementById('loginBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ password: 'AdminPass123!' })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    document.getElementById('loginStatus').innerHTML = '<span class="text-success">✅ Başarılı</span>';
                    document.getElementById('findNearbyBtn').disabled = false;
                    document.getElementById('autoAssociateBtn').disabled = false;
                    isLoggedIn = true;
                } else {
                    document.getElementById('loginStatus').innerHTML = '<span class="text-danger">❌ Başarısız: ' + (data.error || 'Bilinmeyen hata') + '</span>';
                }
            } catch (error) {
                document.getElementById('loginStatus').innerHTML = '<span class="text-danger">❌ Hata: ' + error.message + '</span>';
                console.error('Login error:', error);
            }
        });

        // Find nearby POIs test
        document.getElementById('findNearbyBtn').addEventListener('click', async () => {
            if (!isLoggedIn) return;
            
            try {
                document.getElementById('findStatus').innerHTML = '<span class="text-info">🔄 Aranıyor...</span>';
                
                const response = await fetch(`${apiBase}/routes/${routeId}/nearby-pois?max_distance=500`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const count = data.nearby_pois.length;
                    document.getElementById('findStatus').innerHTML = `<span class="text-success">✅ ${count} POI bulundu</span>`;
                    
                    // Show results
                    const resultsHtml = `
                        <div class="alert alert-info">
                            <h6>Bulunan POI'ler (${count} adet):</h6>
                            <ul class="mb-0">
                                ${data.nearby_pois.slice(0, 5).map(poi => 
                                    `<li>${poi.name} (${poi.category}) - ${Math.round(poi.distance_meters)}m</li>`
                                ).join('')}
                                ${count > 5 ? `<li><em>... ve ${count - 5} tane daha</em></li>` : ''}
                            </ul>
                        </div>
                    `;
                    document.getElementById('results').innerHTML = resultsHtml;
                } else {
                    document.getElementById('findStatus').innerHTML = '<span class="text-danger">❌ Başarısız: ' + (data.error || 'Bilinmeyen hata') + '</span>';
                }
            } catch (error) {
                document.getElementById('findStatus').innerHTML = '<span class="text-danger">❌ Hata: ' + error.message + '</span>';
                console.error('Find nearby error:', error);
            }
        });

        // Auto-associate test
        document.getElementById('autoAssociateBtn').addEventListener('click', async () => {
            if (!isLoggedIn) return;
            
            try {
                document.getElementById('autoStatus').innerHTML = '<span class="text-info">🔄 Ekleniyor...</span>';
                
                const response = await fetch(`${apiBase}/routes/${routeId}/auto-associate-pois`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        max_distance: 500,
                        auto_confirm: true
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const count = data.associated_count;
                    document.getElementById('autoStatus').innerHTML = `<span class="text-success">✅ ${count} POI eklendi</span>`;
                    
                    // Show results
                    const resultsHtml = `
                        <div class="alert alert-success">
                            <h6>Otomatik Ekleme Sonucu:</h6>
                            <p><strong>${count} POI</strong> başarıyla rotaya eklendi!</p>
                            <p><em>${data.message}</em></p>
                        </div>
                    `;
                    document.getElementById('results').innerHTML = resultsHtml;
                } else {
                    document.getElementById('autoStatus').innerHTML = '<span class="text-danger">❌ Başarısız: ' + (data.error || 'Bilinmeyen hata') + '</span>';
                }
            } catch (error) {
                document.getElementById('autoStatus').innerHTML = '<span class="text-danger">❌ Hata: ' + error.message + '</span>';
                console.error('Auto-associate error:', error);
            }
        });

        // Check initial auth status
        fetch('/auth/status', { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
                if (data.authenticated) {
                    document.getElementById('loginStatus').innerHTML = '<span class="text-success">✅ Zaten giriş yapılmış</span>';
                    document.getElementById('findNearbyBtn').disabled = false;
                    document.getElementById('autoAssociateBtn').disabled = false;
                    isLoggedIn = true;
                }
            })
            .catch(error => console.log('Auth check failed:', error));
    </script>
</body>
</html>